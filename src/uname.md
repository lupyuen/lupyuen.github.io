# Fixing a uname bug (Apache NuttX RTOS)

ðŸ“ _30 Jan 2025_

![TODO](https://lupyuen.github.io/images/uname-title.png)

[__`uname`__](TODO) became unusually quieter on [__Apache NuttX RTOS__](TODO)...

```bash
TODO
```

See the subtle bug? The [__Commit Hash__](TODO) is missing!

```bash
TODO
```

_Can we ignore it? Maybe nobody will notice?_

Noooooo! We use it to TODO

(App Hash would be helpful too)

# TODO

https://github.com/apache/nuttx/pull/15501
riscv/Toolchain.defs: guard -r use #15501

https://github.com/apache/nuttx/pull/15444
modlib: preprocess gnu-elf.ld for executable ELF #15444

what;s missing?
https://github.com/lupyuen/nuttx-riscv64/releases/tag/qemu-riscv-nsh64-2025-01-13
https://github.com/lupyuen/nuttx-riscv64/releases/tag/qemu-riscv-knsh64-2025-01-13
NuttShell (NSH) NuttX-12.8.0
nsh> uname -a
NuttX 12.8.0 5f4a15b690 Jan 13 2025 00:34:30 risc-v rv-virt
NuttShell (NSH) NuttX-12.8.0
nsh> uname -a
NuttX 12.8.0  risc-v rv-virt

But not sg2000
https://github.com/lupyuen/nuttx-sg2000/releases/tag/nuttx-sg2000-2025-01-13
nsh> uname -a
NuttX 12.8.0 5f4a15b690 Jan 13 2025 00:17:37 risc-v milkv_duos

uname -a
apps: search uname
https://github.com/search?q=repo%3Aapache%2Fnuttx-apps%20uname&type=code
https://github.com/apache/nuttx-apps/blob/a6b9e718460a56722205c2a84a9b07b94ca664aa/nshlib/nsh_syscmds.c#L771

kernel: seach uname
https://github.com/search?q=repo%3Aapache%2Fnuttx%20uname&type=code
https://github.com/apache/nuttx/blob/a2d4d74af75ffab527ac2422798c3368101da5f3/libs/libc/misc/lib_utsname.c#L93

grep CONFIG_VERSION_BUILD .config
nothing

search for CONFIG_VERSION_BUILD
https://github.com/apache/nuttx/blob/a2d4d74af75ffab527ac2422798c3368101da5f3/Documentation/guides/versioning_and_task_names.rst#L57
The version number you are looking at comes from the header file nuttx/include/nuttx/version.h. That header file was created at build time from a hidden file that you can find in the top-level nuttx directory called .version. 

âžœ  special-qemu-riscv-nsh64 $ cat nuttx/nuttx/include/nuttx/version.h 
/* version.h -- Autogenerated! Do not edit. */

#ifndef __INCLUDE_NUTTX_VERSION_H
#define __INCLUDE_NUTTX_VERSION_H

#define CONFIG_VERSION_STRING "12.8.0"
#define CONFIG_VERSION_MAJOR 12
#define CONFIG_VERSION_MINOR 8
#define CONFIG_VERSION_PATCH 0
#define CONFIG_VERSION_BUILD "a2d4d74af7"

#define CONFIG_VERSION ((CONFIG_VERSION_MAJOR << 16) |\
                        (CONFIG_VERSION_MINOR << 8) |\
                        (CONFIG_VERSION_PATCH))

#endif /* __INCLUDE_NUTTX_VERSION_H */

âžœ  special-qemu-riscv-knsh64 $ cat nuttx/nuttx/include/nuttx/version.h
/* version.h -- Autogenerated! Do not edit. */

#ifndef __INCLUDE_NUTTX_VERSION_H
#define __INCLUDE_NUTTX_VERSION_H

#define CONFIG_VERSION_STRING "12.8.0"
#define CONFIG_VERSION_MAJOR 12
#define CONFIG_VERSION_MINOR 8
#define CONFIG_VERSION_PATCH 0
#define CONFIG_VERSION_BUILD "a2d4d74af7"

#define CONFIG_VERSION ((CONFIG_VERSION_MAJOR << 16) |\
                        (CONFIG_VERSION_MINOR << 8) |\
                        (CONFIG_VERSION_PATCH))

#endif /* __INCLUDE_NUTTX_VERSION_H */

knsh nuttx.S:
/private/tmp/special-qemu-riscv-nsh64/nuttx/nuttx/libs/libc/misc/lib_utsname.c:106

  strlcpy(name->release,  CONFIG_VERSION_STRING, sizeof(name->release));
    8001456a:	4655                	li	a2,21
    8001456c:	0000f597          	auipc	a1,0xf
    80014570:	0c458593          	add	a1,a1,196 # 80023630 <g_idlename+0x1c68>
    80014574:	03540513          	add	a0,s0,53
    80014578:	880f10ef          	jal	800055f8 <strlcpy>

knsh64 nuttx.S:
/private/tmp/special-qemu-riscv-knsh64/nuttx/nuttx/libs/libc/misc/lib_utsname.c:106

  strlcpy(name->release,  CONFIG_VERSION_STRING, sizeof(name->release));
    8021677e:	4655                	li	a2,21
    80216780:	00005597          	auipc	a1,0x5
    80216784:	26058593          	add	a1,a1,608 # 8021b9e0 <_srodata+0x1d78>
    80216788:	03540513          	add	a0,s0,53
    8021678c:	8cdf10ef          	jal	80208058 <strlcpy>

        ## Export the Binary Image to nuttx.bin
        riscv-none-elf-objcopy \
          -O binary \
          nuttx \
          nuttx.bin

#if defined(__DATE__) && defined(__TIME__) && \
    !defined(CONFIG_LIBC_UNAME_DISABLE_TIMESTAMP)
static char g_version[] = CONFIG_VERSION_BUILD " " __DATE__ " " __TIME__;
#else
static char g_version[] = CONFIG_VERSION_BUILD;
#endif

nsh64:
/private/tmp/special-qemu-riscv-nsh64/nuttx/nuttx/libs/libc/misc/lib_utsname.c:108

  strlcpy(name->version,  g_version, sizeof(name->version));
    8001457c:	03300613          	li	a2,51
    80014580:	00019597          	auipc	a1,0x19
    80014584:	de058593          	add	a1,a1,-544 # 8002d360 <g_version>
    80014588:	04a40513          	add	a0,s0,74
    8001458c:	86cf10ef          	jal	800055f8 <strlcpy>

knsh64:
/private/tmp/special-qemu-riscv-knsh64/nuttx/nuttx/libs/libc/misc/lib_utsname.c:108

  strlcpy(name->version,  g_version, sizeof(name->version));
    80216790:	03300613          	li	a2,51
    80216794:	001ea597          	auipc	a1,0x1ea
    80216798:	c2458593          	add	a1,a1,-988 # 804003b8 <g_version>
    8021679c:	04a40513          	add	a0,s0,74
    802167a0:	8b9f10ef          	jal	80208058 <strlcpy>

VSCode Hex Viewer
nsh64: go to 2d360
knsh64: go to 2003b8 (kernel loads at 80200000)
looks identical

Call uname like https://github.com/apache/nuttx-apps/blob/a6b9e718460a56722205c2a84a9b07b94ca664aa/nshlib/nsh_syscmds.c#L771
#include <sys/utsname.h>
  struct utsname info;
  ret = uname(&info);

Call uname
https://github.com/lupyuen2/wip-nuttx-apps/blob/uname/examples/hello/hello_main.c#L43-L53

nsh64:
https://gist.github.com/lupyuen/dc50a606b27ff1348724bf9efb199982#file-special-qemu-riscv-nsh64-log-L600
nsh> hello
Hello, World!!
ret=0
sysname=NuttX
nodename=
release=12.8.0
version=5f4a15b690 Jan 13 2025 10:44:50
machine=risc-v

knsh64:
https://gist.github.com/lupyuen/ee3eee9752165bee8f3e60d57c224372#file-special-qemu-riscv-knsh64-log-L1410
NuttShell (NSH) NuttX-12.8.0
nsh> hello
Hello, World!!
ret=0
sysname=NuttX
nodename=
release=12.8.0
version=
machine=risc-v

print in kernel:
https://github.com/lupyuen2/wip-nuttx/blob/uname/boards/risc-v/qemu-rv/rv-virt/src/qemu_rv_appinit.c#L121
https://github.com/lupyuen2/wip-nuttx/blob/uname/libs/libc/misc/lib_utsname.c#L109

ABC
uname: From _info: g_version=c3330b17c7e-dirty Jan 13 2025 11:49:41
From printf: g_version=c3330b17c7e-dirty Jan 13 2025 11:49:41
board_app_initialize: version=c3330b17c7e-dirty Jan 13 2025 11:49:41

NuttShell (NSH) NuttX-12.7.0
nsh> hello
Hello, World!!
From printf: g_version=
ret=0
sysname=NuttX
nodename=
release=12.7.0
version=
machine=risc-v
nsh> 

nuttx/hello.S

âžœ  apps git:(uname) $ touch examples/hello/hello_main.c
âžœ  apps git:(uname) $ make import V=1
LD:  /Users/luppy/riscv/apps/bin/hello 
riscv-none-elf-ld -e main --oformat elf64-littleriscv -T /Users/luppy/riscv/nuttx/libs/libc/modlib/gnu-elf.ld -e __start -Bstatic -T/Users/luppy/riscv/apps/import/scripts/gnu-elf.ld  -L/Users/luppy/riscv/apps/import/libs -L "/Users/luppy/xpack-riscv-none-elf-gcc-13.2.0-2/bin/../lib/gcc/riscv-none-elf/13.2.0/rv64imafdc_zicsr/lp64d" /Users/luppy/riscv/apps/import/startup/crt0.o  hello_main.c.Users.luppy.riscv.apps.examples.hello.o --start-group -lmm -lc -lproxies -lgcc /Users/luppy/riscv/apps/libapps.a /Users/luppy/xpack-riscv-none-elf-gcc-13.2.0-2/bin/../lib/gcc/riscv-none-elf/13.2.0/rv64imafdc_zicsr/lp64d/libgcc.a --end-group -o  /Users/luppy/riscv/apps/bin/hello

chmod +x /Users/luppy/riscv/apps/bin/hello
mkdir -p /Users/luppy/riscv/apps/bin_debug
cp /Users/luppy/riscv/apps/bin/hello /Users/luppy/riscv/apps/bin_debug
riscv-none-elf-strip --strip-unneeded /Users/luppy/riscv/apps/bin/hello

LD:  /Users/luppy/riscv/apps/bin/hello 
riscv-none-elf-ld \
  -e main \
  --oformat elf64-littleriscv \
  -T /Users/luppy/riscv/nuttx/libs/libc/modlib/gnu-elf.ld \
  -e __start \
  -Bstatic \
  -T/Users/luppy/riscv/apps/import/scripts/gnu-elf.ld  \
  -L/Users/luppy/riscv/apps/import/libs \
  -L "/Users/luppy/xpack-riscv-none-elf-gcc-13.2.0-2/bin/../lib/gcc/riscv-none-elf/13.2.0/rv64imafdc_zicsr/lp64d" /Users/luppy/riscv/apps/import/startup/crt0.o  hello_main.c.Users.luppy.riscv.apps.examples.hello.o \
  --start-group \
  -lmm \
  -lc \
  -lproxies \
  -lgcc /Users/luppy/riscv/apps/libapps.a /Users/luppy/xpack-riscv-none-elf-gcc-13.2.0-2/bin/../lib/gcc/riscv-none-elf/13.2.0/rv64imafdc_zicsr/lp64d/libgcc.a \
  --end-group \
  -o  /Users/luppy/riscv/apps/bin/hello

âžœ  apps git:(uname) $ ls -l /Users/luppy/riscv/apps/bin/hello
-rwxr-xr-x  1 luppy  staff  14048 Jan 13 11:32 /Users/luppy/riscv/apps/bin/hello
âžœ  apps git:(uname) $ 
cd examples/hello
 hello git:(uname) $ riscv-none-elf-ld \
  -e main \
  --oformat elf64-littleriscv \
  -T /Users/luppy/riscv/nuttx/libs/libc/modlib/gnu-elf.ld \
  -e __start \
  -Bstatic \
  -T/Users/luppy/riscv/apps/import/scripts/gnu-elf.ld  \
  -L/Users/luppy/riscv/apps/import/libs \
  -L "/Users/luppy/xpack-riscv-none-elf-gcc-13.2.0-2/bin/../lib/gcc/riscv-none-elf/13.2.0/rv64imafdc_zicsr/lp64d" /Users/luppy/riscv/apps/import/startup/crt0.o  hello_main.c.Users.luppy.riscv.apps.examples.hello.o \
  --start-group \
  -lmm \
  -lc \
  -lproxies \
  -lgcc /Users/luppy/riscv/apps/libapps.a /Users/luppy/xpack-riscv-none-elf-gcc-13.2.0-2/bin/../lib/gcc/riscv-none-elf/13.2.0/rv64imafdc_zicsr/lp64d/libgcc.a \
  --end-group \
  -o  /Users/luppy/riscv/apps/bin/hello
âžœ  hello git:(uname) $ ls -l /Users/luppy/riscv/apps/bin/hello
-rwxr-xr-x  1 luppy  staff  170928 Jan 13 11:35 /Users/luppy/riscv/apps/bin/hello
âžœ  hello git:(uname) $ 
cd nuttx
  riscv-none-elf-objdump \
    --syms --source --reloc --demangle --line-numbers --wide \
    --debugging \
    ../apps/bin/hello \
    >hello.S \
    2>&1

/Users/luppy/riscv/nuttx/hello.S
https://gist.github.com/lupyuen/f65565ba2fd825ae4226d2aee8a63c94

https://gist.github.com/lupyuen/877498cf437618b3b70ba57e59860cfe#file-hello-s-L356-L430

00000000c00000ba <uname>:
uname():
/Users/luppy/riscv/nuttx/libs/libc/misc/lib_utsname.c:95
 *   Otherwise, -1 will be returned and errno set to indicate the error.
 *
 ****************************************************************************/

int uname(FAR struct utsname *name)
{
    c00000ba:	1101                	add	sp,sp,-32
/Users/luppy/riscv/nuttx/libs/libc/misc/lib_utsname.c:100
  int ret = 0;

  /* Copy the strings.  Assure that each is NUL terminated. */

  strlcpy(name->sysname, "NuttX", sizeof(name->sysname));
    c00000bc:	4655                	li	a2,21
    c00000be:	00002597          	auipc	a1,0x2
    c00000c2:	c5a58593          	add	a1,a1,-934 # c0001d18 <_einit+0x74>
/Users/luppy/riscv/nuttx/libs/libc/misc/lib_utsname.c:95
{
    c00000c6:	ec06                	sd	ra,24(sp)
    c00000c8:	e822                	sd	s0,16(sp)
    c00000ca:	e426                	sd	s1,8(sp)
    c00000cc:	842a                	mv	s0,a0
/Users/luppy/riscv/nuttx/libs/libc/misc/lib_utsname.c:100
  strlcpy(name->sysname, "NuttX", sizeof(name->sysname));
    c00000ce:	5ee000ef          	jal	c00006bc <strlcpy>
/Users/luppy/riscv/nuttx/libs/libc/misc/lib_utsname.c:104

  /* Get the hostname */

  ret = gethostname(name->nodename, HOST_NAME_MAX);
    c00000d2:	02000593          	li	a1,32
    c00000d6:	01540513          	add	a0,s0,21
    c00000da:	30b010ef          	jal	c0001be4 <gethostname>
    c00000de:	84aa                	mv	s1,a0
/Users/luppy/riscv/nuttx/libs/libc/misc/lib_utsname.c:105
  name->nodename[HOST_NAME_MAX - 1] = '\0';
    c00000e0:	02040a23          	sb	zero,52(s0)
/Users/luppy/riscv/nuttx/libs/libc/misc/lib_utsname.c:107

  strlcpy(name->release,  CONFIG_VERSION_STRING, sizeof(name->release));
    c00000e4:	4655                	li	a2,21
    c00000e6:	00002597          	auipc	a1,0x2
    c00000ea:	c3a58593          	add	a1,a1,-966 # c0001d20 <_einit+0x7c>
    c00000ee:	03540513          	add	a0,s0,53
    c00000f2:	5ca000ef          	jal	c00006bc <strlcpy>
/Users/luppy/riscv/nuttx/libs/libc/misc/lib_utsname.c:109

  _info("From _info: g_version=%s\n", g_version); //// TODO
    c00000f6:	00100697          	auipc	a3,0x100
    c00000fa:	10a68693          	add	a3,a3,266 # c0100200 <g_version>
    c00000fe:	00002617          	auipc	a2,0x2
    c0000102:	e0260613          	add	a2,a2,-510 # c0001f00 <__FUNCTION__.0>
    c0000106:	00002597          	auipc	a1,0x2
    c000010a:	c2258593          	add	a1,a1,-990 # c0001d28 <_einit+0x84>
    c000010e:	4519                	li	a0,6
    c0000110:	62c000ef          	jal	c000073c <syslog>
/Users/luppy/riscv/nuttx/libs/libc/misc/lib_utsname.c:110
  printf("From printf: g_version=%s\n", g_version); //// TODO
    c0000114:	00100597          	auipc	a1,0x100
    c0000118:	0ec58593          	add	a1,a1,236 # c0100200 <g_version>
    c000011c:	00002517          	auipc	a0,0x2
    c0000120:	c2c50513          	add	a0,a0,-980 # c0001d48 <_einit+0xa4>
    c0000124:	036000ef          	jal	c000015a <printf>
/Users/luppy/riscv/nuttx/libs/libc/misc/lib_utsname.c:111
  strlcpy(name->version,  g_version, sizeof(name->version));
    c0000128:	03300613          	li	a2,51
    c000012c:	00100597          	auipc	a1,0x100
    c0000130:	0d458593          	add	a1,a1,212 # c0100200 <g_version>
    c0000134:	04a40513          	add	a0,s0,74
    c0000138:	584000ef          	jal	c00006bc <strlcpy>
/Users/luppy/riscv/nuttx/libs/libc/misc/lib_utsname.c:113


  nuttx git:(uname) âœ— $ make distclean
âžœ  nuttx git:(uname) âœ— $ tools/configure.sh milkv_duos:nsh
make
relink hello
  riscv-none-elf-objdump \
    --syms --source --reloc --demangle --line-numbers --wide \
    --debugging \
    ../apps/bin/hello \
    >hello.S \
    2>&1

hello-sg2000.S:
https://gist.github.com/lupyuen/910061a54afeddc875ae3b227ab18f0f

Static Variables don't seem to work correctly for rv-virt:knsh64, wonder if there's a problem with the Linking of Static Vars?
https://github.com/apache/nuttx/pull/15444#issuecomment-2586160111

Why this PR?
Because uname was working before:
https://gist.github.com/lupyuen/489af50d987c94e2cda54d927a8ea4f3#file-special-qemu-riscv-knsh64-log-L1398-L1399

# What's Next

Next Article: Why __Sync-Build-Ingest__ is super important for NuttX CI. And how we monitor it with our __Magic Disco Light__.

After That: Since we can __Rewind NuttX Builds__ and automatically __Git Bisect__... Can we create a Bot that will fetch the __Failed Builds from NuttX Dashboard__, identify the Breaking PR, and escalate to the right folks?

Many Thanks to the awesome __NuttX Admins__ and __NuttX Devs__! And [__My Sponsors__](https://lupyuen.github.io/articles/sponsor), for sticking with me all these years.

- [__Sponsor me a coffee__](https://lupyuen.github.io/articles/sponsor)

- [__My Current Project: "Apache NuttX RTOS for Sophgo SG2000"__](https://nuttx-forge.org/lupyuen/nuttx-sg2000)

- [__My Other Project: "NuttX for Ox64 BL808"__](https://nuttx-forge.org/lupyuen/nuttx-ox64)

- [__Older Project: "NuttX for Star64 JH7110"__](https://nuttx-forge.org/lupyuen/nuttx-star64)

- [__Olderer Project: "NuttX for PinePhone"__](https://nuttx-forge.org/lupyuen/pinephone-nuttx)

- [__Check out my articles__](https://lupyuen.github.io)

- [__RSS Feed__](https://lupyuen.github.io/rss.xml)

_Got a question, comment or suggestion? Create an Issue or submit a Pull Request here..._

[__lupyuen.org/src/uname.md__](https://codeberg.org/lupyuen/lupyuen.org/src/branch/master/src/uname.md)
