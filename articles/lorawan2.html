<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>LoRaWAN on PineDio Stack BL604 RISC-V Board</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="LoRaWAN on PineDio Stack BL604 RISC-V Board" 
    data-rh="true">
<meta property="og:description" 
    content="How we test LoRaWAN on PineDio Stack BL604 RISC-V Board"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/lorawan2-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">LoRaWAN on PineDio Stack BL604 RISC-V Board</h1>
    <nav id="TOC"><ul>
<li><a href="#lora-sx1262-transceiver">1 LoRa SX1262 Transceiver</a><ul></ul></li>
<li><a href="#lorawan-firmware">2 LoRaWAN Firmware</a><ul>
<li><a href="#deselect-spi-peripherals">2.1 Deselect SPI Peripherals</a><ul></ul></li>
<li><a href="#swap-spi-pins">2.2 Swap SPI Pins</a><ul></ul></li></ul></li>
<li><a href="#run-the-firmware">3 Run The Firmware</a><ul>
<li><a href="#lorawan-commands">3.1 LoRaWAN Commands</a><ul></ul></li></ul></li>
<li><a href="#lorawan-gateway">4 LoRaWAN Gateway</a><ul></ul></li>
<li><a href="#logic-analyser">5 Logic Analyser</a><ul></ul></li>
<li><a href="#spectrum-analyser">6 Spectrum Analyser</a><ul></ul></li>
<li><a href="#security">7 Security</a><ul>
<li><a href="#cryptographic-co-processor">7.1 Cryptographic Co-Processor</a><ul></ul></li>
<li><a href="#lorawan-alternatives">7.2 LoRaWAN Alternatives</a><ul></ul></li></ul></li>
<li><a href="#seeking-volunteers">8 Seeking Volunteers!</a><ul></ul></li>
<li><a href="#whats-next">9 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">10 Notes</a><ul></ul></li></ul></nav><p><img src="https://lupyuen.github.io/images/lorawan2-title.jpg" alt="Tiny tasty treat‚Ä¶ PineDio Stack BL604 RISC-V Board" /></p>
<p><em>Tiny tasty treat‚Ä¶ PineDio Stack BL604 RISC-V Board</em></p>
<p>üìù <em>19 Sep 2021</em></p>
<p>Previously I wrote about testing the prototype <strong>PineDio Stack BL604</strong> RISC-V Board‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/pinedio"><strong>‚ÄúPineDio Stack BL604 RISC-V Board: Testing The Prototype‚Äù</strong></a></li>
</ul>
<p>Today we dive into the most exciting component on PineDio Stack: <strong>Semtech SX1262 Transceiver</strong> for <strong>LoRa and LoRaWAN Networking</strong>.</p>
<p><em>Why LoRa?</em></p>
<p>LoRa is a <strong>Low-Power, Long-Range, Low-Bandwidth</strong> wireless network.</p>
<p>LoRa is perfect for <strong>IoT Sensor Devices</strong> that run on Battery Power. (Or Solar Power)</p>
<p>Since PineDio Stack comes with a <a href="https://lupyuen.github.io/articles/pinedio"><strong>Solar Panel</strong></a>, it will work really well for Agriculture Sensors.</p>
<p>(And many other IoT gadgets out there in the sun)</p>
<p><em>Will LoRa support all kinds of messages?</em></p>
<p>Not quite. LoRa only supports <strong>Short Messages</strong> of up to <a href="https://lora-developers.semtech.com/documentation/tech-papers-and-guides/lora-and-lorawan"><strong>242 Bytes</strong></a>.</p>
<p>And because LoRa is a Low Power (best effort) network, <strong>messages may get dropped.</strong></p>
<p>Which is probably OK for sensor devices that send data periodically.</p>
<p>(But not for texting your friends)</p>
<p><em>Is LoRa secure?</em></p>
<p>LoRa messages are delivered securely when we join a <strong>LoRaWAN Network</strong>.</p>
<p>Though our <strong>Security Keys</strong> would also need to be <strong>stored securely</strong> on PineDio Stack.</p>
<p>(We‚Äôll learn how in a while)</p>
<p><em>Which Pine64 devices will talk LoRa and LoRaWAN?</em></p>
<p>Once the drivers are implemented, these Pine64 devices will talk LoRa and LoRaWAN to PineDio Stack‚Ä¶</p>
<ul>
<li>
<p><a href="https://wiki.pine64.org/wiki/Pinedio"><strong>PineDio LoRa Gateway</strong></a></p>
</li>
<li>
<p><a href="https://wiki.pine64.org/wiki/Pinedio#Pinephone_backplate"><strong>PinePhone with LoRa Backplate</strong></a></p>
</li>
<li>
<p><a href="https://wiki.pine64.org/wiki/Pinedio#USB_adapter"><strong>Pine64 LoRa USB Adapter</strong></a></p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/lorawan2-pine64.jpg" alt="PineDio Gateway, PinePhone Backplate and USB Adapter" /></p>
<p>This article describes the (pre-production) <strong>PineDio Stack Prototype</strong> thus‚Ä¶</p>
<blockquote>
<p>‚ö†Ô∏è <em><strong>Obligatory Disclaimer:</strong> Features included in The Prototype are not complete, and will most certainly undergo changes before becoming available for public consumption. (Burp) They are described here for testing, exploration, education and entertainment purposes only. The Prototype shall NOT be used in production gadgets. (Like toasters, microwave ovens, and most definitely not, pressure cookers)</em></p>
</blockquote>
<p><img src="https://lupyuen.github.io/images/lorawan2-board.jpg" alt="LoRa SX1262 Transceiver on PineDio Stack BL604" /></p>
<p><a href="https://electronics.stackexchange.com/questions/335912/can-i-break-a-radio-tranceiving-device-by-operating-it-with-no-antenna-connected"><strong>CAUTION</strong>: Always connect the Antenna before Powering On‚Ä¶ Or the LoRa Transceiver may get damaged! See this</a></p>
<h1 id="lora-sx1262-transceiver" class="section-header"><a href="#lora-sx1262-transceiver">1 LoRa SX1262 Transceiver</a></h1>
<p>According to the PineDio Stack Schematic‚Ä¶</p>
<ul>
<li><a href="https://wiki.pine64.org/wiki/Pinedio#PineDio_Stack"><strong>PineDio Stack Schematic (Prototype)</strong></a></li>
</ul>
<p>Our <strong>LoRa SX1262 Transceiver</strong> is wired onboard like so‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/pinedio-lora.png" alt="LoRa SX1262 Transceiver wired to PineDio Stack BL604" /></p>
<p>Note that the above SPI Pins are shared with the <strong>SPI Flash and ST7789 Display</strong>‚Ä¶</p>
<table><thead><tr><th align="center">GPIO Number</th><th align="left">SPI Pin</th></tr></thead><tbody>
<tr><td align="center"><strong><code>17</code></strong></td><td align="left">Common SDO <em>(MOSI)</em></td></tr>
<tr><td align="center"><strong><code>0</code></strong></td><td align="left">Common SDI <em>(MISO)</em></td></tr>
<tr><td align="center"><strong><code>11</code></strong></td><td align="left">Common SCK</td></tr>
<tr><td align="center"><strong><code>14</code></strong></td><td align="left">CS for SPI Flash</td></tr>
<tr><td align="center"><strong><code>20</code></strong></td><td align="left">CS for ST7789</td></tr>
<tr><td align="center"><strong><code>15</code></strong></td><td align="left">CS for SX1262</td></tr>
</tbody></table>
<p><a href="https://www.oshwa.org/a-resolution-to-redefine-spi-signal-names">(More about SDO and SDI)</a></p>
<p>We set the <strong>Chip Select Pin (CS)</strong> to Low to select the <strong>Active SPI Device</strong>: Either LoRa SX1262, SPI Flash or ST7789 Display‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/pinedio-spi.jpg" alt="SPI Bus on PineDio Stack" /></p>
<p>To test the LoRa SX1262 Transceiver, we define the <strong>GPIO Pin Numbers</strong> like so: <a href="https://github.com/lupyuen/bl_iot_sdk/blob/pinedio/components/3rdparty/lora-sx1262/include/sx126x-board.h#L36-L50">lora-sx1262/sx126x-board.h</a></p>
<div class="example-wrap"><pre class="language-c">//  Below are the pin numbers for PineDio Stack BL604 with onboard SX1262.
#define SX126X_SPI_IDX           0  //  SPI Port 0
#define SX126X_SPI_SDI_PIN       0  //  SPI Serial Data In Pin  (formerly MISO)
#define SX126X_SPI_SDO_PIN      17  //  SPI Serial Data Out Pin (formerly MOSI)
#define SX126X_SPI_CLK_PIN      11  //  SPI Clock Pin
#define SX126X_SPI_CS_PIN       15  //  SPI Chip Select Pin
#define SX126X_SPI_CS_OLD        8  //  Unused SPI Chip Select Pin
#define SX126X_NRESET           18  //  Reset Pin
#define SX126X_DIO1             19  //  DIO1
#define SX126X_BUSY_PIN         10  //  Busy Pin
#define SX126X_DEBUG_CS_PIN      5  //  Debug Chip Select Pin, mirrors the High / Low State of SX1262 Chip Select Pin. Set to -1 if not needed.
#define SX126X_TCXO_WAKEUP_TIME  5  //  Time required for the TCXO to wakeup (milliseconds)
#define SX126X_SPI_BAUDRATE  (200 * 1000)  //  SPI Frequency (200 kHz)</pre></div>
<p>(<code>SX126X_DEBUG_CS_PIN</code> should be set to <code>-1</code> if we‚Äôre not debugging. More about the Debug CS Pin later)</p>
<p>We define the <strong>Chip Select Pins</strong> for SPI Flash and ST7789 Display as well: <a href="https://github.com/lupyuen/bl_iot_sdk/blob/pinedio/customer_app/pinedio_lorawan/pinedio_lorawan/demo.c#L101-L105">pinedio_lorawan/demo.c</a></p>
<div class="example-wrap"><pre class="language-c">/// GPIO for SPI Flash Chip Select Pin. We must set this to High to deselect SPI Flash.
#define FLASH_CS_PIN     14

/// GPIO for ST7789 SPI Chip Select Pin. We must set this to High to deselect ST7789 Display.
#define DISPLAY_CS_PIN   20</pre></div><h1 id="lorawan-firmware" class="section-header"><a href="#lorawan-firmware">2 LoRaWAN Firmware</a></h1>
<p>To test LoRaWAN on PineDio Stack we shall run this <strong>LoRaWAN Firmware</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/bl_iot_sdk/tree/pinedio/customer_app/pinedio_lorawan"><strong><code>pinedio_lorawan</code> Firmware</strong></a></li>
</ul>
<p>Which calls the following <strong>LoRaWAN and SX1262 Drivers</strong>‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/bl_iot_sdk/tree/pinedio/components/3rdparty/lorawan"><strong><code>lorawan</code> Driver</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/bl_iot_sdk/tree/pinedio/components/3rdparty/lora-sx1262"><strong><code>lora-sx1262</code> Driver</strong></a></p>
</li>
</ul>
<p>The firmware and drivers were previously ported from Apache Mynewt operating system to BL602 and BL604‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/lorawan"><strong>‚ÄúPineCone BL602 Talks LoRaWAN‚Äù</strong></a></li>
</ul>
<p>Here are the changes we made for PineDio Stack.</p>
<h2 id="deselect-spi-peripherals" class="section-header"><a href="#deselect-spi-peripherals">2.1 Deselect SPI Peripherals</a></h2>
<p>While testing LoRaWAN (and LoRa SX1262), we need to <strong>deselect all other SPI Peripherals</strong> (SPI Flash and ST7789 Display).</p>
<p>From <a href="https://github.com/lupyuen/bl_iot_sdk/blob/pinedio/customer_app/pinedio_lorawan/pinedio_lorawan/demo.c#L107-L130">pinedio_lorawan/demo.c</a> ‚Ä¶</p>
<div class="example-wrap"><pre class="language-c">/// Set Chip Select pins to High, to deselect SX1262, SPI Flash and ST7789
int deselect_spi(void) {
  //  Configure Chip Select pins as GPIO Output Pins (instead of GPIO Input)
  int rc;
  rc = bl_gpio_enable_output(FLASH_CS_PIN,      0, 0);  assert(rc == 0);
  rc = bl_gpio_enable_output(DISPLAY_CS_PIN,    0, 0);  assert(rc == 0);
  rc = bl_gpio_enable_output(SX126X_SPI_CS_PIN, 0, 0);  assert(rc == 0);
  if (SX126X_DEBUG_CS_PIN &gt;= 0) {  //  Mirror SX126X_SPI_CS_PIN
    rc = bl_gpio_enable_output(SX126X_DEBUG_CS_PIN, 0, 0);  assert(rc == 0);
  }</pre></div>
<p>First we <strong>configure the Chip Select Pins</strong> for GPIO Output.</p>
<p>Then we set the <strong>Chip Select Pins to High</strong>, to deselect the SPI Peripherals‚Ä¶</p>
<div class="example-wrap"><pre class="language-c">  //  Set Chip Select pins to High, to deselect SX1262, SPI Flash and ST7789
  rc = bl_gpio_output_set(FLASH_CS_PIN,      1);  assert(rc == 0);
  rc = bl_gpio_output_set(DISPLAY_CS_PIN,    1);  assert(rc == 0);
  rc = bl_gpio_output_set(SX126X_SPI_CS_PIN, 1);  assert(rc == 0);
  if (SX126X_DEBUG_CS_PIN &gt;= 0) {  //  Mirror SX126X_SPI_CS_PIN
    rc = bl_gpio_output_set(SX126X_DEBUG_CS_PIN, 1);  assert(rc == 0);
  }
  return 0;
}</pre></div>
<p>(More about <code>SX126X_DEBUG_CS_PIN</code> when we talk about the Logic Analyser)</p>
<p>This function is called by the <a href="https://github.com/lupyuen/bl_iot_sdk/blob/pinedio/customer_app/pinedio_lorawan/pinedio_lorawan/lorawan.c#L167-L173"><strong><code>init_lorawan</code> Command</strong></a>, which we‚Äôll run in a while‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/lorawan2-deselect.png" alt="Deselect SPI Peripherals" /></p>
<p><a href="https://github.com/lupyuen/bl_iot_sdk/blob/pinedio/customer_app/pinedio_lorawan/pinedio_lorawan/lorawan.c#L167-L173">(Source)</a></p>
<h2 id="swap-spi-pins" class="section-header"><a href="#swap-spi-pins">2.2 Swap SPI Pins</a></h2>
<p>Due to a quirk in the SPI implementation on BL602 and BL604, we need to <strong>swap the SPI Pins</strong> for SDI <em>(formerly MISO)</em> and SDO <em>(formerly MOSI)</em>.</p>
<p>We do this by calling <strong>GLB_Swap_SPI_0_MOSI_With_MISO</strong> in <a href="https://github.com/lupyuen/bl_iot_sdk/blob/pinedio/components/3rdparty/lora-sx1262/src/sx126x-board.c#L168-L202">lora-sx1262/sx126x-board.c</a> ‚Ä¶</p>
<div class="example-wrap"><pre class="language-c">/// Initialise GPIO Pins and SPI Port. Called by SX126xIoIrqInit.
void SX126xIoInit( void ) {
  //  Configure the pins for GPIO Input / Output
  GpioInitOutput( SX126X_SPI_CS_PIN, 1 );
  GpioInitInput( SX126X_BUSY_PIN, 0, 0 );
  GpioInitInput( SX126X_DIO1, 0, 0 );
  if (SX126X_DEBUG_CS_PIN &gt;= 0) { GpioInitOutput( SX126X_DEBUG_CS_PIN, 1 ); }

  //  Note: We must swap SDI (MISO) and SDO (MOSI)
  //  to comply with the SPI Pin Definitions in 
  //  BL602 / BL604 Reference Manual
  int rc = GLB_Swap_SPI_0_MOSI_With_MISO(ENABLE);  assert(rc == 0);</pre></div>
<p><a href="https://lupyuen.github.io/articles/pinedio#spi-pins-are-swapped">(More about swapping SPI Pins)</a></p>
<p>After swapping the SPI Pins we may <strong>initialise the SPI Port</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-c">  //  Configure the SPI Port
  rc = spi_init(
    &amp;spi_device,     //  SPI Device
    SX126X_SPI_IDX,  //  SPI Port
    0,               //  SPI Mode: 0 for Controller
    //  TODO: Due to a quirk in BL602 SPI, we must set
    //  SPI Polarity-Phase to 1 (CPOL=0, CPHA=1).
    //  But actually Polarity-Phase for SX126X should be 0 (CPOL=0, CPHA=0). 
    1,                    //  SPI Polarity-Phase
    SX126X_SPI_BAUDRATE,  //  SPI Frequency
    2,                    //  Transmit DMA Channel
    3,                    //  Receive DMA Channel
    SX126X_SPI_CLK_PIN,   //  SPI Clock Pin 
    SX126X_SPI_CS_OLD,    //  Unused SPI Chip Select Pin
    SX126X_SPI_SDO_PIN,   //  SPI Serial Data Out Pin (formerly MOSI)
    SX126X_SPI_SDI_PIN    //  SPI Serial Data In Pin  (formerly MISO)
  );
  assert(rc == 0);
}</pre></div>
<p>Note that the <strong>SPI Polarity-Phase should be 1</strong> and not 0.</p>
<p>This seems to be another quirk of the SPI implementation on BL602 and BL604‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/spi#spi-phase-looks-sus"><strong>‚ÄúSPI Phase looks sus‚Äù</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/lorawan2-swap.png" alt="Swap SPI Pins and tweak the SPI Polarity-Phase" /></p>
<p><a href="https://github.com/lupyuen/bl_iot_sdk/blob/pinedio/components/3rdparty/lora-sx1262/src/sx126x-board.c#L168-L202">(Source)</a></p>
<h1 id="run-the-firmware" class="section-header"><a href="#run-the-firmware">3 Run The Firmware</a></h1>
<p>We <strong>build and flash the LoRaWAN Firmware</strong> to PineDio Stack with these steps‚Ä¶</p>
<ol>
<li>
<p><a href="https://lupyuen.github.io/articles/pinedio#bl604-blinky"><strong>‚ÄúBL604 Blinky (Build the Firmware)‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/pinedio#flash-firmware-to-bl604"><strong>‚ÄúFlash Firmware To BL604‚Äù</strong></a></p>
</li>
</ol>
<p>And these modifications‚Ä¶</p>
<ul>
<li>
<p>Change the branch <strong><code>3wire</code></strong> to <strong><code>pinedio</code></strong></p>
</li>
<li>
<p>Change the firmware <strong><code>pinedio_blinky</code></strong> to <strong><code>pinedio_lorawan</code></strong></p>
</li>
</ul>
<p>Now we run the <strong>LoRaWAN commands</strong> to‚Ä¶</p>
<ol>
<li>
<p><strong>Join a LoRaWAN Network</strong></p>
<p>(Because we‚Äôll transmit data securely over LoRa)</p>
</li>
<li>
<p><strong>Send a Data Packet</strong> to the network</p>
<p>(So that the packet appears in our LoRaWAN Gateway)</p>
</li>
</ol>
<p>We‚Äôll talk to the <strong>ChirpStack LoRaWAN Gateway</strong> that we have installed here‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/wisgate"><strong>‚ÄúBuild a LoRaWAN Network with RAKwireless WisGate Developer Gateway‚Äù</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/lorawan2-commands.png" alt="LoRaWAN Commands" /></p>
<p><a href="https://github.com/lupyuen/bl_iot_sdk/tree/pinedio/customer_app/pinedio_lorawan#lorawan-commands">(Source)</a></p>
<h2 id="lorawan-commands" class="section-header"><a href="#lorawan-commands">3.1 LoRaWAN Commands</a></h2>
<p>At the BL604 Command Prompt, enter these <strong>LoRaWAN Commands</strong>‚Ä¶</p>
<ol>
<li>
<p>First we start the <strong>Background Task</strong> that will handle LoRa packets‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash">create_task</pre></div></li>
<li>
<p>Next we initialise the <strong>LoRa SX1262 and LoRaWAN Drivers</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash">init_lorawan</pre></div></li>
<li>
<p>We set the <strong>Device EUI</strong> (Extended Unique Identifier)‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash">las_wr_dev_eui 0x4b:0xc1:0x5e:0xe7:0x37:0x7b:0xb1:0x5b</pre></div>
<p>Change the above EUI to the one in our ChirpStack Gateway: <code>Applications ‚Üí app ‚Üí Device EUI</code></p>
</li>
<li>
<p>Set the <strong>App EUI</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash">las_wr_app_eui 0x00:0x00:0x00:0x00:0x00:0x00:0x00:0x00</pre></div>
<p>This is not needed for ChirpStack, thus we set to default <code>0000000000000000</code>.</p>
</li>
<li>
<p>Set the <strong>App Key</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash">las_wr_app_key 0xaa:0xff:0xad:0x5c:0x7e:0x87:0xf6:0x4d:0xe3:0xf0:0x87:0x32:0xfc:0x1d:0xd2:0x5d</pre></div>
<p>We get the App Key from ChirpStack at <code>Applications ‚Üí app ‚Üí Devices ‚Üí device_otaa_class_a ‚Üí Keys (OTAA) ‚Üí Application Key</code></p>
</li>
<li>
<p>We send a request to <strong>join the LoRaWAN Network</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash">las_join 3</pre></div>
<p>(Retry up to 3 times)</p>
</li>
<li>
<p>After the ChirpStack LoRaWAN Gateway has accepted our Join Request, we open a <strong>LoRaWAN Application Port</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash">las_app_port open 2</pre></div>
<p>(2 is the Application Port Number)</p>
</li>
<li>
<p>Finally we <strong>send a LoRaWAN Data Packet</strong> containing 5 bytes of data (<code>0x00</code>) to LoRaWAN Port 2‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash">las_app_tx 2 5 0</pre></div>
<p>(0 means that this is an Unconfirmed Message, we‚Äôre not expecting an acknowledgement from the LoRaWAN Gateway)</p>
</li>
</ol>
<p>We should see this in our PineDio Stack serial terminal‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/lupyuen/bl_iot_sdk/tree/pinedio/customer_app/pinedio_lorawan#output-log"><strong>Output Log for LoRaWAN Firmware</strong></a></p>
</li>
<li>
<p><a href="https://www.youtube.com/watch?v=BMMIIiZG6G0"><strong>Watch the Demo Video on YouTube</strong></a></p>
</li>
</ul>
<p>Let‚Äôs check our ChirpStack LoRaWAN Gateway!</p>
<p><a href="https://lupyuen.github.io/articles/lorawan#lorawan-driver">(More about the LoRaWAN Commands)</a></p>
<p><img src="https://lupyuen.github.io/images/lorawan2-joinsend.png" alt="LoRaWAN Firmware" /></p>
<h1 id="lorawan-gateway" class="section-header"><a href="#lorawan-gateway">4 LoRaWAN Gateway</a></h1>
<p>To see the <strong>Join Network Request</strong> and the <strong>Data Packet</strong> received by our ChirpStack LoRaWAN Gateway, we do this‚Ä¶ </p>
<ol>
<li>
<p>In ChirpStack, click <strong><code>Applications ‚Üí app ‚Üí device_otaa_class_a ‚Üí LoRaWAN Frames</code></strong></p>
</li>
<li>
<p>Restart PineDio Stack.</p>
<p>Run the LoRaWAN Commands from the previous section.</p>
</li>
<li>
<p>The <strong>Join Network Request</strong> appears in ChirpStack, followed by the <strong>Data Packet</strong>‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/lorawan2-chirpstack.png" alt="Join Network Request and Data Packet in ChirpStack" /></p>
</li>
<li>
<p>Click the <strong><code>Device Data</code></strong> tab in ChirpStack.</p>
</li>
<li>
<p>On PineDio Stack, run this command to send a Data Packet‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash">las_app_tx 2 5 0</pre></div></li>
<li>
<p>Our Data Packet appears in ChirpStack.</p>
<p><strong><code>DecodedDataHex</code></strong> shows 5 bytes of zero, which is what we sent‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/lorawan2-chirpstack2.png" alt="Data Packet in ChirpStack" /></p>
</li>
</ol>
<p>LoRaWAN tested OK on PineDio Stack!</p>
<p>Let‚Äôs take a peek inside our LoRa SX1262 Transceiver‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/pinedio-logic.jpg" alt="PineDio Stack with Logic Analyser" /></p>
<h1 id="logic-analyser" class="section-header"><a href="#logic-analyser">5 Logic Analyser</a></h1>
<p><em>How did we find out that the SPI Pins need to be swapped?</em></p>
<p><em>And the tweaking for SPI Polarity-Phase?</em></p>
<p>A <strong>Logic Analyser</strong> is super helpful for troubleshooting SPI and other interfacing problems on prototype hardware. (Pic above)</p>
<p>PineDio Stack‚Äôs <strong>GPIO Connector</strong> exposes the SPI Pins: SDO <em>(formerly MOSI)</em>, SDI <em>(formerly MISO)</em> and SCK‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/pinedio-gpio2.jpg" alt="PineDio Stack GPIO Connector" /></p>
<p>We <strong>connect our Logic Analyser</strong> to the GPIO Connector like so‚Ä¶</p>
<table><thead><tr><th align="center">GPIO Number</th><th align="left">SPI Pin</th><th align="center">Connector Pin</th></tr></thead><tbody>
<tr><td align="center"><strong><code>17</code></strong></td><td align="left">Common SDO <em>(MOSI)</em></td><td align="center"><code>7</code></td></tr>
<tr><td align="center"><strong><code>0</code></strong></td><td align="left">Common SDI <em>(MISO)</em></td><td align="center"><code>17</code></td></tr>
<tr><td align="center"><strong><code>11</code></strong></td><td align="left">Common SCK</td><td align="center"><code>4</code></td></tr>
<tr><td align="center"><strong><code>5</code></strong></td><td align="left">Debug CS</td><td align="center"><code>2</code></td></tr>
</tbody></table>
<p><img src="https://lupyuen.github.io/images/pinedio-logic2.jpg" alt="Logic Analyser connected to PineDio Stack" /></p>
<p><em>What about the SX1262 Chip Select Pin: GPIO 15?</em></p>
<p>Unfortunately <strong>GPIO 15 is not exposed</strong> on the GPIO Connector.</p>
<p>Hence we designate GPIO 5 as the <strong>Debug CS Pin</strong> that mirrors the GPIO High / Low state of GPIO 15. <a href="https://github.com/lupyuen/bl_iot_sdk/commit/91f7e751594066d4b97fc5d351c46e74ccded00e#diff-f571fdf8eada0589c0db580e990078fa53eeaf373b8eb7bd738363f16f9954ad">(Here‚Äôs how)</a></p>
<p>Then we simply connect our Logic Analyser to <strong>GPIO 5 as the Chip Select Pin.</strong> (Pic above)</p>
<p>Our Logic Analyser shows that BL604 is indeed talking correctly to SX1262 over SPI‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/lorawan2-logic.png" alt="LoRa SX1262 with Logic Analyser" /></p>
<h1 id="spectrum-analyser" class="section-header"><a href="#spectrum-analyser">6 Spectrum Analyser</a></h1>
<p>We‚Äôve used a Logic Analyser to sniff the data inside our LoRa Transceiver. Now we use a <strong>Spectrum Analyser</strong> to sniff the data in the airwaves!</p>
<p>Our Spectrum Analyser is the <strong>Airspy R2 Software Defined Radio</strong>, which will sniff a range of radio frequences‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/lorawan2-airspy.jpg" alt="Airspy R2 SDR with PineDio Stack" /></p>
<p>When we analyse the radio spectrum (with <strong>Cubic SDR</strong>), we see this healthy <strong>radio signal</strong> produced by our LoRa Transceiver‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/pinedio-chirp2.jpg" alt="LoRa SX1262 visualised with SDR" /></p>
<p>This is known as a <strong>LoRa Chirp</strong>.</p>
<p>LoRa Packets have this unique shape so that the packets can be <strong>transmitted over long distances</strong> in spite of radio interference.</p>
<p><a href="https://lora-developers.semtech.com/documentation/tech-papers-and-guides/lora-and-lorawan">(Up to 5 kilometres in some urban areas!)</a></p>
<p>More about LoRa and Software Defined Radio here‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/lora#visualise-lora-with-software-defined-radio"><strong>‚ÄúVisualise LoRa with Software Defined Radio‚Äù</strong></a></li>
</ul>
<p>(The ‚Äúfireflies‚Äù look odd though. Are we transmitting with too much power?)</p>
<h1 id="security" class="section-header"><a href="#security">7 Security</a></h1>
<p><em>Since LoRa packets can be sniffed over the airwaves‚Ä¶</em></p>
<p><em>How do we transmit data securely over LoRa?</em></p>
<p>That‚Äôs why we join a <strong>LoRaWAN Network</strong> when we transmit data.</p>
<p>LoRaWAN is a layer on top of LoRa that adds <strong>security features</strong> like‚Ä¶</p>
<ul>
<li>
<p><strong>Message Encryption</strong></p>
<p>(Messages are encrypted with a 128-bit AES Key)</p>
</li>
<li>
<p><strong>Message Integrity Check</strong></p>
<p>(Prevents tampering and replay of messages)</p>
</li>
<li>
<p><strong>Message Routing</strong></p>
<p>(We relay messages through a trusted LoRaWAN Gateway, instead of peer-to-peer direct messaging)</p>
</li>
<li>
<p><strong>Message Throttling</strong></p>
<p>(Prevents flooding of messages)</p>
</li>
</ul>
<p>More about LoRaWAN Security here‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/wisgate#lorawan-security"><strong>‚ÄúLoRaWAN Security‚Äù</strong></a></li>
</ul>
<p><em>What‚Äôs the catch?</em></p>
<p>Well the <strong>LoRaWAN Security Keys</strong> would need to be <strong>stored and accessed securely</strong> on PineDio Stack.</p>
<p>We should never allow the Security Keys to be exposed.</p>
<p><em>Doesn‚Äôt BL604 securely store Security Keys in its <a href="https://lupyuen.github.io/articles/flash#efuse-configuration">Internal EFuse Storage</a>?</em></p>
<p>Yes. Though there have been past incidents (on other microcontrollers) where Security Keys in EFuse Storage have been compromised. <a href="https://limitedresults.com/2019/11/pwn-the-esp32-forever-flash-encryption-and-sec-boot-keys-extraction/">(See this)</a></p>
<h2 id="cryptographic-co-processor" class="section-header"><a href="#cryptographic-co-processor">7.1 Cryptographic Co-Processor</a></h2>
<p><em>Is there a better way to store and access Security Keys?</em></p>
<p>We could use a <strong>Cryptographic Co-Processor</strong> like this‚Ä¶</p>
<ul>
<li><a href="https://www.microchip.com/en-us/product/ATECC608A">Microchip ATECC608A</a></li>
</ul>
<p>ATECC608A works with <strong>The Things Network</strong>, the public worldwide LoRaWAN Network‚Ä¶</p>
<ul>
<li><a href="https://www.thethingsindustries.com/docs/devices/atecc608a/claim/">ATECC608A Secure Element on The Things Network</a></li>
</ul>
<p>It also works with <strong>Helium</strong>, another global LoRaWAN Network‚Ä¶</p>
<ul>
<li><a href="https://github.com/helium/ecc508">ATECC608A Library for Helium</a></li>
</ul>
<p>There are new dev boards with ATECC608 onboard‚Ä¶</p>
<ul>
<li><a href="https://www.cnx-software.com/2021/09/14/portenta-h7-lite-low-cost-arduino-pro-board/">Portenta H7 Lite with ATECC608</a></li>
</ul>
<p>This article explains how a microcontroller might connect to a secure network (like LoRaWAN) with ATECC608A‚Ä¶</p>
<ul>
<li><a href="https://books.google.com.sg/books?id=3F7XDwAAQBAJ&amp;pg=PA302&amp;lpg=PA302&amp;dq=ATECC608A&amp;source=bl&amp;ots=80tY23LkbA&amp;sig=ACfU3U2Ngp_Rao6FG1hpS2ays4O-vNEkCg&amp;hl=en&amp;sa=X&amp;ved=2ahUKEwi_19-4ovnyAhWXILcAHcpQDaY4MhDoAXoECBIQAw#v=onepage&amp;q=ATECC608A&amp;f=false">Internet of Things: A Confluence of Many Disciplines</a></li>
</ul>
<p><em>What‚Äôs the catch?</em></p>
<p>We need to be <strong>extra careful</strong> when working with Cryptographic Co-Processors‚Ä¶</p>
<p>Once the Security Keys have been injected, <strong>they can never be reset</strong>!</p>
<p>(Same for EFuse Storage)</p>
<h2 id="lorawan-alternatives" class="section-header"><a href="#lorawan-alternatives">7.2 LoRaWAN Alternatives</a></h2>
<p><em>Can we send LoRa messages securely‚Ä¶ Without LoRaWAN?</em></p>
<p>Traditional Peer-to-Peer Messaging Protocols (like XMPP and Matrix) won‚Äôt run on PineDio Stack with LoRa.</p>
<p>(Because of LoRa‚Äôs tiny lossy packets. And JSON over HTTPS is too heavy for BL604)</p>
<p>These newer <strong>Peer-to-Peer Messaging Protocols</strong> will probably work with PineDio Stack‚Ä¶</p>
<ul>
<li>
<p><a href="https://meshtastic.org/"><strong>Meshtastic</strong></a>: Data Mesh Network for LoRa</p>
</li>
<li>
<p><a href="https://hackaday.io/project/161491-qmesh-a-lora-based-voice-mesh-network"><strong>QMesh</strong></a>: Voice Mesh Network for LoRa</p>
</li>
</ul>
<p>There is an <strong>experimental Matrix protocol</strong> for IoT devices‚Ä¶</p>
<ul>
<li><a href="https://matrix.org/blog/2019/03/12/breaking-the-100-bps-barrier-with-matrix-meshsim-coap-proxy">Ultra Low Bandwidth Transport for Matrix (Experimental)</a></li>
</ul>
<p>Maybe we‚Äôll see messaging protocols based on Blockchain‚Ä¶</p>
<ul>
<li><a href="https://matheo.uliege.be/bitstream/2268.2/11657/12/thesis.pdf">‚ÄúDesigning a Community-Driven Decentralized Storage Network for IoT Data‚Äù</a></li>
</ul>
<p><em>How secure are they?</em></p>
<p>Sorry I haven‚Äôt reviewed their security features. Someday I might!</p>
<p><em>PineDio Stack supports triple comms: LoRa, WiFi AND Bluetooth LE‚Ä¶</em></p>
<p><em>What can we do with them?</em></p>
<p>Maybe we can turn PineDio Stack into a (very basic) <strong>Solar-Powered Gateway for LoRa + WiFi + Bluetooth LE</strong>?</p>
<p>That will <strong>relay LoRa and Bluetooth LE messages</strong> to the internet over WiFi?</p>
<p>Like for <strong>tracking our pets</strong>?</p>
<p>Or for connecting our <strong>PineTime watches</strong> to the internet?</p>
<p>Got any ideas? Lemme know!</p>
<h1 id="seeking-volunteers" class="section-header"><a href="#seeking-volunteers">8 Seeking Volunteers!</a></h1>
<p>I‚Äôm really excited that PineDio Stack BL604 will be available soon!</p>
<p>But in the meantime, JF and I have <strong>plenty to test on PineDio Stack</strong>‚Ä¶</p>
<ol>
<li>ST7789 Display <em>(SPI)</em></li>
<li>LoRa SX1262 <em>(SPI)</em></li>
<li>SPI Flash <em>(SPI)</em></li>
<li>Accelerometer <em>(I2C)</em></li>
<li>Heart Rate Sensor <em>(I2C)</em></li>
<li>Touch Panel <em>(I2C)</em></li>
<li>Vibrator <em>(GPIO)</em></li>
<li>Push Button <em>(GPIO)</em></li>
<li>WiFi</li>
<li>Bluetooth LE</li>
<li>JTAG Debugging</li>
<li>Battery Charging</li>
<li>Solar Power</li>
</ol>
<p><a href="https://twitter.com/MisterTechBlog"><strong>Please let us know</strong></a> if you‚Äôre keen to help! üôè</p>
<h1 id="whats-next" class="section-header"><a href="#whats-next">9 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>The Things Network</p>
<p>Sorry for griping‚Ä¶ But why doesn‚Äôt Singapore have decent coverage for The Things Network? üôÑ</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book">Read ‚ÄúThe RISC-V BL602 / BL604 Book‚Äù</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/lorawan2.md"><code>lupyuen.github.io/src/lorawan2.md</code></a></p>
<h1 id="notes" class="section-header"><a href="#notes">10 Notes</a></h1>
<ol>
<li>
<p>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1436128755987058691">this Twitter Thread</a></p>
</li>
<li>
<p>TODO: Sync with pine64</p>
</li>
</ol>

    
</body>
</html>