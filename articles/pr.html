<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Preparing a Pull Request for Apache NuttX RTOS</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Preparing a Pull Request for Apache NuttX RTOS" 
    data-rh="true">
<meta property="og:description" 
    content="Here are the steps to prepare a Pull Request for Apache NuttX RTOS"
    data-rh="true">
<meta name="description" 
    content="Here are the steps to prepare a Pull Request for Apache NuttX RTOS">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/pr-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Preparing a Pull Request for Apache NuttX RTOS</h1>
    <nav id="TOC"><ul>
<li><a href="#nuttx-repositories">1 NuttX Repositories</a><ul></ul></li>
<li><a href="#build-and-test">2 Build and Test</a><ul>
<li><a href="#regression-test">2.1 Regression Test</a><ul></ul></li>
<li><a href="#documentation">2.2 Documentation</a><ul></ul></li></ul></li>
<li><a href="#check-coding-style">3 Check Coding Style</a><ul></ul></li>
<li><a href="#write-the-pull-request">4 Write the Pull Request</a><ul>
<li><a href="#title">4.1 Title</a><ul></ul></li>
<li><a href="#summary">4.2 Summary</a><ul></ul></li>
<li><a href="#impact">4.3 Impact</a><ul></ul></li>
<li><a href="#testing">4.4 Testing</a><ul></ul></li></ul></li>
<li><a href="#squash-the-commits">5 Squash the Commits</a><ul></ul></li>
<li><a href="#meditate">6 Meditate</a><ul></ul></li>
<li><a href="#submit-the-pull-request">7 Submit the Pull Request</a><ul></ul></li>
<li><a href="#update-our-repositories">8 Update Our Repositories</a><ul></ul></li>
<li><a href="#whats-next">9 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">10 Notes</a><ul></ul></li>
<li><a href="#appendix-validate-nuttx-release">11 Appendix: Validate NuttX Release</a><ul></ul></li></ul></nav><p>üìù <em>28 Nov 2022</em></p>
<p><img src="https://lupyuen.github.io/images/pr-title.jpg" alt="Typical Pull Request for Apache NuttX RTOS" /></p>
<p>This article explains how I prepared my Pull Requests for submission to <a href="https://nuttx.apache.org/docs/latest/index.html"><strong>Apache NuttX RTOS</strong></a>. So if we‚Äôre contributing code to NuttX, just follow these steps and things will (probably) go Hunky Dory!</p>
<p>(Like the fish)</p>
<p>Before we begin, please swim over to the official <strong>Development Workflow</strong> for NuttX‚Ä¶</p>
<ul>
<li><a href="https://nuttx.apache.org/docs/latest/contributing/workflow.html"><strong>‚ÄúNuttX Development Workflow‚Äù</strong></a></li>
</ul>
<p>Ready? Let‚Äôs dive in! (Like the fish)</p>
<p><img src="https://lupyuen.github.io/images/pr-fork.png" alt="Create Fork" /></p>
<h1 id="nuttx-repositories"><a href="#nuttx-repositories">1 NuttX Repositories</a></h1>
<p>We begin by <strong>creating our forks</strong> for the <strong><code>nuttx</code></strong> and <strong><code>apps</code></strong> repositories‚Ä¶</p>
<ol>
<li>
<p>Browse to <strong>NuttX Repository</strong>‚Ä¶</p>
<p><a href="https://github.com/apache/nuttx"><strong>github.com/apache/nuttx</strong></a></p>
<p>Click ‚Äú<strong>Fork</strong>‚Äù to create our fork. (Pic above)</p>
<p>Click ‚Äú<strong>Actions</strong>‚Äù and enable workflows‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/pr-actions.png" alt="Enable Workflows" /></p>
<p>(This will check that our code compiles OK at every commit)</p>
</li>
<li>
<p>Do the same for the <strong>NuttX Apps Repository</strong>‚Ä¶</p>
<p><a href="https://github.com/apache/nuttx-apps"><strong>github.com/apache/nuttx-apps</strong></a></p>
<p>Click ‚Äú<strong>Fork</strong>‚Äù to create our fork.</p>
<p>Click ‚Äú<strong>Actions</strong>‚Äù and enable workflows.</p>
</li>
<li>
<p>As a principle, let‚Äôs keep our <strong><code>master</code></strong> branch <strong>always in sync</strong> with the NuttX Mainline <strong><code>master</code></strong> branch.</p>
<p>(This seems cleaner for <a href="https://lupyuen.github.io/articles/pr#update-our-repositories"><strong>syncing upstream updates</strong></a> into our repo)</p>
<p>Let‚Äôs <strong>create a branch</strong> to make our changes‚Ä¶</p>
</li>
<li>
<p>In our NuttX Repository, click <strong><code>master</code></strong>.</p>
<p>Enter the name of our new branch.</p>
<p>Click ‚Äú<strong>Create Branch</strong>‚Äù</p>
<p><img src="https://lupyuen.github.io/images/pr-branch.png" alt="Create Branch" /></p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/tree/gic">(I named my branch <strong><code>gic</code></strong> for Generic Interrupt Controller)</a></p>
</li>
<li>
<p>Do the same for our <strong>NuttX Apps Repository</strong></p>
<p>(Because we should sync <strong><code>nuttx</code></strong> and <strong><code>apps</code></strong> too)</p>
</li>
<li>
<p>Download the new branches of our <strong><code>nuttx</code></strong> and <strong><code>apps</code></strong> repositories‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Download the &quot;gic&quot; branch of &quot;lupyuen2/wip-pinephone-nuttx&quot;
## TODO: Change the branch name and repo URLs
mkdir nuttx
cd nuttx
git clone \
  --branch gic \
  https://github.com/lupyuen2/wip-pinephone-nuttx \
  nuttx
git clone \
  --branch gic \
  https://github.com/lupyuen2/wip-pinephone-nuttx-apps \
  apps
</code></pre></div></li>
</ol>
<h1 id="build-and-test"><a href="#build-and-test">2 Build and Test</a></h1>
<p>We‚Äôre ready to code!</p>
<ol>
<li>
<p>Consider breaking our Pull Request into <strong>Smaller Pull Requests</strong>.</p>
<p>This Pull Request implements <strong>One Single Feature</strong> (Generic Interrupt Controller)‚Ä¶</p>
<p><a href="https://github.com/apache/nuttx/pull/7630"><strong>‚Äúarch/arm64: Add support for Generic Interrupt Controller Version 2‚Äù</strong></a></p>
<p>That‚Äôs called by another Pull Request‚Ä¶</p>
<p><a href="https://github.com/apache/nuttx/pull/7692"><strong>‚Äúarch/arm64: Add support for PINE64 PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><strong>Modify the code</strong> in <strong><code>nuttx</code></strong> and <strong><code>apps</code></strong> to implement our awesome new feature.</p>
</li>
<li>
<p><strong>Build and test</strong> the modified code.</p>
<p><a href="https://gist.github.com/lupyuen/5e2fba642a33bf64d3378df3795042d7">(I configured <code>F1</code> in VSCode to run this <strong>Build Script</strong>)</a></p>
</li>
<li>
<p>Capture the <strong>Output Log</strong> and save it as a <a href="https://gist.github.com/lupyuen/7537da777d728a22ab379b1ef234a2d1"><strong>GitHub Gist</strong></a>‚Ä¶</p>
<ul>
<li><a href="https://gist.github.com/lupyuen/7537da777d728a22ab379b1ef234a2d1"><strong>‚ÄúNuttX QEMU Log for Generic Interrupt Controller‚Äù</strong></a></li>
</ul>
<p>We‚Äôll add this to our Pull Request. <strong>Test Logs are super helpful</strong> for NuttX Maintainers!</p>
<p>(Because we can‚Äôt tell which way the train went‚Ä¶ Unless we have the Test Logs!)</p>
</li>
<li>
<p><strong>Commit the modified code</strong> to our repositories.</p>
<p>Sometimes the <strong>GitHub Actions Workflow</strong> will fail with a strange error (like below). Just re-run the failed jobs. <a href="https://lupyuen.github.io/images/pr-rerun.png">(Like this)</a></p>
<div class="example-wrap"><pre class="language-text"><code>Error response from daemon:
login attempt to https://ghcr.io/v2/
failed with status: 503 Service Unavailable&quot;
</code></pre></div></li>
</ol>
<h2 id="regression-test"><a href="#regression-test">2.1 Regression Test</a></h2>
<p><em>Will our modified code break other parts of NuttX?</em></p>
<p>That‚Äôs why it‚Äôs good to run a <a href="https://en.wikipedia.org/wiki/Regression_testing"><strong>Regression Test</strong></a> (if feasible) to be sure that other parts of NuttX aren‚Äôt affected by our modified code.</p>
<p>For our Pull Request‚Ä¶</p>
<ul>
<li><a href="https://github.com/apache/nuttx/pull/7630"><strong>‚Äúarch/arm64: Add support for Generic Interrupt Controller Version 2‚Äù</strong></a></li>
</ul>
<p>We tested with <a href="https://www.qemu.org/docs/master/system/target-arm.html"><strong>QEMU Emulator</strong></a> our <strong>new implementation</strong> of Generic Interrupt Controller v2‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>tools/configure.sh qemu-armv8a:nsh_gicv2 ; make ; qemu-system-aarch64 ...
</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/7537da777d728a22ab379b1ef234a2d1">(See the NuttX QEMU Log)</a></p>
<p>And for Regression Testing we tested the <strong>existing implementation</strong> of Generic Interrupt Controller v3‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>tools/configure.sh qemu-armv8a:nsh ; make ; qemu-system-aarch64 ...
</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/dec66bc348092a998772b32993e5ed65">(See the NuttX QEMU Log)</a></p>
<p>Remember to capture the <strong>Output Log</strong>, we‚Äôll add it to our Pull Request.</p>
<p>(Yeah it will be hard to run a Regression Test if it requires hardware that we don‚Äôt have)</p>
<h2 id="documentation"><a href="#documentation">2.2 Documentation</a></h2>
<p>Please update the <strong>Documentation</strong>. The Documentation might be in a <strong>Text File</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/apache/nuttx/blob/master/boards/arm64/qemu/qemu-armv8a/README.txt"><strong>nuttx/‚Ä¶/README.txt</strong></a></li>
</ul>
<p>Or in the <strong>Official NuttX Docs</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/apache/nuttx/blob/master/Documentation/platforms/arm/a64/boards/pinephone/index.rst"><strong>nuttx/Documentation/‚Ä¶/index.rst</strong></a></li>
</ul>
<p>To update the Official NuttX Docs, follow the instructions here‚Ä¶</p>
<ul>
<li>
<p><a href="https://nuttx.apache.org/docs/latest/contributing/documentation.html"><strong>‚ÄúNuttX Documentation‚Äù</strong></a></p>
<p><a href="https://gist.github.com/lupyuen/c061ac688f430ef11a1c60e0b284a1fe">(See the Log)</a></p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/pr-nxstyle.jpg" alt="Check Coding Style with nxstyle" /></p>
<h1 id="check-coding-style"><a href="#check-coding-style">3 Check Coding Style</a></h1>
<p>Our NuttX Code will follow this Coding Standard‚Ä¶</p>
<ul>
<li><a href="https://nuttx.apache.org/docs/latest/contributing/coding_style.html"><strong>‚ÄúNuttX C Coding Standard‚Äù</strong></a></li>
</ul>
<p>NuttX provides a tool <strong><code>nxstyle</code></strong> that will check the Coding Style of our source files‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Compile nxstyle
## TODO: Change &quot;$HOME/nuttx&quot; to our NuttX Project Folder
gcc -o $HOME/nxstyle $HOME/nuttx/nuttx/tools/nxstyle.c

## Check coding style for our modified source files
## TODO: Change the file paths
$HOME/nxstyle $HOME/nuttx/nuttx/arch/arm64/Kconfig
$HOME/nxstyle $HOME/nuttx/nuttx/arch/arm64/src/common/Make.defs
$HOME/nxstyle $HOME/nuttx/nuttx/arch/arm64/src/common/arm64_gic.h
$HOME/nxstyle $HOME/nuttx/nuttx/arch/arm64/src/common/arm64_gicv2.c
</code></pre></div>
<p><a href="https://github.com/apache/nuttx/blob/master/tools/nxstyle.c">(<code>nxstyle.c</code> is here)</a></p>
<p><a href="https://gist.github.com/lupyuen/5e2fba642a33bf64d3378df3795042d7">(How I run <code>nxstyle</code> in my <strong>Build Script</strong>)</a></p>
<p><em>Will <code>nxstyle</code> check Kconfig and Makefiles?</em></p>
<p>Not yet, but maybe someday? That‚Äôs why we passed all the modified files to <code>nxstyle</code> for checking.</p>
<p><em>How do we fix our code?</em></p>
<p>The pic above shows the output from <strong><code>nxstyle</code></strong>. We‚Äôll see messages like‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>- C++ style comment
- Long line found
- Mixed case identifier found
- Operator/assignment must be followed/preceded with whitespace
- Upper case hex constant found
- #include outside of &#39;Included Files&#39; section
</code></pre></div>
<p>We modify our code so that this‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>// Initialize GIC. Called by CPU0 only.
int arm64_gic_initialize(void) {
  // Verify that GIC Version is 2
  int err = gic_validate_dist_version();
  if (err) { sinfo(&quot;no distributor detected, giving up ret=%d\n&quot;, err); return err; }

  // CPU0-specific initialization for GIC
  arm_gic0_initialize();

  // CPU-generic initialization for GIC
  arm_gic_initialize();
  return 0;
}
</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx/blob/pinephone/arch/arm64/src/common/arm64_gicv3.c#L717-L743">(Source)</a></p>
<p>Becomes this‚Ä¶</p>
<div class="example-wrap"><pre class="language-c"><code>/****************************************************************************
 * Name: arm64_gic_initialize
 *
 * Description:
 *   Initialize GIC. Called by CPU0 only.
 *
 * Input Parameters
 *   None
 *
 * Returned Value:
 *   Zero (OK) on success; a negated errno value is returned on any failure.
 *
 ****************************************************************************/

int arm64_gic_initialize(void)
{
  int err;

  /* Verify that GIC Version is 2 */

  err = gic_validate_dist_version();
  if (err)
    {
      sinfo(&quot;no distributor detected, giving up ret=%d\n&quot;, err);
      return err;
    }

  /* CPU0-specific initialization for GIC */

  arm_gic0_initialize();

  /* CPU-generic initialization for GIC */

  arm_gic_initialize();

  return 0;
}
</code></pre></div>
<p><a href="https://github.com/apache/nuttx/blob/master/arch/arm64/src/common/arm64_gicv2.c#L1325-L1363">(Source)</a></p>
<p>If we see this‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>/* */ not balanced
</code></pre></div>
<p>Check that our stars ‚Äú<strong><code>*</code></strong>‚Äù are aligned (heh)‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>/******************************
 * Name: missing_asterisk_below
 *
 *****************************/
</code></pre></div>
<p>After fixing, <strong>test our code</strong> one last time.</p>
<h1 id="write-the-pull-request"><a href="#write-the-pull-request">4 Write the Pull Request</a></h1>
<p>Our Pull Request will have‚Ä¶</p>
<ol>
<li>
<p><strong>Title</strong>: NuttX Subsystem and One-Line Summary</p>
</li>
<li>
<p><strong>Summary</strong>: What‚Äôs the purpose of the Pull Request? What files are changed?</p>
</li>
<li>
<p><strong>Impact</strong>: Which parts of NuttX are affected by the Pull Request? Which parts <em>won‚Äôt</em> be affected?</p>
</li>
<li>
<p><strong>Testing</strong>: Provide evidence that our Pull Request does what it‚Äôs supposed to do.</p>
<p>(And that it won‚Äôt do what it‚Äôs <em>not supposed</em> to do)</p>
</li>
</ol>
<p>To write the above items, let‚Äôs walk through these Pull Requests‚Ä¶</p>
<ul>
<li>
<p><a href="https://github.com/apache/nuttx/pull/7630"><strong>‚Äúarch/arm64: Add support for Generic Interrupt Controller Version 2‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/apache/nuttx/pull/7692"><strong>‚Äúarch/arm64: Add support for PINE64 PinePhone‚Äù</strong></a></p>
</li>
</ul>
<h2 id="title"><a href="#title">4.1 Title</a></h2>
<p>Inside our Title is the <strong>NuttX Subsystem</strong> and <strong>One-Line Summary</strong>‚Ä¶</p>
<blockquote>
<p><em>‚Äúarch/arm64: Add support for Generic Interrupt Controller Version 2‚Äù</em></p>
</blockquote>
<blockquote>
<p><a href="https://github.com/apache/nuttx/pull/7630">(Source)</a></p>
</blockquote>
<p>Let‚Äôs write this into a <strong>Markdown File</strong> for easier copying‚Ä¶</p>
<ul>
<li>
<p><a href="https://gist.github.com/lupyuen/4dbe011143dfc5404e1791ba74a79deb"><strong>Sample Pull Request</strong></a></p>
<p><a href="https://gist.githubusercontent.com/lupyuen/4dbe011143dfc5404e1791ba74a79deb/raw/b8731c9132c428050e6146c0d2097e7bb7c6eb03/sample-nuttx-pull-request.md">(See the Markdown Code)</a></p>
</li>
</ul>
<p>We‚Äôll add the following sections to the Markdown File‚Ä¶</p>
<h2 id="summary"><a href="#summary">4.2 Summary</a></h2>
<p>In the Summary we write the <strong>purpose of the Pull Request</strong>‚Ä¶</p>
<blockquote>
<p><em>‚ÄúThis PR adds support for GIC Version 2, which is needed by Pine64 PinePhone.‚Äù</em></p>
</blockquote>
<blockquote>
<p><a href="https://github.com/apache/nuttx/pull/7630">(Source)</a></p>
</blockquote>
<p>And we list the <strong>files that we changed</strong>‚Ä¶</p>
<blockquote>
<p><em>‚Äú<code>arch/arm64/Kconfig</code>: Under ‚ÄúARM64 Options‚Äù, we added an integer option ARM_GIC_VERSION (‚ÄúGIC version‚Äù) that selects the GIC Version. Valid values are 2, 3 and 4, default is 3.‚Äú</em></p>
</blockquote>
<blockquote>
<p><a href="https://github.com/apache/nuttx/pull/7630">(Source)</a></p>
</blockquote>
<p>If it‚Äôs a long list, we might <strong>break into subsections</strong> like this‚Ä¶</p>
<ul>
<li><a href="https://github.com/apache/nuttx/pull/7692"><strong>arch/arm64: Add support for PINE64 PinePhone</strong></a></li>
</ul>
<p>For <strong>Code Provenance</strong> it‚Äôs good to state <strong>how we created the code</strong>‚Ä¶</p>
<blockquote>
<p><em>‚ÄúThis 64-bit implementation of GIC v2 is mostly identical to the existing GIC v2 for 32-bit Armv7-A (<a href="https://github.com/apache/incubator-nuttx/blob/master/arch/arm/src/armv7-a/arm_gicv2.c"><code>arm_gicv2.c</code></a>, <a href="https://github.com/apache/incubator-nuttx/blob/master/arch/arm/src/armv7-a/gic.h"><code>gic.h</code></a>), with minor modifications to support 64-bit Registers (Interrupt Context).‚Äù</em></p>
</blockquote>
<blockquote>
<p><a href="https://github.com/apache/nuttx/pull/7630">(Source)</a></p>
</blockquote>
<h2 id="impact"><a href="#impact">4.3 Impact</a></h2>
<p>Under ‚ÄúImpact‚Äù, we write <strong>which parts of NuttX are affected</strong> by the Pull Request. </p>
<p>(And which parts <em>won‚Äôt</em> be affected)</p>
<blockquote>
<p><em>‚ÄúWith this PR, NuttX now supports GIC v2 on Arm64.</em></p>
</blockquote>
<blockquote>
<p><em>There is no impact on the existing implementation of GIC v3, as tested below.‚Äú</em></p>
</blockquote>
<blockquote>
<p><a href="https://github.com/apache/nuttx/pull/7630">(Source)</a></p>
</blockquote>
<h2 id="testing"><a href="#testing">4.4 Testing</a></h2>
<p>Under ‚ÄúTesting‚Äù, we provide evidence that our Pull Request <strong>does what it‚Äôs supposed to do.</strong> We fill in the‚Ä¶</p>
<ul>
<li>
<p><strong>Commands</strong> used for testing</p>
</li>
<li>
<p><strong>Output Logs</strong> captured from our testing</p>
</li>
</ul>
<p>Like this‚Ä¶</p>
<blockquote>
<p><em>‚ÄúWe tested with QEMU our implementation of GIC v2:</em></p>
</blockquote>
<blockquote>
<p><em><code>tools/configure.sh qemu-armv8a:nsh_gicv2 ; make ; qemu-system-aarch64 ...</code></em></p>
</blockquote>
<blockquote>
<p><em><a href="https://gist.github.com/lupyuen/7537da777d728a22ab379b1ef234a2d1">(See the NuttX QEMU Log)</a></em></p>
</blockquote>
<blockquote>
<p><em>The log shows that GIC v2 has correctly handled interrupts‚Äú</em></p>
</blockquote>
<blockquote>
<p><a href="https://github.com/apache/nuttx/pull/7630">(Source)</a></p>
</blockquote>
<p>If we have done a <a href="https://lupyuen.github.io/articles/pr#regression-test"><strong>Regression Test</strong></a>, provide the details too‚Ä¶</p>
<blockquote>
<p><em>‚ÄúFor Regression Testing: We tested the existing implementation of GIC v3‚Ä¶‚Äù</em></p>
</blockquote>
<blockquote>
<p><em><code>tools/configure.sh qemu-armv8a:nsh ; make ; qemu-system-aarch64 ...</code></em></p>
</blockquote>
<blockquote>
<p><em><a href="https://gist.github.com/lupyuen/dec66bc348092a998772b32993e5ed65">(See the NuttX QEMU Log)</a></em></p>
</blockquote>
<blockquote>
<p><a href="https://github.com/apache/nuttx/pull/7630">(Source)</a></p>
</blockquote>
<p><strong>Test Logs are super helpful</strong> for NuttX Maintainers!</p>
<p>(Because we can‚Äôt tell which way the train went‚Ä¶ By staring at the track!)</p>
<p>Now we tidy up our commits‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/pr-squash1.png" alt="Squash Commits with GitHub Desktop" /></p>
<h1 id="squash-the-commits"><a href="#squash-the-commits">5 Squash the Commits</a></h1>
<p><em>What‚Äôs this ‚Äúsquashing‚Äù?</em></p>
<p>‚ÄúSquashing‚Äù means we‚Äôre <strong>combining Multiple Commits</strong> into One Single Commit.</p>
<p>Our <strong>Commit History</strong> can get awfully messy during development‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>- Initial Commit
- Fixing Build
- Build OK!
- Oops fixing bug
- Tested OK yay!
</code></pre></div>
<p><a href="https://github.com/lupyuen/nuttx/commits/pinephone/arch/arm64/src/qemu/qemu_serial.c">(Source)</a></p>
<p>So we always <strong>Squash the Commits</strong> into One Single Commit (to help future maintainers)‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>- arch/arm64: Add support for Generic Interrupt Controller Version 2
</code></pre></div>
<p><a href="https://github.com/apache/nuttx/pull/7630/commits">(Source)</a></p>
<p><em>How do we squash the commits?</em></p>
<p>We‚Äôll use <a href="https://desktop.github.com/"><strong>GitHub Desktop</strong></a> (because I‚Äôm terrible with the Git Command Line)‚Ä¶</p>
<ol>
<li>
<p>Install <a href="https://desktop.github.com/"><strong>GitHub Desktop</strong></a> and launch it</p>
</li>
<li>
<p>Click ‚Äú<strong>File ‚Üí Add Local Repository</strong>‚Äù</p>
<p>Select our downloaded <strong><code>nuttx</code></strong> folder.</p>
<p>Click ‚Äú<strong>Add Repository</strong>‚Äù</p>
</li>
<li>
<p>Click the ‚Äú<strong>History</strong>‚Äù tab to reveal the Commit History</p>
<p><a href="https://lupyuen.github.io/images/pr-squash1.png">(Pic above)</a></p>
</li>
<li>
<p>Select the Commits to be Squashed.</p>
<p>Right-click the Commits.</p>
<p>Select ‚Äú<strong>Squash Commits</strong>‚Äù</p>
<p><a href="https://lupyuen.github.io/images/pr-squash1.png">(Pic above)</a></p>
</li>
<li>
<p>Copy the <strong>Title</strong> of our Pull Request and paste into the <strong>Title Box</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>arch/arm64: Add support for Generic Interrupt Controller Version 2
</code></pre></div>
<p>Copy the <strong>Summary</strong> of our Pull Request and paste into the <strong>Description Box</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>This PR adds support for GIC Version 2.
- `boards/arm64/qemu/qemu-armv8a/configs/nsh_gicv2/defconfig`: Added the Board Configuration
</code></pre></div>
<p>Click ‚Äú<strong>Squash Commits</strong>‚Äù</p>
<p><img src="https://lupyuen.github.io/images/pr-squash2.png" alt="Squash Commits with GitHub Desktop" /></p>
</li>
<li>
<p>Click ‚Äú<strong>Begin Squash</strong>‚Äù</p>
<p><img src="https://lupyuen.github.io/images/pr-squash3.png" alt="Squash Commits with GitHub Desktop" /></p>
</li>
<li>
<p>Click ‚Äú<strong>Force Push Origin</strong>‚Äù</p>
<p><img src="https://lupyuen.github.io/images/pr-squash4.png" alt="Squash Commits with GitHub Desktop" /></p>
</li>
<li>
<p>Click ‚Äú<strong>I‚Äôm Sure</strong>‚Äù</p>
<p><img src="https://lupyuen.github.io/images/pr-squash5.png" alt="Squash Commits with GitHub Desktop" /></p>
<p>And we‚Äôre ready to merge upstream! (Like the salmon)</p>
</li>
</ol>
<p><em>What if we prefer the Git Command Line?</em></p>
<p>Here are the steps to Squash Commits with the <strong>Git Command Line</strong>‚Ä¶</p>
<ul>
<li><a href="https://github.com/k88hudson/git-flight-rules#i-need-to-combine-commits"><strong>‚ÄúFlight rules for Git: I need to combine commits‚Äù</strong></a></li>
</ul>
<p><img src="https://lupyuen.github.io/images/pr-walk.jpg" alt="Taking a long walk" /></p>
<h1 id="meditate"><a href="#meditate">6 Meditate</a></h1>
<p><strong>Breathe. Take a break.</strong></p>
<p>We‚Äôre about to make <strong>NuttX History</strong>‚Ä¶ Our changes will be recorded for posterity!</p>
<p>Take a long walk and ponder‚Ä¶</p>
<ul>
<li>
<p><strong>Who might benefit</strong> from our Pull Request</p>
</li>
<li>
<p>How we might <strong>best help them</strong></p>
</li>
</ul>
<p>(I walked 12 km for 3 hours while meditating on my Pull Request)</p>
<p>If we get an inspiration or epiphany, touch up the Pull Request.</p>
<p>(And resquash the commits)</p>
<p><em>What‚Äôs your epiphany?</em></p>
<p>Through my Pull Requests, I hope to turn NuttX into a valuable tool for teaching the internals of <strong>Smartphone Operating Systems</strong>.</p>
<p>That‚Äôs my motivation for <a href="https://github.com/apache/nuttx/pull/7692"><strong>porting NuttX to PINE64 PinePhone</strong></a>.</p>
<p>But for now‚Ä¶ Let‚Äôs finish our Pull Request!</p>
<p><img src="https://lupyuen.github.io/images/pr-pullrequest1.png" alt="Submit the Pull Request" /></p>
<h1 id="submit-the-pull-request"><a href="#submit-the-pull-request">7 Submit the Pull Request</a></h1>
<p>Finally it‚Äôs time to submit our Pull Request!</p>
<ol>
<li>
<p>Create the <strong>Pull Request</strong> (pic above)</p>
</li>
<li>
<p>Verify that it has only <strong>One Single Commit</strong> (pic above)</p>
<p><a href="https://lupyuen.github.io/articles/pr#squash-the-commits">(Squash the Commits)</a></p>
</li>
<li>
<p>Copy these into the Pull Request‚Ä¶</p>
<p><a href="https://lupyuen.github.io/articles/pr#title"><strong>Title</strong></a></p>
<p><a href="https://lupyuen.github.io/articles/pr#summary"><strong>Summary</strong></a></p>
<p><a href="https://lupyuen.github.io/articles/pr#impact"><strong>Impact</strong></a></p>
<p><a href="https://lupyuen.github.io/articles/pr#testing"><strong>Testing</strong></a></p>
<p><a href="https://github.com/apache/nuttx/pull/7630">(Like this)</a></p>
</li>
<li>
<p>Submit the Pull Request</p>
</li>
<li>
<p>Wait for the <strong>Automated Checks</strong> to be completed (might take an hour)‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/pr-pullrequest2.png" alt="Automated Checks for Pull Request" /></p>
</li>
<li>
<p><strong>Fix any errors</strong> in the Automated Checks</p>
</li>
<li>
<p>Wait for the NuttX Team to <strong>review and comment</strong> on our Pull Request.</p>
<p>This might take a while (due to the time zones)‚Ä¶ Grab a coffee and standby for fixes!</p>
<p><a href="https://lupyuen.github.io/articles/sourdough">(I bake sourdough while waiting)</a></p>
<p>If all goes Hunky Dory, our Pull Request will be <strong>approved and merged!</strong> üéâ</p>
</li>
</ol>
<p>Sometimes we need to <strong>Rebase To The Latest Master</strong> due to updates in the GitHub Actions Workflow (Continuous Integration Script). Here‚Äôs how‚Ä¶</p>
<ol>
<li>
<p>Browse to the <strong><code>master</code></strong> branch of our <strong><code>nuttx</code></strong> repository.</p>
<p>Click ‚Äú<strong>Sync Fork ‚Üí Update Branch</strong>‚Äù</p>
<p>(Pic below)</p>
</li>
<li>
<p>Launch <a href="https://desktop.github.com/"><strong>GitHub Desktop</strong></a></p>
<p>Click ‚Äú<strong>File ‚Üí Add Local Repository</strong>‚Äù</p>
<p>Select our downloaded <strong><code>nuttx</code></strong> folder.</p>
<p>Click ‚Äú<strong>Add Repository</strong>‚Äù</p>
</li>
<li>
<p>Check that the <strong>Current Branch</strong> is our Working Branch for the Pull Request.</p>
<p>(Like <strong><code>gic</code></strong> branch)</p>
</li>
<li>
<p>Click ‚Äú<strong>Fetch Origin</strong>‚Äù</p>
</li>
<li>
<p>Click ‚Äú<strong>Branch ‚Üí Rebase Current Branch</strong>‚Äù</p>
<p>Select the <strong><code>master</code></strong> branch</p>
<p>Click ‚Äú<strong>Rebase</strong>‚Äù and ‚Äú<strong>Begin Rebase</strong>‚Äù</p>
</li>
<li>
<p>Click ‚Äú<strong>Force Push Origin</strong>‚Äù and ‚Äú<strong>I‚Äôm Sure</strong>‚Äù</p>
<p><a href="https://docs.github.com/en/desktop/contributing-and-collaborating-using-github-desktop/keeping-your-local-repository-in-sync-with-github/syncing-your-branch#rebasing-your-project-branch-onto-another-branch">(See the official docs)</a></p>
</li>
</ol>
<p><img src="https://lupyuen.github.io/images/pr-update.png" alt="Pull Updates from NuttX Mainline" /></p>
<h1 id="update-our-repositories"><a href="#update-our-repositories">8 Update Our Repositories</a></h1>
<p>After our Pull Request has been merged into NuttX Mainline, <strong>pull the updates</strong> into our repositories‚Ä¶</p>
<ol>
<li>
<p>Browse to the <strong><code>master</code></strong> branch of our <strong><code>nuttx</code></strong> repository.</p>
<p>Click ‚Äú<strong>Sync Fork ‚Üí Update Branch</strong>‚Äù</p>
<p>(Pic above)</p>
</li>
<li>
<p>Do the same for the <strong><code>master</code></strong> branch of our <strong><code>apps</code></strong> repository.</p>
<p>Click ‚Äú<strong>Sync Fork ‚Üí Update Branch</strong>‚Äù</p>
</li>
<li>
<p>Test the code from the <strong><code>master</code></strong> branch of our <strong><code>nuttx</code></strong> and <strong><code>apps</code></strong> repositories.</p>
</li>
</ol>
<p>When we‚Äôre ready to add our <strong>next awesome feature</strong>‚Ä¶</p>
<ol>
<li>
<p>Pull the updates from NuttX Mainline into our <strong><code>nuttx</code></strong> repository‚Ä¶</p>
<p>Select the <strong><code>master</code></strong> branch.</p>
<p>Click ‚Äú<strong>Sync Fork ‚Üí Update Branch</strong>‚Äù</p>
<p>(Pic above)</p>
</li>
<li>
<p>Do the same for our <strong><code>apps</code></strong> repository.</p>
</li>
<li>
<p>In our <strong><code>nuttx</code></strong> repository, click <strong><code>master</code></strong>.</p>
<p>Enter the name of our new branch.</p>
<p>Click ‚Äú<strong>Create Branch</strong>‚Äù</p>
<p><img src="https://lupyuen.github.io/images/pr-branch.png" alt="Create Branch" /></p>
</li>
<li>
<p>Do the same for our <strong><code>apps</code></strong> repository.</p>
</li>
<li>
<p>Modify the code in the new branch of our <strong><code>nuttx</code></strong> and <strong><code>apps</code></strong> repositories.</p>
<p>Build, test and submit our new Pull Request.</p>
</li>
</ol>
<p>And that‚Äôs the Complete Lifecycle of a Pull Request for Apache NuttX RTOS!</p>
<p>One last thing: Please help to validate that the <strong>NuttX Release works OK</strong>! We really appreciate your help with this‚Ä¶ üôè</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/pr#appendix-validate-nuttx-release"><strong>‚ÄúValidate NuttX Release‚Äù</strong></a></li>
</ul>
<h1 id="whats-next"><a href="#whats-next">9 What‚Äôs Next</a></h1>
<p>I hope this article will be helpful for folks contributing code to NuttX for the very first time.</p>
<p>In the next article we‚Äôll explain this complex Pull Request that adds a <strong>new SoC and new Board</strong> to NuttX. Stay Tuned!</p>
<ul>
<li><a href="https://github.com/apache/nuttx/pull/7692"><strong>‚Äúarch/arm64: Add support for PINE64 PinePhone‚Äù</strong></a></li>
</ul>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>My Current Project: ‚ÄúApache NuttX RTOS for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book"><strong>My Other Project: ‚ÄúThe RISC-V BL602 Book‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/pr.md"><strong>lupyuen.github.io/src/pr.md</strong></a></p>
<h1 id="notes"><a href="#notes">10 Notes</a></h1>
<ol>
<li>
<p>When we modify the <strong>Kconfig</strong> Configuration Files, remember to update the <strong>defconfig</strong> Configuration Files!</p>
<p><a href="https://github.com/apache/nuttx/pull/9243#issuecomment-1542918859">(Like this)</a></p>
<p>What happens if we forget to update <strong>defconfig</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>Configuration/Tool: pinephone/sensor
Building NuttX...
Normalize pinephone/sensor
71d70
&lt; CONFIG_UART1_SERIAL_CONSOLE=y
Saving the new configuration file
HEAD detached at pull/9243/merge
Changes not staged for commit:
(use &quot;git add &lt;file&gt;...&quot; to update what will be committed)
(use &quot;git restore &lt;file&gt;...&quot; to discard changes in working directory)
    modified:   boards/arm64/a64/pinephone/configs/sensor/defconfig
</code></pre></div>
<p><a href="https://github.com/apache/nuttx/pull/9243#issuecomment-1542918859">(Source)</a></p>
</li>
<li>
<p>How do we create a new <strong>defconfig</strong>?</p>
<p>In the ‚Äú<strong>nuttx/nuttx</strong>‚Äù folder, run this‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>make savedefconfig
</code></pre></div>
<p>This creates the file <strong>defconfig</strong> that contains the changed settings.</p>
<p>Copy the <strong>defconfig</strong> file to the new <strong>config</strong> subfolder‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>mkdir boards/&lt;archname&gt;/&lt;chipname&gt;/&lt;boardname&gt;/config/&lt;mynewcustomconfig&gt;

mv defconfig boards/&lt;archname&gt;/&lt;chipname&gt;/&lt;boardname&gt;/config/&lt;mynewcustomconfig&gt;/
</code></pre></div>
<p><a href="https://www.mail-archive.com/dev@nuttx.apache.org/msg09876.html">(Thanks to <strong>Alan C. Assis</strong> for the tip!)</a></p>
</li>
<li>
<p>TODO: UART Settings</p>
<div class="example-wrap"><pre class="language-text"><code>CONFIG_UART3_BAUD=115200
CONFIG_UART3_BITS=8
CONFIG_UART3_PARITY=0
CONFIG_UART3_2STOP=0
</code></pre></div>
<p>TODO</p>
<div class="example-wrap"><pre class="language-text"><code>Configuration/Tool: pinephone/modem
Building NuttX...
Normalize pinephone/modem
69,72d68
&lt; CONFIG_UART3_BAUD=115200
&lt; CONFIG_UART3_BITS=8
&lt; CONFIG_UART3_PARITY=0
&lt; CONFIG_UART3_2STOP=0
Saving the new configuration file
HEAD detached at pull/9304/merge
Changes not staged for commit:
(use &quot;git add &lt;file&gt;...&quot; to update what will be committed)
(use &quot;git restore &lt;file&gt;...&quot; to discard changes in working directory)
    modified:   boards/arm64/a64/pinephone/configs/modem/defconfig
</code></pre></div>
<p><a href="https://github.com/apache/nuttx/actions/runs/4997328093/jobs/8951602341">(Source)</a></p>
</li>
<li>
<p>Here‚Äôs an excellent guide for the <strong>Git Command Line</strong>‚Ä¶</p>
<p><a href="https://github.com/k88hudson/git-flight-rules"><strong>‚ÄúFlight rules for Git‚Äù</strong></a></p>
</li>
<li>
<p>Converting our code to the <a href="https://nuttx.apache.org/docs/latest/contributing/coding_style.html"><strong>‚ÄúNuttX C Coding Standard‚Äù</strong></a>‚Ä¶</p>
<p>Can we automate this with a <strong>VSCode Extension?</strong></p>
<p>Maybe like the <a href="https://marketplace.visualstudio.com/items?itemName=idanp.checkpatch"><strong>Linux checkpatch Extension</strong></a>, but it will actually auto-reformat our lines?</p>
</li>
<li>
<p><a href="https://www.qemu.org/docs/master/system/target-arm.html"><strong>QEMU Emulator</strong></a> is incredibly helpful for Regression Testing‚Ä¶</p>
<p>Can we extend it to <strong>emulate PinePhone</strong>? Maybe just the UART Hardware? Check out the articles‚Ä¶</p>
<p><a href="https://lupyuen.github.io/articles/unicorn"><strong>‚Äú(Possibly) Emulate PinePhone with Unicorn Emulator‚Äù</strong></a></p>
<p><a href="https://lupyuen.github.io/articles/unicorn2"><strong>‚Äú(Clickable) Call Graph for Apache NuttX Real-Time Operating System‚Äù</strong></a></p>
</li>
</ol>
<h1 id="appendix-validate-nuttx-release"><a href="#appendix-validate-nuttx-release">11 Appendix: Validate NuttX Release</a></h1>
<p><em>For each Official Release of NuttX, how do we check if it runs OK on all devices? Like PinePhone, ESP32, BL602, ‚Ä¶</em></p>
<p>NuttX needs to be <strong>tested on every device</strong>, and we need your help! üôè</p>
<p>Before every Official Release of NuttX, a <strong>Validation Request</strong> will be broadcast on the <a href="https://nuttx.apache.org/community/"><strong>NuttX Developers Mailing List</strong></a>‚Ä¶</p>
<ul>
<li><a href="https://www.mail-archive.com/dev@nuttx.apache.org/msg09563.html"><strong>Validation Request for NuttX Release</strong></a></li>
</ul>
<p>Follow the instructions here to validate that the NuttX Release <strong>builds correctly and runs OK</strong> on your device‚Ä¶</p>
<ul>
<li>
<p><a href="https://cwiki.apache.org/confluence/display/NUTTX/Validating+a+staged+Release"><strong>Validating a Staged Release</strong></a></p>
<p>(See below for the updates)</p>
</li>
</ul>
<p>Here‚Äôs the script I run to <strong>validate NuttX on PinePhone</strong>‚Ä¶</p>
<ul>
<li><a href="https://gist.github.com/lupyuen/a08d3d478beefc5a492ed2dae39438f3"><strong>Validation Script for PinePhone: release.sh</strong></a></li>
</ul>
<p>And here‚Äôs the output of the <strong>validation script</strong>‚Ä¶</p>
<ul>
<li><a href="https://gist.github.com/lupyuen/5760e0375d44a06b3c730a10614e4d24"><strong>Validation Output for PinePhone: release.log</strong></a></li>
</ul>
<p>Boot NuttX on our device, run ‚Äú<strong>uname -a</strong>‚Äù and ‚Äú<strong>free</strong>‚Äù‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>NuttShell (NSH) NuttX-12.1.0
nsh&gt; uname -a
NuttX 12.1.0 d40f4032fc Apr 12 2023 07:11:20 arm64 pinephone
nsh&gt; free
      total     used   free      largest   nused nfree
Umem: 133414240 550768 132863472 132863376 56    2
</code></pre></div>
<p>The <strong>NuttX Hash</strong> (like ‚Äúd40f4032fc‚Äù above) should match the <a href="https://www.mail-archive.com/dev@nuttx.apache.org/msg09563.html"><strong>Validation Request</strong></a>.</p>
<p>Copy the above into a <strong>Validation Response</strong> email‚Ä¶</p>
<ul>
<li><a href="https://www.mail-archive.com/dev@nuttx.apache.org/msg09565.html"><strong>Validation Response for NuttX Release</strong></a></li>
</ul>
<p>And send back to the Mailing List. (Assuming all is hunky dory)</p>
<p>Since there are so many NuttX devices, we really appreciate your help with the NuttX Validation! üôè</p>
<p><em>What are the updates to the NuttX Validation Instructions?</em></p>
<p>The <a href="https://cwiki.apache.org/confluence/display/NUTTX/Validating+a+staged+Release"><strong>NuttX Validation Instructions</strong></a> should be updated‚Ä¶</p>
<ul>
<li>
<p>To verify the NuttX Signature, we need to <strong>import the NuttX Keys</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>wget https://dist.apache.org/repos/dist/dev/nuttx/KEYS
gpg --import KEYS
</code></pre></div></li>
<li>
<p>We also need to <strong>trust the NuttX Keys</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>gpg --edit-key 9208D2E4B800D66F749AD4E94137A71698C5E4DB
</code></pre></div>
<p>(That‚Äôs the RSA Key Fingerprint from ‚Äú<strong>gpg ‚Äìverify</strong>‚Äù)</p>
<p>Then enter ‚Äú<strong>trust</strong>‚Äù and ‚Äú<strong>5</strong>‚Äù</p>
</li>
<li>
<p>The file ‚Äú<strong>DISCLAIMER-WIP</strong>‚Äù no longer exists in the <strong>nuttx</strong> and <strong>apps</strong> folders</p>
</li>
</ul>

    
</body>
</html>