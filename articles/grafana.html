<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Grafana Data Source for The Things Network</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Grafana Data Source for The Things Network" 
    data-rh="true">
<meta property="og:description" 
    content="How we visualise Sensor Data from The Things Network... With a Custom MQTT Data Source in Grafana"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/grafana-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Grafana Data Source for The Things Network</h1>
    <nav id="TOC"><ul>
<li><a href="#configure-the-things-network-mqtt">1 Configure The Things Network MQTT</a><ul>
<li><a href="#test-the-things-network-mqtt">1.1 Test The Things Network MQTT</a><ul></ul></li></ul></li>
<li><a href="#configure-grafana-data-source">2 Configure Grafana Data Source</a><ul></ul></li>
<li><a href="#grafana-dashboard">3 Grafana Dashboard</a><ul></ul></li>
<li><a href="#cbor-concise-binary-object-representation">4 CBOR: Concise Binary Object Representation</a><ul></ul></li>
<li><a href="#transform-mqtt-messages">5 Transform MQTT Messages</a><ul></ul></li>
<li><a href="#troubleshooting">6 Troubleshooting</a><ul></ul></li>
<li><a href="#store-data-with-prometheus">7 Store Data with Prometheus</a><ul></ul></li>
<li><a href="#whats-next">8 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">9 Notes</a><ul></ul></li>
<li><a href="#appendix-install-grafana-and-data-source">10 Appendix: Install Grafana and Data Source</a><ul>
<li><a href="#install-grafana">10.1 Install Grafana</a><ul></ul></li>
<li><a href="#build-data-source">10.2 Build Data Source</a><ul></ul></li>
<li><a href="#enable-data-source">10.3 Enable Data Source</a><ul></ul></li></ul></li>
<li><a href="#appendix-install-build-tools-for-macos">11 Appendix: Install Build Tools for macOS</a><ul></ul></li></ul></nav><p>üìù <em>30 Sep 2021</em></p>
<p><a href="https://lupyuen.github.io/articles/ttn"><strong>The Things Network</strong></a> is a public global <strong>wireless network for IoT devices</strong>‚Ä¶</p>
<p>(And it‚Äôs free for fair use!)</p>
<p><a href="https://grafana.com/oss/grafana/"><strong>Grafana</strong></a> is a open source tool for <strong>visualising all kinds of real-time data</strong>‚Ä¶</p>
<p>(Works on Linux, macOS and Windows)</p>
<p><em>Can we connect Grafana to The Things Network‚Ä¶</em></p>
<p><em>And instantly visualise the Sensor Data from our IoT Devices?</em></p>
<p><img src="https://lupyuen.github.io/images/grafana-flow.jpg" alt="Visualising The Things Network Sensor Data with Grafana" /></p>
<p>Today we shall experiment with a custom <strong>MQTT Data Source</strong> for Grafana that will stream real-time Sensor Data from The Things Network.</p>
<p><em>Wait‚Ä¶ We‚Äôre streaming the Sensor Data without storing it?</em></p>
<p>Yep this <strong>streaming setup for Grafana</strong> requires fewer components because it doesn‚Äôt store the data.</p>
<p>But it has limitations, which we‚Äôll discuss shortly.</p>
<p>(This is work-in-progress, some spot may get rough. And please pardon my ghastly GoLang üôè)</p>
<p><img src="https://lupyuen.github.io/images/grafana-title.jpg" alt="Grafana visualising Sensor Data from The Things Network" /></p>
<p><em>Grafana visualising Sensor Data from The Things Network</em></p>
<h1 id="configure-the-things-network-mqtt" class="section-header"><a href="#configure-the-things-network-mqtt">1 Configure The Things Network MQTT</a></h1>
<p>Previously we have <strong>configured our IoT Device</strong> in The Things Network‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/ttn"><strong>‚ÄúThe Things Network on PineDio Stack BL604 RISC-V Board‚Äù</strong></a></li>
</ul>
<p>Now we <strong>enable the MQTT Server</strong> in The Things Network by clicking‚Ä¶</p>
<ul>
<li><strong>Applications</strong> ‚Üí <em>(Your Application)</em> ‚Üí <strong>Integrations</strong> ‚Üí <strong>MQTT</strong></li>
</ul>
<p><img src="https://lupyuen.github.io/images/grafana-ttn.png" alt="Configure The Things Network MQTT Server" /></p>
<p>Click <strong>‚ÄúGenerate New API Key‚Äù</strong> and copy the values for‚Ä¶</p>
<ul>
<li>
<p><strong>Public Address</strong></p>
<p>(We won‚Äôt be using the Public TLS Address since our Data Source doesn‚Äôt support TLS)</p>
</li>
<li>
<p><strong>Username</strong></p>
</li>
<li>
<p><strong>Password</strong></p>
<p>(This is the only time we can see the password. Don‚Äôt forget to copy it!)</p>
</li>
</ul>
<p>We‚Äôll use the values in the next chapter.</p>
<h2 id="test-the-things-network-mqtt" class="section-header"><a href="#test-the-things-network-mqtt">1.1 Test The Things Network MQTT</a></h2>
<p>To <strong>test the MQTT Server</strong> at The Things Network, enter this command‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"># Change au1.cloud.thethings.network to our MQTT Public Address
# Change luppy-application@ttn to our MQTT Username
mosquitto_sub -h au1.cloud.thethings.network -t &quot;#&quot; -u &quot;luppy-application@ttn&quot; -P &quot;YOUR_API_KEY&quot; -d</pre></div>
<p>MQTT JSON Messages will appear whenever our IoT Device joins the network or transmits data.</p>
<p><a href="https://github.com/lupyuen/the-things-network-datasource#mqtt-log">(See sample MQTT Log)</a></p>
<p><a href="https://www.thethingsindustries.com/docs/integrations/mqtt/">(More about The Things Network MQTT)</a></p>
<h1 id="configure-grafana-data-source" class="section-header"><a href="#configure-grafana-data-source">2 Configure Grafana Data Source</a></h1>
<p>Let‚Äôs <strong>add and configure</strong> our Grafana Data Source for The Things Network‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen/the-things-network-datasource"><strong>lupyuen/the-things-network-datasource</strong></a></li>
</ul>
<p>Follow these instructions to <strong>install Grafana and the Data Source</strong> for The Things Network‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/grafana#appendix-install-grafana-and-data-source"><strong>‚ÄúInstall Grafana and Data Source‚Äù</strong></a></li>
</ul>
<p>In Grafana, click the left menu bar‚Ä¶</p>
<ul>
<li><strong>Configuration</strong> ‚Üí <strong>Data Sources</strong></li>
</ul>
<p>Click <strong>‚ÄúAdd Data Source‚Äù</strong></p>
<p><img src="https://lupyuen.github.io/images/grafana-datasource4.png" alt="Add Data Source" /></p>
<p>Look for <strong>‚ÄúThe Things Network‚Äù</strong> and click <strong>‚ÄúSelect‚Äù</strong></p>
<p><img src="https://lupyuen.github.io/images/grafana-datasource2.png" alt="Data Source for The Things Network" /></p>
<p>Fill in the values copied from our <strong>MQTT Server at The Things Network</strong>‚Ä¶</p>
<ul>
<li>
<p><strong>Name</strong>: Use the default</p>
</li>
<li>
<p><strong>Host</strong>: Public Address of our MQTT Server</p>
</li>
<li>
<p><strong>Port</strong>: 1883</p>
</li>
<li>
<p><strong>Username</strong>: Username for our MQTT Server</p>
</li>
<li>
<p><strong>Password</strong>: Password for our MQTT Server</p>
</li>
</ul>
<p><img src="https://lupyuen.github.io/images/grafana-config.png" alt="Configuring the Grafana Data Source for The Things Network" /></p>
<p>Click <strong>‚ÄúSave &amp; Test‚Äù</strong></p>
<p>We should see the message <strong>‚ÄúMQTT Connected‚Äù</strong>‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/grafana-config2.png" alt="MQTT Connected" /></p>
<h1 id="grafana-dashboard" class="section-header"><a href="#grafana-dashboard">3 Grafana Dashboard</a></h1>
<p>TODO</p>
<p>Only one topic is supported: ‚Äú<code>all</code>‚Äù</p>
<p><img src="https://lupyuen.github.io/images/grafana-datasource3.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/grafana-dashboard2.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/grafana-filter.png" alt="" /></p>
<h1 id="cbor-concise-binary-object-representation" class="section-header"><a href="#cbor-concise-binary-object-representation">4 CBOR: Concise Binary Object Representation</a></h1>
<p>TODO</p>
<p>We assume that Message Payloads are encoded in <a href="https://en.wikipedia.org/wiki/CBOR"><strong>CBOR Format</strong></a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-json">{ &quot;t&quot;: 1234 }</pre></div>
<p>(Multiple fields are OK)</p>
<p><img src="https://lupyuen.github.io/images/grafana-cbor.png" alt="" /></p>
<p><a href="http://cbor.me/">(Source)</a></p>
<p>TODO2</p>
<p><img src="https://lupyuen.github.io/images/grafana-cbor2.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/grafana-payload.jpg" alt="" /></p>
<h1 id="transform-mqtt-messages" class="section-header"><a href="#transform-mqtt-messages">5 Transform MQTT Messages</a></h1>
<p>TODO</p>
<ul>
<li><a href="https://github.com/lupyuen/the-things-network-datasource"><strong>lupyuen/the-things-network-datasource</strong></a></li>
</ul>
<p>This Data Source is based on the MQTT data source for Grafana‚Ä¶</p>
<ul>
<li><a href="https://github.com/grafana/mqtt-datasource">github.com/grafana/mqtt-datasource</a></li>
</ul>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/grafana-code.png" alt="" /></p>
<p>TODO4</p>
<p><img src="https://lupyuen.github.io/images/grafana-code2.png" alt="" /></p>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/grafana-test.png" alt="" /></p>
<h1 id="troubleshooting" class="section-header"><a href="#troubleshooting">6 Troubleshooting</a></h1>
<p>TODO</p>
<p>To <strong>enable Debug Logs</strong>, edit‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"># For Linux:
/usr/share/grafana/conf/defaults.ini

# For macOS:
/usr/local/etc/grafana/grafana.ini

# For Windows:
C:\Program Files\GrafanaLabs\grafana\conf\defaults.ini</pre></div>
<p>And set‚Ä¶</p>
<div class="example-wrap"><pre class="language-text">[log]
level = debug</pre></div>
<p>In case of problems, check the <strong>Grafana Log</strong> at‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"># For Linux:
/var/log/grafana/grafana.log

# For Windows:
C:\Program Files\GrafanaLabs\grafana\data\log\grafana.log</pre></div>
<p><a href="https://github.com/lupyuen/the-things-network-datasource#grafana-log">(See sample Grafana Log)</a></p>
<h1 id="store-data-with-prometheus" class="section-header"><a href="#store-data-with-prometheus">7 Store Data with Prometheus</a></h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/grafana-flow2.jpg" alt="" /></p>
<h1 id="whats-next" class="section-header"><a href="#whats-next">8 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>PineDio Stack BL604</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book">Read ‚ÄúThe RISC-V BL602 / BL604 Book‚Äù</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/grafana.md"><code>lupyuen.github.io/src/grafana.md</code></a></p>
<h1 id="notes" class="section-header"><a href="#notes">9 Notes</a></h1>
<ol>
<li>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1440459917828050946">this Twitter Thread</a></li>
</ol>
<h1 id="appendix-install-grafana-and-data-source" class="section-header"><a href="#appendix-install-grafana-and-data-source">10 Appendix: Install Grafana and Data Source</a></h1>
<p>Here are the steps to install Grafana and our Data Source for The Things Network.</p>
<h2 id="install-grafana" class="section-header"><a href="#install-grafana">10.1 Install Grafana</a></h2>
<ol>
<li>
<p>Browse to <a href="https://grafana.com/oss/grafana/"><strong>grafana.com/oss/grafana</strong></a></p>
<p>Click <strong>‚ÄúGet Grafana ‚Üí Self-Managed ‚Üí Download Grafana‚Äù</strong></p>
</li>
<li>
<p>For <strong>‚ÄúEdition‚Äù</strong> select <strong>‚ÄúOSS‚Äù</strong></p>
</li>
<li>
<p>Click Linux, macOS, Windows, Arm or Docker</p>
<p>(Grafana for Linux works on WSL too)</p>
</li>
<li>
<p>Follow the instructions to download and install Grafana</p>
</li>
<li>
<p>For Linux and macOS: Start the Grafana Server</p>
<div class="example-wrap"><pre class="language-bash"># For Ubuntu and WSL
sudo service grafana-server restart
sudo service grafana-server status

# For macOS
brew services start grafana</pre></div></li>
<li>
<p>To test Grafana, browse to </p>
<p><strong><code>http://localhost:3000</code></strong></p>
<p><strong>Username:</strong> admin</p>
<p><strong>Password:</strong> admin</p>
</li>
</ol>
<h2 id="build-data-source" class="section-header"><a href="#build-data-source">10.2 Build Data Source</a></h2>
<p>(Note: Our Data Source uses the Grafana Live Streaming API, please use Grafana version 8.0 or later)</p>
<ol>
<li>
<p>For Windows: Grant <strong><code>Full Control</code></strong> permission to the <strong><code>Users</code></strong> group for the Grafana Plugins Folder‚Ä¶</p>
<div class="example-wrap"><pre class="language-text">C:\Program Files\GrafanaLabs\grafana\data\plugins</pre></div>
<p><img src="https://lupyuen.github.io/images/grafana-permission.png" alt="Permissions for plugins folder" /></p>
</li>
<li>
<p><strong>Download the Data Source</strong> into the Grafana Plugins Folder‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash">#  For Linux: Need &quot;sudo&quot; to access this folder
cd /var/lib/grafana/plugins

#  For Windows: Need to grant &quot;Full Control&quot; permission to &quot;Users&quot; group for this folder
cd C:\Program Files\GrafanaLabs\grafana\data\plugins

#  Download source files for The Things Network Data Source
git clone --recursive https://github.com/lupyuen/the-things-network-datasource</pre></div></li>
<li>
<p>Install the <strong>Build Tools</strong>‚Ä¶</p>
<p><a href="https://github.com/grafana/mqtt-datasource/issues/15#issuecomment-894477802"><strong>Build Tools for Linux (Ubuntu)</strong></a></p>
<p><a href="https://lupyuen.github.io/articles/grafana#appendix-install-build-tools-for-macos">__Build Tools for macOS</a></p>
<p><a href="https://github.com/grafana/mqtt-datasource/issues/15#issuecomment-894534196"><strong>Build Tools for Windows</strong></a></p>
<p><a href="https://grafana.com/tutorials/build-a-streaming-data-source-plugin/">(More details here)</a></p>
</li>
<li>
<p><strong>Build the Data Source</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash">#  Install the dependencies
cd the-things-network-datasource
yarn install

#  Build the Data Source (React + Go)
yarn build</pre></div>
<p><a href="https://github.com/lupyuen/the-things-network-datasource#build-log">(See the Build Log)</a></p>
</li>
<li>
<p>If ‚Äú<code>yarn build</code>‚Äù fails on Windows, edit <code>package.json</code> and replace ‚Äú<code>rm -rf</code>‚Äù by ‚Äú<code>rimraf</code>‚Äù</p>
</li>
<li>
<p><strong>Restart the Grafana Service</strong> for the Data Source to load</p>
<div class="example-wrap"><pre class="language-bash"># For Ubuntu and WSL:
sudo service grafana-server restart
sudo service grafana-server status

# For macOS:
brew services restart grafana

# For Windows: Run this as Administrator
net stop grafana
net start grafana</pre></div></li>
</ol>
<h2 id="enable-data-source" class="section-header"><a href="#enable-data-source">10.3 Enable Data Source</a></h2>
<ol>
<li>
<p>Edit the <strong>Grafana Configuration File</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"># For Linux:
/usr/share/grafana/conf/defaults.ini

# For macOS:
/usr/local/etc/grafana/grafana.ini

# For Windows:
C:\Program Files\GrafanaLabs\grafana\conf\defaults.ini</pre></div></li>
<li>
<p>To <strong>enable our Data Source</strong>, set‚Ä¶</p>
<div class="example-wrap"><pre class="language-text">[plugins]
allow_loading_unsigned_plugins = the-things-network-datasource</pre></div></li>
<li>
<p>To <strong>enable Debug Logs</strong>, set‚Ä¶</p>
<div class="example-wrap"><pre class="language-text">[log]
level = debug</pre></div></li>
<li>
<p><strong>Restart the Grafana Service</strong> for the Data Source to load</p>
<div class="example-wrap"><pre class="language-bash"># For Ubuntu and WSL:
sudo service grafana-server restart
sudo service grafana-server status

# For macOS:
brew services restart grafana

# For Windows: Run this as Administrator
net stop grafana
net start grafana</pre></div></li>
<li>
<p>In case of problems, check the <strong>Grafana Log</strong> at‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"># For Linux:
/var/log/grafana/grafana.log

# For Windows:
C:\Program Files\GrafanaLabs\grafana\data\log\grafana.log</pre></div>
<p><a href="https://github.com/lupyuen/the-things-network-datasource#grafana-log">(See sample Grafana Log)</a></p>
</li>
</ol>
<h1 id="appendix-install-build-tools-for-macos" class="section-header"><a href="#appendix-install-build-tools-for-macos">11 Appendix: Install Build Tools for macOS</a></h1>
<p>To install the tools for building our Grafana Data Source on macOS‚Ä¶</p>
<ol>
<li>
<p>Install <strong>Node.js v14</strong> or later‚Ä¶</p>
<p><a href="https://nodejs.org"><strong><code>nodejs.org</code></strong></a></p>
</li>
<li>
<p>Install <strong>Yarn</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash">npm install -g yarn</pre></div></li>
<li>
<p>Install <strong>Go</strong>‚Ä¶</p>
<p><a href="https://golang.org"><strong><code>golang.org</code></strong></a></p>
</li>
<li>
<p>Install <strong>Mage</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash">go get -u -d github.com/magefile/mage

pushd $GOPATH/src/github.com/magefile/mage

go run bootstrap.go

mage -version

# Shows:
# Mage Build Tool v1.11.0-2-g4cf3cfc
# Build Date: 2021-08-03T11:57:28-07:00
# Commit: 4cf3cfc
# built with: go1.13.8

popd</pre></div></li>
</ol>

    
</body>
</html>