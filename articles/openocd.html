<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Connect PineCone BL602 to OpenOCD</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Connect PineCone BL602 to OpenOCD" 
    data-rh="true">
<meta property="og:description" 
    content="How we connect PineCone BL602 Evaluation Board to OpenOCD... For flashing and debugging RISC-V firmware" 
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/openocd-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Connect PineCone BL602 to OpenOCD</h1>
    <nav id="TOC"><ul>
<li><a href="#what-is-openocd">1 What is OpenOCD?</a><ul>
<li><a href="#openocd-vs-uart-flashing">1.1 OpenOCD vs UART Flashing</a><ul></ul></li>
<li><a href="#openocd-alternatives">1.2 OpenOCD Alternatives</a><ul></ul></li></ul></li>
<li><a href="#what-is-jtag">2 What is JTAG?</a><ul>
<li><a href="#jtag-vs-swd">2.1 JTAG vs SWD</a><ul></ul></li></ul></li>
<li><a href="#wheres-the-jtag-port">3 Where's the JTAG Port?</a><ul></ul></li>
<li><a href="#connect-jtag-debugger-to-pinecone">4 Connect JTAG Debugger to PineCone</a><ul></ul></li>
<li><a href="#download-and-run-openocd">5 Download and run OpenOCD</a><ul>
<li><a href="#download-openocd">5.1 Download OpenOCD</a><ul></ul></li>
<li><a href="#download-openocd-script">5.2 Download OpenOCD Script</a><ul></ul></li>
<li><a href="#run-openocd">5.3 Run OpenOCD</a><ul></ul></li>
<li><a href="#openocd-output">5.4 OpenOCD Output</a><ul></ul></li>
<li><a href="#troubleshoot-openocd">5.5 Troubleshoot OpenOCD</a><ul></ul></li></ul></li>
<li><a href="#openocd-script">6 OpenOCD Script</a><ul>
<li><a href="#debug-logging">6.1 Debug Logging</a><ul></ul></li>
<li><a href="#openocd-driver">6.2 OpenOCD Driver</a><ul></ul></li>
<li><a href="#ftdi-channel">6.3 FTDI Channel</a><ul></ul></li>
<li><a href="#jtag-speed">6.4 JTAG Speed</a><ul></ul></li>
<li><a href="#cpu-id">6.5 CPU ID</a><ul></ul></li>
<li><a href="#restart-pinecone">6.6 Restart PineCone</a><ul></ul></li>
<li><a href="#wait-for-gdb-and-tcl-commands">6.7 Wait for GDB and TCL Commands</a><ul></ul></li></ul></li>
<li><a href="#if-you-love-the-led-set-it-free">7 If you love the LED... Set it free!</a><ul>
<li><a href="#free-the-led-from-jtag-port">7.1 Free the LED from JTAG Port</a><ul></ul></li></ul></li>
<li><a href="#remap-the-jtag-port">8 Remap the JTAG Port</a><ul>
<li><a href="#before-and-after">8.1 Before and After</a><ul></ul></li></ul></li>
<li><a href="#test-the-remapped-jtag-port">9 Test the Remapped JTAG Port</a><ul>
<li><a href="#connect-the-remapped-jtag-port">9.1 Connect the Remapped JTAG Port</a><ul></ul></li>
<li><a href="#download-the-remap-firmware">9.2 Download the Remap Firmware</a><ul></ul></li>
<li><a href="#flash-the-remap-firmware">9.3 Flash the Remap Firmware</a><ul></ul></li>
<li><a href="#start-the-remap-firmware">9.4 Start the Remap Firmware</a><ul></ul></li>
<li><a href="#run-openocd-1">9.5 Run OpenOCD</a><ul></ul></li>
<li><a href="#remove-the-remap-firmware">9.6 Remove the Remap Firmware</a><ul></ul></li></ul></li>
<li><a href="#how-to-fix-the-jtag-port">10 How to fix the JTAG Port</a><ul>
<li><a href="#redesign-the-pinecone-hardware">10.1 Redesign the PineCone Hardware</a><ul></ul></li>
<li><a href="#keep-pinecone-as-is">10.2 Keep PineCone as is</a><ul></ul></li>
<li><a href="#integrate-jtag-debugger-with-pinecone">10.3 Integrate JTAG Debugger with PineCone</a><ul></ul></li></ul></li>
<li><a href="#whats-next">11 What's Next</a><ul></ul></li></ul></nav><p><img src="https://lupyuen.github.io/images/openocd-title.jpg" alt="PineCone BL602 RISC-V Evaluation Board connected to Sipeed JTAG Debugger" /></p>
<p><em>PineCone BL602 RISC-V Evaluation Board connected to Sipeed JTAG Debugger</em></p>
<p>Today we'll learn to connect the <a href="https://lupyuen.github.io/articles/pinecone"><strong>PineCone BL602 RISC-V Evaluation Board</strong></a> to OpenOCD for flashing and debugging PineCone firmware.</p>
<h1 id="what-is-openocd" class="section-header"><a href="#what-is-openocd">1 What is OpenOCD?</a></h1>
<p><strong>OpenOCD</strong> is the open source software that runs on our computer and connects to microcontrollers (like PineCone) to...</p>
<ol>
<li>
<p><strong>Flash our firmware</strong> to the microcontroller's (PineCone's) internal Flash Memory</p>
</li>
<li>
<p><strong>Debug our firmware</strong>: Set breakpoints, step through code, examine the variables</p>
</li>
</ol>
<p>Most development tools (like VSCode) work with OpenOCD for flashing and debugging firmware.</p>
<p>Thus it's important to get PineCone talking to OpenOCD, so that our development tools will work with PineCone.</p>
<p>(<a href="https://github.com/lupyuen/bl602-rust-guide">Rust for PineCone</a> also uses OpenOCD for flashing and debugging)</p>
<p>PineCone exposes a <strong>JTAG Port</strong> that works with OpenOCD for flashing and debugging firmware. </p>
<p>This is similar to the SWD Port that's found in PineTime, STM32 Blue Pill and other Arm microcontrollers.</p>
<p>We'll learn about JTAG in the next section.</p>
<h2 id="openocd-vs-uart-flashing" class="section-header"><a href="#openocd-vs-uart-flashing">1.1 OpenOCD vs UART Flashing</a></h2>
<p><em>Doesn't PineCone support UART flashing? Why use OpenOCD and JTAG?</em></p>
<p>Yes we may flash our firmware to PineCone via a Serial USB connection to PineCone's UART Port. <a href="https://lupyuen.github.io/articles/pinecone">More about this</a></p>
<p>However it uses a flashing protocol that's designed specifically for BL602 devices. The flashing protocol is not supported by popular tools like VSCode.</p>
<p>BL602 doesn't support debugging over UART. For serious firmware coding on BL602, OpenOCD is the best option.</p>
<p>(I have a hunch that flashing firmware over UART will be faster than JTAG... We'll find out soon)</p>
<h2 id="openocd-alternatives" class="section-header"><a href="#openocd-alternatives">1.2 OpenOCD Alternatives</a></h2>
<p><em>OpenOCD has been around for a while. Are there newer tools for flashing and debugging?</em></p>
<p>There's a newer alternative to OpenOCD that's built with Rust: <a href="https://probe.rs/">probe.rs</a></p>
<p>It has beta support for JTAG. Hopefully we can use it with PineCone someday.</p>
<p>But for today, we'll learn to use OpenOCD and JTAG with PineCone.</p>
<p><img src="https://lupyuen.github.io/images/pinecone-sipeed.jpg" alt="Sipeed JTAG Debugger" /></p>
<p><em>Sipeed JTAG Debugger with the JTAG Pins: TMS, TCK, TDI, TDO, GND</em></p>
<h1 id="what-is-jtag" class="section-header"><a href="#what-is-jtag">2 What is JTAG?</a></h1>
<p>PineCone's <strong>JTAG Port</strong> is a standard port for flashing and debugging firmware, available on most RISC-V microcontrollers (like SiFive FE310 and GigaDevice GD32 VF103).</p>
<p>JTAG uses these pins...</p>
<ol>
<li><strong>TMS (Test Mode Select)</strong>: Select the JTAG operation to be executed</li>
<li><strong>TCK (Test Clock)</strong>: Synchronise the serial input/output bits</li>
<li><strong>TDI (Test Data Input)</strong>: Serial data input</li>
<li><strong>TDO (Test Data Output)</strong>: Serial data output</li>
<li><strong>GND (Ground)</strong>: Always connect the Ground Pin, or JTAG will get wonky</li>
</ol>
<p>(If you stare at it... Yep JTAG looks like SPI!)</p>
<p>We'll connect the JTAG Port on PineCone to our computer with a JTAG Debugger, like the <a href="https://www.seeedstudio.com/Sipeed-USB-JTAG-TTL-RISC-V-Debugger-p-2910.html">Sipeed JTAG Debugger</a> shown above.</p>
<p><em>Why are the JTAG Pins named &quot;Test&quot;?</em></p>
<p>Because JTAG was originally created for testing Printed Circuit Boards. JTAG stands for Joint Test Action Group, the maintainers of the JTAG standard.</p>
<p><a href="https://www.allaboutcircuits.com/technical-articles/introduction-to-jtag-test-access-port-tap/">More about JTAG</a></p>
<h2 id="jtag-vs-swd" class="section-header"><a href="#jtag-vs-swd">2.1 JTAG vs SWD</a></h2>
<p><em>Is SWD supported for flashing and debugging firmware on PineCone?</em></p>
<p>Sorry no. SWD is available only on Arm Microcontrollers. <a href="https://medium.com/@ly.lee/openocd-on-raspberry-pi-better-with-swd-on-spi-7dea9caeb590?source=friends_link&amp;sk=df399bfd913d3e262447d28aa5af6b63">(SWD was created by Arm)</a></p>
<p>SWD is derived from JTAG... It takes the 4 pins from JTAG and smashes them into 2 pins SWDCLK (Clock) and SWDIO (Birectional Data). <a href="https://en.wikipedia.org/wiki/JTAG#Similar_interface_standards">More details</a></p>
<p>Let's go deep into the JTAG Port on PineCone...</p>
<p><img src="https://lupyuen.github.io/images/pinecone-jtag.png" alt="Default JTAG Port on PineCone" /></p>
<p><em>Default JTAG Port on PineCone</em></p>
<h1 id="wheres-the-jtag-port" class="section-header"><a href="#wheres-the-jtag-port">3 Where's the JTAG Port?</a></h1>
<p>BL602 is an interesting microcontroller... Each pin may be remapped to various functions: GPIO, SPI, I2C, UART, PWM, ADC, SDIO, even JTAG!</p>
<p>To find the default JTAG Pins, we refer to...</p>
<ul>
<li>
<p><a href="https://github.com/pine64/bl602-docs/blob/main/mirrored/Bouffalo%20Lab%20BL602_Reference_Manual_en_1.1.pdf">BL602 Reference Manual</a></p>
<p>Section 3.2.8, &quot;GPIO Function&quot; (Pages 27 to 40)</p>
</li>
<li>
<p><a href="https://github.com/pine64/bl602-docs/blob/main/mirrored/Pine64%20BL602%20EVB%20Schematic%20ver%201.1.pdf">PineCone Schematics</a></p>
<p>&quot;Module Interface&quot;</p>
</li>
</ul>
<p>(See the pic above)</p>
<p>Based on the above docs, the JTAG Port is located at the following pins whenever we boot or reset PineCone...</p>
<table><thead><tr><th align="center">JTAG Pin</th><th align="left">PineCone Pin</th></tr></thead><tbody>
<tr><td align="center"><strong><code>TDO</code></strong></td><td align="left"><code>IO 11</code></td></tr>
<tr><td align="center"><strong><code>TMS</code></strong></td><td align="left"><code>IO 12</code></td></tr>
<tr><td align="center"><strong><code>TCK</code></strong></td><td align="left"><code>IO 14</code></td></tr>
<tr><td align="center"><strong><code>TDI</code></strong></td><td align="left"><code>IO 17</code></td></tr>
<tr><td align="center"><strong><code>GND</code></strong></td><td align="left"><code>GND</code></td></tr>
</tbody></table>
<p>Before connecting PineCone to our JTAG Debugger, we need to <a href="https://lupyuen.github.io/images/pinecone-solder.jpg">solder the headers</a> to the PineCone board and expose the above JTAG Pins.</p>
<p><img src="https://lupyuen.github.io/images/pinecone-headers.jpg" alt="Default JTAG Port connected to JTAG Debugger" /></p>
<p><em>Default JTAG Port connected to JTAG Debugger. Jumper is set to H, for Bootloader Mode. LED is lit with multiple colours when JTAG is active.</em></p>
<h1 id="connect-jtag-debugger-to-pinecone" class="section-header"><a href="#connect-jtag-debugger-to-pinecone">4 Connect JTAG Debugger to PineCone</a></h1>
<p>The instructions here will work with <a href="https://www.seeedstudio.com/Sipeed-USB-JTAG-TTL-RISC-V-Debugger-p-2910.html">Sipeed JTAG Debugger</a> and other JTAG Debuggers based on FTDI FT2232.</p>
<ul>
<li>
<p><a href="https://mcuoneclipse.com/2019/10/20/jtag-debugging-the-esp32-with-ft2232-and-openocd/">Make your own JTAG Debugger with FT2232</a></p>
</li>
<li>
<p><a href="https://tang.sipeed.com/en/hardware-overview/rv-debugger/?utm_source=platformio&amp;utm_medium=docs">Compare with Schematics of Sipeed JTAG Debugger</a></p>
</li>
</ul>
<p>Now we connect the JTAG Debugger to PineCone...</p>
<ol>
<li>
<p>Connect our JTAG Debugger to the PineCone Pins</p>
<table><thead><tr><th align="center">JTAG Debugger</th><th align="left">PineCone Pin</th><th align="left">Wire Colour</th></tr></thead><tbody>
<tr><td align="center"><strong><code>TDO</code></strong></td><td align="left"><code>IO 11</code></td><td align="left">Blue</td></tr>
<tr><td align="center"><strong><code>TMS</code></strong></td><td align="left"><code>IO 12</code></td><td align="left">Yellow</td></tr>
<tr><td align="center"><strong><code>TCK</code></strong></td><td align="left"><code>IO 14</code></td><td align="left">Green</td></tr>
<tr><td align="center"><strong><code>TDI</code></strong></td><td align="left"><code>IO 17</code></td><td align="left">Red</td></tr>
<tr><td align="center"><strong><code>GND</code></strong></td><td align="left"><code>GND</code></td><td align="left">Black</td></tr>
</tbody></table>
<p>(See pic above)</p>
</li>
<li>
<p>Connect the JTAG Debugger to our computer's USB Port</p>
</li>
<li>
<p>Connect PineCone to our computer's USB Port</p>
<p>(Yes we'll need two USB ports on our computer)</p>
</li>
<li>
<p>Follow these instructions to install the FT2232 drivers for Linux, macOS and Windows...</p>
<ul>
<li>
<p><a href="https://docs.platformio.org/en/latest/plus/debug-tools/sipeed-rv-debugger.html#drivers">Install FT2232 Drivers on Linux, macOS and Windows</a></p>
</li>
<li>
<p>For Windows: Follow the steps above. Then use the Zadig Tool to install the WinUSB Driver for BOTH <code>Dual RS232 (Interface 0)</code> and <code>Dual RS232 (Interface 1)</code></p>
</li>
</ul>
</li>
</ol>
<p>We're ready to download and run OpenOCD...</p>
<p><img src="https://lupyuen.github.io/images/pinecone-jtag-ftdi.jpg" alt="Sipeed JTAG Debugger is powered by FTDI FT2232D" /></p>
<p><em>Sipeed JTAG Debugger is powered by FTDI FT2232D</em></p>
<h1 id="download-and-run-openocd" class="section-header"><a href="#download-and-run-openocd">5 Download and run OpenOCD</a></h1>
<p>Here are the steps to download and run OpenOCD with PineCone on Linux, macOS and Windows...</p>
<h2 id="download-openocd" class="section-header"><a href="#download-openocd">5.1 Download OpenOCD</a></h2>
<p>Download OpenOCD from the <a href="https://github.com/xpack-dev-tools/openocd-xpack/releases/tag/v0.10.0-15/">xPack OpenOCD site</a>... (Other variants of OpenOCD may not work with PineCone)</p>
<ul>
<li>
<p><a href="https://github.com/xpack-dev-tools/openocd-xpack/releases/download/v0.10.0-15/xpack-openocd-0.10.0-15-linux-x64.tar.gz">xPack OpenOCD for Linux x64</a></p>
</li>
<li>
<p><a href="https://github.com/xpack-dev-tools/openocd-xpack/releases/download/v0.10.0-15/xpack-openocd-0.10.0-15-linux-arm64.tar.gz">xPack OpenOCD for Linux Arm64</a></p>
</li>
<li>
<p><a href="https://github.com/xpack-dev-tools/openocd-xpack/releases/download/v0.10.0-15/xpack-openocd-0.10.0-15-darwin-x64.tar.gz">xPack OpenOCD for macOS x64</a></p>
</li>
<li>
<p><a href="https://github.com/xpack-dev-tools/openocd-xpack/releases/download/v0.10.0-15/xpack-openocd-0.10.0-15-win32-x64.zip">xPack OpenOCD for Windows x64</a></p>
</li>
<li>
<p><a href="https://github.com/xpack-dev-tools/openocd-xpack/releases/tag/v0.10.0-15/">Other builds of xPack OpenOCD</a></p>
</li>
</ul>
<p>Extract the downloaded file. On Windows: <a href="https://www.7-zip.org/">Use 7-Zip</a></p>
<h2 id="download-openocd-script" class="section-header"><a href="#download-openocd-script">5.2 Download OpenOCD Script</a></h2>
<p>Open a command prompt and enter...</p>
<pre><code class="language-bash">git clone --recursive https://github.com/lupyuen/pinecone-rust
</code></pre>
<p>If we will be coding Rust Firmware for PineCone, enter these commands too...</p>
<pre><code class="language-bash">git clone --recursive https://github.com/sipeed/bl602-pac
git clone --recursive https://github.com/sipeed/bl602-hal
</code></pre>
<h2 id="run-openocd" class="section-header"><a href="#run-openocd">5.3 Run OpenOCD</a></h2>
<p>At the command prompt, enter...</p>
<pre><code class="language-bash">cd pinecone-rust
OPENOCD_DIRECTORY/bin/openocd
</code></pre>
<p>For Windows: Enter...</p>
<pre><code class="language-cmd">cd pinecone-rust
OPENOCD_DIRECTORY\bin\openocd
</code></pre>
<p>Change <code>OPENOCD_DIRECTORY</code> to the directory that contains the extracted xPack OpenOCD files.</p>
<h2 id="openocd-output" class="section-header"><a href="#openocd-output">5.4 OpenOCD Output</a></h2>
<p>We should see this output in OpenOCD...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">xPack</span> <span class="ident">OpenOCD</span>, <span class="ident">x86_64</span> <span class="ident">Open</span> <span class="ident">On</span><span class="op">-</span><span class="ident">Chip</span> <span class="ident">Debugger</span> <span class="number">0.10</span>.<span class="number">0</span><span class="op">+</span><span class="ident">dev</span><span class="op">-</span><span class="number">00378</span><span class="op">-</span><span class="ident">ge5be992df</span> (<span class="number">2020</span><span class="op">-</span><span class="number">06</span><span class="op">-</span><span class="number">26</span><span class="op">-</span><span class="number">12</span>:<span class="number">31</span>)
<span class="ident">Licensed</span> <span class="ident">under</span> <span class="ident">GNU</span> <span class="ident">GPL</span> <span class="ident">v2</span>
<span class="ident">For</span> <span class="ident">bug</span> <span class="ident">reports</span>, <span class="ident">read</span>
        <span class="ident">http</span>:<span class="comment">//openocd.org/doc/doxygen/bugs.html</span>
<span class="ident">Ready</span> <span class="kw">for</span> <span class="ident">Remote</span> <span class="ident">Connections</span>
<span class="ident">Info</span> : <span class="ident">clock</span> <span class="ident">speed</span> <span class="number">100</span> <span class="ident">kHz</span>
<span class="ident">Info</span> : <span class="ident">JTAG</span> <span class="ident">tap</span>: <span class="ident">riscv</span>.<span class="ident">cpu</span> <span class="ident">tap</span><span class="op">/</span><span class="ident">device</span> <span class="ident">found</span>: <span class="number">0x20000c05</span> (<span class="ident">mfg</span>: <span class="number">0x602</span> (<span class="op">&lt;</span><span class="ident">unknown</span><span class="op">&gt;</span>), <span class="ident">part</span>: <span class="number">0x0000</span>, <span class="ident">ver</span>: <span class="number">0x2</span>)</pre></div>
<p>Notice the mysterious number <code>0x20000c05</code>?</p>
<p>This is very important... <code>0x20000c05</code> is the CPU ID that identifies the BL602 Microcontroller. It shows that our JTAG connection is OK.</p>
<p>If we see any CPU ID other than <code>0x20000c05</code>, it probably means that our JTAG connection is loose. Or that we have connected our JTAG Debugger to the incorrect PineCone Pins.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Info</span> : <span class="ident">datacount</span><span class="op">=</span><span class="number">1</span> <span class="ident">progbufsize</span><span class="op">=</span><span class="number">2</span>
<span class="ident">Info</span> : <span class="ident">Disabling</span> <span class="kw">abstract</span> <span class="ident">command</span> <span class="ident">reads</span> <span class="ident">from</span> <span class="ident">CSRs</span>.
<span class="ident">Info</span> : <span class="ident">Examined</span> <span class="ident">RISC</span><span class="op">-</span><span class="ident">V</span> <span class="ident">core</span>; <span class="ident">found</span> <span class="number">1</span> <span class="ident">harts</span>
<span class="ident">Info</span> :  <span class="ident">hart</span> <span class="number">0</span>: <span class="ident">XLEN</span><span class="op">=</span><span class="number">32</span>, <span class="ident">misa</span><span class="op">=</span><span class="number">0x40801125</span>
<span class="ident">Info</span> : <span class="ident">starting</span> <span class="ident">gdb</span> <span class="ident">server</span> <span class="kw">for</span> <span class="ident">riscv</span>.<span class="ident">cpu</span>.<span class="number">0</span> <span class="ident">on</span> <span class="number">3333</span>
<span class="ident">Info</span> : <span class="ident">Listening</span> <span class="ident">on</span> <span class="ident">port</span> <span class="number">3333</span> <span class="kw">for</span> <span class="ident">gdb</span> <span class="ident">connections</span></pre></div>
<p>Then we see some info about PineCone's BL602 Microcontroller. And we see that OpenOCD is ready to accept debugging commands from GDB.</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Info</span> : <span class="ident">JTAG</span> <span class="ident">tap</span>: <span class="ident">riscv</span>.<span class="ident">cpu</span> <span class="ident">tap</span><span class="op">/</span><span class="ident">device</span> <span class="ident">found</span>: <span class="number">0x20000c05</span> (<span class="ident">mfg</span>: <span class="number">0x602</span> (<span class="op">&lt;</span><span class="ident">unknown</span><span class="op">&gt;</span>), <span class="ident">part</span>: <span class="number">0x0000</span>, <span class="ident">ver</span>: <span class="number">0x2</span>)
<span class="ident">reset</span><span class="op">-</span><span class="ident">assert</span><span class="op">-</span><span class="ident">pre</span>
<span class="ident">reset</span><span class="op">-</span><span class="ident">deassert</span><span class="op">-</span><span class="ident">post</span>
<span class="ident">Info</span> : <span class="ident">Disabling</span> <span class="kw">abstract</span> <span class="ident">command</span> <span class="ident">writes</span> <span class="ident">to</span> <span class="ident">CSRs</span>.
<span class="ident">reset</span><span class="op">-</span><span class="ident">init</span>
<span class="ident">Info</span> : <span class="ident">Listening</span> <span class="ident">on</span> <span class="ident">port</span> <span class="number">6666</span> <span class="kw">for</span> <span class="ident">tcl</span> <span class="ident">connections</span></pre></div>
<p>Finally OpenOCD restarts the JTAG connection. And it listens for OpenOCD (TCL) commands.</p>
<p>If we see CPU ID <code>0x20000c05</code> and the messages above... Congratulations OpenOCD is now connected to PineCone's JTAG Port!</p>
<p>OpenOCD is all ready to flash and debug PineCone firmware. (Which we'll cover in the next article)</p>
<p>To stop OpenOCD and disconnect from PineCone, press <code>Ctrl-C</code>.</p>
<h2 id="troubleshoot-openocd" class="section-header"><a href="#troubleshoot-openocd">5.5 Troubleshoot OpenOCD</a></h2>
<p>If we see...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Error</span>: <span class="ident">unable</span> <span class="ident">to</span> <span class="ident">open</span> <span class="ident">ftdi</span> <span class="ident">device</span> <span class="ident">with</span> <span class="ident">vid</span> <span class="number">0403</span>, <span class="ident">pid</span> <span class="number">6010</span>, <span class="ident">description</span> <span class="string">&#39;*&#39;</span>, <span class="ident">serial</span> <span class="string">&#39;*&#39;</span> <span class="ident">at</span> <span class="ident">bus</span> <span class="ident">location</span> <span class="string">&#39;*&#39;</span></pre></div>
<p>It means that OpenOCD couldn't detect the JTAG Debugger. Check that the FT2232 drivers are installed correctly.</p>
<p>If we see...</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="ident">Error</span>: <span class="ident">failed</span> <span class="ident">read</span> <span class="ident">at</span> <span class="number">0x11</span>, <span class="ident">status</span><span class="op">=</span><span class="number">1</span>
<span class="ident">Error</span>: <span class="ident">Hart</span> <span class="number">0</span> <span class="ident">is</span> <span class="ident">unavailable</span>.
<span class="ident">Error</span>: <span class="ident">Hart</span> <span class="number">0</span> <span class="ident">doesn</span><span class="lifetime">&#39;t</span> <span class="ident">exist</span>.
<span class="ident">Info</span> : <span class="ident">Hart</span> <span class="number">0</span> <span class="ident">unexpectedly</span> <span class="macro">reset</span><span class="macro">!</span>
<span class="ident">Error</span>: <span class="ident">failed</span> <span class="ident">read</span> <span class="ident">at</span> <span class="number">0x11</span>, <span class="ident">status</span><span class="op">=</span><span class="number">1</span></pre></div>
<p>Check that the <code>GND</code> Pin is connected from the JTAG Debugger to PineCone.</p>
<p><a href="https://mcuoneclipse.com/2019/10/20/jtag-debugging-the-esp32-with-ft2232-and-openocd/">More tips on connecting OpenOCD to FT2232</a></p>
<h1 id="openocd-script" class="section-header"><a href="#openocd-script">6 OpenOCD Script</a></h1>
<p>The OpenOCD connection to PineCone is controlled by the OpenOCD Script <a href="https://github.com/lupyuen/pinecone-rust/blob/main/openocd.cfg"><code>pinecone-rust/openocd.cfg</code></a>.</p>
<p>Our OpenOCD Script is based on the one kindly contributed by the <a href="https://github.com/sipeed/bl602-rust-guide">Sipeed BL602 Community</a>.</p>
<p>Let's study the important bits of our OpenOCD Script: <a href="https://github.com/lupyuen/pinecone-rust/blob/main/openocd.cfg"><code>pinecone-rust/openocd.cfg</code></a></p>
<h2 id="debug-logging" class="section-header"><a href="#debug-logging">6.1 Debug Logging</a></h2>
<pre><code class="language-text"># Uncomment to enable debug messages
# debug_level 4
</code></pre>
<p>To show debug messages in OpenOCD, uncomment the <code>debug_level</code> line. (Remove the leading &quot;<code>#</code>&quot;)</p>
<p>This is useful for troubleshooting the OpenOCD connection to PineCone. OpenOCD will show every single JTAG packet transmitted between our computer and PineCone.</p>
<h2 id="openocd-driver" class="section-header"><a href="#openocd-driver">6.2 OpenOCD Driver</a></h2>
<pre><code class="language-text">adapter driver ftdi

ftdi_vid_pid 0x0403 0x6010
</code></pre>
<p>Here we tell OpenOCD to use the FT2232 debugger that's connected to USB.</p>
<p><code>0x0403</code> is the USB Vendor ID for FT2232. <code>0x6010</code> is the USB Product ID.</p>
<h2 id="ftdi-channel" class="section-header"><a href="#ftdi-channel">6.3 FTDI Channel</a></h2>
<pre><code class="language-text"># Sipeed JTAG Debugger uses FTDI Channel 0, not 1
ftdi_channel 0
# Previously: ftdi_channel 1
</code></pre>
<p>According to the <a href="https://www.ftdichip.com/Support/Documents/DataSheets/ICs/DS_FT2232D.pdf">FT2232 Specs</a>, the FT2232 module supports two Serial Channels: 0 and 1.</p>
<p>For Sipeed JTAG Debugger: The FTDI Channel must be 0. <a href="https://tang.sipeed.com/en/hardware-overview/rv-debugger/?utm_source=platformio&amp;utm_medium=docs">See the schematics</a></p>
<p>For other JTAG Debuggers: Set the FTDI Channel to 0 if PineCone is connected to the first Serial Channel, and to 1 for the second Serial Channel.</p>
<h2 id="jtag-speed" class="section-header"><a href="#jtag-speed">6.4 JTAG Speed</a></h2>
<pre><code class="language-text">transport select jtag

# TODO: Increase the adapter speed (now 100 kHz)
adapter speed 100
# Previously: adapter speed 2000
</code></pre>
<p>Here we select JTAG as the communication protocol for talking to PineCone.</p>
<p>Our OpenOCD Script talks to PineCone at 100 kbps, which is a safe (but slow) data rate that works with most JTAG Debuggers.</p>
<p>We should increase the Adapter Speed to speed up the data transfer. (After lots of testing, of course)</p>
<h2 id="cpu-id" class="section-header"><a href="#cpu-id">6.5 CPU ID</a></h2>
<pre><code class="language-text">set _CHIPNAME riscv
jtag newtap $_CHIPNAME cpu -irlen 5 -expected-id 0x20000c05
</code></pre>
<p>This is the part that verifies BL602's CPU ID: <code>0x20000c05</code></p>
<p>This should never be changed. (Unless we're connecting to a different microcontroller)</p>
<h2 id="restart-pinecone" class="section-header"><a href="#restart-pinecone">6.6 Restart PineCone</a></h2>
<pre><code class="language-text">init
reset init
</code></pre>
<p>The <code>init</code> command initiates the JTAG connection to PineCone, and verifies the CPU ID of our BL602 Microcontroller.</p>
<p><code>reset init</code> triggers a reboot of PineCone. (Similar to pressing the <code>RST</code> button on PineCone)</p>
<h2 id="wait-for-gdb-and-tcl-commands" class="section-header"><a href="#wait-for-gdb-and-tcl-commands">6.7 Wait for GDB and TCL Commands</a></h2>
<p>After executing our script, OpenOCD waits to receive GDB Debugging commands and OpenOCD TCL commands.</p>
<p>For some OpenOCD Scripts (like for flashing firmware), we don't need OpenOCD to wait for further commands. In such scripts, we terminate OpenOCD with the <code>exit</code> command...</p>
<pre><code class="language-text"># Terminate OpenOCD
exit
</code></pre>
<p>See the complete OpenOCD Script: <a href="https://github.com/lupyuen/pinecone-rust/blob/main/openocd.cfg"><code>pinecone-rust/openocd.cfg</code></a></p>
<p><a href="https://twitter.com/gamelaster/status/1335997851151835140?s=20">Check out the awesome work on PineCone OpenOCD by @gamelaster</a></p>
<p><a href="http://openocd.org/doc/html/index.html">More about OpenOCD</a></p>
<p><img src="https://lupyuen.github.io/images/pinecone-led.png" alt="PineCone LED uses GPIO 11, 14, 17" /></p>
<p><em>PineCone LED uses GPIO 11, 14, 17</em></p>
<h1 id="if-you-love-the-led-set-it-free" class="section-header"><a href="#if-you-love-the-led-set-it-free">7 If you love the LED... Set it free!</a></h1>
<p><em>Why does the PineCone LED light up in colour when the JTAG Port is active?</em></p>
<p>To solve this mystery, we dig deep into the <a href="https://github.com/pine64/bl602-docs/blob/main/mirrored/Pine64%20BL602%20EVB%20Schematic%20ver%201.1.pdf">PineCone Schematics</a> and check the BL602 Pins connected to our LED... (See pic above)</p>
<table><thead><tr><th align="left">LED Pin</th><th align="left">BL602 Pin</th></tr></thead><tbody>
<tr><td align="left"><strong><code>LED Blue</code></strong></td><td align="left"><code>IO 11</code></td></tr>
<tr><td align="left"><strong><code>LED Green</code></strong></td><td align="left"><code>IO 14</code></td></tr>
<tr><td align="left"><strong><code>LED Red</code></strong></td><td align="left"><code>IO 17</code></td></tr>
</tbody></table>
<p>Aha! PineCone's LED is connected to the same pins as the JTAG Port. Which explains the disco lights during JTAG programming!</p>
<p>This is a problem... If we control the PineCone LED in our firmware, it will interfere with the JTAG Port.</p>
<p><em>Can we use PineCone's LED in our firmware... While debugging our firmware with JTAG?</em></p>
<p>According to the <a href="https://github.com/pine64/bl602-docs/blob/main/mirrored/Bouffalo%20Lab%20BL602_Reference_Manual_en_1.1.pdf">BL602 Reference Manual</a> (Section 3.2.8 &quot;GPIO Function&quot;, Page 27), we may remap the JTAG Port to other GPIO Pins (and avoid the conflict).</p>
<h2 id="free-the-led-from-jtag-port" class="section-header"><a href="#free-the-led-from-jtag-port">7.1 Free the LED from JTAG Port</a></h2>
<p>Here's our plan to free the LED from the JTAG Port...</p>
<ol>
<li>
<p>We remap the three LED pins from JTAG to PWM, so that we may to control the LED...</p>
<table><thead><tr><th align="left">LED Pin</th><th align="left">BL602 Pin</th><th align="left">Remap Pin Function</th></tr></thead><tbody>
<tr><td align="left"><strong><code>LED Blue</code></strong></td><td align="left"><code>IO 11</code></td><td align="left">JTAG → PWM</td></tr>
<tr><td align="left"><strong><code>LED Green</code></strong></td><td align="left"><code>IO 14</code></td><td align="left">JTAG → PWM</td></tr>
<tr><td align="left"><strong><code>LED Red</code></strong></td><td align="left"><code>IO 17</code></td><td align="left">JTAG → PWM</td></tr>
</tbody></table>
</li>
<li>
<p>Then we pick three unused BL602 Pins and remap them to JTAG...</p>
<table><thead><tr><th align="left">JTAG Pin</th><th align="left">BL602 Pin</th><th align="left">Remap Pin Function</th></tr></thead><tbody>
<tr><td align="left"><strong><code>JTAG TDI</code></strong></td><td align="left"><code>IO 1</code></td><td align="left">SDIO → JTAG</td></tr>
<tr><td align="left"><strong><code>JTAG TCK</code></strong></td><td align="left"><code>IO 2</code></td><td align="left">SDIO → JTAG</td></tr>
<tr><td align="left"><strong><code>JTAG TDO</code></strong></td><td align="left"><code>IO 3</code></td><td align="left">SDIO → JTAG</td></tr>
</tbody></table>
</li>
<li>
<p>We keep the JTAG TMS pin as is because it wasn't invited to the disco party...</p>
<table><thead><tr><th align="left">JTAG Pin</th><th align="left">BL602 Pin</th><th align="left">Remap Pin Function</th></tr></thead><tbody>
<tr><td align="left"><strong><code>JTAG TMS</code></strong></td><td align="left"><code>IO 12</code></td><td align="left">JTAG → JTAG</td></tr>
</tbody></table>
</li>
<li>
<p>Finally we set the GPIO Control bits for the pins remapped to JTAG...</p>
<table><thead><tr><th align="left">GPIO Control</th><th align="left">Value</th></tr></thead><tbody>
<tr><td align="left">Pull Down Control</td><td align="left">0</td></tr>
<tr><td align="left">Pull Up Control</td><td align="left">0</td></tr>
<tr><td align="left">Driving Control</td><td align="left">0</td></tr>
<tr><td align="left">SMT Control</td><td align="left">1</td></tr>
<tr><td align="left">Input Enable</td><td align="left">1</td></tr>
</tbody></table>
<p>(These values were obtained by sniffing the GPIO Control bits for the default JTAG Port)</p>
</li>
</ol>
<p>Let's study the firmware code that remaps the JTAG Port... And frees our LED!</p>
<p><img src="https://lupyuen.github.io/images/pinecone-gpio.png" alt="BL602 Configuration Register for Pins IO 0 and IO 1" /></p>
<p><em>BL602 Configuration Register for Pins IO 0 and IO 1</em></p>
<h1 id="remap-the-jtag-port" class="section-header"><a href="#remap-the-jtag-port">8 Remap the JTAG Port</a></h1>
<p>Remember that we need to remap JTAG and PWM functions of the following pins...</p>
<table><thead><tr><th align="left">LED / JTAG Pin</th><th align="left">BL602 Pin</th><th align="left">Remap Pin Function</th></tr></thead><tbody>
<tr><td align="left"><strong><code>JTAG TDI</code></strong></td><td align="left"><code>IO 1</code></td><td align="left">SDIO → JTAG</td></tr>
<tr><td align="left"><strong><code>JTAG TCK</code></strong></td><td align="left"><code>IO 2</code></td><td align="left">SDIO → JTAG</td></tr>
<tr><td align="left"><strong><code>JTAG TDO</code></strong></td><td align="left"><code>IO 3</code></td><td align="left">SDIO → JTAG</td></tr>
<tr><td align="left"><strong><code>LED Blue</code></strong></td><td align="left"><code>IO 11</code></td><td align="left">JTAG → PWM</td></tr>
<tr><td align="left"><strong><code>LED Green</code></strong></td><td align="left"><code>IO 14</code></td><td align="left">JTAG → PWM</td></tr>
<tr><td align="left"><strong><code>LED Red</code></strong></td><td align="left"><code>IO 17</code></td><td align="left">JTAG → PWM</td></tr>
</tbody></table>
<p>Here's how we write the firmware code to remap the pins: <a href="https://github.com/lupyuen/bl_iot_sdk/blob/jtag/customer_app/sdk_app_helloworld/sdk_app_helloworld/main.c#L83-L241"><code>sdk_app_helloworld/main.c</code></a></p>
<ol>
<li>
<p>According to the pic above, we configure BL602 Pin <code>IO 1</code> by writing to the memory address <code>0x40000100</code>. We'll call this address <code>GP1FUNC_ADDR</code></p>
<pre><code class="language-c">//  GPIO_CFGCTL0
//  Address：0x40000100
uint32_t *GPIO_CFGCTL0 = (uint32_t *) 0x40000100;
uint32_t *GP1FUNC_ADDR = GPIO_CFGCTL0;
</code></pre>
<p>The pic above appears in the <a href="https://github.com/pine64/bl602-docs/blob/main/mirrored/Bouffalo%20Lab%20BL602_Reference_Manual_en_1.1.pdf">BL602 Reference Manual</a>, Section 3.3.5 &quot;GPIO_CFGCTL0&quot;, Page 33.</p>
<p>(&quot;地址&quot; is Chinese for &quot;Address&quot;)</p>
</li>
<li>
<p>We'll set bits 24 to 27 of <code>GP1FUNC_ADDR</code> to select the desired Pin Function (i.e. JTAG).</p>
<p>We define the Pin Function bit shift (offset) as <code>GP1FUNC_SHIFT</code> and the bit mask as <code>GP1FUNC_MASK</code>...</p>
<pre><code class="language-c">//  27:24 GP1FUNC
const uint32_t GP1FUNC_SHIFT = 24;
const uint32_t GP1FUNC_MASK  = 0x0f &lt;&lt; GP1FUNC_SHIFT;
</code></pre>
</li>
<li>
<p>Then we'll set bits 16 to 21 of <code>GP1FUNC_ADDR</code> for the GPIO Pin Control.</p>
<p>We define the Pin Control bit shift (offset) as <code>GP1CTRL_SHIFT</code> and the bit mask as <code>GP1CTRL_MASK</code>...</p>
<pre><code class="language-c">//  21:16 GP1CTRL
const uint32_t GP1CTRL_SHIFT = 16;
const uint32_t GP1CTRL_MASK  = 0x3f &lt;&lt; GP1CTRL_SHIFT;
</code></pre>
</li>
<li>
<p>To map Pin <code>IO 1</code> to JTAG, we set the Pin Function of <code>GP1FUNC_ADDR</code> to <code>GPIO_FUN_JTAG</code>, and the Pin Control to <code>GPIO_CTRL</code></p>
<pre><code class="language-c">//  IO 1 becomes JTAG TDI. Also set the Pin Control.
*GP1FUNC_ADDR = (*GP1FUNC_ADDR &amp; ~GP1FUNC_MASK &amp; ~GP1CTRL_MASK) 
    | (GPIO_FUN_JTAG &lt;&lt; GP1FUNC_SHIFT)
    | (GPIO_CTRL     &lt;&lt; GP1CTRL_SHIFT);
</code></pre>
</li>
<li>
<p>The Pin Function values (<code>GPIO_FUN_JTAG</code> and <code>GPIO_FUN_PWM</code>) are defined as...</p>
<pre><code class="language-c">//  Pin Functions (4 bits). From components/bl602/bl602_std/bl602_std/StdDriver/Inc/bl602_gpio.h
const uint32_t GPIO_FUN_PWM  =  8;  //  Pin Function for PWM  (0x8)
const uint32_t GPIO_FUN_JTAG = 14;  //  Pin Function for JTAG (0xe)
</code></pre>
</li>
<li>
<p>The Pin Control value <code>GPIO_CTRL</code> is defined as...</p>
<pre><code class="language-c">//  Pin Control (6 bits)
//  Pull Down Control: 0 (1 bit)
//  Pull Up Control:   0 (1 bit)
//  Driving Control:   0 (2 bits)
//  SMT Control:       1 (1 bit)
//  Input Enable:      1 (1 bit)
const uint32_t GPIO_CTRL = 3;  //  Pin Control
</code></pre>
</li>
<li>
<p>We apply the above steps to remap each Pin Function and set the Pin Control bits...</p>
<table><thead><tr><th align="left">LED / JTAG Pin</th><th align="left">BL602 Pin</th><th align="left">Remap Pin Function</th></tr></thead><tbody>
<tr><td align="left"><strong><code>JTAG TDI</code></strong></td><td align="left"><code>IO 1</code></td><td align="left">SDIO → JTAG</td></tr>
<tr><td align="left"><strong><code>JTAG TCK</code></strong></td><td align="left"><code>IO 2</code></td><td align="left">SDIO → JTAG</td></tr>
<tr><td align="left"><strong><code>JTAG TDO</code></strong></td><td align="left"><code>IO 3</code></td><td align="left">SDIO → JTAG</td></tr>
<tr><td align="left"><strong><code>LED Blue</code></strong></td><td align="left"><code>IO 11</code></td><td align="left">JTAG → PWM</td></tr>
<tr><td align="left"><strong><code>LED Green</code></strong></td><td align="left"><code>IO 14</code></td><td align="left">JTAG → PWM</td></tr>
<tr><td align="left"><strong><code>LED Red</code></strong></td><td align="left"><code>IO 17</code></td><td align="left">JTAG → PWM</td></tr>
</tbody></table>
</li>
</ol>
<p>The remapping code for all 6 pins may be found here: <a href="https://github.com/lupyuen/bl_iot_sdk/blob/jtag/customer_app/sdk_app_helloworld/sdk_app_helloworld/main.c#L83-L241"><code>sdk_app_helloworld/main.c</code></a></p>
<h2 id="before-and-after" class="section-header"><a href="#before-and-after">8.1 Before and After</a></h2>
<p>Here are the values of the Pin Function and Pin Control registers before and after remapping...</p>
<table><thead><tr><th align="left">Register</th><th align="left">Before</th><th align="left">After</th><th align="left">Pin</th></tr></thead><tbody>
<tr><td align="left"><code>GPIO_CFGCTL0</code></td><td align="left"><strong><code>bb</code></strong> <strong><code>17</code></strong> <code>bb</code> <code>17</code></td><td align="left"><strong><code>ee</code></strong> <strong><code>03</code></strong> <code>bb</code> <code>17</code></td><td align="left">1</td></tr>
<tr><td align="left"><code>GPIO_CFGCTL1</code></td><td align="left"><strong><code>11</code></strong> <code>03</code> <strong><code>bb</code></strong> <strong><code>17</code></strong></td><td align="left"><strong><code>ee</code></strong> <code>03</code> <strong><code>ee</code></strong> <strong><code>03</code></strong></td><td align="left">2, 3</td></tr>
<tr><td align="left"><code>GPIO_CFGCTL5</code></td><td align="left"><strong><code>0e</code></strong> <code>03</code> <code>0b</code> <code>03</code></td><td align="left"><strong><code>08</code></strong> <code>03</code> <code>0b</code> <code>03</code></td><td align="left">11</td></tr>
<tr><td align="left"><code>GPIO_CFGCTL7</code></td><td align="left"><code>0b</code> <code>03</code> <strong><code>0e</code></strong> <code>03</code></td><td align="left"><code>0b</code> <code>03</code> <strong><code>08</code></strong> <code>03</code></td><td align="left">14</td></tr>
<tr><td align="left"><code>GPIO_CFGCTL8</code></td><td align="left"><strong><code>0e</code></strong> <code>03</code> <code>07</code> <code>17</code></td><td align="left"><strong><code>08</code></strong> <code>03</code> <code>07</code> <code>17</code></td><td align="left">17</td></tr>
</tbody></table>
<p>(Changed values have been highlighted)</p>
<p>Note that the Pin Function fields (4 bits each) have been changed to <code>0xe</code> for JTAG and <code>0x8</code> for PWM.</p>
<p>The Pin Control fields (6 bits each) have also been changed to <code>0x03</code>.</p>
<p>Let's test the remapped JTAG Port on our PineCone!</p>
<p><img src="https://lupyuen.github.io/images/pinecone-headers2.jpg" alt="Remapped PineCone Connection to JTAG Debugger" /></p>
<p><em>Remapped JTAG Port connected to JTAG Debugger. The LED lights up in bright white to signify that the JTAG Port has been remapped. Jumper is set to L, for Normal Mode.</em></p>
<h1 id="test-the-remapped-jtag-port" class="section-header"><a href="#test-the-remapped-jtag-port">9 Test the Remapped JTAG Port</a></h1>
<p><em>How shall we test the JTAG Port remap?</em></p>
<p>We test by flashing a modified <code>helloworld</code> firmware that contains the remap code from the previous section...</p>
<h2 id="connect-the-remapped-jtag-port" class="section-header"><a href="#connect-the-remapped-jtag-port">9.1 Connect the Remapped JTAG Port</a></h2>
<ol>
<li>
<p>Disconnect PineCone and JTAG Debugger from our computer</p>
</li>
<li>
<p>Connect the remapped JTAG Pins from PineCone to our JTAG Deugger...</p>
<table><thead><tr><th align="left">JTAG Pin</th><th align="left">PineCone Pin</th></tr></thead><tbody>
<tr><td align="left"><strong><code>TDI</code></strong></td><td align="left"><code>IO 1</code></td></tr>
<tr><td align="left"><strong><code>TCK</code></strong></td><td align="left"><code>IO 2</code></td></tr>
<tr><td align="left"><strong><code>TDO</code></strong></td><td align="left"><code>IO 3</code></td></tr>
<tr><td align="left"><strong><code>TMS</code></strong></td><td align="left"><code>IO 12</code></td></tr>
<tr><td align="left"><strong><code>GND</code></strong></td><td align="left"><code>GND</code></td></tr>
</tbody></table>
<p>(See the pic above)</p>
</li>
<li>
<p>Set the PineCone Jumper to <code>H</code> (Bootloader Mode), because we shall be flashing the firmware shortly</p>
</li>
<li>
<p>Connect both PineCone and JTAG Debugger to our computer's USB ports</p>
</li>
</ol>
<h2 id="download-the-remap-firmware" class="section-header"><a href="#download-the-remap-firmware">9.2 Download the Remap Firmware</a></h2>
<p>The firmware code from the previous section has been built and uploaded as a GitHub Release. Here's how we download the firmware the remaps the JTAG Port...</p>
<ol>
<li>
<p>Browse to this GitHub Release...</p>
<p><a href="https://github.com/lupyuen/bl_iot_sdk/releases/tag/v0.0.4"><code>github.com/lupyuen/bl_iot_sdk/releases/tag/v0.0.4</code></a></p>
</li>
<li>
<p>Scroll to the bottom. Under <code>Assets</code>, click <code>build_out.zip</code></p>
</li>
<li>
<p>Unzip the downloaded file <code>build_out.zip</code></p>
</li>
<li>
<p>In the extracted files, look for...</p>
<pre><code class="language-text">build_out/sdk_app_helloworld.bin
</code></pre>
<p>We shall be flashing <code>sdk_app_helloworld.bin</code> in the next step.</p>
<p>This version of the <code>helloworld</code> app has been modified to remap the JTAG Port.</p>
<p><a href="https://github.com/lupyuen/bl_iot_sdk/blob/jtag/customer_app/sdk_app_helloworld/sdk_app_helloworld/main.c#L83-L241">Browse the source code</a></p>
</li>
</ol>
<h2 id="flash-the-remap-firmware" class="section-header"><a href="#flash-the-remap-firmware">9.3 Flash the Remap Firmware</a></h2>
<ol>
<li>
<p>Check that the PineCone Jumper has been set to <code>H</code> (Bootloader Mode), ready for flashing</p>
</li>
<li>
<p>Follow the instructions in this article to flash the <code>sdk_app_helloworld.bin</code> firmware that we have just downloaded. (Not the one from GitHub Actions)</p>
<p><a href="https://lupyuen.github.io/articles/pinecone">&quot;Quick Peek of PineCone BL602 RISC-V Evaluation Board&quot;</a>, Section 4.2: <a href="https://lupyuen.github.io/articles/pinecone#flashing-firmware">&quot;Flashing Firmware&quot;</a></p>
<p>When selecting the firmware file, remember to choose the <code>sdk_app_helloworld.bin</code> firmware that we have just downloaded.</p>
</li>
</ol>
<h2 id="start-the-remap-firmware" class="section-header"><a href="#start-the-remap-firmware">9.4 Start the Remap Firmware</a></h2>
<ol>
<li>
<p>After flashing the remap firmware, set the PineCone Jumper to <code>L</code> (Normal Mode) and power on PineCone</p>
</li>
<li>
<p>PineCone's LED should light up bright white to signify that the JTAG Port has been remapped</p>
</li>
</ol>
<h2 id="run-openocd-1" class="section-header"><a href="#run-openocd-1">9.5 Run OpenOCD</a></h2>
<ol>
<li>
<p>Run OpenOCD using the same steps that we have covered in this article</p>
</li>
<li>
<p>We should see the same OpenOCD output, including the CPU ID.</p>
<p>This means that the remapped JTAG Port is working OK.</p>
</li>
<li>
<p>Remap Tip: When we reboot PineCone with Jumper set to <code>H</code> (Bootloader Mode), PineCone switches back to the Default JTAG Port. The LED turns multicolour.</p>
<p>Set the Jumper to <code>L</code> (Normal Mode) and reboot PineTime to restore the Remapped JTAG Port. The LED turns bright white.</p>
</li>
</ol>
<h2 id="remove-the-remap-firmware" class="section-header"><a href="#remove-the-remap-firmware">9.6 Remove the Remap Firmware</a></h2>
<ol>
<li>
<p>To remove the remap firmware, follow the instructions in this article to flash the original <code>sdk_app_helloworld.bin</code> firmware from GitHub Actions. (Not the modified one we have just downloaded)</p>
<p><a href="https://lupyuen.github.io/articles/pinecone">&quot;Quick Peek of PineCone BL602 RISC-V Evaluation Board&quot;</a>, Section 4.2: <a href="https://lupyuen.github.io/articles/pinecone#flashing-firmware">&quot;Flashing Firmware&quot;</a></p>
</li>
<li>
<p>Set PineCone's Jumper to <code>L</code> (Normal Mode) and power on PineCone.</p>
<p>The LED should no longer light up after booting</p>
<p>This signifies that the JTAG Port is no longer remapped. And we're back to the default JTAG Port.</p>
</li>
</ol>
<p><img src="https://lupyuen.github.io/images/pinecone-led2.jpg" alt="PineCone with Remapped JTAG Port" /></p>
<p><em>PineCone with Remapped JTAG Port. The LED lights up in bright white to signify that the JTAG Port has been remapped.</em></p>
<h1 id="how-to-fix-the-jtag-port" class="section-header"><a href="#how-to-fix-the-jtag-port">10 How to fix the JTAG Port</a></h1>
<p><em>What are the options for resolving the conflict between the JTAG Pins and the LED Pins on PineCone?</em></p>
<p>We have a couple of options...</p>
<h2 id="redesign-the-pinecone-hardware" class="section-header"><a href="#redesign-the-pinecone-hardware">10.1 Redesign the PineCone Hardware</a></h2>
<p><em>Connect the LED to other pins. Keep the default JTAG Port.</em></p>
<p>We'll no longer have the multicolour lights during JTAG programming... But this option allows us to control the LED while doing debugging over JTAG, without having to remap the JTAG Port.</p>
<p>This makes PineCone coding easier. And we'll never have to worry about connecting our JTAG Debugger to the wrong PineCone Pins.</p>
<p>This is my preferred option, though it will cost more to redesign and manufacture the board.</p>
<h2 id="keep-pinecone-as-is" class="section-header"><a href="#keep-pinecone-as-is">10.2 Keep PineCone as is</a></h2>
<p><em>LED is connected on the default JTAG Pins.</em></p>
<p>But will we need to use the LED and JTAG Debugging at the same time?</p>
<ol>
<li>
<p><strong>Only LED</strong>: We'll remap the LED Pins to PWM so that we may control them.</p>
</li>
<li>
<p><strong>Only JTAG</strong>: We'll use the default JTAG Port. No remapping needed. </p>
<p>(And we get free disco lights during JTAG flashing and debugging)</p>
</li>
<li>
<p><strong>Both LED and JTAG</strong>: This gets tricky.</p>
<p>As we have learnt earlier, we need to remap the LED Pins to PWM, and remap the JTAG Port to other pins.</p>
<ul>
<li>
<p>This remapping can be done in the PineCone Firmware.</p>
<p>But whenever PineCone reboots, the JTAG Port reverts to the default pins, until our firmware remaps the port.</p>
<p>This may be a problem if we need to reboot PineCone during JTAG flashing or debugging.</p>
</li>
<li>
<p>Alternatively: We may remap the LED and JTAG pins in the PineCone Bootloader <code>blsp_boot2</code></p>
<p>This ensures that the pins are remapped quickly whenever PineCone reboots.</p>
</li>
</ul>
</li>
</ol>
<h2 id="integrate-jtag-debugger-with-pinecone" class="section-header"><a href="#integrate-jtag-debugger-with-pinecone">10.3 Integrate JTAG Debugger with PineCone</a></h2>
<p>We hear that Sipeed's upcoming BL602 Board will have an onboard JTAG Debugger. (Probably FT2232)</p>
<p>This increases the cost of the BL602 board... But it simplifies the USB connection between our computer and the BL602 board.</p>
<p>For PineCone we're using 2 USB ports (PineCone USB + JTAG Debugger). With an integrated JTAG Debugger, we'll need only 1 USB port.</p>
<h1 id="whats-next" class="section-header"><a href="#whats-next">11 What's Next</a></h1>
<p>Today we have connected OpenOCD to PineCone... Next we shall try flashing and debugging RISC-V firmware on PineCone! (With VSCode, GDB, ...)</p>
<p>I'll also be testing on PineCone the <a href="https://github.com/lupyuen/pinecone-rust">Embedded Rust Firmware</a>, kindly contributed by the Sipeed BL602 Community. <a href="https://lupyuen.github.io/pinecone-rust/">PineCone Rust Docs</a></p>
<p>Stay tuned!</p>
<p><a href="https://lupyuen.github.io">Check out my articles</a></p>
<p><a href="https://lupyuen.github.io/rss.xml">RSS Feed</a></p>
<p><a href="https://github.com/sponsors/lupyuen">Sponsor me a coffee</a></p>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here...</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/openocd.md"><code>github.com/lupyuen/lupyuen.github.io/src/openocd.md</code></a></p>

    
</body>
</html>