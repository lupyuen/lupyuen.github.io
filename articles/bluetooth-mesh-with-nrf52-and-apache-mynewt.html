<!doctype html>
<html lang="en">

<head>
  <link rel="stylesheet" type="text/css" href="/_static/css/banner-styles.css?v=bsmaklHF" />
  <link rel="stylesheet" type="text/css" href="/_static/css/iconochive.css?v=qtvMKcIJ" />
  <!-- End Wayback Rewrite JS Include -->
  <title data-rh="true">Bluetooth Mesh with nRF52 and Apache Mynewt - Lup Yuen Lee 李立源 - Medium</title>
  <meta data-rh="true" charset="utf-8" />
  <meta data-rh="true" name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />
  <meta data-rh="true" name="theme-color" content="#000000" />
  <meta data-rh="true" name="twitter:app:name:iphone" content="Medium" />
  <meta data-rh="true" name="twitter:app:id:iphone" content="828256236" />
  <meta data-rh="true" property="al:ios:app_name" content="Medium" />
  <meta data-rh="true" property="al:ios:app_store_id" content="828256236" />
  <meta data-rh="true" property="al:android:package" content="com.medium.reader" />
  <meta data-rh="true" property="fb:app_id" content="542599432471018" />
  <meta data-rh="true" property="og:site_name" content="Medium" />
  <meta data-rh="true" property="og:type" content="article" />
  <meta data-rh="true" property="article:published_time" content="2019-11-26T04:41:58.671Z" />
  <meta data-rh="true" name="title" content="Bluetooth Mesh with nRF52 and Apache Mynewt - Lup Yuen Lee 李立源 - Medium" />
  <meta data-rh="true" property="og:title" content="Bluetooth Mesh with nRF52 and Apache Mynewt" />
  <meta data-rh="true" property="twitter:title" content="Bluetooth Mesh with nRF52 and Apache Mynewt" />
  <meta data-rh="true" name="twitter:site" content="@Medium" />
  <meta data-rh="true" name="twitter:app:url:iphone" content="medium://p/44823407c471" />
  <meta data-rh="true" property="al:android:url" content="medium://p/44823407c471" />
  <meta data-rh="true" property="al:ios:url" content="medium://p/44823407c471" />
  <meta data-rh="true" property="al:android:app_name" content="Medium" />
  <meta data-rh="true" name="description" content="A gentle introduction with fifty shades of fabulous models" />
  <meta data-rh="true" property="og:description" content="A gentle introduction with fifty shades of fabulous models" />
  <meta data-rh="true" property="twitter:description"
    content="A gentle introduction with fifty shades of fabulous models" />
  <meta data-rh="true" property="og:url"
    content="https://web.archive.org/web/20191217201743/https://medium.com/@ly.lee/bluetooth-mesh-with-nrf52-and-apache-mynewt-44823407c471" />
  <meta data-rh="true" property="al:web:url"
    content="https://medium.com/@ly.lee/bluetooth-mesh-with-nrf52-and-apache-mynewt-44823407c471" />
  <meta data-rh="true" property="og:image"
    content="https://web.archive.org/web/20191217201743im_/https://miro.medium.com/max/1200/1*ceITcv2j-Rexz_1r6AHp1g.png" />
  <meta data-rh="true" name="twitter:image:src"
    content="https://miro.medium.com/max/1200/1*ceITcv2j-Rexz_1r6AHp1g.png" />
  <meta data-rh="true" name="twitter:card" content="summary_large_image" />
  <meta data-rh="true" property="article:author" content="https://medium.com/@ly.lee" />
  <meta data-rh="true" name="twitter:creator" content="@MisterTechBlog" />
  <meta data-rh="true" name="author" content="Lup Yuen Lee 李立源" />
  <meta data-rh="true" name="robots" content="index,follow" />
  <meta data-rh="true" name="referrer" content="unsafe-url" />
  <meta data-rh="true" name="twitter:label1" value="Reading time" />
  <meta data-rh="true" name="twitter:data1" value="15 min read" />
  <meta data-rh="true" name="parsely-post-id" content="44823407c471" />
  <link data-rh="true" rel="publisher" href="https://plus.google.com/103654360130207659246" />
  <link data-rh="true" rel="search" type="application/opensearchdescription+xml" title="Medium"
    href="/web/20191217201743/https://medium.com/osd.xml" />
  <link data-rh="true" rel="apple-touch-icon" sizes="152x152"
    href="https://web.archive.org/web/20191217201743im_/https://cdn-images-1.medium.com/fit/c/152/152/1*8I-HPL0bfoIzGied-dzOvA.png" />
  <link data-rh="true" rel="apple-touch-icon" sizes="120x120"
    href="https://web.archive.org/web/20191217201743im_/https://cdn-images-1.medium.com/fit/c/120/120/1*8I-HPL0bfoIzGied-dzOvA.png" />
  <link data-rh="true" rel="apple-touch-icon" sizes="76x76"
    href="https://web.archive.org/web/20191217201743im_/https://cdn-images-1.medium.com/fit/c/76/76/1*8I-HPL0bfoIzGied-dzOvA.png" />
  <link data-rh="true" rel="apple-touch-icon" sizes="60x60"
    href="https://web.archive.org/web/20191217201743im_/https://cdn-images-1.medium.com/fit/c/60/60/1*8I-HPL0bfoIzGied-dzOvA.png" />
  <link data-rh="true" rel="mask-icon"
    href="https://web.archive.org/web/20191217201743im_/https://cdn-static-1.medium.com/_/fp/icons/monogram-mask.KPLCSFEZviQN0jQ7veN2RQ.svg"
    color="#171717" />
  <link data-rh="true" rel="icon"
    href="https://web.archive.org/web/20191217201743im_/https://cdn-static-1.medium.com/_/fp/icons/favicon-rebrand-medium.3Y6xpZ-0FSdWDnPM3hSBIA.ico" />
  <link data-rh="true" id="glyph_link" rel="stylesheet" type="text/css"
    href="https://web.archive.org/web/20191217201743cs_/https://glyph.medium.com/css/e/sr/latin/e/ssr/latin/e/ssb/latin/m2.css" />
  <link data-rh="true" rel="author" href="https://medium.com/@ly.lee" />
  <link data-rh="true" rel="canonical"
    href="https://web.archive.org/web/20191217201743/https://medium.com/@ly.lee/bluetooth-mesh-with-nrf52-and-apache-mynewt-44823407c471" />
  <link data-rh="true" rel="alternate"
    href="https://web.archive.org/web/20191217201743/android-app://com.medium.reader/https/medium.com/p/44823407c471" />

<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">

<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->

</head>

<body>
  <div id="root">
    <div class="a b c">
      <article class="meteredContent">
        <section class="cy cz da db ak dc ct n dd"></section><span class="r"></span>
        <div>
          <div class="de u df dg dh di"></div>
          <section class="dj dk dl dm dn">
            <div class="do ak">
              <figure class="dp do ak paragraph-image">

                <p><img src="https://lupyuen.github.io/images/legacy/l1.png" /></p>


                <figcaption class="cd eg eh ei ej dc da db ek el by em">Bluetooth Mesh with four EBYTE E73-TBB
                  Development Boards based on Nordic nRF52832 Microcontroller</figcaption>
              </figure>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah en aj ak">
                <div>
                  <div id="a987" class="eo ep ar bz eq b er es et eu ev ew ex ey ez fa fb">
                    <h1 class="eq b er fc et fd ev fe ex ff ez fg ar">Bluetooth Mesh with nRF52 and Apache Mynewt</h1>
                  </div>
                  <div class="fh">
                    <div class="n fi fj fk fl">
                      <div class="o n">
                        <div><a rel="noopener"
                            href="/web/20191217201743/https://medium.com/@ly.lee?source=post_page-----44823407c471----------------------">
                            <div class="ds fm fn">
                              <div class="ch n fo o p de fp fq fr fs ft di"><svg width="57" height="57"
                                  viewbox="0 0 57 57">
                                  <path fill-rule="evenodd" clip-rule="evenodd"
                                    d="M28.5 1.2A27.45 27.45 0 0 0 4.06 15.82L3 15.27A28.65 28.65 0 0 1 28.5 0C39.64 0 49.29 6.2 54 15.27l-1.06.55A27.45 27.45 0 0 0 28.5 1.2zM4.06 41.18A27.45 27.45 0 0 0 28.5 55.8a27.45 27.45 0 0 0 24.44-14.62l1.06.55A28.65 28.65 0 0 1 28.5 57 28.65 28.65 0 0 1 3 41.73l1.06-.55z">
                                  </path>
                                </svg></div><img alt="Lup Yuen Lee 李立源" class="r fu fn fm"
                                src="https://web.archive.org/web/20191217201743im_/https://miro.medium.com/fit/c/96/96/1*KGohS3sQaUnr58gc0BIfoQ.jpeg"
                                width="48" height="48" />
                            </div>
                          </a></div>
                        <div class="fv ak r">
                          <div class="n">
                            <div style="flex:1"><span class="by b bz ca cb cc r ar q">
                                <div class="fw n o fx"><span class="by em eg ca ax fy fz au av aw ar"><a
                                      class="bi bj bk bl bm bn bo bp bq br ga bu bv bw bx" rel="noopener"
                                      href="/web/20191217201743/https://medium.com/@ly.lee?source=post_page-----44823407c471----------------------">Lup
                                      Yuen Lee 李立源</a></span>
                                  <div class="gb r bh h"><button
                                      class="gc ar q cn gd ge gf gg br bw gh gi gj gk gl gm cq by b bz gn go cc cr cs ct cu cv bu">Follow</button>
                                  </div>
                                </div>
                              </span></div>
                          </div><span class="by b bz ca cb cc r cd ce"><span class="by em eg ca ax fy fz au av aw cd">
                              <div><a class="bi bj bk bl bm bn bo bp bq br ga bu bv bw bx" rel="noopener"
                                  href="/web/20191217201743/https://medium.com/@ly.lee/bluetooth-mesh-with-nrf52-and-apache-mynewt-44823407c471?source=post_page-----44823407c471----------------------">Oct
                                  15</a> <!-- -->·
                                <!-- -->
                                <!-- -->15
                                <!-- --> min read<span style="padding-left:4px"><svg class="star-15px_svg__svgIcon-use"
                                    width="15" height="15" viewbox="0 0 15 15" style="margin-top:-2px">
                                    <path
                                      d="M7.44 2.32c.03-.1.09-.1.12 0l1.2 3.53a.29.29 0 0 0 .26.2h3.88c.11 0 .13.04.04.1L9.8 8.33a.27.27 0 0 0-.1.29l1.2 3.53c.03.1-.01.13-.1.07l-3.14-2.18a.3.3 0 0 0-.32 0L4.2 12.22c-.1.06-.14.03-.1-.07l1.2-3.53a.27.27 0 0 0-.1-.3L2.06 6.16c-.1-.06-.07-.12.03-.12h3.89a.29.29 0 0 0 .26-.19l1.2-3.52z">
                                    </path>
                                  </svg></span>
                              </div>
                            </span></span>
                        </div>
                      </div>
                      <div class="n gp gq gr gs gt gu gv gw ab">
                        <div class="n o">
                          <div class="gx r bh"><a
                              href="//web.archive.org/web/20191217201743/https://medium.com/p/44823407c471/share/twitter?source=post_actions_header---------------------------"
                              class="bi bj bk bl bm bn bo bp bq br bs bt bu bv bw bx" target="_blank"
                              rel="noopener"><svg width="29" height="29" class="q">
                                <path
                                  d="M22.05 7.54a4.47 4.47 0 0 0-3.3-1.46 4.53 4.53 0 0 0-4.53 4.53c0 .35.04.7.08 1.05A12.9 12.9 0 0 1 5 6.89a5.1 5.1 0 0 0-.65 2.26c.03 1.6.83 2.99 2.02 3.79a4.3 4.3 0 0 1-2.02-.57v.08a4.55 4.55 0 0 0 3.63 4.44c-.4.08-.8.13-1.21.16l-.81-.08a4.54 4.54 0 0 0 4.2 3.15 9.56 9.56 0 0 1-5.66 1.94l-1.05-.08c2 1.27 4.38 2.02 6.94 2.02 8.3 0 12.86-6.9 12.84-12.85.02-.24 0-.43 0-.65a8.68 8.68 0 0 0 2.26-2.34c-.82.38-1.7.62-2.6.72a4.37 4.37 0 0 0 1.95-2.51c-.84.53-1.81.9-2.83 1.13z">
                                </path>
                              </svg></a></div>
                          <div class="gx r bh"><a
                              href="//web.archive.org/web/20191217201743/https://medium.com/p/44823407c471/share/facebook?source=post_actions_header---------------------------"
                              class="bi bj bk bl bm bn bo bp bq br bs bt bu bv bw bx" target="_blank"
                              rel="noopener"><svg width="29" height="29" class="q">
                                <path
                                  d="M23.2 5H5.8a.8.8 0 0 0-.8.8V23.2c0 .44.35.8.8.8h9.3v-7.13h-2.38V13.9h2.38v-2.38c0-2.45 1.55-3.66 3.74-3.66 1.05 0 1.95.08 2.2.11v2.57h-1.5c-1.2 0-1.48.57-1.48 1.4v1.96h2.97l-.6 2.97h-2.37l.05 7.12h5.1a.8.8 0 0 0 .79-.8V5.8a.8.8 0 0 0-.8-.79">
                                </path>
                              </svg></a></div>
                          <div class="gy r ao">
                            <div>
                              <div class="cu" role="tooltip" aria-hidden="true"><a
                                  href="https://web.archive.org/web/20191217201743/https://medium.com/m/signin?operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40ly.lee%2Fbluetooth-mesh-with-nrf52-and-apache-mynewt-44823407c471&amp;source=post_actions_header--------------------------bookmark_sidebar-"
                                  class="bi bj bk bl bm bn bo bp bq br bs bt bu bv bw bx" rel="noopener"><svg width="25"
                                    height="25" viewbox="0 0 25 25">
                                    <path
                                      d="M19 6a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v14.66h.01c.01.1.05.2.12.28a.5.5 0 0 0 .7.03l5.67-4.12 5.66 4.13a.5.5 0 0 0 .71-.03.5.5 0 0 0 .12-.29H19V6zm-6.84 9.97L7 19.64V6a1 1 0 0 1 1-1h9a1 1 0 0 1 1 1v13.64l-5.16-3.67a.49.49 0 0 0-.68 0z"
                                      fill-rule="evenodd"></path>
                                  </svg></a></div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <p id="6c30" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Suppose we have four light bulbs
                  in our home, each with its own on/off switch…</p>
                <figure class="ho hp hq hr hs do da db paragraph-image">

                  <p><img src="https://lupyuen.github.io/images/legacy/l2.png" /></p>


                </figure>
                <p id="7ef5" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Let’s make them smart… With
                  <strong class="hb hu">Wireless Remote Control</strong>!</p>
                <figure class="ho hp hq hr hs do da db paragraph-image">

                  <p><img src="https://lupyuen.github.io/images/legacy/l3.png" /></p>


                </figure>
                <p id="8c22" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Flipping the on/off switch of the
                  first bulb should switch the other bulbs on and off. So the first on/off switch acts like a <strong
                    class="hb hu">Master On/Off Switch</strong> for our entire home.</p>
                <p id="e2aa" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm"><em class="hv">How shall we
                    implement this?</em></p>
                <p id="acf8" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">We could do this with WiFi…
                  Assuming that we have good WiFi coverage at every corner of our home. There’s a simpler solution…
                  <strong class="hb hu">Bluetooth Mesh</strong>!</p>
                <p id="1512" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">With Bluetooth Mesh there’s no
                  need for a shared network like WiFi. Each node in the mesh may<strong class="hb hu"> relay messages to
                    other nodes</strong> in the mesh. So our bulbs could relay on/off messages to one another all around
                  the house… Maybe outside the house too! (Think Christmas lights)</p>
                <p id="dc03" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">That’s exactly what I have
                  created here… A Master On/Off Switch for <strong class="hb hu">four nRF52 wireless nodes</strong>,
                  connected via Bluetooth Mesh…</p>
              </div>
            </div>
            <div class="do">
              <div class="n p">
                <div class="hw hx hy hz ia ib ag ic ah id aj ak">
                  <figure class="ho hp hq hr hs do">
                    <div class="dz r ds">
                      <div class="ie r"><iframe
                          src="https://cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fwww.youtube.com%2Fembed%2F5W9GteiLClg%3Ffeature%3Doembed&amp;url=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3D5W9GteiLClg&amp;image=https%3A%2F%2Fi.ytimg.com%2Fvi%2F5W9GteiLClg%2Fhqdefault.jpg&amp;key=a19fcc184b9711e1b4764040d3dc5c07&amp;type=text%2Fhtml&amp;schema=youtube"
                          allowfullscreen="" frameborder="0" height="480" width="854" title="nRF52 Bluetooth Mesh"
                          class="de t u dw ak" scrolling="auto"></iframe></div>
                    </div>
                    <figcaption class="cd eg eh ei ej dc da db ek el by em">Master On/Off Switch for four nRF52 wireless
                      nodes, connected via Bluetooth Mesh. The nRF52 boards are powered by a USB charger connected to
                      the Micro USB ports.</figcaption>
                  </figure>
                </div>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah en aj ak">
                <p id="a35d" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Now Bluetooth Mesh is incredibly
                  complicated and difficult to grasp… So I’ll explain it in small pieces (while I’m learning it myself!)
                </p>
                <p id="bc07" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">In this tutorial we’ll set up the
                  above nRF52 mesh network, step by step, <strong class="hb hu">without any coding</strong>! During the
                  setup we’ll encounter mesh concepts (like Models, Elements, Groups, …) We’ll learn them only when we
                  meet them. (The advanced concepts shall be deferred to the next tutorial.)</p>
                <p id="c7bb" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">The complete source code may be
                  found in the <code class="ea if ig ih ii b">mesh</code> branch of this repository…</p>
                <div class="ij ik il im in io"><a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/tree/mesh"
                    rel="noopener nofollow">
                    <section class="ir da db ak ct n bh is it iu iv iw ix iy iz ja jb jc jd je jf jg">
                      <div class="jh n dd p ji jj">
                        <h2 class="by jk jl ca ar">
                          <div class="ax ip fz au iq aw">lupyuen/stm32bluepill-mynewt-sensor</div>
                        </h2>
                        <div class="jm r">
                          <h3 class="by em eg ca cd">
                            <div class="ax ip fz au iq aw">This mesh branch contains the source code for a Bluetooth
                              Mesh Sensor Application for nRF52 with Apache Mynewt and…</div>
                          </h3>
                        </div>
                        <div class="jn r">
                          <h4 class="by em go ca cd">
                            <div class="ax ip fz au iq aw">github.com</div>
                          </h4>
                        </div>
                      </div>
                    </section>
                  </a></div>
              </div>
            </div>
          </section>
          <hr class="jo em jp jq jr ej js jt ju jv jw" />
          <section class="dj dk dl dm dn">
            <div class="do">
              <div class="n p">
                <div class="hw hx hy hz ia ib ag ic ah id aj ak">
                  <figure class="ho hp hq hr hs do jy jz paragraph-image">

                    <p><img src="https://lupyuen.github.io/images/legacy/l4.jpeg" /></p>


                    <figcaption class="cd eg eh ei ej dc da db ek el by em">EBYTE E73-TBB Development Board (based on
                      nRF52) provisioned into a Bluetooth Mesh by running meshctl on Raspberry Pi 4</figcaption>
                  </figure>
                </div>
              </div>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah en aj ak">
                <h1 id="0bb0" class="kb kc ar bz by jk er kd et ke kf kg kh ki kj kk kl">Hardware Needed</h1>
                <p id="3847" class="gz ha ar bz hb b hc km he kn hg ko hi kp hk kq hm">Get ready the following hardware
                  to build our Bluetooth Mesh…</p>
                <ul class="">
                  <li id="e784" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm kr ks kt">One or more <strong
                      class="hb hu">nRF52 Development Boards</strong> (I used the $8 <a class="bi cv ku kv kw kx"
                      target="_blank" rel="noopener"
                      href="/web/20191217201743/https://medium.com/@ly.lee/coding-nrf52-with-rust-and-apache-mynewt-on-visual-studio-code-9521bcba6004?source=friends_link&amp;sk=bb4e2523b922d0870259ab3fa696c7da">EBYTE
                      E73-TBB Development Board</a>)</li>
                  <li id="6435" class="gz ha ar bz hb b hc ky he kz hg la hi lb hk lc hm kr ks kt"><a
                      href="https://www.aliexpress.com/wholesale?catId=0&amp;initiative_id=SB_20180924134644&amp;SearchText=st-link+v2&amp;switch_new_app=y"
                      class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow"><strong class="hb hu">ST-Link v2
                        USB Programmer</strong></a> (under $2, <a class="bi cv ku kv kw kx" target="_blank"
                      rel="noopener"
                      href="/web/20191217201743/https://medium.com/@ly.lee/coding-nrf52-with-rust-and-apache-mynewt-on-visual-studio-code-9521bcba6004?source=friends_link&amp;sk=bb4e2523b922d0870259ab3fa696c7da">check
                      my article</a>)</li>
                  <li id="0aff" class="gz ha ar bz hb b hc ky he kz hg la hi lb hk lc hm kr ks kt"><strong
                      class="hb hu">Raspberry Pi 3 or 4</strong> (Older models may work too. I tested on Pi 4)</li>
                </ul>
                <p id="2693" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">This is the same setup that I
                  have explained in my previous article <em class="hv">“</em><a class="bi cv ku kv kw kx"
                    target="_blank" rel="noopener"
                    href="/web/20191217201743/https://medium.com/@ly.lee/coding-nrf52-with-rust-and-apache-mynewt-on-visual-studio-code-9521bcba6004?source=friends_link&amp;sk=bb4e2523b922d0870259ab3fa696c7da"><em
                      class="hv">Coding nRF52 with Rust and Apache Mynewt on Visual Studio Code</em></a><em
                    class="hv">”</em></p>
              </div>
            </div>
          </section>
          <hr class="jo em jp jq jr ej js jt ju jv jw" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah en aj ak">
                <h1 id="9eea" class="kb kc ar bz by jk er ld et le kf lf kh lg kj lh kl">Install Raspberry Pi</h1>
                <p id="4869" class="gz ha ar bz hb b hc km he kn hg ko hi kp hk kq hm">To set up the Bluetooth Mesh
                  network, we need to use a Raspberry Pi to talk to the nRF52 boards wirelessly and add them one by one
                  to the mesh… This is called <strong class="hb hu">Mesh Provisioning</strong>.</p>
                <p id="8298" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">We’ll be using a tool called
                  <code class="ea if ig ih ii b">meshctl</code> to perform the provisioning on our Pi. (Why Pi? Because
                  <code class="ea if ig ih ii b">meshctl</code> doesn’t run on Windows and macOS.) <code
                    class="ea if ig ih ii b">meshctl</code> is part of the open-source <strong
                    class="hb hu">BlueZ</strong> suite of Bluetooth utilities.</p>
                <p id="4db8" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm"><a class="bi cv ku kv kw kx"
                    target="_blank" rel="noopener"
                    href="/web/20191217201743/https://medium.com/@ly.lee/install-meshctl-on-raspberry-pi-51aa1e2579e6?source=friends_link&amp;sk=da397fc011c7a8c0da6d7d14c279191c">Follow
                    the instructions here</a> to install <code class="ea if ig ih ii b">meshctl</code> on your Raspberry
                  Pi. (Yes BlueZ is preinstalled on Pi but it lacks the <code class="ea if ig ih ii b">meshctl</code>
                  utility.)</p>
                <p id="426f" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Unfortunately we need to rebuild
                  the Pi kernel (as explained in the instructions)… Because <code
                    class="ea if ig ih ii b">meshctl</code> needs AEAD-AES_CCM encryption, which runs as a secure
                  service in the kernel. This may take an hour or more to complete.</p>
              </div>
            </div>
          </section>
          <hr class="jo em jp jq jr ej js jt ju jv jw" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah en aj ak">
                <h1 id="2bfc" class="kb kc ar bz by jk er ld et le kf lf kh lg kj lh kl">Install nRF52 Boards</h1>
                <p id="c2a6" class="gz ha ar bz hb b hc km he kn hg ko hi kp hk kq hm"><a class="bi cv ku kv kw kx"
                    target="_blank" rel="noopener"
                    href="/web/20191217201743/https://medium.com/@ly.lee/install-bluetooth-mesh-and-apache-mynewt-for-nrf52-and-visual-studio-code-on-windows-and-macos-52fe180e13e6?source=friends_link&amp;sk=194cba1416c20fcb14826b40d565999e">Follow
                    the instructions here</a> to flash the bootloader and sample application (NimBLE <code
                    class="ea if ig ih ii b"><a href="https://github.com/apache/mynewt-nimble/tree/master/apps/blemesh_models_example_2" class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">blemesh_models_example_2</a></code>)
                  to your nRF52 boards. If the boards have been previously provisioned, click <code
                    class="ea if ig ih ii b">Terminal → Run Task → Erase Flash</code> to erase the previous provisioning
                  info (stored in Flash ROM), then re-flash the bootloader and application.</p>
                <p id="7e3c" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Connect the first nRF52 board to
                  your computer via ST-Link. Start a debug session, click <code class="ea if ig ih ii b">Continue</code>
                  for all breakpoints. Observe the Console Log.</p>
                <p id="5e2d" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Keep your nRF52 Board close to
                  your Raspberry Pi. Remember we’ll be doing the Mesh Provisioning wirelessly, over the crowded 2.4 GHz
                  airwaves, so the provisioning works better when the devices are close together.</p>
              </div>
            </div>
          </section>
          <hr class="jo em jp jq jr ej js jt ju jv jw" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah en aj ak">
                <h1 id="d556" class="kb kc ar bz by jk er ld et le kf lf kh lg kj lh kl">Provision First nRF52 Board
                </h1>
                <p id="f0c9" class="gz ha ar bz hb b hc km he kn hg ko hi kp hk kq hm">On our Raspberry Pi, enter these
                  commands…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="43df" class="ll kc ar bz ii b eg lm ln r lo">cd ~<br/>cp bluez-5.50/mesh/local_node.json bluez-5.50/mesh/prov_db.json .</span></pre>
                <p id="af49" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">The <code
                    class="ea if ig ih ii b">cp</code> command is <strong class="hb hu">only needed for provisioning the
                    first nRF52 board</strong>. What’s <code class="ea if ig ih ii b">prov_db.json</code>?</p>
                <p id="02b6" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">As we provision the mesh, <code
                    class="ea if ig ih ii b">meshctl</code> will remember the details of our mesh… security keys, node
                  addresses, services in each nodes. These details will be saved into <code
                    class="ea if ig ih ii b">prov_db.json</code> when each nRF52 node has been provisioned.</p>
                <p id="3547" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">When we provision the second,
                  third, fourth, … nRF52 nodes, <code class="ea if ig ih ii b">meshctl</code> will read the mesh details
                  from <code class="ea if ig ih ii b">prov_db.json</code> so that it can add the nodes to be existing
                  mesh.</p>
                <p id="9edb" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Now enter…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="ff08" class="ll kc ar bz ii b eg lm ln r lo">meshctl</span></pre>
                <p id="eca5" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Press <code
                    class="ea if ig ih ii b">Enter</code> to see the <code class="ea if ig ih ii b">[meshctl]#</code>
                  prompt.</p>
                <p id="2b58" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Our first nRF52 board is powered
                  on and ready to be provisioned… But <code class="ea if ig ih ii b">meshctl</code> has no clue how to
                  contact the board. Let’s give <code class="ea if ig ih ii b">meshctl</code> some guidance. Enter…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="0acd" class="ll kc ar bz ii b eg lm ln r lo">discover-unprovisioned on</span></pre>
                <p id="86de" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">This enables <code
                    class="ea if ig ih ii b">meshctl</code> to discover any nodes that have not been provisioned…
                  Because unprovisioned nodes will broadcast their unprovisioned status to the airwaves (like a beacon).
                </p>
                <p id="5bea" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">In a while we’ll see this…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="1982" class="ll kc ar bz ii b eg lm ln r lo">SetDiscoveryFilter success<br/>Discovery started<br/>Adapter property changed<br/>[CHG] Controller DC:A6:32:2C:70:F1 Discovering: yes<br/>  Mesh Provisioning Service (00001827-0000-1000-8000-00805f9b34fb)<br/>   Device UUID: <strong class="ii hu">dddd0000000000000000000000000000</strong><br/>   OOB: 0000<br/>[NEW] Device 09:10:C7:7C:DC:8F nimble-mesh-node</span></pre>
                <p id="f227" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Our nRF52 board has been found!
                  (If you don’t see this, move the nRF52 board closer to your Raspberry Pi)</p>
                <p id="9b37" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Take note of the discovered
                  Device UUID <code
                    class="ea if ig ih ii b"><strong class="hb hu">dddd0000000000000000000000000000</strong></code></p>
                <p id="aefa" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Now we tell <code
                    class="ea if ig ih ii b">meshctl</code> to provision this new node into our mesh. Enter…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="8201" class="ll kc ar bz ii b eg lm ln r lo">provision <strong class="ii hu">dddd0000000000000000000000000000</strong></span></pre>
                <p id="a240" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">If the provisioning goes well we
                  should see this prompt…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="58f4" class="ll kc ar bz ii b eg lm ln r lo">Request ASCII key (max characters 6)<br/>[mesh] Enter key (ascii string):</span></pre>
                <p id="b619" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">(Move the devices closer if you
                  don’t see this)</p>
                <p id="dcdf" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">This is a security check, to be
                  sure that we are authorised to provision the node into the mesh. <em class="hv">How do we find the
                    secret key?</em></p>
                <p id="1b63" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Switch over to the Visual Studio
                  Code Debugger. Check the Console Log of our nRF52 board. We should see <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-app.log#L64"
                    class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">this message</a>…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="00e3" class="ll kc ar bz ii b eg lm ln r lo">OOB String: <strong class="ii hu">RWLDWY</strong></span></pre>
                <p id="7b8c" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Go back to <code
                    class="ea if ig ih ii b">meshctl</code> and enter exactly what you see next to OOB String (assuming
                  that you see <code class="ea if ig ih ii b">RWLDWY</code>)…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="8ff1" class="ll kc ar bz ii b eg lm ln r lo">RWLDWY</span></pre>
                <p id="1aa9" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Our provisioning is almost done!
                </p>
              </div>
            </div>
          </section>
          <hr class="jo em jp jq jr ej js jt ju jv jw" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah en aj ak">
                <h1 id="2a01" class="kb kc ar bz by jk er ld et le kf lf kh lg kj lh kl">Unicast Address</h1>
                <p id="3992" class="gz ha ar bz hb b hc km he kn hg ko hi kp hk kq hm">In seconds we should see the
                  provisioning completed for our first mesh node…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="0333" class="ll kc ar bz ii b eg lm ln r lo">Provision success. Assigned Primary Unicast 0100</span></pre>
                <p id="fa26" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">On the Console Log of our nRF52
                  board we should see a matching message…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="b428" class="ll kc ar bz ii b eg lm ln r lo">Local node provisioned, primary address 0x0100</span></pre>
                <p id="db76" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm"><em class="hv">What is this
                    Primary Unicast Address </em><code class="ea if ig ih ii b">0100</code><em class="hv">?</em></p>
                <p id="350d" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Each node in our mesh will be
                  assigned a permanent address (in hexadecimal): <code class="ea if ig ih ii b">0100</code>, <code
                    class="ea if ig ih ii b">0102</code>, <code class="ea if ig ih ii b">0104</code>, <code
                    class="ea if ig ih ii b">0106</code>, … Since this is the first node, it’s assigned address <code
                    class="ea if ig ih ii b">0100</code>.</p>
                <p id="1880" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">(What happened to <code
                    class="ea if ig ih ii b">0101</code>, <code class="ea if ig ih ii b">0103</code>, …? I’ll explain in
                  the next tutorial)</p>
                <p id="21d3" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">This is called a <strong
                    class="hb hu">Unicast Address,</strong> the direct address for the node… <em class="hv">“Got
                    something to say to this node? Call this direct number!”</em></p>
                <figure class="ho hp hq hr hs do da db paragraph-image">

                  <p><img src="https://lupyuen.github.io/images/legacy/l5.png" /></p>


                  <figcaption class="cd eg eh ei ej dc da db ek el by em">Unicast Addresses for our Mesh Nodes
                  </figcaption>
                </figure>
                <p id="39db" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">(Later we’ll see a different kind
                  of address, a Group Address, that we may use to contact multiple nodes.)</p>
                <p id="1fa3" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Unicast Addresses are stored in
                  <code class="ea if ig ih ii b">prov_db.json</code> of our Raspberry Pi, also in the Flash ROM of the
                  nRF52 board (so the board won’t forget its assigned address).</p>
                <p id="0317" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">If we ever need to re-provision
                  this node, we will have to run the <code
                    class="ea if ig ih ii b">Terminal → Run Task → Erase Flash</code> command in Visual Studio Code to
                  erase the Unicast Address stored in the Flash ROM.</p>
              </div>
            </div>
          </section>
          <hr class="jo em jp jq jr ej js jt ju jv jw" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah en aj ak">
                <h1 id="76f2" class="kb kc ar bz by jk er ld et le kf lf kh lg kj lh kl">Configure the nRF52 Node</h1>
                <p id="9088" class="gz ha ar bz hb b hc km he kn hg ko hi kp hk kq hm">Now that we have provisioned the
                  node, let’s configure it. Enter into <code class="ea if ig ih ii b">meshctl</code>…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="94f1" class="ll kc ar bz ii b eg lm ln r lo">menu config</span></pre>
                <p id="86e0" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm"><code
                    class="ea if ig ih ii b">meshctl</code> shall now dial up the new node at <code
                    class="ea if ig ih ii b">0100</code> to give it a makeover. Enter…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="cec0" class="ll kc ar bz ii b eg lm ln r lo">target 0100</span></pre>
                <p id="584a" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Let’s talk secrets. We can’t let
                  anyone manipulate our nodes, so we need to lock our nodes with a common secret <strong
                    class="hb hu">Application Key or AppKey</strong>. Enter into <code
                    class="ea if ig ih ii b">meshctl</code>…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="7993" class="ll kc ar bz ii b eg lm ln r lo">appkey-add 1</span></pre>
                <p id="ab4f" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Where <code
                    class="ea if ig ih ii b">1</code> refers to the AppKey with index 1 from <code
                    class="ea if ig ih ii b">prov_db.json</code>…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="d53f" class="ll kc ar bz ii b eg lm ln r lo">&quot;appKeys&quot;:[<br/>    {<br/>      &quot;index&quot;:0,<br/>      &quot;boundNetKey&quot;:0,<br/>      &quot;key&quot;:&quot;4f68ad85d9f48ac8589df665b6b49b8a&quot;<br/>    },<br/>    {<br/>      &quot;index&quot;:1,<br/>      &quot;boundNetKey&quot;:0,<br/>      &quot;key&quot;:&quot;<strong class="ii hu">2aa2a6ded5a0798ceab5787ca3ae39fc</strong>&quot;<br/>    }<br/>  ],</span></pre>
              </div>
            </div>
          </section>
          <hr class="jo em jp jq jr ej js jt ju jv jw" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah en aj ak">
                <h1 id="45f6" class="kb kc ar bz by jk er ld et le kf lf kh lg kj lh kl">Generic On/Off Model, Server
                  and Client</h1>
                <p id="bca5" class="gz ha ar bz hb b hc km he kn hg ko hi kp hk kq hm">Now that we have loaded the
                  AppKey, we are ready to lock our new node, part by part. Recall that we have two parts in our nRF52
                  node, the Switch and the Light…</p>
                <figure class="ho hp hq hr hs do ef lr cs ls lt lu lv lw bp lx ly lz ma mb mc paragraph-image">

                  <p><img src="https://lupyuen.github.io/images/legacy/l6.png" /></p>

               
                </figure>
                <p id="cec2" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">In Bluetooth Mesh lingo this
                  setup is called a <strong class="hb hu">Generic On/Off Model</strong>… We only remember the on/off
                  state of the Switch and the Light.</p>
                <p id="0ccb" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">The Switch controls the Light. So
                  we call the Switch the <strong class="hb hu">Server</strong>, and we call the Light the <strong
                    class="hb hu">Client</strong>.</p>
                <p id="8d0e" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Let’s lock the Switch, a.k.a.
                  On/Off Server. Enter the into <code class="ea if ig ih ii b">meshctl</code>…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="31ba" class="ll kc ar bz ii b eg lm ln r lo">bind 0 1 1000</span></pre>
                <p id="217d" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">This locks Element #<code
                    class="ea if ig ih ii b">0</code> using AppKey #<code class="ea if ig ih ii b">1</code> (remember
                  our key?) for Model #<code class="ea if ig ih ii b">1000</code>.</p>
                <p id="ae04" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Today we won’t be going combing
                  the entire Periodic Table… We’ll limit ourselves to a single Element: Element #<code
                    class="ea if ig ih ii b">0</code>. (More about Elements next time)</p>
                <p id="4476" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Model #<code
                    class="ea if ig ih ii b">1000</code>… Wow have we got thousands of Models squeezed into our tiny
                  workspace? (Like <em class="hv">Project Runway?</em>)</p>
                <p id="a514" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">No, each Model Server/Client is
                  designated a fixed number by the creators of Bluetooth Mesh… Model #<code
                    class="ea if ig ih ii b">1000</code> is the official designation for <strong class="hb hu">Generic
                    On/Off Server</strong> a.k.a. <code class="ea if ig ih ii b">BT_MESH_MODEL_ID_GEN_ONOFF_SRV</code>
                  a.k.a. The Switch.</p>
                <p id="3290" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">So this command locks the Switch
                  with our AppKey. Once it’s locked, others may access the Switch securely, as long as they got the
                  right AppKey.</p>
                <p id="7f72" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">In case you’re curious about the
                  other Model numbers: <code
                    class="ea if ig ih ii b"><a href="https://github.com/apache/mynewt-nimble/blob/master/nimble/host/mesh/include/mesh/access.h" class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">https://github.com/apache/mynewt-nimble/blob/master/nimble/host/mesh/include/mesh/access.h</a></code>
                </p>
                <p id="d90e" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">For completeness, let’s lock and
                  expose our Light as well. Enter into <code class="ea if ig ih ii b">meshctl</code>…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="04fe" class="ll kc ar bz ii b eg lm ln r lo">bind 0 1 1001</span></pre>
                <p id="3d12" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">This locks (and exposes) Element
                  #<code class="ea if ig ih ii b">0</code> (only one element today) with AppKey #<code
                    class="ea if ig ih ii b">1</code> (yes the same) for Model #<code
                    class="ea if ig ih ii b">1001</code>.</p>
                <p id="7284" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">If we ask the creators of
                  Bluetooth Mesh, they’ll say that Model #<code class="ea if ig ih ii b">1001</code> is the <strong
                    class="hb hu">Generic On/Off Client</strong> alias <code
                    class="ea if ig ih ii b">BT_MESH_MODEL_ID_GEN_ONOFF_CLI</code> alias The Light. So our Light has
                  been locked for secure access.</p>
              </div>
            </div>
          </section>
          <hr class="jo em jp jq jr ej js jt ju jv jw" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah en aj ak">
                <h1 id="ed21" class="kb kc ar bz by jk er ld et le kf lf kh lg kj lh kl">Generic Level Model, Server and
                  Client</h1>
                <p id="57f0" class="gz ha ar bz hb b hc km he kn hg ko hi kp hk kq hm">Our Switch and Light are ready to
                  be used! But let’s strut some more fabulous Models down our tiny runway. Enter into <code
                    class="ea if ig ih ii b">meshctl</code>…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="c0cb" class="ll kc ar bz ii b eg lm ln r lo">bind 0 1 1002<br/>bind 0 1 1003</span></pre>
                <p id="f285" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Same thing as before, but Model
                  #<code class="ea if ig ih ii b">1002</code> is a <strong class="hb hu">Generic Level Server</strong>
                  (<code class="ea if ig ih ii b">BT_MESH_MODEL_ID_GEN_LEVEL_SRV</code>) and Model #<code
                    class="ea if ig ih ii b">1003</code> is a <strong class="hb hu">Generic Level Client</strong> (<code
                    class="ea if ig ih ii b">BT_MESH_MODEL_ID_GEN_LEVEL_CLI</code>).</p>
                <p id="8854" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm"><em class="hv">What’s a Generic
                    Level? Why not just use Generic On/Off?</em></p>
                <p id="2bec" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Sure… if we’re happy with binary
                  states like On and Off, Black and White. But if we’re into <em class="hv">Fifty Shades Of Grey
                  </em>(think dimmable lights), then we need a Generic Level to express levels of brightness <em
                    class="hv">(“50% brightness for this light”)</em></p>
                <p id="ad87" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm"><em class="hv">So many Models…
                    Will this runway ever end?</em></p>
                <p id="4bbe" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Yes… eventually. Our sample
                  application defines a number of Bluetooth Mesh Models. But today we’ll learn only the simplest On/Off
                  Model. The Models are defined here: <code
                    class="ea if ig ih ii b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/apps/my_sensor_app/src/device_composition.c#L2691-L2767" class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/apps/my_sensor_app/src/device_composition.c#L2691-L2767</a></code>
                </p>
              </div>
            </div>
          </section>
          <hr class="jo em jp jq jr ej js jt ju jv jw" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah en aj ak">
                <h1 id="1296" class="kb kc ar bz by jk er ld et le kf lf kh lg kj lh kl">Publish and Subscribe</h1>
                <p id="332a" class="gz ha ar bz hb b hc km he kn hg ko hi kp hk kq hm">Recall from the video that we had
                  a Central Switch controlling the other Lights wirelessly. <em class="hv">How did the on/off state of
                    our Central Switch propagate through the airwaves to the other Lights?</em></p>
                <p id="207a" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">With a little Bluetooth Mesh
                  magic called <strong class="hb hu">Publish and Subscribe</strong>!</p>
                <p id="3284" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Our Central Switch <strong
                    class="hb hu">publishes </strong>its on/off state to the mesh. Then each Light <strong
                    class="hb hu">subscribes</strong> to this on/off state to receive updates.</p>
                <figure class="ho hp hq hr hs do da db paragraph-image">

                  <p><img src="https://lupyuen.github.io/images/legacy/l7.png" /></p>

           
                </figure>
                <p id="e129" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Let’s understand this better by
                  doing a simple Publish and Subscribe. Enter into <code class="ea if ig ih ii b">meshctl</code>…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="d613" class="ll kc ar bz ii b eg lm ln r lo">sub-add 0100 c000 1000</span></pre>
                <p id="2141" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">This creates a new Subscription
                  that will monitor updates to Unicast Address <code class="ea if ig ih ii b">0100</code> (our first
                  node). The Subscription will listen to Group Address <code class="ea if ig ih ii b">c000</code> for
                  updates to Model #<code class="ea if ig ih ii b">1000</code> (our Switch, the Generic On/Off Server).
                </p>
                <p id="83c3" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm"><em class="hv">What is this Group
                    Address </em><code class="ea if ig ih ii b">c000</code><em class="hv">?</em></p>
                <p id="d2bc" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">In a while we’ll see that <code
                    class="ea if ig ih ii b">c000</code> is the Group Address that our Switch will use to publish on/off
                  updates.</p>
                <p id="1136" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Yes we have only one node, but
                  it’s perfectly OK for the node to subscribe to itself. This enables the Light inside our node to
                  subscribe to updates from the Switch that belongs to the same node. <em class="hv">Flip the Switch,
                    and the Light changes!</em></p>
                <p id="da94" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Let’s create another Subscription
                  to reinforce the Publish/Subscribe concept. Enter into <code class="ea if ig ih ii b">meshctl</code>…
                </p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="6da3" class="ll kc ar bz ii b eg lm ln r lo">sub-add 0100 c000 1002</span></pre>
                <p id="0acf" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">This creates a new Subscription
                  that will monitor updates to Unicast Address <code class="ea if ig ih ii b">0100</code> (same node).
                  The Subscription will listen to Group Address <code class="ea if ig ih ii b">c000</code> (same
                  address).</p>
                <p id="61c6" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">But this time we’re listening for
                  updates to Model #<code class="ea if ig ih ii b">1002</code> (our Generic Level Server). Why would we
                  do this? So that the first node can propagate its Brightness Level to other nodes and achieve
                  all-round <em class="hv">Fifty Shades of Grey</em> (actually 65,536 shades).</p>
              </div>
            </div>
          </section>
          <hr class="jo em jp jq jr ej js jt ju jv jw" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah en aj ak">
                <figure class="ho hp hq hr hs do da db paragraph-image">

                  <p><img src="https://lupyuen.github.io/images/legacy/l8.png" /></p>

                </figure>
                <h1 id="6f0c" class="kb kc ar bz by jk er kd et ke kf kg kh ki kj kk kl">Publish On/Off Status and
                  Brightness Level</h1>
                <p id="575b" class="gz ha ar bz hb b hc km he kn hg ko hi kp hk kq hm">To complete the node
                  configuration let’s publish the On/Off Status. Enter into <code
                    class="ea if ig ih ii b">meshctl</code>…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="39a1" class="ll kc ar bz ii b eg lm ln r lo">pub-set 0100 c000 1 0 5 1001</span></pre>
                <p id="5826" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">This creates a new Publication
                  that will notify its subscribers of updates to Unicast Address <code
                    class="ea if ig ih ii b">0100</code> (the first node).</p>
                <p id="f807" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">The updates shall be published to
                  Group Address <code class="ea if ig ih ii b">c000</code> (remember this?). We may pick any Group
                  Address from <code class="ea if ig ih ii b">c000</code> to <code class="ea if ig ih ii b">ffff</code>.
                </p>
                <p id="7288" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">For security, we shall lock the
                  Publication with AppKey #<code class="ea if ig ih ii b">1</code>. The numbers <code
                    class="ea if ig ih ii b">0</code> and <code class="ea if ig ih ii b">5</code> refer to the Publish
                  Period and Publish Retransmit Count (which we won’t cover today, but retransmits are really helpful).
                </p>
                <p id="efbd" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Updates to the On/Off Status
                  shall be channelled to the Light, which is Model #<code class="ea if ig ih ii b">1001</code> (our
                  Generic On/Off Client).</p>
                <p id="c5fb" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Lastly we publish the Brightness
                  Level by entering…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="084a" class="ll kc ar bz ii b eg lm ln r lo">pub-set 0100 c000 1 0 5 1003</span></pre>
                <p id="ce82" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Everything is the same, except
                  for Model #<code class="ea if ig ih ii b">1003</code>, the Generic Level Client that can receive
                  updates for 65,536 levels of brightness. <em class="hv">(No more shady business today I promise!)</em>
                </p>
                <p id="489e" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm"><a
                    href="https://www.96boards.org/blog/patient-monitoring-system-part4/"
                    class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow"><em class="hv">Here’s an excellent
                      application of Generic Level Model</em></a></p>
              </div>
            </div>
          </section>
          <hr class="jo em jp jq jr ej js jt ju jv jw" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah en aj ak">
                <h1 id="1925" class="kb kc ar bz by jk er ld et le kf lf kh lg kj lh kl">Test Publish and Subscribe</h1>
                <p id="6ac9" class="gz ha ar bz hb b hc km he kn hg ko hi kp hk kq hm">Enough provisioning and
                  configuring for our first node… Let’s test it! In <code class="ea if ig ih ii b">meshctl</code> enter…
                </p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="6efb" class="ll kc ar bz ii b eg lm ln r lo">back<br/>menu onoff<br/>target 0100</span></pre>
                <p id="e310" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Remember that Generic On/Off is a
                  standard Model in Bluetooth Mesh. So <code class="ea if ig ih ii b">meshctl</code> will let us send
                  On/Off commands easily (via the <code class="ea if ig ih ii b">onoff</code> menu) to test our node.
                </p>
                <p id="5da7" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">As for the <code
                    class="ea if ig ih ii b">target</code>… Which node shall we be testing? <code
                    class="ea if ig ih ii b">0100</code> of course. Enter into <code
                    class="ea if ig ih ii b">meshctl</code>…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="21af" class="ll kc ar bz ii b eg lm ln r lo">onoff 0</span></pre>
                <p id="f2de" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">This sets the On/Off Client
                  Status to Off. The nRF52 application has been programmed to show the On/Off Client Status on the LED,
                  so this flips the LED Light off. (Check the LED!)</p>
                <p id="7d53" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Verify the On/Off Client Status
                  by entering…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="343a" class="ll kc ar bz ii b eg lm ln r lo">get</span></pre>
                <p id="3908" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">You should see value 0…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="a373" class="ll kc ar bz ii b eg lm ln r lo">On Off Model Message received (1) opcode 8204<br/>00</span></pre>
                <p id="90a0" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">The nRF52 Console Log should show
                  the LED Light flipping off…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="499c" class="ll kc ar bz ii b eg lm ln r lo">power-&gt; 0, color-&gt; 0</span></pre>
                <p id="0e27" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Now watch what happens when you
                  enter this…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="3a61" class="ll kc ar bz ii b eg lm ln r lo">onoff 1<br/>get</span></pre>
                <p id="fc9f" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm"><em class="hv">Yes we are now
                    flipping our nRF52 LED Light on and off wirelessly via our Raspberry Pi!</em></p>
                <p id="894f" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Try the same thing you see in the
                  <a href="https://youtu.be/5W9GteiLClg"
                    class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">video at the top of this
                    article</a>… Press the buttons on the nRF52 board one at a time. Pressing the first button should
                  flip the Light on, pressing the second button should flip the Light off.</p>
                <p id="3851" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">The nRF52 application has been
                  programmed such that pressing the buttons will set the on/off state of the On/Off Server (the Master
                  Switch).</p>
                <p id="a67e" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Remember that the LED Light is an
                  On/Off Client that subscribes to the server… Hence the LED Light will also flip on and off.</p>
                <p id="1e76" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm"><em class="hv">This is Publish
                    and Subscribe in action!</em></p>
                <p id="f8c5" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">When we have finished testing,
                  exit <code class="ea if ig ih ii b">meshctl</code> by entering…</p>
                <pre
                  class="ho hp hq hr hs li lj lk"><span id="b8ec" class="ll kc ar bz ii b eg lm ln r lo">exit</span></pre>
                <p id="f81a" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Always exit <code
                    class="ea if ig ih ii b">meshctl</code> before powering down any mesh node. Otherwise <code
                    class="ea if ig ih ii b">meshctl</code> may hang while attempting to exit. (And you would need to
                  reboot your Raspberry Pi to release the locked Bluetooth driver)</p>
                <p id="f412" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">To connect to the mesh network in
                  future, just launch <code class="ea if ig ih ii b">meshctl</code> and enter <code
                    class="ea if ig ih ii b">connect</code>. All the provisioning details are stored in <code
                    class="ea if ig ih ii b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/apps/my_sensor_app/src/prov_db.json" class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">prov_db.json</a></code>,
                  so <code class="ea if ig ih ii b">meshctl</code> knows exactly how to connect to the mesh. You may
                  power up the nRF52 board by disconnecting it from ST-Link and connecting a USB Charger to the Micro
                  USB port. Here’s a video demo…</p>
              </div>
            </div>
            <div class="do">
              <div class="n p">
                <div class="hw hx hy hz ia ib ag ic ah id aj ak">
                  <figure class="ho hp hq hr hs do">
                    <div class="dz r ds">
                      <div class="ie r"><iframe
                          src="https://cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fwww.youtube.com%2Fembed%2FvqqJWGAsV64%3Ffeature%3Doembed&amp;url=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DvqqJWGAsV64&amp;image=https%3A%2F%2Fi.ytimg.com%2Fvi%2FvqqJWGAsV64%2Fhqdefault.jpg&amp;key=a19fcc184b9711e1b4764040d3dc5c07&amp;type=text%2Fhtml&amp;schema=youtube"
                          allowfullscreen="" frameborder="0" height="480" width="854"
                          title="Bluetooth Mesh with meshctl, Apache Mynewt and nRF52" class="de t u dw ak"
                          scrolling="auto"></iframe></div>
                    </div>
                    <figcaption class="cd eg eh ei ej dc da db ek el by em">Connecting to Bluetooth Mesh with meshctl.
                      The nRF52 board is powered by a USB charger connected to the Micro USB port.</figcaption>
                  </figure>
                </div>
              </div>
            </div>
          </section>
          <hr class="jo em jp jq jr ej js jt ju jv jw" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah en aj ak">
                <h1 id="e70a" class="kb kc ar bz by jk er ld et le kf lf kh lg kj lh kl">Provision, Configure and Test
                  Node #1</h1>
                <p id="6e68" class="gz ha ar bz hb b hc km he kn hg ko hi kp hk kq hm">Here’s a recap of the steps to
                  provision, configure and test our first mesh node…</p>
                <figure class="ho hp hq hr hs do">

                  <p><script src="https://gist.github.com/lupyuen/f6bca2a7a08d30cc53e8a0b6300226ab.js"></script></p>

                  <figcaption class="cd eg eh ei ej dc da db ek el by em">Provision, configure and test Node #1. From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-mesh.log"
                      class="bi cv ku kv kw kx" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-mesh.log</a>
                  </figcaption>
                </figure>
                <p id="e5f3" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Here are my <code
                    class="ea if ig ih ii b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-mesh.log" class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">meshctl</a></code><a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-mesh.log"
                    class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow"> Log</a> and <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-app.log"
                    class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">Console Log</a> for provisioning
                  the first node.</p>
                <p id="f7ee" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Let’s complete the setup for the
                  remaining three nodes in our mesh…</p>
                <figure class="ho hp hq hr hs do da db paragraph-image">

                  <p><img src="https://lupyuen.github.io/images/legacy/l9.png" /></p>


                  <figcaption class="cd eg eh ei ej dc da db ek el by em">Our Bluetooth Mesh with four nodes
                  </figcaption>
                </figure>
              </div>
            </div>
          </section>
          <hr class="jo em jp jq jr ej js jt ju jv jw" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah en aj ak">
                <h1 id="adde" class="kb kc ar bz by jk er ld et le kf lf kh lg kj lh kl">Provision, Configure and Test
                  Nodes #2, 3 and 4</h1>
                <p id="9523" class="gz ha ar bz hb b hc km he kn hg ko hi kp hk kq hm">The mesh demo application works
                  with two or more nodes. Here are the steps for setting up the second, third and fourth nodes.</p>
                <p id="8b87" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm"><a class="bi cv ku kv kw kx"
                    target="_blank" rel="noopener"
                    href="/web/20191217201743/https://medium.com/@ly.lee/install-bluetooth-mesh-and-apache-mynewt-for-nrf52-and-visual-studio-code-on-windows-and-macos-52fe180e13e6?source=friends_link&amp;sk=194cba1416c20fcb14826b40d565999e">Follow
                    the instructions in this article</a> (<em class="hv">“Flash The Firmware”</em>) to flash our
                  application to the second, third and fourth nRF52 boards.</p>
                <p id="fe33" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Before setting up the second mesh
                  node, stop the Visual Studio Code Debugger and disconnect the first node from ST-Link.</p>
                <p id="4e73" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Connect the second node to
                  ST-Link and start the debugger. Press <code class="ea if ig ih ii b">Continue</code> at all
                  breakpoints. Don’t worry, the mesh will run fine without the first node, because <code
                    class="ea if ig ih ii b">meshctl</code> has all the mesh details in <code
                    class="ea if ig ih ii b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/apps/my_sensor_app/src/prov_db.json" class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">prov_db.json</a></code>
                </p>
                <p id="60a2" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Enter these commands to
                  provision, configure and test Node #2…</p>
                <figure class="ho hp hq hr hs do">

                  <p><script src="https://gist.github.com/lupyuen/5579210a6b43e3ec83a1329c8422665b.js"></script></p>

                  <figcaption class="cd eg eh ei ej dc da db ek el by em">Provision, configure and test Node #2. From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-mesh2.log"
                      class="bi cv ku kv kw kx" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-mesh2.log</a>
                  </figcaption>
                </figure>
                <p id="1f0d" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Here are my <code
                    class="ea if ig ih ii b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-mesh2.log" class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">meshctl</a></code><a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-mesh2.log"
                    class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow"> Log</a> and <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-app2.log"
                    class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">Console Log</a> for provisioning
                  the second node.</p>
                <p id="15b4" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Now this looks odd… Can you spot
                  the problem? (Remember that <code class="ea if ig ih ii b">0102</code> is the Unicast Address for Node
                  #2)</p>
                <p id="2912" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm"><code
                    class="ea if ig ih ii b">sub-add 0102 c000 1000</code> — Subscribe to On/Off Updates at Group
                  Address <code class="ea if ig ih ii b">c000<br/>pub-set 0102 c000 1 0 5 1001</code> — Publish On/Off
                  Updates at Group Address <code class="ea if ig ih ii b">c000</code></p>
                <p id="e8d7" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Within Node #2 it makes sense to
                  publish and subscribe On/Off updates locally, so that pressing the buttons on Node #2 will flip the
                  Node #2 LED Light on and off.</p>
                <p id="18aa" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm"><em class="hv">But Group Address
                  </em><code class="ea if ig ih ii b">c000</code><em class="hv"> is already used by Node #1 to publish
                    On/Off updates for the buttons on Node #1!</em></p>
                <p id="ba6d" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Hence when we press the buttons
                  on Node #2, the updates will be propagated to Node #1… The buttons on Node #2 also work as the Master
                  Switch!</p>
                <p id="2ef9" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">This fix for this is… left as an
                  exercise for the reader. For now we’re using a simple setup that has the unintended effect of making
                  all nodes the Master Switch. Now for Node #3…</p>
                <p id="a37d" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Stop the debugger, disconnect
                  Node #2 from ST-Link, connect Node #3 to ST-Link and start the debugger. Press <code
                    class="ea if ig ih ii b">Continue</code> at all breakpoints.</p>
                <p id="bf00" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Enter these commands to
                  provision, configure and test Node #3…</p>
                <figure class="ho hp hq hr hs do">

                  <p><script src="https://gist.github.com/lupyuen/7b5e6529cd090a19671abd626b60bded.js"></script></p>

                  <figcaption class="cd eg eh ei ej dc da db ek el by em">Provision, configure and test Node #3. From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-mesh3.log"
                      class="bi cv ku kv kw kx" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-mesh3.log</a>
                  </figcaption>
                </figure>
                <p id="55f0" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Here are my <code
                    class="ea if ig ih ii b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-mesh3.log" class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">meshctl</a></code><a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-mesh3.log"
                    class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow"> Log</a> and <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-app3.log"
                    class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">Console Log</a> for provisioning
                  the third node. Finally for Node #4…</p>
                <p id="6a4b" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Stop the debugger, disconnect
                  Node #3 from ST-Link, connect Node #4 to ST-Link and start the debugger. Press <code
                    class="ea if ig ih ii b">Continue</code> at all breakpoints.</p>
                <p id="ab03" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Enter these commands to
                  provision, configure and test Node #4…</p>
                <figure class="ho hp hq hr hs do">

                  <p><script src="https://gist.github.com/lupyuen/030789ad983273d5b3caeee509bb799a.js"></script></p>

                  <figcaption class="cd eg eh ei ej dc da db ek el by em">Provision, configure and test Node #4. From <a
                      href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-mesh4.log"
                      class="bi cv ku kv kw kx" target="_blank"
                      rel="noopener nofollow">https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-mesh4.log</a>
                  </figcaption>
                </figure>
                <p id="5739" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Here are my <code
                    class="ea if ig ih ii b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-mesh4.log" class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">meshctl</a></code><a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-mesh4.log"
                    class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow"> Log</a> and <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/logs/provision-app4.log"
                    class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">Console Log</a> for provisioning
                  the fourth node.</p>
                <p id="ce96" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Here’s my <code
                    class="ea if ig ih ii b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/apps/my_sensor_app/src/prov_db.json" class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">prov_db.json</a></code>
                  after provisioning all four nodes. I strongly recommend that you backup your copy of <code
                    class="ea if ig ih ii b"><a href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/apps/my_sensor_app/src/prov_db.json" class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">prov_db.json</a></code>
                  located at the <code class="ea if ig ih ii b">pi</code> home directory of your Raspberry Pi… Because
                  the microSD Card can get corrupted so easily. (Happened a few times while I was writing this)</p>
                <p id="8221" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">If we need to re-provision any of
                  the nodes, remember to erase the Flash ROM with the <code
                    class="ea if ig ih ii b">Terminal → Run Task → Erase Flash</code> command in Visual Studio Code.</p>
                <p id="8904" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">And we’re done! Disconnect the
                  fourth node from ST-Link. Power up all four nodes by connecting a USB Charger to the Micro USB port.
                  Press the buttons on Node #1 <a
                    href="https://youtu.be/5W9GteiLClg"
                    class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">like in this video</a>… And the
                  LED Light on other nodes will magically flip on and off!</p>
                <p id="d910" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm"><em class="hv">Master Light
                    Switch accomplished with Bluetooth Mesh!</em></p>
              </div>
            </div>
          </section>
          <hr class="jo em jp jq jr ej js jt ju jv jw" />
          <section class="dj dk dl dm dn">
            <div class="do ak">
              <figure class="ho hp hq hr hs do ak paragraph-image">

                <p><img src="https://lupyuen.github.io/images/legacy/l10.png" /></p>

        
              </figure>
            </div>
            <div class="n p">
              <div class="ac ae af ag ah en aj ak">
                <h1 id="5650" class="kb kc ar bz by jk er kd et ke kf kg kh ki kj kk kl">What’s Next?</h1>
                <p id="c174" class="gz ha ar bz hb b hc km he kn hg ko hi kp hk kq hm">This is the second article in my
                  nRF52 series of articles. The first article is here: <em class="hv">“</em><a class="bi cv ku kv kw kx"
                    target="_blank" rel="noopener"
                    href="/web/20191217201743/https://medium.com/@ly.lee/coding-nrf52-with-rust-and-apache-mynewt-on-visual-studio-code-9521bcba6004?source=friends_link&amp;sk=bb4e2523b922d0870259ab3fa696c7da"><em
                      class="hv">Coding nRF52 with Rust and Apache Mynewt on Visual Studio Code</em></a><em
                    class="hv">”</em></p>
                <p id="e362" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Bluetooth Mesh looks really
                  useful for the upcoming <a
                    href="https://www.cnx-software.com/2019/09/25/pinetime-smartwatch-specifications-released-availability-scheduled-for-h1-2020/"
                    class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">PineTime Smart Watch</a> (also
                  based on nRF52). So you can discover which of your friends and family members are in close range
                  (assuming they are wearing the watch too).</p>
                <p id="80c4" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm"><em class="hv">Can’t wait to
                    install Bluetooth Mesh on PineTime! Here’s my review…</em></p>
                <div class="ij ik il im in io"><a rel="noopener"
                    href="/web/20191217201743/https://medium.com/swlh/sneak-peek-of-pinetime-smart-watch-and-why-its-perfect-for-teaching-iot-81b74161c159">
                    <section class="ir da db ak ct n bh is it iu iv iw ix iy iz ja jb jc jd je jf jg">
                      <div class="jh n dd p ji jj">
                        <h2 class="by jk jl ca ar">
                          <div class="ax ip fz au iq aw">Sneak Peek of PineTime Smart Watch… And why it’s perfect for
                            teaching IoT</div>
                        </h2>
                        <div class="jm r">
                          <h3 class="by em eg ca cd">
                            <div class="ax ip fz au iq aw">I’m one of the lucky few who received the developer preview
                              version of the PineTime Smart Watch by Pine64. (My official…</div>
                          </h3>
                        </div>
                        <div class="jn r">
                          <h4 class="by em go ca cd">
                            <div class="ax ip fz au iq aw">medium.com</div>
                          </h4>
                        </div>
                      </div>
                      <div class="mh r">
                        <div class="mi r mj mk ml mh mm mn mo"></div>
                      </div>
                    </section>
                  </a></div>
                <div class="ij ik il im in io"><a rel="noopener"
                    href="/web/20191217201743/https://medium.com/@ly.lee/building-a-rust-driver-for-pinetimes-touch-controller-cbc1a5d5d3e9">
                    <section class="ir da db ak ct n bh is it iu iv iw ix iy iz ja jb jc jd je jf jg">
                      <div class="jh n dd p ji jj">
                        <h2 class="by jk jl ca ar">
                          <div class="ax ip fz au iq aw">Building a Rust Driver for PineTime’s Touch Controller</div>
                        </h2>
                        <div class="jm r">
                          <h3 class="by em eg ca cd">
                            <div class="ax ip fz au iq aw">Pretend you’re my IoT student. I give you a PineTime Smart
                              Watch and challenge you to “Make it work… Especially the…</div>
                          </h3>
                        </div>
                        <div class="jn r">
                          <h4 class="by em go ca cd">
                            <div class="ax ip fz au iq aw">medium.com</div>
                          </h4>
                        </div>
                      </div>
                      <div class="mh r">
                        <div class="mp r mj mk ml mh mm mn mo"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="6c6e" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">You may have noticed that the
                  nRF52 application includes the <a class="bi cv ku kv kw kx" target="_blank" rel="noopener"
                    href="/web/20191217201743/https://medium.com/@ly.lee/coding-nrf52-with-rust-and-apache-mynewt-on-visual-studio-code-9521bcba6004?source=friends_link&amp;sk=bb4e2523b922d0870259ab3fa696c7da">Embedded
                    Rust runtime</a>. I’ll be using Rust Macros to eliminate the <a
                    href="https://github.com/lupyuen/stm32bluepill-mynewt-sensor/blob/mesh/apps/my_sensor_app/src/device_composition.c"
                    class="bi cv ku kv kw kx" target="_blank" rel="noopener nofollow">repetitive C code</a> used for
                  building Bluetooth Mesh.</p>
                <p id="ebd9" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm"><em class="hv">Bluetooth Mesh
                    programming doesn’t need to be so complicated… Stay tuned for the simpler, safer Rust version!</em>
                </p>
              </div>
            </div>
          </section>
          <hr class="jo em jp jq jr ej js jt ju jv jw" />
          <section class="dj dk dl dm dn">
            <div class="n p">
              <div class="ac ae af ag ah en aj ak">
                <h1 id="a124" class="kb kc ar bz by jk er ld et le kf lf kh lg kj lh kl">References</h1>
                <p id="51e4" class="gz ha ar bz hb b hc km he kn hg ko hi kp hk kq hm">Our sample application comes from
                  the open-source Apache NimBLE project, which is described here…</p>
                <div class="ij ik il im in io"><a
                    href="https://github.com/apache/mynewt-nimble"
                    rel="noopener nofollow">
                    <section class="ir da db ak ct n bh is it iu iv iw ix iy iz ja jb jc jd je jf jg">
                      <div class="jh n dd p ji jj">
                        <h2 class="by jk jl ca ar">
                          <div class="ax ip fz au iq aw">apache/mynewt-nimble</div>
                        </h2>
                        <div class="jm r">
                          <h3 class="by em eg ca cd">
                            <div class="ax ip fz au iq aw">Apache NimBLE is an open-source Bluetooth 5.0 stack (both
                              Host &amp; Controller) that completely replaces the proprietary…</div>
                          </h3>
                        </div>
                        <div class="jn r">
                          <h4 class="by em go ca cd">
                            <div class="ax ip fz au iq aw">github.com</div>
                          </h4>
                        </div>
                      </div>
                      <div class="mh r">
                        <div class="mq r mj mk ml mh mm mn mo"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="ec2f" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Here’s an excellent tutorial on
                  Bluetooth Mesh based on Zephyr embedded OS…</p>
                <div class="ij ik il im in io"><a
                    href="https://www.96boards.org/blog/patient-monitoring-system-part4/"
                    rel="noopener nofollow">
                    <section class="ir da db ak ct n bh is it iu iv iw ix iy iz ja jb jc jd je jf jg">
                      <div class="jh n dd p ji jj">
                        <h2 class="by jk jl ca ar">
                          <div class="ax ip fz au iq aw">Part 4 - Patient Monitoring System using 96Boards</div>
                        </h2>
                        <div class="jm r">
                          <h3 class="by em eg ca cd">
                            <div class="ax ip fz au iq aw">Hello and Welcome to the final Part 4 of Patient Monitoring
                              System using 96Boards blog series. This blog describes the…</div>
                          </h3>
                        </div>
                        <div class="jn r">
                          <h4 class="by em go ca cd">
                            <div class="ax ip fz au iq aw">www.96boards.org</div>
                          </h4>
                        </div>
                      </div>
                      <div class="mh r">
                        <div class="mr r mj mk ml mh mm mn mo"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="1217" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Another tutorial based on nRF52
                  and Nordic SoftDevice…</p>
                <div class="ij ik il im in io"><a
                    href="https://www.novelbits.io/bluetooth-mesh-tutorial-part-7/"
                    rel="noopener nofollow">
                    <section class="ir da db ak ct n bh is it iu iv iw ix iy iz ja jb jc jd je jf jg">
                      <div class="jh n dd p ji jj">
                        <h2 class="by jk jl ca ar">
                          <div class="ax ip fz au iq aw">The Ultimate Bluetooth Mesh Tutorial (Part 7) - Novel Bits
                          </div>
                        </h2>
                        <div class="jm r">
                          <h3 class="by em eg ca cd">
                            <div class="ax ip fz au iq aw">In today&#x27;s tutorial: We&#x27;ll first take a step back
                              and talk a little bit about interoperability and compatibility in…</div>
                          </h3>
                        </div>
                        <div class="jn r">
                          <h4 class="by em go ca cd">
                            <div class="ax ip fz au iq aw">www.novelbits.io</div>
                          </h4>
                        </div>
                      </div>
                      <div class="mh r">
                        <div class="ms r mj mk ml mh mm mn mo"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="dcca" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">Bluetooth SIG has a series of
                  high-level articles about Bluetooth Mesh…</p>
                <div class="ij ik il im in io"><a
                    href="https://www.bluetooth.com/blog/introducing-bluetooth-mesh-networking/"
                    rel="noopener nofollow">
                    <section class="ir da db ak ct n bh is it iu iv iw ix iy iz ja jb jc jd je jf jg">
                      <div class="jh n dd p ji jj">
                        <h2 class="by jk jl ca ar">
                          <div class="ax ip fz au iq aw">Introducing BluetoothMesh Networking | Bluetooth Technology
                            Website</div>
                        </h2>
                        <div class="jm r">
                          <h3 class="by em eg ca cd">
                            <div class="ax ip fz au iq aw">Bluetooth ® technology, the global standard for simple,
                              secure wireless connectivity, now supports mesh networking. The…</div>
                          </h3>
                        </div>
                        <div class="jn r">
                          <h4 class="by em go ca cd">
                            <div class="ax ip fz au iq aw">www.bluetooth.com</div>
                          </h4>
                        </div>
                      </div>
                      <div class="mh r">
                        <div class="mt r mj mk ml mh mm mn mo"></div>
                      </div>
                    </section>
                  </a></div>
                <p id="6f8f" class="gz ha ar bz hb b hc hd he hf hg hh hi hj hk hl hm">The official Bluetooth Mesh
                  specifications are here…</p>
                <div class="ij ik il im in io"><a
                    href="https://www.bluetooth.com/specifications/mesh-specifications/?utm_campaign=mesh&amp;utm_source=internal&amp;utm_medium=blog&amp;utm_content=bluetooth-mesh-networking-friendship"
                    rel="noopener nofollow">
                    <section class="ir da db ak ct n bh is it iu iv iw ix iy iz ja jb jc jd je jf jg">
                      <div class="jh n dd p ji jj">
                        <h2 class="by jk jl ca ar">
                          <div class="ax ip fz au iq aw">Mesh Networking Specifications | Bluetooth Technology Website
                          </div>
                        </h2>
                        <div class="jm r">
                          <h3 class="by em eg ca cd">
                            <div class="ax ip fz au iq aw">Mesh networking with the power of Bluetooth The Bluetooth ®
                              mesh networking specifications define requirements to…</div>
                          </h3>
                        </div>
                        <div class="jn r">
                          <h4 class="by em go ca cd">
                            <div class="ax ip fz au iq aw">www.bluetooth.com</div>
                          </h4>
                        </div>
                      </div>
                      <div class="mh r">
                        <div class="mu r mj mk ml mh mm mn mo"></div>
                      </div>
                    </section>
                  </a></div>
              </div>
            </div>
          </section>
        </div>
      </article>
    </div>
  </div>
</body>

</html>
<!--
     FILE ARCHIVED ON 20:17:43 Dec 17, 2019 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 23:06:34 Feb 22, 2021.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 105.468
  exclusion.robots: 0.344
  exclusion.robots.policy: 0.33
  RedisCDXSource: 0.781
  esindex: 0.012
  LoadShardBlock: 70.821 (3)
  PetaboxLoader3.datanode: 108.48 (4)
  CDXLines.iter: 29.609 (3)
  load_resource: 122.089
  PetaboxLoader3.resolve: 31.66
-->