<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Zig Visual Programming with Blockly</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Zig Visual Programming with Blockly" 
    data-rh="true">
<meta property="og:description" 
    content="How we create a Zig program visually with Blockly, the drag-n-drop way... And how we might use it to build Sensor IoT Apps for Apache NuttX RTOS"
    data-rh="true">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/blockly-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

        <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Zig Visual Programming with Blockly</h1>
    <nav id="TOC"><ul>
<li><a href="#visual-program">1 Visual Program</a><ul></ul></li>
<li><a href="#code-generator">2 Code Generator</a><ul>
<li><a href="#set-variable">2.1 Set Variable</a><ul></ul></li>
<li><a href="#print-expression">2.2 Print Expression</a><ul></ul></li>
<li><a href="#repeat-loop">2.3 Repeat Loop</a><ul></ul></li>
<li><a href="#main-function">2.4 Main Function</a><ul></ul></li></ul></li>
<li><a href="#define-functions">3 Define Functions</a><ul></ul></li>
<li><a href="#blockly-is-typeless">4 Blockly is Typeless</a><ul></ul></li>
<li><a href="#constants-vs-variables">5 Constants vs Variables</a><ul></ul></li>
<li><a href="#desktop-and-mobile">6 Desktop and Mobile</a><ul></ul></li>
<li><a href="#iot-sensor-apps">7 IoT Sensor Apps</a><ul></ul></li>
<li><a href="#read-sensor-data">8 Read Sensor Data</a><ul></ul></li>
<li><a href="#transmit-sensor-data">9 Transmit Sensor Data</a><ul></ul></li>
<li><a href="#whats-next">10 What‚Äôs Next</a><ul></ul></li>
<li><a href="#notes">11 Notes</a><ul></ul></li>
<li><a href="#appendix-fixed-point-numbers">12 Appendix: Fixed-Point Numbers</a><ul></ul></li>
<li><a href="#appendix-add-a-zig-tab">13 Appendix: Add a Zig Tab</a><ul></ul></li>
<li><a href="#appendix-zig-code-generator">14 Appendix: Zig Code Generator</a><ul></ul></li>
<li><a href="#appendix-load-code-generator">15 Appendix: Load Code Generator</a><ul></ul></li>
<li><a href="#appendix-build-blockly">16 Appendix: Build Blockly</a><ul></ul></li>
<li><a href="#appendix-test-blockly">17 Appendix: Test Blockly</a><ul></ul></li></ul></nav><p>üìù <em>11 Aug 2022</em></p>
<p><img src="https://lupyuen.github.io/images/blockly-title.jpg" alt="Zig Visual Programming with Blockly" /></p>
<p><em>Can we create a Zig program visually‚Ä¶ The Drag-and-Drop way?</em></p>
<p>Let‚Äôs find out! Today we shall explore <a href="https://developers.google.com/blockly"><strong>Blockly</strong></a>, the Scratch-like browser-based coding toolkit‚Ä¶</p>
<p>And how we might customise Blockly to <strong>create Zig programs</strong> visually. (Pic above)</p>
<p><em>Will it work for any Zig program?</em></p>
<p>We‚Äôre not quite done yet. We hit some <strong>interesting challenges</strong>, like Blockly‚Äôs ‚ÄúTypelessness‚Äù and Zig‚Äôs ‚ÄúAnti-Shadowing‚Äù.</p>
<p>But it might work for creating <strong>IoT Sensor Apps</strong> for Embedded Platforms. (Like Apache NuttX RTOS)</p>
<p>(More about this below)</p>
<p>Let‚Äôs head down into our Zig experiment with Blocky‚Ä¶</p>
<ul>
<li><a href="https://github.com/lupyuen3/blockly-zig-nuttx"><strong>lupyuen3/blockly-zig-nuttx</strong></a></li>
</ul>
<p>And learn how how we ended up here‚Ä¶</p>
<ul>
<li><a href="https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/"><strong>Blockly with Zig (Work in Progress)</strong></a></li>
</ul>
<h1 id="visual-program"><a href="#visual-program">1 Visual Program</a></h1>
<p><em>What‚Äôs Visual Programming like with Blockly?</em></p>
<p>With Blockly, we create Visual Programs by dragging and dropping <strong>Interlocking Blocks</strong>. (Exactly like Scratch and MakeCode)</p>
<p>This is a Visual Program that loops 10 times, printing the number <code>123.45</code>‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/blockly-run1.png" alt="Blockly Visual Program" /></p>
<p>We can try dragging-n-dropping the Blocks here‚Ä¶</p>
<ul>
<li><a href="https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/"><strong>Blockly with Zig (Work in Progress)</strong></a></li>
</ul>
<p>To find the above Blocks, click the <strong>Blocks Toolbox</strong> (at left) and look under <strong>‚ÄúLoops‚Äù</strong>, <strong>‚ÄúVariables‚Äù</strong>, <strong>‚ÄúMath‚Äù</strong> and <strong>‚ÄúText‚Äù</strong>.</p>
<p><em>But will it produce a Zig program?</em></p>
<p>Yep if we click the <strong>Zig Tab</strong>‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/blockly-run3a.png" alt="Zig Tab in Blockly" /></p>
<p>This <strong>Zig Program</strong> appears‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>/// Import Standard Library
const std = @import(&quot;std&quot;);

/// Main Function
pub fn main() !void {
  var count: usize = 0;
  while (count &lt; 10) : (count += 1) {
    const a: f32 = 123.45;
    debug(&quot;a={}&quot;, .{ a });
  }
}

/// Aliases for Standard Library
const assert = std.debug.assert;
const debug  = std.log.debug;</code></pre></div>
<p>When we copy-n-paste the program and run it with Zig‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>$ zig run a.zig
debug: a=1.23449996e+02
debug: a=1.23449996e+02
debug: a=1.23449996e+02
debug: a=1.23449996e+02
debug: a=1.23449996e+02
debug: a=1.23449996e+02
debug: a=1.23449996e+02
debug: a=1.23449996e+02
debug: a=1.23449996e+02
debug: a=1.23449996e+02</code></pre></div>
<p>Indeed it produces the right result!</p>
<p>(Not the tidiest output, but we‚Äôll come back to this)</p>
<p><em>Will this work with all Blocks?</em></p>
<p>Not quite. We customised Blockly to support the <strong>bare minimum of Blocks</strong>.</p>
<p>There‚Äôs plenty more to be customised for Zig. Lemme know if you‚Äôre keen to help! üôè</p>
<p><img src="https://lupyuen.github.io/images/blockly-run2.png" alt="Zig Code generated by Blocky" /></p>
<h1 id="code-generator"><a href="#code-generator">2 Code Generator</a></h1>
<p><em>How did Blockly automagically output our Zig Program?</em></p>
<p>Blockly comes bundled with <strong>Code Generators</strong> that will churn out programs in JavaScript, Python, Dart, ‚Ä¶</p>
<p>Sadly it doesn‚Äôt have one for Zig. So we built our own <strong>Zig Code Generator</strong> for Blockly‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/blockly#appendix-add-a-zig-tab"><strong>‚ÄúAdd a Zig Tab‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/blockly#appendix-zig-code-generator"><strong>‚ÄúZig Code Generator‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/blockly#appendix-load-code-generator"><strong>‚ÄúLoad Code Generator‚Äù</strong></a></p>
</li>
</ul>
<p><em>Every Block generates its own Zig Code?</em></p>
<p>Our Code Generator needs to output Zig Code for <strong>every kind of Block</strong>.</p>
<p>(Which makes it tiresome to customise Blockly for Zig)</p>
<p>To understand the work involved, we‚Äôll look at three Blocks and how our Code Generator handles them‚Ä¶</p>
<ul>
<li>
<p><strong>Set Variable</strong></p>
</li>
<li>
<p><strong>Print Expression</strong></p>
</li>
<li>
<p><strong>Repeat Loop</strong></p>
</li>
</ul>
<p>We‚Äôll also study the <strong>Main Function</strong> that‚Äôs produced by our Code Generator.</p>
<p><img src="https://lupyuen.github.io/images/blockly-run5.png" alt="Set Variable" /></p>
<h2 id="set-variable"><a href="#set-variable">2.1 Set Variable</a></h2>
<p>Blockly will let us assign Values to Variables. (Pic above)</p>
<p>To keep things simple, we‚Äôll handle Variables as <strong>Constants</strong>. And they shall be <strong>Floating-Point Numbers</strong>. (We‚Äôll explain why)</p>
<p>Thus the Block above will generate this Zig code‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>const a: f32 = 123.45;</code></pre></div>
<p>This is how we generate the code with a template (through <strong>String Interpolation</strong>): <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig/variables.js#L25-L32">generators/zig/variables.js</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>Zig[&#39;variables_set&#39;] = function(block) {
  // Variable setter.
  ...
  return `const ${varName}: f32 = ${argument0};\n`;
};</code></pre></div>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Template_literals">(More about String Interpolation)</a></p>
<p><em>Isn‚Äôt this (gasp) JavaScript?</em></p>
<p>Blockly is coded in <strong>plain old JavaScript</strong>. Hence we‚Äôll write our Zig Code Generator in JavaScript too.</p>
<p>(Maybe someday we‚Äôll convert the Zig Code Generator to WebAssembly and build it in Zig)</p>
<p><img src="https://lupyuen.github.io/images/blockly-run6.png" alt="Print Expression" /></p>
<h2 id="print-expression"><a href="#print-expression">2.2 Print Expression</a></h2>
<p>To <strong>print the value</strong> of an expression (pic above), we generate this Zig code‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>debug(&quot;a={}&quot;, .{ a });</code></pre></div>
<p>Here‚Äôs the implementation in our Zig Code Generator: <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig/text.js#L268-L272">generators/zig/text.js</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>Zig[&#39;text_print&#39;] = function(block) {
  // Print statement.
  ...
  return `debug(&quot;${msg}={}&quot;, .{ ${msg} });\n`;
};</code></pre></div>
<p>(It won‚Äôt work with strings, we‚Äôll handle that later)</p>
<p><img src="https://lupyuen.github.io/images/blockly-run4.png" alt="Repeat Loop" /></p>
<h2 id="repeat-loop"><a href="#repeat-loop">2.3 Repeat Loop</a></h2>
<p>To run a <strong>repeating loop</strong> (pic above), we generate this Zig code‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>var count: usize = 0;
while (count &lt; 10) : (count += 1) {
  ...
}</code></pre></div>
<p>With this template in our Zig Code Generator: <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig/loops.js#L19-L45">generators/zig/loops.js</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>Zig[&#39;controls_repeat_ext&#39;] = function(block) {
  // Repeat n times.
  ...
  code += [
    `var ${loopVar}: usize = 0;\n`,
    `while (${loopVar} &lt; ${endVar}) : (${loopVar} += 1) {\n`,
    branch,
    &#39;}\n&#39;
  ].join(&#39;&#39;);
  return code;
};</code></pre></div>
<p><em>What if we have two Repeat Loops? Won‚Äôt ‚Äú<code>count</code>‚Äù clash?</em></p>
<p>Blockly will helpfully <strong>generate another counter</strong> like ‚Äú<code>count2</code>‚Äù‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>var count2: usize = 0;
while (count2 &lt; 10) : (count2 += 1) {
  ...
}</code></pre></div>
<p>(Try it out!)</p>
<h2 id="main-function"><a href="#main-function">2.4 Main Function</a></h2>
<p>To become a valid Zig program, our generated Zig code needs to be wrapped into a <strong>Main Function</strong> like this‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>/// Import Standard Library
const std = @import(&quot;std&quot;);

/// Main Function
pub fn main() !void {
  // TODO: Generated Zig Code here
  ...
}

/// Aliases for Standard Library
const assert = std.debug.assert;
const debug  = std.log.debug;</code></pre></div>
<p>We do this with another template in our Zig Code Generator: <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig.js#L132-L193">generators/zig.js</a></p>
<div class="example-wrap"><pre class="language-javascript"><code>Zig.finish = function(code) {
  ...
  // Compose Main Function
  code = [
    &#39;/// Main Function\n&#39;,
    &#39;pub fn main() !void {\n&#39;,
    code,
    &#39;}&#39;,
  ].join(&#39;&#39;);</code></pre></div>
<p>The code above composes the <strong>Main Function</strong>.</p>
<p>Next we define the <strong>Header and Trailer</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-javascript"><code>  // Compose Zig Header
  const header = [
    &#39;/// Import Standard Library\n&#39;,
    &#39;const std = @import(&quot;std&quot;);\n&#39;,
  ].join(&#39;&#39;);

  // Compose Zig Trailer
  const trailer = [
    &#39;/// Aliases for Standard Library\n&#39;,
    &#39;const assert = std.debug.assert;\n&#39;,
    &#39;const debug  = std.log.debug;\n&#39;,
  ].join(&#39;&#39;);</code></pre></div>
<p>Finally we combine them and return the result‚Ä¶</p>
<div class="example-wrap"><pre class="language-javascript"><code>  // Combine Header, Code, 
  // Function Definitions and Trailer
  return [
    header,
    &#39;\n&#39;,
    code,
    (allDefs == &#39;&#39;) ? &#39;&#39; : &#39;\n\n&#39;,
    allDefs.replace(/\n\n+/g, &#39;\n\n&#39;).replace(/\n*$/, &#39;\n\n&#39;),
    trailer,
  ].join(&#39;&#39;);
};</code></pre></div>
<p>Let‚Äôs talk about Function Definitions‚Ä¶</p>
<h1 id="define-functions"><a href="#define-functions">3 Define Functions</a></h1>
<p><em>Can we define Zig Functions in Blockly?</em></p>
<p>Sure can! This <strong>Function Block</strong>‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/blockly-run7a.jpg" alt="Define Blockly Function" /></p>
<p><a href="https://lupyuen.github.io/images/blockly-run9.jpg">(Parameters are defined in <strong>Function Settings</strong>)</a></p>
<p>Will generate this perfectly valid <strong>Zig Function</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>fn do_something(x: f32, y: f32) !f32 {
  const a: f32 = 123.45;
  debug(&quot;a={}&quot;, .{ a });
  return x + y;
}</code></pre></div>
<p>And calling the above function‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/blockly-run7b.jpg" alt="Call Blockly Function" /></p>
<p>Works OK with Zig too‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>const a: f32 = 123.45;
const b: f32 = try do_something(a, a);
debug(&quot;b={}&quot;, .{ b });</code></pre></div>
<p>Thus indeed it‚Äôs possible to create <a href="https://lupyuen.github.io/images/blockly-run10.jpg"><strong>Complex Blockly Apps</strong></a> with Zig. <a href="https://lupyuen.github.io/images/blockly-run10.jpg">(Like this)</a></p>
<p>The above templates are defined in our Code Generator at <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig/procedures.js#L18-L92">generators/zig/procedures.js</a></p>
<h1 id="blockly-is-typeless"><a href="#blockly-is-typeless">4 Blockly is Typeless</a></h1>
<p><em>Why are our Constants declared as Floating-Point <code>f32</code>?</em></p>
<p>Here comes the interesting challenge with Zig on Blockly‚Ä¶</p>
<p><strong>Blockly is Typeless!</strong></p>
<p>Blockly doesn‚Äôt recognise Types, so it will gladly accept this‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/blockly-run8.jpg" alt="Blocky is Typeless" /></p>
<p>Which works fine with <a href="https://developer.mozilla.org/en-US/docs/Glossary/Dynamic_typing"><strong>Dynamically-Typed Languages</strong></a> like JavaScript‚Ä¶</p>
<div class="example-wrap"><pre class="language-javascript"><code>// Dynamic Type in JavaScript
var a;
a = 123.45;
a = &#39;abc&#39;;</code></pre></div>
<p>But not for <a href="https://developer.mozilla.org/en-US/docs/Glossary/Static_typing"><strong>Statically-Typed Languages</strong></a> like Zig!</p>
<p>That‚Äôs why we constrain all Types as <code>f32</code>, until we figure out how to handle strings and other types‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>// Static Type in Zig
const a: f32 = 123.45;
// Nope we won&#39;t accept &quot;abc&quot;</code></pre></div>
<p><em>Won‚Äôt that severely limit our Zig Programs?</em></p>
<p><code>f32</code> is probably sufficient for simple <strong>IoT Sensor Apps</strong>.</p>
<p>Such apps work only with numeric <strong>Sensor Data</strong> (like temperature, humidity). And they don‚Äôt need to manipulate strings.</p>
<p>(More about this in a while)</p>
<h1 id="constants-vs-variables"><a href="#constants-vs-variables">5 Constants vs Variables</a></h1>
<p><em>What other challenges do we have with Zig on Blockly?</em></p>
<p>Our Astute Reader would have seen this Oncoming Wreckage (from miles away)‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/blockly-run12.jpg" alt="Redeclared Constants in Blockly" /></p>
<p>The <strong>Double Assignment</strong> above will cause Constant Problems‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>// This is OK
const a: f32 = 123.45;

// Oops! `a` is redeclared...
const a: f32 = 234.56;</code></pre></div>
<p>Our Code Generator will have to stop this somehow.</p>
<p><em>Why not declare as a Variable? (Instead of a Constant)</em></p>
<div class="example-wrap"><pre class="language-zig"><code>// This is OK
var a: f32 = undefined;
a = 123.45;
a = 234.56;</code></pre></div>
<p>Call me stupendously stubborn, but I think Constants look neater than Variables?</p>
<p>Also we might have a problem with <a href="https://ziglang.org/documentation/master/#Shadowing"><strong>Shadowed Identifiers</strong></a>‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/blockly-run15.jpg" alt="Shadowing in Blockly" /></p>
<p>This code won‚Äôt compile with Zig even if change <code>const</code> to <code>var</code>‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>// This is OK
const a: f32 = 123.45;
debug(&quot;a={}&quot;, .{ a });

var count: usize = 0;
while (count &lt; 10) : (count += 1) {

  // Oops! `a` is shadowed...
  const a: f32 = 234.56;
  debug(&quot;a={}&quot;, .{ a });
}</code></pre></div>
<p><a href="https://ziglang.org/documentation/master/#Shadowing">(More about Shadowing)</a></p>
<p>So yeah, supporting Zig on Blockly can get really challenging.</p>
<p>(Though supporting C on Blockly would be a total nightmare!)</p>
<h1 id="desktop-and-mobile"><a href="#desktop-and-mobile">6 Desktop and Mobile</a></h1>
<p><em>Can we build Blockly apps on Mobile Devices?</em></p>
<p>Blockly works OK with Mobile Web Browsers‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/blockly-mobile.jpg" alt="Blocky on Mobile Web Browser" /></p>
<p><a href="https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/">(Source)</a></p>
<p><em>Is Blockly available as an offline, non-web Desktop App?</em></p>
<p>Not yet. But we could package Blockly as a <strong>VSCode Extension</strong> that will turn it into a Desktop App‚Ä¶</p>
<ul>
<li><a href="https://lupyuen.github.io/articles/advanced-topics-for-visual-embedded-rust-programming"><strong>Blockly Extension for VSCode</strong></a></li>
</ul>
<p>Or we might package Blockly into a <strong>Standalone App</strong> with Tauri‚Ä¶</p>
<ul>
<li><a href="https://tauri.app/"><strong>Tauri Desktop Bundler</strong></a></li>
</ul>
<p><em>Why would we need a Desktop App for Blockly?</em></p>
<p>It‚Äôs easier to <strong>compile the Generated Zig Code</strong> when we‚Äôre on a Desktop App.</p>
<p>And a Desktop App is more convenient for <strong>flashing the compiled code</strong> to Embedded Devices.</p>
<h1 id="iot-sensor-apps"><a href="#iot-sensor-apps">7 IoT Sensor Apps</a></h1>
<p><em>We said earlier that Blockly might be suitable for IoT Sensor Apps. Why?</em></p>
<p>Suppose we‚Äôre building an <strong>IoT Sensor Device</strong> that will monitor Temperature and Humidity.</p>
<p>The firmware in our device will periodically <strong>read and transmit the Sensor Data</strong> like this‚Ä¶</p>
<p>TODO</p>
<p>Which we might <strong>build with Blockly</strong> like so‚Ä¶</p>
<p><img src="https://lupyuen.github.io/images/sensor-visual.jpg" alt="Visual Programming for Zig with NuttX Sensors" /></p>
<p><em>Whoa that‚Äôs a lot to digest!</em></p>
<p>We‚Äôll break down this IoT Sensor App in the next section.</p>
<p><em>But why build IoT Sensor Apps with Blockly and Zig?</em></p>
<ul>
<li>
<p><strong>Types are simpler:</strong> Only Floating-Point Numbers will be supported for Sensor Data</p>
<p>(No strings needed)</p>
</li>
<li>
<p><strong>Blockly is Typeless:</strong> With Zig we can use Type Inference to deduce the missing Types</p>
<p>(Doing this in C would be extremely painful)</p>
</li>
<li>
<p><strong>Easier to experiment</strong> with various IoT Sensors: Temperature, Humidity, Air Pressure, ‚Ä¶</p>
<p>(Or mix and match a bunch of IoT Sensors!)</p>
</li>
</ul>
<p>Let‚Äôs talk about the reading and sending of Sensor Data‚Ä¶</p>
<h1 id="read-sensor-data"><a href="#read-sensor-data">8 Read Sensor Data</a></h1>
<p>Earlier we talked about our IoT Sensor App <strong>reading Sensor Data</strong> (like Temperature) from a real sensor <a href="https://www.bosch-sensortec.com/products/environmental-sensors/humidity-sensors-bme280/">(like <strong>Bosch BME280</strong>)</a>.</p>
<p>This is how it might look in Blockly‚Ä¶</p>
<blockquote>
<p><img src="https://lupyuen.github.io/images/sensor-visual2.jpg" alt="Read Sensor Data in Blockly" /></p>
</blockquote>
<p>(We‚Äôll populate Blockly with a whole bunch of <strong>Sensor Blocks</strong> like BME280)</p>
<p>And this is the Zig Code that we might auto-generate: <a href="https://github.com/lupyuen/visual-zig-nuttx/blob/visual/visual.zig#L27-L115">visual-zig-nuttx/visual/visual.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>// Read the Temperature
const temperature: f32 = blk: {

  // Open the Sensor Device
  const fd = c.open(
    &quot;/dev/sensor/baro0&quot;,       // Path of Sensor Device
    c.O_RDONLY | c.O_NONBLOCK  // Open for read-only
  );

  // Close the Sensor Device when this block returns
  defer {
    _ = c.close(fd);
  }

  // If Sensor Data is available...
  var sensor_value: f32 = undefined;
  if (c.poll(&amp;fds, 1, -1) &gt; 0) {

    // Define the Sensor Data Type
    var sensor_data = std.mem.zeroes(c.struct_sensor_event_baro);
    const len = @sizeOf(@TypeOf(sensor_data));

    // Read the Sensor Data
    if (c.read(fd, &amp;sensor_data, len) &gt;= len) {

      // Remember the Sensor Value
      sensor_value = sensor_data.temperature;
            
    } else { std.log.err(&quot;Sensor data incorrect size&quot;, .{}); }
  } else { std.log.err(&quot;Sensor data not available&quot;, .{}); }

  // Return the Sensor Value
  break :blk sensor_value;
};

// Print the Temperature
debug(&quot;temperature={}&quot;, .{
  floatToFixed(temperature)
});</code></pre></div>
<p>When we run this on <strong>Apache NuttX RTOS</strong>, it will actually fetch the Temperature from the Bosch BME280 Sensor!</p>
<p><a href="https://lupyuen.github.io/articles/sensor#read-barometer-sensor">(As explained here)</a></p>
<p><em>What a huge chunk of Zig!</em></p>
<p>The complete implementation is a huger chunk of Zig, because we need to <strong>handle Errors</strong>. <a href="https://github.com/lupyuen/visual-zig-nuttx/blob/visual/visual.zig#L27-L115">(See this)</a></p>
<p>But it might be hunky dory for Blockly. We just need to define one Block for <strong>every Sensor</strong> supported by NuttX. (Like BME280)</p>
<p>And every Block will churn out the <strong>Boilerplate Code</strong> (plus Error Handling) that we see above.</p>
<p><em>Surely some of the code can be refactored into reusable Zig Functions?</em></p>
<p>Refactoring the code can get tricky because the <strong>Sensor Data Struct and Fields</strong> are dependent on the Sensor‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>// Define the Sensor Data Type
// Note: `sensor_event_baro` depends on the sensor
var sensor_data = std.mem.zeroes(
  c.struct_sensor_event_baro
);
const len = @sizeOf(@TypeOf(sensor_data));

// Read the Sensor Data
if (c.read(fd, &amp;sensor_data, len) &gt;= len) {

  // Remember the Sensor Value
  // Note: `temperature` depends on the sensor
  sensor_value = sensor_data.temperature;</code></pre></div>
<p><a href="https://ziglang.org/documentation/master/#Compile-Time-Parameters">(<strong><code>comptime</code> Generics</strong> might help)</a></p>
<p><em>What‚Äôs <code>floatToFixed</code>?</em></p>
<div class="example-wrap"><pre class="language-zig"><code>// Read the Temperature as a Float
const temperature: f32 = ...

// Print the Temperature as a
// Fixed-Point Number (2 decimal places)
debug(&quot;temperature={}&quot;, .{
  floatToFixed(temperature)
});</code></pre></div>
<p>That‚Äôs our tidy way of printing <a href="https://en.wikipedia.org/wiki/Fixed-point_arithmetic"><strong>Fixed-Point Numbers</strong></a> (with 2 decimal places)‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>temperature=23.45</code></pre></div>
<p>Instead of the awful <code>2.34500007e+01</code> we saw earlier.</p>
<p><a href="https://lupyuen.github.io/articles/blockly#appendix-fixed-point-numbers">(More about this in the Appendix)</a></p>
<p><em>What‚Äôs <code>blk</code>?</em></p>
<p>That‚Äôs how we return a value from the <strong>Block Expression</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-zig"><code>// Read the Temperature
const temperature: f32 = blk: {

  // Do something
  var fd = ...

  // Return the Sensor Value
  break :blk 23.45;
};</code></pre></div>
<p>This sets <code>temperature</code> to <code>23.45</code>.</p>
<p>Block Expressions are a great way to <strong>prevent leakage</strong> of our Local Variables (like <code>fd</code>) into the Outer Scope and <a href="https://lupyuen.github.io/articles/blockly#constants-vs-variables"><strong>avoid Shadowing</strong></a>.</p>
<p><a href="https://ziglang.org/documentation/master/#blocks">(More about Block Expressions)</a></p>
<h1 id="transmit-sensor-data"><a href="#transmit-sensor-data">9 Transmit Sensor Data</a></h1>
<p>Two sections ago we talked about our IoT Sensor App <strong>transmitting Sensor Data</strong> (like Temperature) to a Wireless IoT Network <a href="https://makezine.com/2021/05/24/go-long-with-lora-radio/">(like <strong>LoRaWAN</strong>)</a>.</p>
<p>We‚Äôll do this in two steps‚Ä¶</p>
<ul>
<li>
<p><strong>Compose</strong> the Sensor Data Message</p>
<p>(Compress our Sensor Data into a tiny Data Packet)</p>
</li>
<li>
<p><strong>Transmit</strong> the Sensor Data Message</p>
<p>(Over LoRaWAN)</p>
</li>
</ul>
<p>Assume we‚Äôve read Temperature and Humidity from our sensor.</p>
<p>This is how we might <strong>compose a Sensor Data Message</strong> in Blockly‚Ä¶</p>
<blockquote>
<p><img src="https://lupyuen.github.io/images/sensor-visual3.jpg" alt="Compose Sensor Data Message in Blockly" /></p>
</blockquote>
<p>TODO: CBOR</p>
<p>This message compressed with CBOR‚Ä¶</p>
<div class="example-wrap"><pre class="language-json"><code>{
  &quot;t&quot;: 2345,
  &quot;h&quot;: 6789
}</code></pre></div>
<p>(Numbers have been scaled up by 100)</p>
<p>Will require only <strong>11 Bytes!</strong> <a href="https://lupyuen.github.io/images/blockly-cbor.jpg">(See this)</a></p>
<p>After composing our Sensor Data Message, this is how we might <strong>transmit the Sensor Data Message</strong> in Blockly‚Ä¶</p>
<blockquote>
<p><img src="https://lupyuen.github.io/images/sensor-visual4.jpg" alt="Transmit Sensor Data Message in Blockly" /></p>
</blockquote>
<p>TODO: Custom block</p>
<p><img src="https://lupyuen.github.io/images/sensor-visual.jpg" alt="Visual Programming for Zig with NuttX Sensors" /></p>
<h1 id="whats-next"><a href="#whats-next">10 What‚Äôs Next</a></h1>
<p>TODO</p>
<p>See my earlier work on Zig, NuttX, LoRaWAN and LVGL‚Ä¶</p>
<ul>
<li>
<p><a href="https://lupyuen.github.io/articles/zig"><strong>‚ÄúZig on RISC-V BL602: Quick Peek with Apache NuttX RTOS‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/iot"><strong>‚ÄúBuild an IoT App with Zig and LoRaWAN‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/lvgl"><strong>‚ÄúBuild an LVGL Touchscreen App with Zig‚Äù</strong></a></p>
</li>
</ul>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/articles/book"><strong>Read ‚ÄúThe RISC-V BL602 / BL604 Book‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/blockly.md"><strong>lupyuen.github.io/src/blockly.md</strong></a></p>
<h1 id="notes"><a href="#notes">11 Notes</a></h1>
<ol>
<li>This article is the expanded version of <a href="https://twitter.com/MisterTechBlog/status/1554650482240397312"><strong>this Twitter Thread</strong></a></li>
</ol>
<h1 id="appendix-fixed-point-numbers"><a href="#appendix-fixed-point-numbers">12 Appendix: Fixed-Point Numbers</a></h1>
<p>TODO</p>
<p><a href="https://github.com/lupyuen/visual-zig-nuttx/blob/visual/visual.zig#L15-L25">visual-zig-nuttx/visual/visual.zig</a></p>
<div class="example-wrap"><pre class="language-zig"><code>const a: f32 = 123.45;
debug(&quot;a={}&quot;, .{ floatToFixed(a) });</code></pre></div><h1 id="appendix-add-a-zig-tab"><a href="#appendix-add-a-zig-tab">13 Appendix: Add a Zig Tab</a></h1>
<p>TODO</p>
<p>Blockly is bundled with a list of Demos‚Ä¶</p>
<p><a href="https://lupyuen3.github.io/blockly-zig-nuttx/demos/">lupyuen3.github.io/blockly-zig-nuttx/demos</a></p>
<p>There‚Äôs a Code Generation Demo that shows the code generated by Blockly for JavaScript, Python, Dart, ‚Ä¶</p>
<p><a href="https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/">lupyuen3.github.io/blockly-zig-nuttx/demos/code</a></p>
<p>Let‚Äôs add a tab that will show the Zig code generated by Blockly: <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/demos/code/index.html">demos/code/index.html</a></p>
<div class="example-wrap"><pre class="language-html"><code>&lt;!--  Inserted this to Load Messages: (Not sure why)  --&gt;
&lt;script src=&quot;../../msg/messages.js&quot;&gt;&lt;/script&gt;
...
&lt;tr id=&quot;tabRow&quot; height=&quot;1em&quot;&gt;
  &lt;td id=&quot;tab_blocks&quot; class=&quot;tabon&quot;&gt;...&lt;/td&gt;
  &lt;td class=&quot;tabmin tab_collapse&quot;&gt;&amp;nbsp;&lt;/td&gt;
  &lt;!-- Inserted these two lines: --&gt;
  &lt;td id=&quot;tab_zig&quot; class=&quot;taboff tab_collapse&quot;&gt;Zig&lt;/td&gt;
  &lt;td class=&quot;tabmin tab_collapse&quot;&gt;&amp;nbsp;&lt;/td&gt;
...
&lt;div id=&quot;content_blocks&quot; class=&quot;content&quot;&gt;&lt;/div&gt;
&lt;!-- Inserted this line: --&gt;
&lt;pre id=&quot;content_zig&quot; class=&quot;content prettyprint lang-zig&quot;&gt;&lt;/pre&gt;</code></pre></div>
<p><a href="https://github.com/lupyuen3/blockly-zig-nuttx/pull/1/files#diff-dcf2ffe98d7d8b4a0dd7b9f769557dbe8c9e0e726236ef229def25c956a43d8f">(See the changes)</a></p>
<p>We‚Äôll see the Zig Tab like this‚Ä¶</p>
<p><a href="https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/">lupyuen3.github.io/blockly-zig-nuttx/demos/code</a></p>
<p><img src="https://lupyuen.github.io/images/blockly-run3a.png" alt="Zig Tab in Blockly" /></p>
<h1 id="appendix-zig-code-generator"><a href="#appendix-zig-code-generator">14 Appendix: Zig Code Generator</a></h1>
<p>TODO</p>
<p>Blockly comes bundled with Code Generators for JavaScript, Python, Dart, ‚Ä¶</p>
<p>Let‚Äôs create a Code Generator for Zig, by copying from the Dart Code Generator.</p>
<p>Copy <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/dart.js">generators/dart.js</a> to <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig.js">generators/zig.js</a></p>
<p>Copy all files from <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/dart">generators/dart</a> to <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig">generators/zig</a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>all.js
colour.js
lists.js
logic.js
loops.js
math.js
procedures.js
text.js
variables.js  
variables_dynamic.js</code></pre></div>
<p><a href="https://github.com/lupyuen3/blockly-zig-nuttx/commit/ba968942c6ee55937ca554e1d290d8d563fa0b78">(See the copied files)</a></p>
<p>Edit <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/dart.js">generators/zig.js</a> and all files in <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/generators/zig">generators/zig</a>.</p>
<p>Change all <code>Dart</code> to <code>Zig</code>, preserve case.</p>
<p><a href="https://github.com/lupyuen3/blockly-zig-nuttx/commit/efe185d6cac4306dcdc6b6a5f261b331bb992976">(See the changes)</a></p>
<h1 id="appendix-load-code-generator"><a href="#appendix-load-code-generator">15 Appendix: Load Code Generator</a></h1>
<p>TODO</p>
<p>Let‚Äôs load our Zig Code Generator in Blockly‚Ä¶</p>
<p>Add the Zig Code Generator to <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/demos/code/index.html">demos/code/index.html</a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-html"><code>&lt;!--  Load Zig Code Generator  --&gt;
&lt;script src=&quot;../../zig_compressed.js&quot;&gt;&lt;/script&gt;</code></pre></div>
<p><a href="https://github.com/lupyuen3/blockly-zig-nuttx/pull/1/files#diff-dcf2ffe98d7d8b4a0dd7b9f769557dbe8c9e0e726236ef229def25c956a43d8f">(See the changes)</a></p>
<p>Enable the Zig Code Generator in <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/demos/code/code.js">demos/code/code.js</a>‚Ä¶</p>
<div class="example-wrap"><pre class="language-javascript"><code>// Inserted `zig`...
Code.TABS_ = [
  &#39;blocks&#39;, &#39;zig&#39;, &#39;javascript&#39;, &#39;php&#39;, &#39;python&#39;, &#39;dart&#39;, &#39;lua&#39;, &#39;xml&#39;, &#39;json&#39;
];
...
// Inserted `Zig`...
Code.TABS_DISPLAY_ = [
  &#39;Blocks&#39;, &#39;Zig&#39;, &#39;JavaScript&#39;, &#39;PHP&#39;, &#39;Python&#39;, &#39;Dart&#39;, &#39;Lua&#39;, &#39;XML&#39;, &#39;JSON&#39;
];
...
Code.renderContent = function() {
  ...
  } else if (content.id === &#39;content_json&#39;) {
    var jsonTextarea = document.getElementById(&#39;content_json&#39;);
    jsonTextarea.value = JSON.stringify(
        Blockly.serialization.workspaces.save(Code.workspace), null, 2);
    jsonTextarea.focus();
  // Inserted this...
  } else if (content.id == &#39;content_zig&#39;) {
    Code.attemptCodeGeneration(Blockly.Zig);</code></pre></div>
<p><a href="https://github.com/lupyuen3/blockly-zig-nuttx/pull/1/files#diff-d72873b861dee958e5d443c919726dd856de594bd56b1e73d8948a7719163553">(See the changes)</a></p>
<p>Add our Code Generator to the Build Task: <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/scripts/gulpfiles/build_tasks.js#L98-L139">scripts/gulpfiles/build_tasks.js</a></p>
<div class="example-wrap"><pre class="language-javascript"><code> const chunks = [
   // Added this...
   {
      name: &#39;zig&#39;,
      entry: &#39;generators/zig/all.js&#39;,
      reexport: &#39;Blockly.Zig&#39;,
   }
 ];</code></pre></div>
<p><a href="https://github.com/lupyuen3/blockly-zig-nuttx/pull/1/files#diff-a9a5784f43ce15ca76bb3e99eb6625c3ea15381e20eac6f7527ecbcb2945ac14">(See the changes)</a></p>
<p>Now we compile our Zig Code Generator‚Ä¶</p>
<h1 id="appendix-build-blockly"><a href="#appendix-build-blockly">16 Appendix: Build Blockly</a></h1>
<p>TODO</p>
<p>Blockly builds fine with Linux, macOS and WSL. (But not plain old Windows CMD)</p>
<p>To build Blockly with the Zig Code Generator‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>git clone --recursive https://github.com/lupyuen3/blockly-zig-nuttx
cd blockly-zig-nuttx
npm install

# Run these steps when we change the Zig Code Generator
npm run build
npm run publish

# When prompted &quot;Is this the correct branch?&quot;,
# press N

# Instead of &quot;npm run publish&quot; (which can be slow), we may do this...
# cp build/*compressed* .

# For WSL: We can copy the generated files to c:\blockly-zig-nuttx for testing on Windows
# cp *compressed* /mnt/c/blockly-zig-nuttx</code></pre></div>
<p>This compiles and updates the Zig Code Generator in <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/zig_compressed.js">zig_compressed.js</a> and <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/zig_compressed.js.map">zig_compressed.js.map</a></p>
<p>If we‚Äôre using VSCode, here‚Äôs the Build Task: <a href="https://github.com/lupyuen3/blockly-zig-nuttx/blob/master/.vscode/tasks.json">.vscode/tasks.json</a></p>
<p>Let‚Äôs test our compiled Code Generator‚Ä¶</p>
<h1 id="appendix-test-blockly"><a href="#appendix-test-blockly">17 Appendix: Test Blockly</a></h1>
<p>TODO</p>
<p>Browse to <code>blockly-zig-nuttx/demos/code</code> with a Local Web Server. <a href="https://chrome.google.com/webstore/detail/web-server-for-chrome/ofhbbkphhbklhfoeikjpcbhemlocgigb/">(Like Web Server for Chrome)</a></p>
<p>We should see this‚Ä¶</p>
<p><a href="https://lupyuen3.github.io/blockly-zig-nuttx/demos/code/">lupyuen3.github.io/blockly-zig-nuttx/demos/code</a></p>
<p><img src="https://lupyuen.github.io/images/blockly-run3a.png" alt="Zig Tab in Blockly" /></p>
<p>Blockly will NOT render correctly with <code>file://...</code>, it must be <code>http://localhost:port/...</code></p>
<p>Drag-and-drop some Blocks and click the <strong>Zig Tab.</strong></p>
<p>The Zig Tab now shows the generated code in Zig.</p>
<p>Some of the generated code might appear as Dart (instead of Zig) because we haven‚Äôt completely converted our Code Generator from Dart to Zig.</p>
<p>In case of problems, check the <strong>JavaScript Console</strong>. Ignore the <code>storage.js</code> error.</p>
<p><em>Can we save the Blocks? So we don‚Äôt need to drag them again when retesting?</em></p>
<p>Click the <strong>JSON Tab</strong> and copy the Blockly JSON that appears.</p>
<p>Whenever we rebuild Blockly and reload the site, just paste the Blockly JSON back into the JSON Tab. The Blocks will be automagically restored.</p>

    
</body>
</html>