<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Grafana Dashboard on Google Cloud VM for Apache NuttX RTOS</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Grafana Dashboard on Google Cloud VM for Apache NuttX RTOS" 
    data-rh="true">
<meta property="og:description" 
    content=""
    data-rh="true">
<meta name="description" 
    content="">
<meta property="og:image" 
    content="https://lupyuen.org/images/dashboard-title.jpg">
<meta property="og:type" 
    content="article" data-rh="true">
<link rel="canonical"
    href="https://lupyuen.org/articles/dashboard" />
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Grafana Dashboard on Google Cloud VM for Apache NuttX RTOS</h1>
    <nav id="rustdoc"><ul>
<li><a href="#create-our-virtual-machine" title="Create Our Virtual Machine">1 Create Our Virtual Machine</a><ul></ul></li>
<li><a href="#install-grafana" title="Install Grafana">2 Install Grafana</a><ul></ul></li>
<li><a href="#install-prometheus" title="Install Prometheus">3 Install Prometheus</a><ul></ul></li>
<li><a href="#install-pushgateway" title="Install Pushgateway">4 Install Pushgateway</a><ul></ul></li>
<li><a href="#ingest-a-sample-nuttx-log" title="Ingest a Sample NuttX Log">5 Ingest a Sample NuttX Log</a><ul></ul></li>
<li><a href="#connect-grafana-to-prometheus" title="Connect Grafana to Prometheus">6 Connect Grafana to Prometheus</a><ul></ul></li>
<li><a href="#ssh-key-for-vm-login" title="SSH Key for VM Login">7 SSH Key for VM Login</a><ul></ul></li>
<li><a href="#ssh-key-for-github" title="SSH Key for GitHub">8 SSH Key for GitHub</a><ul></ul></li>
<li><a href="#set-the-github-token" title="Set the GitHub Token">9 Set the GitHub Token</a><ul></ul></li>
<li><a href="#nuttx-mirror-repo" title="NuttX Mirror Repo">10 NuttX Mirror Repo</a><ul></ul></li>
<li><a href="#ingest-github-logs" title="Ingest GitHub Logs">11 Ingest GitHub Logs</a><ul></ul></li>
<li><a href="#start-the-build-for-nuttx-mirror-repo" title="Start the Build for NuttX Mirror Repo">12 Start the Build for NuttX Mirror Repo</a><ul></ul></li>
<li><a href="#forever-build-and-ingest" title="Forever Build and Ingest">13 Forever Build and Ingest</a><ul></ul></li>
<li><a href="#ingest-the-github-gists-and-gitlab-snippets" title="Ingest the GitHub Gists and GitLab Snippets">14 Ingest the GitHub Gists and GitLab Snippets</a><ul></ul></li>
<li><a href="#expand-the-vm-disk" title="Expand the VM Disk">15 Expand the VM Disk</a><ul></ul></li>
<li><a href="#configure-our-grafana-server" title="Configure Our Grafana Server">16 Configure Our Grafana Server</a><ul></ul></li>
<li><a href="#publish-online-with-cloudflare-tunnel" title="Publish Online with Cloudflare Tunnel">17 Publish Online with Cloudflare Tunnel</a><ul></ul></li>
<li><a href="#cost-of-google-cloud" title="Cost of Google Cloud">18 Cost of Google Cloud</a><ul></ul></li>
<li><a href="#whats-next" title="What‚Äôs Next">19 What‚Äôs Next</a><ul></ul></li></ul></nav><p>üìù <em>20 Feb 2025</em></p>
<p><img src="https://lupyuen.org/images/dashboard-title.jpg" alt="Grafana Dashboard on Google Cloud VM for Apache NuttX RTOS" /></p>
<p>TODO</p>
<p><em>What if we prefer another cloud? Or our own machine?</em></p>
<p>The steps below will work for any Debian Bookworm machine.</p>
<h1 id="create-our-virtual-machine"><a class="doc-anchor" href="#create-our-virtual-machine">¬ß</a>1 Create Our Virtual Machine</h1>
<p>Create Project: nuttx-dashboard</p>
<p>https://console.cloud.google.com/projectcreate</p>
<p>Click ‚ÄúSelect Project‚Äù</p>
<p>Click ‚ÄúCreate a VM‚Äù. General Purpose / Debian Bookworm is OK.</p>
<p>Click ‚ÄúCompute Engine API &gt; Enable‚Äù and wait a while</p>
<p>Fill in the Instance Name ‚Äúnuttx-dashboard-vm‚Äù. Click ‚ÄúCreate‚Äù</p>
<p>Click ‚ÄúConnect &gt; SSH‚Äù</p>
<p>And SSH Console appears!</p>
<div class="example-wrap"><pre class="language-bash"><code>Linux nuttx-dashboard-vm 6.1.0-41-cloud-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.158-1 (2025-11-09) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
luppy@nuttx-dashboard-vm:~$ uname -a
Linux nuttx-dashboard-vm 6.1.0-41-cloud-amd64 #1 SMP PREEMPT_DYNAMIC Debian 6.1.158-1 (2025-11-09) x86_64 GNU/Linux
luppy@nuttx-dashboard-vm:~$ 

sudo apt update
sudo apt upgrade</code></pre></div><h1 id="install-grafana"><a class="doc-anchor" href="#install-grafana">¬ß</a>2 Install Grafana</h1>
<p>Install the latest version of Grafana OSS</p>
<p>https://grafana.com/grafana/download/12.3.0?pg=oss-graf&amp;plcmt=hero-btn-1&amp;edition=oss</p>
<p>https://grafana.com/docs/grafana/latest/setup-grafana/installation/debian/#install-from-apt-repository</p>
<div class="example-wrap"><pre class="language-bash"><code>## Grafana OSS	grafana	https://apt.grafana.com stable main
## Install the prerequisite packages
sudo apt-get install -y apt-transport-https wget

## Import the GPG key
sudo mkdir -p /etc/apt/keyrings/
wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | sudo tee /etc/apt/keyrings/grafana.gpg &gt; /dev/null

## Add a repository for stable releases
echo &quot;deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main&quot; | sudo tee -a /etc/apt/sources.list.d/grafana.list

## Updates the list of available packages
sudo apt-get update

## Installs the latest OSS release
sudo apt-get install grafana

## Configure grafana to start automatically using systemd
sudo /bin/systemctl daemon-reload
sudo /bin/systemctl enable grafana-server

## Start grafana-server
sudo /bin/systemctl start grafana-server

## Grafana Server is listening on http://localhost:3000
$ netstat -an | grep LISTEN
tcp6       0      0 :::3000                 :::*                    LISTEN     </code></pre></div>
<p>VM Instances &gt; External IP
35.198.238.211</p>
<p>VM Instances &gt; Set Up Firewall Rules</p>
<p>Firewall Policies &gt; Create Firewall Rule</p>
<p>allow-tcp-3000</p>
<p>Targets: All instances in the network</p>
<p>IPv4 Ranges: 0.0.0.0/0</p>
<p>Protocol and Ports: TCP 3000</p>
<p>Click ‚ÄúCreate‚Äù</p>
<p>http://35.198.238.211:3000</p>
<p>Username: admin
Password: admin
Set the new password</p>
<h1 id="install-prometheus"><a class="doc-anchor" href="#install-prometheus">¬ß</a>3 Install Prometheus</h1><div class="example-wrap"><pre class="language-bash"><code>## From https://ecintelligence.ma/en/blog/complete-guide-to-prometheus-and-grafana-monitorin/
## Install Prometheus server
sudo apt install prometheus

## Enable services to start on boot
sudo systemctl enable prometheus

## Start services
sudo systemctl start prometheus

## Check service status
sudo systemctl status prometheus

## We should see...
## ‚óè prometheus.service - Monitoring system and time series database
## Loaded: loaded (/lib/systemd/system/prometheus.service; enabled; preset: enabled)
## Active: active (running)

## Check listening ports
sudo ss -tlnp | grep -E &#39;9090|9100&#39;

## We should see...
## LISTEN 0      4096               *:9090             *:*    users:((&quot;prometheus&quot;,pid=93392,fd=7))     
## LISTEN 0      4096               *:9100             *:*    users:((&quot;prometheus-node&quot;,pid=93237,fd=3))</code></pre></div>
<p>VM Instances &gt; Set Up Firewall Rules</p>
<p>Firewall Policies &gt; Create Firewall Rule</p>
<p>allow-tcp-9090</p>
<p>Targets: All instances in the network</p>
<p>IPv4 Ranges: 0.0.0.0/0</p>
<p>Protocol and Ports: TCP 9090</p>
<p>Click ‚ÄúCreate‚Äù</p>
<p>http://35.198.238.211:9090</p>
<p>The main configuration file is located at /etc/prometheus/prometheus.yml</p>
<h1 id="install-pushgateway"><a class="doc-anchor" href="#install-pushgateway">¬ß</a>4 Install Pushgateway</h1>
<p>https://devopscube.com/setup-prometheus-pushgateway-vm/</p>
<div class="example-wrap"><pre class="language-bash"><code>## From https://devopscube.com/setup-prometheus-pushgateway-vm/

wget https://github.com/prometheus/pushgateway/releases/download/v1.11.2/pushgateway-1.11.2.linux-amd64.tar.gz
tar xvf pushgateway-1.11.2.linux-amd64.tar.gz
mv pushgateway-1.11.2.linux-amd64 pushgateway
cd pushgateway/
sudo useradd -rs /bin/false pushgateway
sudo cp pushgateway /usr/local/bin/
sudo chown pushgateway:pushgateway /usr/local/bin/pushgateway

sudo --shell
cat &lt;&lt;EOT &gt; /etc/systemd/system/pushgateway.service
[Unit]
Description=Prometheus Pushgateway
Wants=network-online.target
After=network-online.target

[Service]
User=pushgateway
Group=pushgateway
Type=simple
ExecStart=/usr/local/bin/pushgateway

[Install]
WantedBy=multi-user.target
EOT
exit

sudo systemctl enable pushgateway
sudo systemctl start pushgateway
sudo systemctl status pushgateway

## We should see...
## pushgateway.service - Prometheus Pushgateway
## Loaded: loaded (/etc/systemd/system/pushgateway.service; enabled; preset: enabled)
## Active: active (running) since Mon 2026-01-05 08:46:49 UTC; 4s ago

curl localhost:9091/metrics

## We should see...
## HELP go_gc_duration_seconds A summary of the wall-time pause (stop-the-world) duration in garbage collection cycles.
## TYPE go_gc_duration_seconds summary</code></pre></div>
<p>VM Instances &gt; Set Up Firewall Rules</p>
<p>Firewall Policies &gt; Create Firewall Rule</p>
<p>allow-tcp-9091</p>
<p>Targets: All instances in the network</p>
<p>IPv4 Ranges: 0.0.0.0/0</p>
<p>Protocol and Ports: TCP 9091</p>
<p>Click ‚ÄúCreate‚Äù</p>
<p>http://35.198.238.211:9091</p>
<h1 id="ingest-a-sample-nuttx-log"><a class="doc-anchor" href="#ingest-a-sample-nuttx-log">¬ß</a>5 Ingest a Sample NuttX Log</h1><div class="example-wrap"><pre class="language-bash"><code>pushd /tmp
wget https://github.com/lupyuen/ingest-nuttx-builds/releases/download/v1.0.0/defconfig.txt
wget https://github.com/lupyuen/ingest-nuttx-builds/releases/download/v1.0.0/ci-xtensa-02.log
popd

## Install rust: https://rustup.rs/
## Press Enter for default option
curl --proto &#39;=https&#39; --tlsv1.2 -sSf https://sh.rustup.rs | sh
. &quot;$HOME/.cargo/env&quot;
sudo apt install gcc pkg-config libssl-dev

sudo apt install git
git clone https://github.com/lupyuen/ingest-nuttx-builds
cd ingest-nuttx-builds
cargo run \
  -- \
  --user NuttX \
  --repo nuttx \
  --defconfig /tmp/defconfig.txt \
  --file /tmp/ci-xtensa-02.log \
  --nuttx-hash 59f200ac4fe6c940dc0eab2155bb3cb566724082 \
  --apps-hash 4f93ec0a4335d574eeecfd295584fbfb17056e5b \
  --group xtensa-02 \
  --run-id 20706016275 \
  --job-id 59436813170 \
  --step 10

## We should see...
## lines[0]=Configuration/Tool: esp32s3-devkit/spi
## lines.last=  [1/1] Normalize esp32s3-devkit/spi
## target=esp32s3-devkit:spi
## timestamp=2026-01-05T08:39:57
## body=
## # TYPE build_score gauge
## # HELP build_score 1.0 for successful build, 0.0 for failed build
## build_score{ version=&quot;3&quot;, timestamp=&quot;2026-01-05T08:39:57&quot;, timestamp_log=&quot;2026-01-05T08:39:57&quot;, user=&quot;NuttX&quot;, arch=&quot;xtensa&quot;, subarch=&quot;esp32s3&quot;, group=&quot;xtensa-02&quot;, board=&quot;esp32s3-devkit&quot;, config=&quot;spi&quot;, target=&quot;esp32s3-devkit:spi&quot;, url=&quot;https://github.com/NuttX/nuttx/actions/runs/20706016275/job/59436813170#step:10:2455&quot;, url_display=&quot;&quot;, nuttx_hash=&quot;59f200ac4fe6c940dc0eab2155bb3cb566724082&quot;, apps_hash=&quot;4f93ec0a4335d574eeecfd295584fbfb17056e5b&quot; } 1
## res=Response { url: &quot;http://localhost:9091/metrics/job/NuttX/instance/esp32s3-devkit:spi&quot;, status: 200, headers: {&quot;date&quot;: &quot;Mon, 05 Jan 2026 10:10:52 GMT&quot;, &quot;content-length&quot;: &quot;0&quot;} }</code></pre></div>
<p>Check http://35.198.238.211:9091</p>
<p>TODO: Connect prometheus to pushgateway</p>
<div class="example-wrap"><pre class="language-bash"><code>sudo nano /etc/prometheus/prometheus.yml
## Erase everything in the file. Replace by contents of
## https://github.com/lupyuen/ingest-nuttx-builds/blob/main/prometheus.yml
sudo systemctl restart prometheus</code></pre></div>
<p>Check http://35.198.238.211:9090</p>
<p>Enter the query ‚Äúbuild_score‚Äù</p>
<p>Press Execute</p>
<h1 id="connect-grafana-to-prometheus"><a class="doc-anchor" href="#connect-grafana-to-prometheus">¬ß</a>6 Connect Grafana to Prometheus</h1>
<p>Follow these steps to create the dashboard (skip the <code>apt install</code>):</p>
<p><a href="https://lupyuen.org/articles/ci4#grafana-dashboard">Grafana Dashboard</a></p>
<p>Add Data Source: https://lupyuen.org/articles/ci4#appendix-all-builds-dashboard</p>
<p>Copy and overwrite the Dashboard JSON: https://github.com/lupyuen/ingest-nuttx-builds/blob/main/dashboard.json</p>
<p>But change ALL references to Prometheus UID:</p>
<div class="example-wrap"><pre class="language-json"><code>...
&quot;datasource&quot;: {
  &quot;type&quot;: &quot;prometheus&quot;,
  &quot;uid&quot;: &quot;df998a9io0yrkb&quot;
}
...</code></pre></div>
<p>(Get the UID from the Dashboard JSON before overwriting it)</p>
<p>Copy and overwite the Dashboard History JSON: https://github.com/lupyuen/ingest-nuttx-builds/blob/main/dashboard-history.json</p>
<p>Remember to change ALL references to Prometheus UID. (See above)</p>
<p>Set permission:</p>
<ul>
<li>Settings &gt; Permission &gt; Role Viewer &gt; View</li>
<li>Same for Build History Dashboard</li>
</ul>
<h1 id="ssh-key-for-vm-login"><a class="doc-anchor" href="#ssh-key-for-vm-login">¬ß</a>7 SSH Key for VM Login</h1>
<p>Create SSH Key: https://docs.cloud.google.com/compute/docs/connect/create-ssh-keys</p>
<div class="example-wrap"><pre class="language-bash"><code>## Do this on our computer, NOT the VM!
## Change &quot;luppy&quot; to your VM Username
ssh-keygen \
  -t rsa \
  -f $HOME/.ssh/nuttx-dashboard-vm \
  -C luppy

## Check the output
ls $HOME/.ssh/nuttx-dashboard-vm*

## We should see...
## nuttx-dashboard-vm
## nuttx-dashboard-vm.pub</code></pre></div>
<p>Install the GCloud CLI: https://docs.cloud.google.com/sdk/docs/install-sdk</p>
<div class="example-wrap"><pre class="language-bash"><code>## For macOS:
brew install gcloud-cli
export PATH=/opt/homebrew/share/google-cloud-sdk/bin:&quot;$PATH&quot;
gcloud version
## We should see: Google Cloud SDK 550.0.0</code></pre></div>
<p>Add SSH keys to VMs that use metadata-based SSH keys: https://docs.cloud.google.com/compute/docs/connect/add-ssh-keys?cloudshell=false#metadata</p>
<p>Google Cloud Console: Metadata: https://console.cloud.google.com/compute/metadata</p>
<p>Click ‚ÄúSSH Keys‚Äù</p>
<p>Click ‚ÄúAdd SSH Key‚Äù</p>
<p>Copy and paste the contents of $HOME/.ssh/nuttx-dashboard-vm.pub</p>
<p>Click ‚ÄúSave‚Äù</p>
<div class="example-wrap"><pre class="language-bash"><code>## From https://docs.cloud.google.com/compute/docs/connect/standard-ssh#openssh-client
## Change &quot;luppy&quot; to your VM Username
ssh \
  -i $HOME/.ssh/nuttx-dashboard-vm \
  luppy@35.198.238.211</code></pre></div>
<p>In VSCode: Click ‚ÄúRemote Explorer &gt; SSH &gt; +‚Äù</p>
<div class="example-wrap"><pre class="language-bash"><code>ssh -i ~/.ssh/nuttx-dashboard-vm luppy@35.198.238.211 </code></pre></div>
<p>Select the SSH Config file $HOME/.ssh/config</p>
<p>Click ‚ÄúConnect‚Äù</p>
<p>Click ‚ÄúFile &gt; Open File / Folder‚Äù</p>
<p>$HOME/.ssh/config will look like:</p>
<div class="example-wrap"><pre class="language-bash"><code>Host 35.198.238.211
  HostName 35.198.238.211
  IdentityFile ~/.ssh/nuttx-dashboard-vm
  User luppy</code></pre></div>
<p>Probably better to rename the ‚ÄúHost‚Äù, in case the IP Address changes‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>Host nuttx-dashboard-vm
  HostName 35.198.238.211
  IdentityFile ~/.ssh/nuttx-dashboard-vm
  User luppy</code></pre></div><h1 id="ssh-key-for-github"><a class="doc-anchor" href="#ssh-key-for-github">¬ß</a>8 SSH Key for GitHub</h1>
<p>nuttxpr is an Ordinary GitHub Account with Read Access. Don‚Äôt use a GitHub Admin Account!</p>
<p>Create the GitHub SSH Key on VM: https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent</p>
<div class="example-wrap"><pre class="language-bash"><code>ssh-keygen \
  -t ed25519 \
  -f $HOME/.ssh/nuttxpr@github \
  -C &quot;nuttxpr@github&quot;</code></pre></div>
<p>Add SSH Key to GitHub Account: https://docs.github.com/en/authentication/connecting-to-github-with-ssh/adding-a-new-ssh-key-to-your-github-account</p>
<p>Copy from Public Key $HOME/.ssh/nuttxpr@github.pub to GitHub</p>
<p>Test it:</p>
<div class="example-wrap"><pre class="language-bash"><code>ssh -T \
  -i $HOME/.ssh/nuttxpr@github \
  git@github.com

## We should see...
## Hi nuttxpr! You&#39;ve successfully authenticated, but GitHub does not provide shell access.</code></pre></div>
<p>Edit $HOME/.ssh/config</p>
<div class="example-wrap"><pre class="language-bash"><code>nano $HOME/.ssh/config</code></pre></div>
<p>Add this‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>Host github.com
  IdentityFile ~/.ssh/nuttxpr@github</code></pre></div>
<p>Test it:</p>
<div class="example-wrap"><pre class="language-bash"><code>## Should now work without stating Private Key
ssh -T \
  git@github.com

## We should see...
## Hi nuttxpr! You&#39;ve successfully authenticated, but GitHub does not provide shell access.</code></pre></div><h1 id="set-the-github-token"><a class="doc-anchor" href="#set-the-github-token">¬ß</a>9 Set the GitHub Token</h1>
<p>Create $HOME/github-token.sh</p>
<div class="example-wrap"><pre class="language-bash"><code>## GitHub Settings &gt; Developer Settings &gt; Tokens (Classic) &gt; Generate New Token (Classic)
## Check the following:
## repo (Full control of private repositories)
## repo:status (Access commit status)
## repo_deployment (Access deployment status)
## public_repo (Access public repositories)
## repo:invite (Access repository invitations)
## security_events (Read and write security events)
export GITHUB_TOKEN=...

## Enable Rust Logging
export RUST_LOG=info 
export RUST_BACKTRACE=1</code></pre></div>
<p>If we‚Äôre ingesting GitLab Snippets: Create $HOME/gitlab-token.sh</p>
<div class="example-wrap"><pre class="language-bash"><code>## User Settings &gt; Access tokens
## Select scopes:
## api: Grants complete read/write access to the API, including all groups and projects, the container registry, the dependency proxy, and the package registry.
export GITLAB_TOKEN=...
export GITLAB_USER=lupyuen
export GITLAB_REPO=nuttx-build-log</code></pre></div><h1 id="nuttx-mirror-repo"><a class="doc-anchor" href="#nuttx-mirror-repo">¬ß</a>10 NuttX Mirror Repo</h1>
<p><code>nuttxpr</code> will start the build by pushing a patch to the NuttX Mirror Repo. We grant permission to <code>nuttxpr</code></p>
<p>NuttX Mirror Collaborators: https://github.com/NuttX/nuttx/settings/access</p>
<p>Click ‚ÄúAdd People‚Äù</p>
<p>Enter <code>nuttxpr</code></p>
<p>Role: Write</p>
<p>Log in as <code>nuttxpr</code> to accept the invitation</p>
<p>Check the collaborators: https://github.com/NuttX/nuttx/settings/access</p>
<h1 id="ingest-github-logs"><a class="doc-anchor" href="#ingest-github-logs">¬ß</a>11 Ingest GitHub Logs</h1>
<p>Inside the VM: Run https://github.com/lupyuen/ingest-nuttx-builds/blob/main/github.sh</p>
<div class="example-wrap"><pre class="language-bash"><code>## Install GitHub CLI: https://github.com/cli/cli/blob/trunk/docs/install_linux.md#debian
(type -p wget &gt;/dev/null || (sudo apt update &amp;&amp; sudo apt install wget -y)) \
	&amp;&amp; sudo mkdir -p -m 755 /etc/apt/keyrings \
	&amp;&amp; out=$(mktemp) &amp;&amp; wget -nv -O$out https://cli.github.com/packages/githubcli-archive-keyring.gpg \
	&amp;&amp; cat $out | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg &gt; /dev/null \
	&amp;&amp; sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg \
	&amp;&amp; sudo mkdir -p -m 755 /etc/apt/sources.list.d \
	&amp;&amp; echo &quot;deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main&quot; | sudo tee /etc/apt/sources.list.d/github-cli.list &gt; /dev/null \
	&amp;&amp; sudo apt update \
	&amp;&amp; sudo apt install gh -y
. $HOME/github-token.sh
gh auth status

## We should see...
## ‚úì Logged in to github.com account nuttxpr (GITHUB_TOKEN)
## - Active account: true
## - Git operations protocol: https
## - Token: ghp_************************************
## - Token scopes: &#39;read:org&#39;, &#39;repo&#39;

## github.sh needs the NuttX defconfigs here (yeah we should fix the hardcoded &quot;riscv&quot;)
mkdir $HOME/riscv
pushd $HOME/riscv
git clone https://github.com/apache/nuttx
popd

## Run github.sh
sudo apt install unzip
cd
git clone https://github.com/lupyuen/ingest-nuttx-builds
cd ingest-nuttx-builds
./github.sh</code></pre></div>
<p>Log for Ingest NuttX Builds: https://gist.github.com/lupyuen/8cf82eab994c2bca77f129ffa118acf0</p>
<p>Check Pushgateway http://35.198.238.211:9091</p>
<p>Check Prometheus: Enter ‚Äúbuild_score‚Äù, click Execute. http://35.198.238.211:9090</p>
<p>Check Grafana http://35.198.238.211:3000/d/fe2bqg6uk7nr4a</p>
<p>And Build History: http://35.198.238.211:3000/d/fe2q876wubc3kc</p>
<p>TODO: Fix step:10 to ??? for Linux</p>
<h1 id="start-the-build-for-nuttx-mirror-repo"><a class="doc-anchor" href="#start-the-build-for-nuttx-mirror-repo">¬ß</a>12 Start the Build for NuttX Mirror Repo</h1>
<p>Only one instance of sync-build-ingest.sh should ever be running! Make sure <code>lupyuen</code> isn‚Äôt running it on his Home Computer.</p>
<p>Inside the VM: Run https://github.com/lupyuen/nuttx-release/blob/main/sync-build-ingest.sh</p>
<div class="example-wrap"><pre class="language-bash"><code>. $HOME/github-token.sh
gh auth status

## We should see...
## ‚úì Logged in to github.com account nuttxpr (GITHUB_TOKEN)
## - Active account: true
## - Git operations protocol: https
## - Token: ghp_************************************
## - Token scopes: &#39;read:org&#39;, &#39;repo&#39;

## Configure the Git User
git config --global user.email &quot;nuttxpr@gmail.com&quot;
git config --global user.name &quot;nuttxpr (nuttx-dashboard-vm)&quot;

## Run sync-build-ingest.sh
cd
git clone https://github.com/lupyuen/nuttx-release
cd $HOME/nuttx-release
./sync-build-ingest.sh

## If we see: &quot;**** ERROR: Expected Downstream Commit to be &#39;Enable macOS Builds&#39; but found: ...&quot;
## Then run this instead:
## ./enable-macos-windows.sh
## ./sync-build-ingest.sh</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/c9dd83842ab9b845eadedb968bd63bc1">sync-build-ingest.sh Log</a></p>
<p><a href="https://gist.github.com/lupyuen/3d21869dae705d6c9d3acc1e8d94ffd1">enable-macos-windows.sh Log</a></p>
<p>We should see the patch that starts the NuttX Build:</p>
<p>https://github.com/NuttX/nuttx/commits/master/</p>
<p>And the NuttX Build should be running:</p>
<p>https://github.com/NuttX/nuttx/actions/workflows/build.yml</p>
<p>In case of sync problems: Go to https://github.com/NuttX/nuttx/tree/master, click ‚ÄúSync Fork &gt; Discard Commit‚Äù. Then run enable-macos-windows.sh followed by sync-build-ingest.sh.</p>
<p>If we see</p>
<div class="example-wrap"><pre class="language-bash"><code>fatal: cannot create directory at &#39;arch/arm/src/kinetis&#39;: No space left on device
warning: Clone succeeded, but checkout failed.</code></pre></div>
<p>Increase the disk space. Need 5 GB for /tmp. See the section below.</p>
<h1 id="forever-build-and-ingest"><a class="doc-anchor" href="#forever-build-and-ingest">¬ß</a>13 Forever Build and Ingest</h1>
<p>nano $HOME/sync.sh</p>
<div class="example-wrap"><pre class="language-bash"><code>#!/usr/bin/env bash
## Sync NuttX Mirror, Build NuttX Mirror and Ingest GitHub Actions Logs

set -x  #  Echo commands
. $HOME/github-token.sh
gh auth status

for (( ; ; )); do
  cd $HOME/nuttx-release
  ./sync-build-ingest.sh

  set +x ; echo &quot;**** sync.sh: Waiting&quot; ; set -x
  date ; sleep 900
done</code></pre></div>
<p>Run $HOME/sync.sh</p>
<div class="example-wrap"><pre class="language-bash"><code>sudo apt install tmux
tmux
chmod +x $HOME/sync.sh
$HOME/sync.sh

## If the SSH Session Disconnects:
## Do this to reconnect the sync.sh session...
## tmux a</code></pre></div>
<p>(Don‚Äôt use cron, need to monitor manually so that we don‚Äôt run into overuse of the GitHub Runners of the Mirror Repo)</p>
<p><a href="https://github.com/lupyuen/nuttx-release/releases/download/v1.0.0/sync.log">Log for NuttX Build and Ingest</a></p>
<p>In case of sync problems: Go to https://github.com/NuttX/nuttx/tree/master, click ‚ÄúSync Fork &gt; Discard Commit‚Äù. Then run enable-macos-windows.sh followed by sync.sh.</p>
<h1 id="ingest-the-github-gists-and-gitlab-snippets"><a class="doc-anchor" href="#ingest-the-github-gists-and-gitlab-snippets">¬ß</a>14 Ingest the GitHub Gists and GitLab Snippets</h1>
<p>Remember to set GitLab Token</p>
<div class="example-wrap"><pre class="language-bash"><code>tmux
cd $HOME/ingest-nuttx-builds
./run.sh

## If the SSH Session Disconnects:
## Do this to reconnect the run.sh session...
## tmux a</code></pre></div>
<p>(Don‚Äôt use cron, need to monitor manually so that we don‚Äôt run into overuse of the GitHub API and GitLab API)</p>
<p><a href="https://gist.github.com/lupyuen/d29be01f9e5ad256c6bb6df1e1ddea6d">Log for Ingest GitHub Gists and GitLab Snippets</a></p>
<h1 id="expand-the-vm-disk"><a class="doc-anchor" href="#expand-the-vm-disk">¬ß</a>15 Expand the VM Disk</h1><div class="example-wrap"><pre class="language-bash"><code>## TODO: Out of space in /tmp
$ df -H
Filesystem      Size  Used Avail Use% Mounted on
udev            2.1G     0  2.1G   0% /dev
tmpfs           412M  574k  411M   1% /run
/dev/sda1        11G  9.8G     0 100% /
tmpfs           2.1G     0  2.1G   0% /dev/shm
tmpfs           5.3M     0  5.3M   0% /run/lock
/dev/sda15      130M   13M  118M  10% /boot/efi
tmpfs           412M     0  412M   0% /run/user/1000

## Before:
$ df -H
Filesystem      Size  Used Avail Use% Mounted on
udev            2.1G     0  2.1G   0% /dev
tmpfs           412M  574k  411M   1% /run
/dev/sda1        11G  8.5G  1.4G  87% /
tmpfs           2.1G     0  2.1G   0% /dev/shm
tmpfs           5.3M     0  5.3M   0% /run/lock
/dev/sda15      130M   13M  118M  10% /boot/efi
tmpfs           412M     0  412M   0% /run/user/1000

## Most of the disk space used by /tmp
$ rm -rf /tmp/sync-build-ingest/</code></pre></div>
<p>Resize the disk: https://dev.to/lovestaco/expanding-disk-size-in-google-cloud-5gkh</p>
<p>Click VM &gt; Details &gt; Storage &gt; Boot Disk</p>
<p>Click Menu &gt; Edit at Top Right</p>
<p>Increase the size from 10 GB to 20 GB. Click Save</p>
<p>Inside the VM:</p>
<div class="example-wrap"><pre class="language-bash"><code>sudo apt install fdisk
sudo fdisk -l

## We should see
## Device      Start      End  Sectors  Size Type
## /dev/sda1  262144 20969471 20707328  9.9G Linux root (x86-64)
## /dev/sda14   2048     8191     6144    3M BIOS boot
## /dev/sda15   8192   262143   253952  124M EFI System

## Let&#39;s expand /dev/sda to 20 GB
sudo fdisk /dev/sda

## Ignore the warning
## Enter: w

## Resize partition 1 (/dev/sda1), which maps to /
sudo apt install cloud-guest-utils
sudo growpart /dev/sda 1

## We should see...
## CHANGED: partition=1 start=262144 old: size=20707328 end=20969471 new: size=41680863 end=41943006

## Resize the Filesystem
sudo resize2fs /dev/sda1

## We should see...
## Filesystem at /dev/sda1 is mounted on /; on-line resizing required
## old_desc_blocks = 2, new_desc_blocks = 3
## The filesystem on /dev/sda1 is now 5210107 (4k) blocks long.

## sda1 is bigger now
$ sudo fdisk -l
Device      Start      End  Sectors  Size Type
/dev/sda1  262144 41943006 41680863 19.9G Linux root (x86-64)
/dev/sda14   2048     8191     6144    3M BIOS boot
/dev/sda15   8192   262143   253952  124M EFI System

## More space in /tmp yay!
$ df -H
Filesystem      Size  Used Avail Use% Mounted on
udev            2.1G     0  2.1G   0% /dev
tmpfs           412M  574k  411M   1% /run
/dev/sda1        21G  8.5G   12G  43% /
tmpfs           2.1G     0  2.1G   0% /dev/shm
tmpfs           5.3M     0  5.3M   0% /run/lock
/dev/sda15      130M   13M  118M  10% /boot/efi
tmpfs           412M     0  412M   0% /run/user/1000</code></pre></div><h1 id="configure-our-grafana-server"><a class="doc-anchor" href="#configure-our-grafana-server">¬ß</a>16 Configure Our Grafana Server</h1>
<p>Edit /etc/grafana/grafana.ini</p>
<p>Look for these settings and edit them (don‚Äôt add them)‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code># Log web requests
# Default: router_logging = false
router_logging = true

# enable gzip
# Default: enable_gzip = false
enable_gzip = true

# This enables data proxy logging, default is false
logging = true

# Default UI theme (&quot;dark&quot;, &quot;light&quot; or &quot;system&quot;)
# Default: default_theme = dark
default_theme = light

# Path to a custom home page. Users are only redirected to this if the default home dashboard is used. It should match a frontend route and contain a leading slash.
# Default: home_page =
home_page = /d/fe2bqg6uk7nr4a

# Disable usage of Grafana build-in login solution.
# Default: disable_login = false
disable_login = true

# Set to true to disable (hide) the login form, useful if you use OAuth, defaults to false
disable_login_form = true

# enable anonymous access
# Default: enabled = false
enabled = true

# specify organization name that should be used for unauthenticated users
org_name = Main Org.

# specify role for unauthenticated users
org_role = Viewer

# mask the Grafana version number for unauthenticated users
# Default: hide_version = false
hide_version = true</code></pre></div>
<p><a href="https://github.com/lupyuen/ingest-nuttx-builds/blob/main/grafana2.ini">grafana.ini</a></p>
<p>Restart grafana</p>
<div class="example-wrap"><pre class="language-bash"><code>sudo systemctl restart grafana-server</code></pre></div><h1 id="publish-online-with-cloudflare-tunnel"><a class="doc-anchor" href="#publish-online-with-cloudflare-tunnel">¬ß</a>17 Publish Online with Cloudflare Tunnel</h1>
<p>TODO</p>
<p>Create a Cloudflare Tunnel, pointing to http://localhost:3000</p>
<p>Or use Cloudflare CDN.</p>
<h1 id="cost-of-google-cloud"><a class="doc-anchor" href="#cost-of-google-cloud">¬ß</a>18 Cost of Google Cloud</h1>
<p>TODO</p>
<p>_Will it be cheaper to run on an Asian Cloud? Like AliCloud? _</p>
<p>Hmmm interesting‚Ä¶ We should try out!</p>
<h1 id="whats-next"><a class="doc-anchor" href="#whats-next">¬ß</a>19 What‚Äôs Next</h1>
<p>Now that NuttX Dashboard is running in the Cloud (and not at Home)‚Ä¶ We‚Äôre going overseas for Twincity Marathon!</p>
<p>TODO</p>

    
    <!-- Begin scripts/rustdoc-after.html: Post-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker and Prism Theme -->
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker and Prism Theme -->

    <!-- End scripts/rustdoc-after.html -->
    

</body>
</html>