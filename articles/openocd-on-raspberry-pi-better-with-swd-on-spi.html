<!doctype html>
<html lang="en">

<head>
  <link rel="stylesheet" type="text/css" href="/_static/css/banner-styles.css?v=bsmaklHF" />
  <link rel="stylesheet" type="text/css" href="/_static/css/iconochive.css?v=qtvMKcIJ" />
  <!-- End Wayback Rewrite JS Include -->
  <title data-rh="true">OpenOCD on Raspberry Pi: Better with SWD on SPI | by Lup Yuen Lee ÊùéÁ´ãÊ∫ê | Medium</title>
  <meta data-rh="true" charset="utf-8" />
  <meta data-rh="true" name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1" />
  <meta data-rh="true" name="theme-color" content="#000000" />
  <meta data-rh="true" property="og:type" content="article" />
  <meta data-rh="true" property="article:published_time" content="2020-12-11T12:54:05.157Z" />
  <meta data-rh="true" name="title"
    content="OpenOCD on Raspberry Pi: Better with SWD on SPI | by Lup Yuen Lee ÊùéÁ´ãÊ∫ê | Medium" />
  <meta data-rh="true" property="og:title" content="OpenOCD on Raspberry Pi: Better with SWD on SPI" />
  <meta data-rh="true" property="twitter:title" content="OpenOCD on Raspberry Pi: Better with SWD on SPI" />
  <meta data-rh="true" name="description"
    content="The setup that we see above‚Ä¶ Debugging nRF52 with a Raspberry Pi running VSCode and OpenOCD‚Ä¶ Was impossible just a week ago! OpenOCD connects to nRF52 for flashing and debugging by running Arm‚Äôs SWD‚Ä¶" />
  <meta data-rh="true" property="og:description" content="Sneaky tricks to align stray bits into proper bytes" />
  <meta data-rh="true" property="twitter:description" content="Sneaky tricks to align stray bits into proper bytes" />
  <meta data-rh="true" name="twitter:card" content="summary_large_image" />
  <meta data-rh="true" name="twitter:creator" content="@MisterTechBlog" />
  <meta data-rh="true" name="author" content="Lup Yuen Lee ÊùéÁ´ãÊ∫ê" />
  <meta data-rh="true" name="robots" content="index,follow,max-image-preview:large" />
  <meta data-rh="true" name="referrer" content="unsafe-url" />
  <meta data-rh="true" name="twitter:label1" value="Reading time" />
  <meta data-rh="true" name="twitter:data1" value="14 min read" />
  <meta property="og:image" 
  content="https://lupyuen.github.io/images/legacy/d1.jpeg">

<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">

<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
    a {
        color: #77d;
    }
</style>
<!-- End scripts/rustdoc-header.html -->

</head>

<body>
  <div id="root">
    <div class="a b c">
      <div class="d e f g h i j k"></div>
      <div class="s">
        <article>
          <section class="fa fb fc fd w fe bp s"></section><span class="s"></span>
          <div>
            <div class="ff ep fg fh fi fj"></div>
            <section class="dh fk fl dc fm">
              <div class="fn w">

                <p><img src="https://lupyuen.github.io/images/legacy/d1.jpeg" /></p>
                <p><em>Debugging nRF52 with a Raspberry Pi 4 running
                    VSCode and OpenOCD with SWD over SPI at 31 MHz</em></p>

              </div>
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <div class="">
                    <h1 id="2f47"
                      class="gj df gk av cu gl gm gn go gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd he hf hg">OpenOCD
                      on Raspberry Pi: Better with SWD on SPI</h1>
                    <div class="cr">
                      <div class="n ce hh hi hj">
                        <div class="o n">
                          <div><a rel="noopener"
                              href="https://lupyuen.github.io">
                              <div class="ah hk hl">
                                <div class="bb n ar o p ff hm hn ho hp hq fj"></div>

                              </div>
                            </a></div>
                          <div class="dt w n co">
                            <div class="n">
                              <div style="flex:1"><span class="av b aw ax hg"><a class="" rel="noopener"
                                    href="https://lupyuen.github.io">
                                    <h4 class="av b aw ax ay">Lup Yuen Lee ÊùéÁ´ãÊ∫ê</h4>
                                  </a></span></div>
                            </div><span class="av b aw ax bt"><a class="" rel="noopener"
                                href="https://lupyuen.github.io">
                                <h4 class="av b aw ax bt"><span class="hs"></span>Jan 17, 2020<span
                                    class="ht">¬∑</span>14 min read</h4>
                              </a></span>
                          </div>
                        </div>
                        <div class="n cn hu hv hw hx hy hz ia ib">
                          <div class="n o">
                            <div class="ic s">
                              <div class="bq" aria-hidden="false"></div>
                            </div>
                            <div class="id s">
                              <div class="ie"><span><a
                                    href="https://lupyuen.github.io/articles/openocd-on-raspberry-pi-better-with-swd-on-spi"
                                    class="dn do bu bv bw bx by bz ca bg dp dq cb dr ds" rel="noopener"></a></span></div>
                            </div>
                            <div class="if s as"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <p id="03ff" class="ig ih gk ii b ij ik il im in io ip iq ir is it iu iv iw ix iy iz dh hg"><em
                      class="ja">Sneaky tricks to align stray bits into proper bytes</em></p>
                  <p id="8f9a"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">The setup
                    that we see above‚Ä¶ Debugging nRF52 with a Raspberry Pi running <a
                      href="https://code.headmelted.com/" class="dn jg"
                      rel="noopener nofollow">VSCode</a> and <a
                      href="http://openocd.org/doc/html/About.html#What-is-OpenOCD_003f"
                      class="dn jg" rel="noopener nofollow">OpenOCD</a>‚Ä¶ <em class="ja">Was impossible just a week
                      ago!</em></p>
                  <p id="7df9"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">OpenOCD
                    connects to nRF52 for flashing and debugging by running <a
                      href="https://github.com/MarkDing/swd_programing_sram"
                      class="dn jg" rel="noopener nofollow">Arm‚Äôs SWD protocol</a> over GPIO <a
                      href="https://en.wikipedia.org/wiki/Bit_banging"
                      class="dn jg" rel="noopener nofollow">Bit Banging</a>. OpenOCD was sending data to nRF52 <strong
                      class="ii cu">one bit at a time</strong>‚Ä¶ Works fine when OpenOCD is the only task running, <em
                      class="ja">not when it‚Äôs sharing the CPU with VSCode and other interactive tasks!</em></p>
                  <p id="fb26"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">That‚Äôs
                    because multitasking skews the precise timing that‚Äôs needed by OpenOCD to send each bit correctly.
                  </p>
                  <p id="f9c9"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Inst<span
                      id="rmm">e</span>ad of sending data over GPIO one bit at a time, <em class="ja">what if we could
                      blast out the data over </em><a
                      href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/spi/README.md"
                      class="dn jg" rel="noopener nofollow"><em class="ja">Raspberry Pi‚Äôs SPI interface</em></a><em
                      class="ja">?</em></p>
                  <p id="72df"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><strong
                      class="ii cu">SPI (</strong><a
                      href="https://en.wikipedia.org/wiki/Serial_Peripheral_Interface"
                      class="dn jg" rel="noopener nofollow"><strong class="ii cu">Serial Peripheral
                        Interface</strong></a><strong class="ii cu">)</strong> is implemented as a <a
                      href="https://github.com/raspberrypi/linux/blob/rpi-3.12.y/drivers/spi/spi-bcm2708.c"
                      class="dn jg" rel="noopener nofollow">kernel mode driver</a> with interrupts, so it runs with
                    <strong class="ii cu">high CPU priority</strong>. Raspberry Pi‚Äôs <a
                      href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/bcm2835/BCM2835-ARM-Peripherals.pdf"
                      class="dn jg" rel="noopener nofollow">Broadcom microcontroller</a> supports Bidirectional SPI (31
                    MHz) with <strong class="ii cu">precise clocking and buffering</strong>. <em class="ja">Why not use
                      SPI for SWD?</em></p>
                  <p id="d4a6"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">This
                    article explains how we did that‚Ä¶ By overcoming some interesting bitwise challenges. The SWD
                    protocol enables OpenOCD to flash and debug firmware, by reading and writing the debugging registers
                    on our Arm CPU. We‚Äôll study the SWD Register Read/Write operations in a while‚Ä¶</p>
                </div>
              </div>
            </section>
            <div class="n p cr jh ji jj" role="separator"><span class="jk hr bq jl jm jn"></span><span
                class="jk hr bq jl jm jn"></span><span class="jk hr bq jl jm"></span></div>
            <section class="dh fk fl dc fm">
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <h1 id="6277"
                    class="jo jp gk av jq jr js ik jt ju jv in jw jx jy jz ka kb kc kd ke kf kg kh ki kj hg">Build and
                    Test OpenOCD with SPI</h1>
                  <p id="a6b7"
                    class="ig ih gk ii b ij kk ik il im kl in io ip km iq ir is kn it iu iv ko iw ix iz dh hg"><strong
                      class="ii cu">UPDATE: There‚Äôs an easier way to build </strong><code
                      class="fy kp kq kr ks b"><strong class="ii cu">openocd-spi</strong></code><strong class="ii cu">
                      and use it to flash firmware‚Ä¶ </strong><a
                      href="https://github.com/lupyuen/pinetime-updater"
                      class="dn jg" rel="noopener nofollow"><strong class="ii cu">Check out </strong></a><code
                      class="fy kp kq kr ks b"><a href="https://github.com/lupyuen/pinetime-updater" class="dn jg" rel="noopener nofollow"><strong class="ii cu">pinetime-updater</strong></a></code>
                  </p>
                  <p id="0f26"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">The SPI
                    version of OpenOCD is here‚Ä¶</p>

                  <p><a href="https://github.com/lupyuen/openocd-spi">https://github.com/lupyuen/openocd-spi</a></p>    

                  <p id="6b24"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">To build
                    and test on Raspberry Pi Zero, 1, 2, 3 or 4‚Ä¶</p>
                  <p id="a357"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">1Ô∏è‚É£
                    Connect PineTime / nRF52 to the SPI port on Raspberry Pi‚Ä¶</p>

                  <p><script src="https://gist.github.com/lupyuen/6913bcd5ff5a5d67698f8bac0d84599b.js"></script></p>

                  <p><img src="https://lupyuen.github.io/images/legacy/d2.png" /></p>
                <p><em>Connecting Raspberry Pi to PineTime / nRF52.
                      Based on <a href="https://pinout.xyz/" class="dn jg"
                        rel="noopener nofollow">https://pinout.xyz/</a></em></p>

                </div>
              </div>
              <div class="fn">
                <div class="n p">
                  <div class="mb mc md me mf mg am mh an mi ap w">


<p><img src="https://lupyuen.github.io/images/legacy/d3.jpeg" /></p>
<p><em>Connecting Raspberry Pi to PineTime / nRF52</em></p>

                  </div>
                </div>
              </div>
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <p id="bdc9"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">2Ô∏è‚É£
                    Enable the SPI interface on Raspberry Pi‚Ä¶</p>
                  <pre
                    class="lt lu lv lw lx mn mo mp"><span id="f7f6" class="hg mq jp gk ks b di mr ms s mt">sudo raspi-config</span></pre>
                  <p id="ad7b"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Select
                    <code class="fy kp kq kr ks b">Interfacing Options ‚Üí SPI ‚Üí Yes</code></p>
                  <p id="8871"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">3Ô∏è‚É£
                    Download and build the modified OpenOCD‚Ä¶</p>
                  <pre
                    class="lt lu lv lw lx mn mo mp"><span id="b44b" class="hg mq jp gk ks b di mr ms s mt">cd ~<br/>git clone <a href="https://github.com/lupyuen/openocd-spi" class="dn jg" rel="noopener nofollow">https://github.com/lupyuen/openocd-spi</a><br/>cd openocd-spi<br/>./bootstrap<br/>./configure --enable-sysfsgpio --enable-bcm2835spi --enable-cmsis-dap<br/>make</span></pre>
                  <p id="8eda"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">The
                    modified OpenOCD executable is now at <code class="fy kp kq kr ks b">openocd-spi/src/openocd</code>
                  </p>
                  <p id="dbee"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">If you
                    see this error‚Ä¶</p>
                  <pre
                    class="lt lu lv lw lx mn mo mp"><span id="053f" class="hg mq jp gk ks b di mr ms s mt">Cloning into &#x27;openocd-spi/jimtcl&#x27;...<br/>fatal: unable to access &#x27;<a href="http://repo.or.cz/r/jimtcl.git/'" class="dn jg" rel="noopener nofollow">http://repo.or.cz/r/jimtcl.git/&#x27;</a>: Recv failure: Connection reset by peer<br/>fatal: clone of &#x27;<a href="http://repo.or.cz/r/jimtcl.git'" class="dn jg" rel="noopener nofollow">http://repo.or.cz/r/jimtcl.git&#x27;</a> into submodule path &#x27;/private/tmp/aa/openocd-spi/jimtcl&#x27; failed</span></pre>
                  <p id="8ba3"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">It means
                    that the sub-repository for one of the dependencies <code class="fy kp kq kr ks b">jimtcl</code> is
                    temporarily down. You may download the pre-built <code class="fy kp kq kr ks b">openocd-spi</code>
                    binaries <a
                      href="https://github.com/lupyuen/pinetime-rust-mynewt/releases/download/openocd-spi2/openocd-spi.7z"
                      class="dn jg" rel="noopener nofollow">from this link</a>.</p>
                  <p id="5c77"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">4Ô∏è‚É£ If
                    you‚Äôre using <code class="fy kp kq kr ks b">pinetime-rust-mynewt</code> downloaded <a class="dn jg"
                      rel="noopener"
                      href="https://lupyuen.github.io/articles/build-and-flash-rust-mynewt-firmware-for-pinetime-smart-watch">from
                      this article</a>‚Ä¶</p>
                  <p id="e40b"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Edit the
                    OpenOCD scripts located at <code
                      class="fy kp kq kr ks b">pinetime-rust-mynewt/scripts/nrf52-pi</code>‚Ä¶</p>
                  <p id="a482"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><code
                      class="fy kp kq kr ks b">flash-app.sh, flash-boot.sh, flash-unprotect.sh</code></p>
                  <p id="52a7"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Change
                    the <code class="fy kp kq kr ks b">openocd</code> folder to <code
                      class="fy kp kq kr ks b">openocd-spi</code> like this‚Ä¶</p>
                  <pre
                    class="lt lu lv lw lx mn mo mp"><span id="e986" class="hg mq jp gk ks b di mr ms s mt">$HOME/<strong class="ks cu">openocd-spi</strong>/src/openocd \<br/>    -s $HOME/<strong class="ks cu">openocd-spi</strong>/tcl \<br/>    -f scripts/nrf52-pi/swd-pi.ocd \<br/>    -f scripts/nrf52/flash-app.ocd</span></pre>
                  <p id="51fd"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Run these
                    scripts to unprotect the flash ROM, flash the bootloader and flash the application via SPI‚Ä¶</p>
                  <pre
                    class="lt lu lv lw lx mn mo mp"><span id="f816" class="hg mq jp gk ks b di mr ms s mt">cd ~/pinetime-rust-mynewt<br/>scripts/nrf52-pi/flash-unprotect.sh<br/>scripts/nrf52-pi/flash-boot.sh<br/>scripts/nrf52-pi/flash-app.sh</span></pre>
                  <p id="f06f"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">More
                    details may be found the article <em class="ja">‚Äú</em><a class="dn jg" rel="noopener"
                      href="https://lupyuen.github.io/articles/build-and-flash-rust-mynewt-firmware-for-pinetime-smart-watch"><em
                        class="ja">Build and Flash Rust+Mynewt Firmware for PineTime Smart Watch</em></a><em
                      class="ja">‚Äù</em> under the section <em class="ja">‚ÄúRemove PineTime Flash Protection‚Äù</em></p>
                  <p id="002d"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">5Ô∏è‚É£ If
                    you prefer to write your own OpenOCD scripts (instead of using <code
                      class="fy kp kq kr ks b">pinetime-rust-mynewt</code>)‚Ä¶</p>
                  <p id="1d6f"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Here‚Äôs a
                    sample OpenOCD script and shell script that you may adapt for flashing‚Ä¶</p>
                  <p id="48f5"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">OpenOCD
                    Script: <code
                      class="fy kp kq kr ks b"><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/scripts/nrf52/flash-boot.ocd" class="dn jg" rel="noopener nofollow">flash-boot.ocd</a></code>
                    and <code
                      class="fy kp kq kr ks b"><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/scripts/nrf52-pi/swd-pi.ocd" class="dn jg" rel="noopener nofollow">swd-pi.ocd</a></code>
                  </p>
                  <p id="dad4"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Shell
                    Script:</p>
                  <pre
                    class="lt lu lv lw lx mn mo mp"><span id="c828" class="hg mq jp gk ks b di mr ms s mt">$HOME/<strong class="ks cu">openocd-spi</strong>/src/openocd \<br/>    -s $HOME/<strong class="ks cu">openocd-spi</strong>/tcl \<br/>    -f swd-pi.ocd \<br/>    -f flash-boot.ocd</span></pre>
                  <p id="3d1e"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Unlike
                    GPIO, the SPI interface doesn‚Äôt require <code class="fy kp kq kr ks b">sudo</code> access.</p>
                  <p id="3b47"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Make sure
                    that you select <code class="fy kp kq kr ks b">bcm2835spi</code> as the OpenOCD interface (in <code
                      class="fy kp kq kr ks b"><a href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/scripts/nrf52-pi/swd-pi.ocd" class="dn jg" rel="noopener nofollow">swd-pi.ocd</a></code>).
                  </p>
                  <pre
                    class="lt lu lv lw lx mn mo mp"><span id="ac0e" class="hg mq jp gk ks b di mr ms s mt"># Select the Broadcom SPI interface for Raspberry Pi (SWD transport)<br/>interface bcm2835spi </span><span id="273b" class="hg mq jp gk ks b di mu mv mw mx my ms s mt"># Set the SPI speed in kHz<br/>bcm2835spi_speed 31200  # 31.2 MHz</span></pre>
                  <p id="6deb"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><code
                      class="fy kp kq kr ks b">bcm2835spi</code> accepts one parameter <code
                      class="fy kp kq kr ks b">bcm2835spi_speed</code>, the SPI speed in kHz. <code
                      class="fy kp kq kr ks b">bcm2835spi_speed</code> defaults to <code
                      class="fy kp kq kr ks b">31200</code> (31.2 MHz). <a
                      href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/spi/README.md"
                      class="dn jg" rel="noopener nofollow"><em class="ja">Check this for the list of supported SPI
                        speeds</em></a></p>
                  <p id="5bc7"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Run the
                    above scripts to flash your device.</p>
                  <p id="e09b"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">6Ô∏è‚É£ You
                    should see this message if you‚Äôre using the 31 MHz SPI version of OpenOCD (instead of the old GPIO
                    version)‚Ä¶</p>
                  <pre
                    class="lt lu lv lw lx mn mo mp"><span id="547e" class="hg mq jp gk ks b di mr ms s mt">Info : BCM2835 SPI SWD driver<br/>Info : SWD only mode enabled<br/>Info : clock speed 31200 kHz</span></pre>
                  <p id="87d9"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">7Ô∏è‚É£ If
                    the flashing over SPI is successful, you should see‚Ä¶</p>
                  <pre
                    class="lt lu lv lw lx mn mo mp"><span id="b9ee" class="hg mq jp gk ks b di mr ms s mt">** Programming Started **<br/>Info : nRF52832-QFAA(build code: E1) 512kB Flash, 64kB RAM<br/>Warn : Adding extra erase range, 0x0003da78 .. 0x0003dfff<br/>** Programming Finished **<br/>** Verify Started **<br/>** Verified OK **</span></pre>
                </div>
              </div>
              <div class="fn w">


<p><img src="https://lupyuen.github.io/images/legacy/d4.jpeg" /></p>
<p><em>Here‚Äôs a tip: Colour the Raspberry Pi pins with
                    a marker (one side only) so that we remember which pin to connect</em></p>


              </div>
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <blockquote class="na nb nc">
                    <p id="aee9"
                      class="ig ih ja ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><em
                        class="gk">üíé </em>The Bidirectional SPI we‚Äôre using on Raspberry Pi is slightly different from
                      the <a
                        href="https://en.wikipedia.org/wiki/Serial_Peripheral_Interface"
                        class="dn jg" rel="noopener nofollow">normal SPI interface</a>‚Ä¶ Normal SPI runs on 3 data pins:
                      SCLK (Clock), MOSI (Host ‚Üí Target), MISO (Target ‚Üí Host). The <a
                        href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/bcm2835/BCM2835-ARM-Peripherals.pdf"
                        class="dn jg" rel="noopener nofollow">Broadcom microcontroller on Pi</a> supports <a
                        href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/spi/README.md"
                        class="dn jg" rel="noopener nofollow">SPI with 2 data pins</a>, by merging the MOSI and MISO
                      pins. Hence it‚Äôs called ‚ÄúBidirectional SPI‚Äù. It‚Äôs pin-compatible with SWD, which also uses 2 data
                      pins.</p>
                    <p id="fccb"
                      class="ig ih ja ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Will
                      SWD over SPI work on other microcontrollers besides Broadcom? Possibly not‚Ä¶ I wasn‚Äôt able to find
                      a similar Bidirectional SPI mode for Rockchip RK3328, for instance. Bidirectional SPI mode is
                      sometimes named MOMI or SISO mode.</p>
                  </blockquote>
                </div>
              </div>
            </section>
            <div class="n p cr jh ji jj" role="separator"><span class="jk hr bq jl jm jn"></span><span
                class="jk hr bq jl jm jn"></span><span class="jk hr bq jl jm"></span></div>
            <section class="dh fk fl dc fm">
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <h1 id="d19a"
                    class="jo jp gk av jq jr js ik jt ju jv in jw jx jy jz ka kb kc kd ke kf kg kh ki kj hg">SWD Read
                    Operation</h1>
                  <p id="ccae"
                    class="ig ih gk ii b ij kk ik il im kl in io ip km iq ir is kn it iu iv ko iw ix iz dh hg">OpenOCD
                    flashes and debugs firmware by reading and writing the debugging registers on our Arm CPU. Let‚Äôs
                    look at the reading of registers‚Ä¶</p>
                  <p id="b69d"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">For
                    Raspberry Pi to read an SWD Register on nRF52, we perform an SWD Read Operation like this (Raspberry
                    Pi is the host, PineTime/nRF52 is the target)‚Ä¶</p>
                </div>
              </div>
              <div class="fn w">


<p><img src="https://lupyuen.github.io/images/legacy/d5.png" /></p>
<p><em>SWD Read Operation with 2 undefined trailing
                    bits. From <a
                      href="https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=0"
                      class="dn jg"
                      rel="noopener nofollow">https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=0</a>
                  </em></p>

              </div>
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <p id="0038"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Here we
                    are reading the <strong class="ii cu">IDCODE (Identification Code) Register</strong>, which
                    identifies the Arm Debug Interface (<code class="fy kp kq kr ks b">0x2ba01477</code> for nRF52).
                    IDCODE is Register #0 (in Read Mode), so we set <code class="fy kp kq kr ks b">A2</code> and <code
                      class="fy kp kq kr ks b">A3</code> (bits 2 and 3 of the register number) to <code
                      class="fy kp kq kr ks b">0</code>.</p>
                  <p id="1f2d"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><strong
                      class="ii cu"><em class="ja">Pi ‚Üí nRF52: 8 bits‚Ä¶</em></strong></p>


<p><img src="https://lupyuen.github.io/images/legacy/d6.png" /></p>
<p><em>From Pi to nRF52</em></p>

                  <p id="57c4"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Pi sends
                    <code class="fy kp kq kr ks b">0xA5</code> (least significant bit first) to nRF52. That‚Äôs followed
                    by <code class="fy kp kq kr ks b">Trn</code>, the Turnaround Bit. This bit gives 1 clock cycle of
                    breathing space whenever we flip the transmission from Pi to nRF52 and back. The value of <code
                      class="fy kp kq kr ks b">Trn</code> doesn‚Äôt matter.</p>
                  <p id="f84f"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><strong
                      class="ii cu"><em class="ja">nRF52 ‚Üí Pi: 38 bits (including turnaround)‚Ä¶</em></strong></p>
                </div>
              </div>
              <div class="fn w">


<p><img src="https://lupyuen.github.io/images/legacy/d7.png" /></p>
<p><em>From nRF52 to Pi</em></p>


                </div>
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <p id="2fed"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">nRF52
                    responds with the Acknowledgement <code class="fy kp kq kr ks b">100</code> (which means OK).
                    Followed by 32 bits of data (the value of Register IDCODE), a Parity bit, and another Turnaround
                    Bit.</p>
                  <p id="b426"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Now let‚Äôs
                    see whether Raspberry Pi‚Äôs SPI interface will allow us to send and receive this kind of data.</p>
                  <p id="ecb9"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><strong
                      class="ii cu"><em class="ja">Missing: 2 bits‚Ä¶</em></strong></p>


<p><img src="https://lupyuen.github.io/images/legacy/d8.png" /></p>
<p><em>From nRF52 to Pi and back</em></p>


                  <p id="4545"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Count the
                    bits for the entire SWD Read Operation (look at the red blocks)‚Ä¶ It has 46 bits, which is <em
                      class="ja">2 bits short of 6 whole bytes</em>.</p>
                  <p id="730b"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Also the
                    <em class="ja">last byte is split across Pi and nRF52</em>‚Ä¶ nRF52 sends 5 bits, then Turnaround,
                    then Pi is supposed to send 2 bits from the next read/write operation!</p>
                  <p id="c399"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Since
                    Raspberry Pi‚Äôs SPI interface can only send and receive whole bytes (not bits)‚Ä¶ <em class="ja">We
                      have a problem with the last 2 stray bits!</em></p>
                  <p id="55f6"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">nRF52
                    gets utterly confused after the SWD Read Operation. Only way to fix this? <strong
                      class="ii cu">Reset the SWD connection and resynchronise by resending the JTAG-To-SWD
                      Sequence.</strong></p>

                      <p><script src="https://gist.github.com/lupyuen/b8612a2a9f861da7750f9baca66d94bc.js"></script></p>
                      
<p><em>Sending the JTAG-To-SWD Sequence to reset SWD
                      connection. From <a
                        href="https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/swd.h"
                        class="dn jg"
                        rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/swd.h</a>
</em></p>


                  <p id="05bd"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Yes our
                    SWD flashing may slow down when we reset the SWD connection after every SWD Read Operation‚Ä¶ But we
                    are now running the SWD connection over SPI at a speedy <strong class="ii cu">31 MHz</strong>! This
                    compensates for the reset transmission, so the overall SWD flashing is still fast.</p>

                    <p><script src="https://gist.github.com/lupyuen/70a0e939bb1b7a985e5b8eedbb34baee.js"></script></p>

<p><em>After every SWD Read Operation, send the
                      JTAG-To-SWD Sequence to reset SWD connection. From <a
                        href="https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bcm2835spi.c"
                        class="dn jg"
                        rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bcm2835spi.c</a>
</em></p>


                </div>
              </div>
            </section>
            <div class="n p cr jh ji jj" role="separator"><span class="jk hr bq jl jm jn"></span><span
                class="jk hr bq jl jm jn"></span><span class="jk hr bq jl jm"></span></div>
            <section class="dh fk fl dc fm">
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <h1 id="30e6"
                    class="jo jp gk av jq jr js ik jt ju jv in jw jx jy jz ka kb kc kd ke kf kg kh ki kj hg">Throwaway
                    SWD Read Operation</h1>
                  <p id="fb58"
                    class="ig ih gk ii b ij kk ik il im kl in io ip km iq ir is kn it iu iv ko iw ix iz dh hg">For SWD
                    to work over SPI, we need to reset the SWD connection after every SWD Read Operation‚Ä¶ Just send the
                    JTAG-To-SWD Sequence! But there‚Äôs a catch: <em class="ja">We MUST read IDCODE after sending the
                      JTAG-To-SWD Sequence‚Ä¶</em></p>


                  
                  <p><img src="https://lupyuen.github.io/images/legacy/d9.png" /></p>
<p><em>Resetting the SWD connection. From ARM¬Æ Debug
                      Interface v5 Architecture Specification <a
                        href="https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf"
                        class="dn jg"
                        rel="noopener nofollow">https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf</a>
</em></p>


                  <p id="d77e"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><em
                      class="ja">See the problem here? </em>We need to reset after reading a register‚Ä¶ <em
                      class="ja">And yet we need to read a register (IDCODE) after resetting!</em></p>
                  <p id="c12a"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><em
                      class="ja">The snake eats its own tail! </em>To break the snake, we use a sneaky way to read
                    IDCODE after resetting, the Throwaway Way‚Ä¶</p>
                </div>
              </div>
              <div class="fn w">


                  
                <p><img src="https://lupyuen.github.io/images/legacy/d10.png" /></p>
<p><em>Read IDCODE Operation: Normal operation (above)
                    and Throwaway operation (below). From <a
                      href="https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=0"
                      class="dn jg"
                      rel="noopener nofollow">https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=0</a>
</em></p>


              </div>
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <p id="a7ab"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Notice
                    that we <em class="ja">slide the entire Read IDCODE Operation two bits to the right</em>‚Ä¶ Inserting
                    two null bits in front.</p>
                  <p id="2cc8"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><em
                      class="ja">Will nRF52 accept the two null leading bits sent by Pi?</em> Yes because all SWD
                    Read/Write Operations must start with <code class="fy kp kq kr ks b">1</code>. So it‚Äôs always OK for
                    Pi to send null bits before and after every SWD Read/Write Operation.</p>
                  <p id="b4b0"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">For a
                    normal SWD Read Operation (that‚Äôs not byte-aligned and hence problematic)‚Ä¶</p>
                  <p id="2d5b"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><strong
                      class="ii cu"><em class="ja">Pi ‚Üí nRF52</em></strong>: 8 bits (<code
                      class="fy kp kq kr ks b">A5</code>), followed by‚Ä¶<br /><strong class="ii cu"><em class="ja">nRF52
                        ‚Üí Pi</em></strong>: 38 bits (Data + Parity + Turnaround)</p>
                  <p id="b205"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><strong
                      class="ii cu">Total 46 bits</strong>, not byte-aligned, no good. For our special Throwaway version
                    with two prepadded null bits‚Ä¶</p>
                  <p id="449e"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><strong
                      class="ii cu"><em class="ja">Pi ‚Üí nRF52</em></strong>: 48 bits (<code
                      class="fy kp kq kr ks b">94 02 00 00 00 00</code>), followed by‚Ä¶<br /><strong class="ii cu"><em
                        class="ja">nRF52 ‚Üí Pi</em></strong>: 0 bits</p>
                  <p id="5182"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><strong
                      class="ii cu">Total 48 bits</strong>, byte-aligned, all good! So the next SWD Read or Write
                    Operation may be sent, perfectly aligned to the byte. (If the next operation is SWD Read, we‚Äôll have
                    to read the register, reset and read IDCODE again)</p>
                  <p id="3133"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><em
                      class="ja">But it sounds like Pi is yakking away over the entire SWD Read Operation, not really
                      listening to nRF52 (and getting the value of IDCODE)?</em></p>
                  <p id="0362"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">That‚Äôs
                    perfectly fine‚Ä¶ We don‚Äôt really care about the value of IDCODE anyway. We are only reading IDCODE
                    because Arm said so.</p>
                  <p id="758a"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Thus in
                    the SPI implementation of SWD, we see this special Throwaway Read IDCODE (<code
                      class="fy kp kq kr ks b">94 02 00 00 00 00</code>) that‚Äôs sent after every SWD connection reset in
                    <code
                      class="fy kp kq kr ks b"><a href="https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/spi.c" class="dn jg" rel="noopener nofollow">spi_transmit_resync</a>()</code>.
                    To give sufficient clock cycles for nRF52 to do its job, we insert a null byte before and after the
                    Throwaway Read IDCODE: <code
                      class="fy kp kq kr ks b"><strong class="ii cu">00</strong> 94 02 00 00 00 00 <strong class="ii cu">00</strong></code>
                  </p>
                                  
                  <p><script src="https://gist.github.com/lupyuen/0d45e70d60bcd303a12392f13eebf80b.js"></script></p>
<p><em>Reset SWD Connection with Throwaway Read
                      IDCODE. From <a
                        href="https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bcm2835spi.c"
                        class="dn jg"
                        rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bcm2835spi.c</a>
</em></p>

                  <p id="7acf"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><em
                      class="ja">What‚Äôs the SWD Write ABORT Operation?</em> We‚Äôll learn in a while‚Ä¶</p>
                </div>
              </div>
            </section>
            <div class="n p cr jh ji jj" role="separator"><span class="jk hr bq jl jm jn"></span><span
                class="jk hr bq jl jm jn"></span><span class="jk hr bq jl jm"></span></div>
            <section class="dh fk fl dc fm">
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <h1 id="81ad"
                    class="jo jp gk av jq jr js ik jt ju jv in jw jx jy jz ka kb kc kd ke kf kg kh ki kj hg">SWD Write
                    Operation</h1>
                  <p id="7a4a"
                    class="ig ih gk ii b ij kk ik il im kl in io ip km iq ir is kn it iu iv ko iw ix iz dh hg">For
                    Raspberry Pi to write an SWD Register on nRF52, we perform an SWD Write Operation like this
                    (Raspberry Pi is the host, PineTime/nRF52 is the target)‚Ä¶</p>
                </div>
              </div>
              <div class="fn w">


                  
                <p><img src="https://lupyuen.github.io/images/legacy/d11.png" /></p>
<p><em>SWD Write Operation padded with 2 null bits.
                    From <a
                      href="https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=0"
                      class="dn jg"
                      rel="noopener nofollow">https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=0</a>
                  </em></p></em></p>

              </div>
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <p id="31fa"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Here we
                    are writing the value <code class="fy kp kq kr ks b">0x1E</code> to the <strong class="ii cu">ABORT
                      Register</strong>. Whenever a SWD protocol error occurs during transmission (e.g. misaligned
                    bits), we need to clear the error by writing to the ABORT Register.</p>
                  <p id="91be"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">ABORT is
                    Register #0 (in Write Mode), so we set <code class="fy kp kq kr ks b">A2</code> and <code
                      class="fy kp kq kr ks b">A3</code> (bits 2 and 3 of the register number) to <code
                      class="fy kp kq kr ks b">0</code>.</p>
                  <p id="cb3f"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><strong
                      class="ii cu"><em class="ja">Pi ‚Üí nRF52: 8 bits‚Ä¶</em></strong></p>


                  
                  <p><img src="https://lupyuen.github.io/images/legacy/d12.png" /></p>
<p><em>From Pi to nRF52</em></p>

                  <p id="78a0"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Pi sends
                    <code class="fy kp kq kr ks b">0x81</code> (least significant bit first) to nRF52. That‚Äôs followed
                    by <code class="fy kp kq kr ks b">Trn</code>, the Turnaround Bit.</p>
                  <p id="9139"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><strong
                      class="ii cu"><em class="ja">nRF52 ‚Üí Pi: 5 bits (including turnaround)‚Ä¶</em></strong></p>


                  
                  <p><img src="https://lupyuen.github.io/images/legacy/d13.png" /></p>
<p><em>From nRF52 to Pi</em></p>

                  <p id="59cf"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">nRF52
                    responds with the Acknowledgement <code class="fy kp kq kr ks b">100</code> (which means OK). and
                    another Turnaround Bit.</p>
                  <p id="a1fd"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><strong
                      class="ii cu"><em class="ja">Pi ‚Üí nRF52: 33 bits‚Ä¶</em></strong></p>
                </div>
              </div>
              <div class="fn w">


                  
                <p><img src="https://lupyuen.github.io/images/legacy/d14.png" /></p>
<p><em>From Pi to nRF52</em></p>

              </div>
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <p id="c3aa"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Pi sends
                    32 bits of data (the value to be written to Register ABORT) and a Parity bit.</p>
                  <p id="b3c1"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><strong
                      class="ii cu"><em class="ja">Pi ‚Üí nRF52: 2 bits (padding for byte alignment)‚Ä¶</em></strong></p>


                  
                  <p><img src="https://lupyuen.github.io/images/legacy/d15.png" /></p>
<p><em>From Pi to nRF52</em></p>

                  <p id="ea2d"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">For our
                    SPI implementation, Pi sends an extra 2 null bits to make the entire operation byte-aligned: 6 whole
                    SPI bytes. <em class="ja">(Remember: It‚Äôs OK to insert extra null bits before and after SWD
                      Read/Write Operations)</em></p>
                  <p id="c4c9"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">No
                    misaligned bits for SWD Write Operations‚Ä¶ <em class="ja">Phew!</em></p>
                </div>
              </div>
            </section>
            <div class="n p cr jh ji jj" role="separator"><span class="jk hr bq jl jm jn"></span><span
                class="jk hr bq jl jm jn"></span><span class="jk hr bq jl jm"></span></div>
            <section class="dh fk fl dc fm">
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <h1 id="a93c"
                    class="jo jp gk av jq jr js ik jt ju jv in jw jx jy jz ka kb kc kd ke kf kg kh ki kj hg">A
                    Convenient Write Lie</h1>
                  <p id="5a2c"
                    class="ig ih gk ii b ij kk ik il im kl in io ip km iq ir is kn it iu iv ko iw ix iz dh hg"><em
                      class="ja">Will SWD Write Operations work over SPI?</em> SWD Write Operations are always
                    byte-aligned, because we padded 2 null bits. But we have a funny Turnaround situation in the second
                    byte of the SWD Write Operation‚Ä¶</p>


                  
                  <p><img src="https://lupyuen.github.io/images/legacy/d16.png" /></p>
<p><em>From Pi to nRF52 and back</em></p>

                  <p id="69ee"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><em
                      class="ja">There are Two Turnarounds in the same byte!</em></p>
                  <p id="d467"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><strong
                      class="ii cu"><em class="ja">nRF52 ‚Üí Pi:</em></strong> 3 Acknowledgement Bits + 2 Turnaround Bits,
                    followed by‚Ä¶<em class="ja"><br /></em><strong class="ii cu"><em class="ja">Pi ‚Üí
                        nRF52:</em></strong><em class="ja"> </em>3 Data Bits</p>
                  <p id="72be"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">We can‚Äôt
                    flip the direction of transmission within a single SPI byte transfer. <em class="ja">So this fails
                      for SPI!</em> Thankfully we have another sneaky solution for this problematic second byte‚Ä¶</p>
                  <p id="4c36"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><strong
                      class="ii cu"><em class="ja">nRF52 ‚Üí Pi:</em></strong> 0 bits, followed by‚Ä¶<em
                      class="ja"><br /></em><strong class="ii cu"><em class="ja">Pi ‚Üí nRF52:</em></strong><em
                      class="ja"> </em>3 Acknowledgement Bits + 2 Turnaround Bits + 3 Data Bits</p>
                  <p id="155a"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><em
                      class="ja">Look familiar?</em> This is the same trick as the Throwaway SWD Read Operation‚Ä¶ <em
                      class="ja">We now throw away the 3 Acknowledgement Bits sent by nRF52 to Pi!</em></p>
                  <p id="bde1"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Instead
                    of Pi receiving the 3 Acknowledgement Bits from nRF52, <em class="ja">Pi now sends 3 bits to
                      nRF52</em>. Doesn‚Äôt matter whether they are <code class="fy kp kq kr ks b">0</code> or <code
                      class="fy kp kq kr ks b">1</code>, as long as it takes 3 clock cycles.</p>
                  <p id="2c7d"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">But that
                    means we won‚Äôt know whether the Write Acknowledgement is OK (<code
                      class="fy kp kq kr ks b">100</code>)!</p>
                  <p id="a5f4"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><em
                      class="ja">Think about it‚Ä¶ Is this Write Acknowledgement really useful?</em> It happens <em
                      class="ja">before</em> the data is written! Most of the time it‚Äôs used to indicate that the
                    Register ID (in <code class="fy kp kq kr ks b">A2</code> and <code
                      class="fy kp kq kr ks b">A3</code>) is valid.</p>
                  <p id="101c"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Thus we
                    take a calculated risk and assume that the <strong class="ii cu">SWD Write Acknowledgement is always
                      OK</strong>. Our SPI code always lies and returns <code class="fy kp kq kr ks b">100</code> to
                    OpenOCD.</p>

                    <p><script src="https://gist.github.com/lupyuen/82adeeecf84f6b62d90d9536c3043105.js"></script></p>

<p><em>Our SPI code always returns OK to OpenOCD for
                      SWD Write Acknowledgement. From <a
                        href="https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bcm2835spi.c"
                        class="dn jg"
                        rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bcm2835spi.c</a>
</em></p>

                  <p id="eb0b"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><em
                      class="ja">Will this cause problems when flashing the ROM of nRF52? Since we‚Äôre not checking the
                      SWD Write Acknowledgement?</em></p>
                  <p id="749e"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Here‚Äôs
                    how we mitigate the risk of write failures: <strong class="ii cu">We always read and verify the ROM
                      contents after flashing</strong>, like in <a
                      href="https://github.com/lupyuen/pinetime-rust-mynewt/blob/master/scripts/nrf52/flash-app.ocd"
                      class="dn jg" rel="noopener nofollow">this OpenOCD script</a>‚Ä¶</p>
                  <pre
                    class="lt lu lv lw lx mn mo mp"><span id="dd35" class="hg mq jp gk ks b di mr ms s mt">program bin/targets/nrf52_my_sensor/app/apps/my_sensor_app/my_sensor_app.img verify 0x00008000</span></pre>
                  <p id="1afa"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">When we
                    throw away the SWD Write Acknowledgement, we eliminate all Turnarounds. Our SWD Write Operation
                    becomes really simple‚Ä¶ <em class="ja">Just send 8 whole bytes from Pi to nRF52!</em></p>
                  <p id="11ed"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><em
                      class="ja">Perfect for implementing SWD over SPI!</em></p>
                  <p id="ff0e"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Hence to
                    write value <code class="fy kp kq kr ks b">0x1E</code> to the ABORT Register, Pi only needs to blast
                    out 6 bytes over SPI to nRF52: <code class="fy kp kq kr ks b">81 d3 03 00 00 00</code></p>

                    <p><script src="https://gist.github.com/lupyuen/3fd90b6f7f060e49bd629eccee1958d7.js"></script></p>

<p><em>Sending 8 whole bytes from Pi to nRF52 for an
                      SPI Write Operation. From <a
                        href="https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bcm2835spi.c"
                        class="dn jg"
                        rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bcm2835spi.c</a>
</em></p>

                </div>
              </div>
            </section>
            <div class="n p cr jh ji jj" role="separator"><span class="jk hr bq jl jm jn"></span><span
                class="jk hr bq jl jm jn"></span><span class="jk hr bq jl jm"></span></div>
            <section class="dh fk fl dc fm">
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <h1 id="81eb"
                    class="jo jp gk av jq jr js ik jt ju jv in jw jx jy jz ka kb kc kd ke kf kg kh ki kj hg">Clear the
                    Sticky Error Bits</h1>
                  <p id="6561"
                    class="ig ih gk ii b ij kk ik il im kl in io ip km iq ir is kn it iu iv ko iw ix iz dh hg">We added
                    debug logs to the existing OpenOCD code in <code
                      class="fy kp kq kr ks b"><a href="https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bitbang.c#L414-L464" class="dn jg" rel="noopener nofollow">bitbang.c</a></code>
                    to compare the old GPIO and new SPI implementations of the SWD protocol.</p>
                  <p id="b1f6"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Remember
                    we said earlier that every SWD Read Operation will be followed by an SWD connection reset that
                    transmits two byte sequences to nRF52‚Ä¶</p>
                  <ol class="">
                    <li id="3467"
                      class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz nw nx ny hg">
                      JTAG-To-SWD Sequence</li>
                    <li id="01a6"
                      class="ig ih gk ii b ij nz ik il im oa in io ip ob iq ir is oc it iu iv od iw ix iz nw nx ny hg">
                      Read IDCODE Sequence, prepadded with two null bits</li>
                  </ol>
                  <p id="3f64"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Here‚Äôs
                    what happens when we run OpenOCD with that setup‚Ä¶</p>


                  
                  <p><img src="https://lupyuen.github.io/images/legacy/d17.png" /></p>
<p><em>Comparing the logs from SWD over GPIO (left)
                      with SWD over SPI (right). From <a
                        href="https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=900511571"
                        class="dn jg"
                        rel="noopener nofollow">https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=900511571</a>
</em></p>

                  <p id="27f8"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Both the
                    GPIO and SPI versions of OpenOCD are reading and writing to the same nRF52 registers: IDCODE, SELECT
                    AP, CTRL/STAT. But the value of the Control/Status Register (CTRL/STAT) is different for SPI: <code
                      class="fy kp kq kr ks b">f0000003</code>.</p>
                  <p id="6270"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">What‚Äôs
                    <code class="fy kp kq kr ks b">f0000003</code>? Let‚Äôs key that <a
                      href="https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=2077834467"
                      class="dn jg" rel="noopener nofollow">into this spreadsheet</a> to decode the Control/Status
                    value‚Ä¶</p>
                </div>
              </div>
              <div class="fn w">


                  
                <p><img src="https://lupyuen.github.io/images/legacy/d18.png" /></p>
<p><em>Control/Status Register Decoder: <a
                      href="https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=2077834467"
                      class="dn jg"
                      rel="noopener nofollow">https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=2077834467</a>
</em></p>

              </div>
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <p id="a209"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><em
                      class="ja">What‚Äôs the difference between the GPIO and SPI values for the Control/Status
                      Register?</em> SPI is experiencing the <strong class="ii cu">STICKYORUN</strong> error‚Ä¶</p>


                  
                  <p><img src="https://lupyuen.github.io/images/legacy/d19.png" /></p>
<p><em>STICKYORUN flag in the Control/Status
                      Register. From ARM¬Æ Debug Interface v5 Architecture Specification <a
                        href="https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf"
                        class="dn jg"
                        rel="noopener nofollow">https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf</a>
</em></p>

                  <p id="528b"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">This
                    means that nRF52 has <strong class="ii cu">detected some overrun garbage on the SWD
                      connection</strong>‚Ä¶ <em class="ja">Must be due to our misaligned SWD Read Operations!</em></p>
                  <p id="8474"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">This is a
                    ‚ÄúSticky‚Äù error‚Ä¶ It sticks there forever until we do something to clear the error status. <strong
                      class="ii cu">If we don‚Äôt clear the Sticky error status, all SWD operations will fail.</strong>
                  </p>


                  
                  <p><img src="https://lupyuen.github.io/images/legacy/d20.png" /></p>
<p><em>ABORT Register. From ARM¬Æ Debug Interface v5
                      Architecture Specification <a
                        href="https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf"
                        class="dn jg"
                        rel="noopener nofollow">https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf</a>
</em></p>

                  <p id="264e"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">The
                    solution: We write value <code class="fy kp kq kr ks b">0x1E</code> to the ABORT Register. That‚Äôs
                    binary <code class="fy kp kq kr ks b">11110</code>, which means that we are clearing <em
                      class="ja">all</em> the errors: Overrun Error, Write Data Error, Sticky Error, Sticky Compare
                    Error.</p>
                  <p id="b043"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">In the
                    previous section we have learnt how to write value <code class="fy kp kq kr ks b">0x1E</code> to the
                    ABORT Register: By blasting out over SPI <code class="fy kp kq kr ks b">81 d3 03 00 00 00</code></p>
                  <p id="8206"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><em
                      class="ja">When shall we write to the ABORT Register to clear the errors?</em></p>
                  <p id="1b5f"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Remember
                    that Pi has become extremely negligent to nRF52‚Ä¶ <em class="ja">Pi has thrown away so much feedback
                      and acknowledgement from nRF52!</em> We don‚Äôt know exactly when nRF52 is having issues. But since‚Ä¶
                  </p>
                  <ol class="">
                    <li id="0b29"
                      class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz nw nx ny hg">
                      The errors are caused by the misaligned SWD Read Operation</li>
                    <li id="0da2"
                      class="ig ih gk ii b ij nz ik il im oa in io ip ob iq ir is oc it iu iv od iw ix iz nw nx ny hg">
                      And we always reset the SWD connection after every SWD Read Operation (except the Throwaway Read
                      IDCODE)‚Ä¶</li>
                  </ol>
                  <p id="f7cb"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Let‚Äôs
                    write to the ABORT Register and <strong class="ii cu">clear the errors at every SWD connection
                      reset</strong>.</p>
                  <p><script src="https://gist.github.com/lupyuen/4977b46c0c7dfdc6c8d22cf6cbfd6f6c.js"></script></p>

<p><em>Clearing the errors at every SWD connect
                      reset by writing to ABORT. From <a
                        href="https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bcm2835spi.c"
                        class="dn jg"
                        rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bcm2835spi.c</a>
</em></p>

                  <p id="6702"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><em
                      class="ja">With this fix, SWD over SPI works perfectly!</em></p>
                </div>
              </div>
            </section>
            <div class="n p cr jh ji jj" role="separator"><span class="jk hr bq jl jm jn"></span><span
                class="jk hr bq jl jm jn"></span><span class="jk hr bq jl jm"></span></div>
            <section class="dh fk fl dc fm">
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <h1 id="6258"
                    class="jo jp gk av jq jr js ik jt ju jv in jw jx jy jz ka kb kc kd ke kf kg kh ki kj hg">Inject SPI
                    into OpenOCD Bit Bang</h1>
                  <p id="2886"
                    class="ig ih gk ii b ij kk ik il im kl in io ip km iq ir is kn it iu iv ko iw ix iz dh hg">We have
                    SWD Read and Write Operations working fine over SPI, and we have forcibly fixed all the SWD errors
                    indirectly caused by SPI. Now let‚Äôs inject this SPI code into the OpenOCD code.</p>
                  <p id="8ac8"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">OpenOCD
                    calls <code class="fy kp kq kr ks b">bitbang_exchange()</code> in <code
                      class="fy kp kq kr ks b"><a href="https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bitbang.c#L414-L464" class="dn jg" rel="noopener nofollow">bitbang.c</a></code>
                    whenever it needs to transmit or receive a chunk of bits in a fixed direction. OpenOCD calls <code
                      class="fy kp kq kr ks b">bitbang_exchange()</code> two times for every SWD Read, three times for
                    every SWD Write‚Ä¶</p>
                </div>
              </div>
              <div class="fn">
                <div class="n p">
                  <div class="mb mc md me mf mg am mh an mi ap w">


                  
                    <p><img src="https://lupyuen.github.io/images/legacy/d21.png" /></p>
<p><em><code
                          class="fy kp kq kr ks b">SWD Read: bitbang_exchange()</code> called for two chunks of bits.
                        From <a
                          href="https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf"
                          class="dn jg"
                          rel="noopener nofollow">https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf</a>
</em></p>



                  
                    <p><img src="https://lupyuen.github.io/images/legacy/d22.png" /></p>
<p><em><code
                          class="fy kp kq kr ks b">SWD Write: bitbang_exchange()</code> called for three chunks of bits.
                        From <a
                          href="https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf"
                          class="dn jg"
                          rel="noopener nofollow">https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf</a>
</em></p>

                  </div>
                </div>
              </div>
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <p id="f7dd"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><code
                      class="fy kp kq kr ks b">bitbang_exchange()</code> is called by OpenOCD like this‚Ä¶</p>
                      <p><script src="https://gist.github.com/lupyuen/f3ed89f07ef8e0eefd588a7c91dee5b1.js"></script></p>
<p><em></em></p>

                  <p id="fb07"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Here‚Äôs
                    the existing code for <code class="fy kp kq kr ks b">bitbang_exchange()</code> that transmits and
                    receives chunks of bits over GPIO‚Ä¶</p>
                    <p><script src="https://gist.github.com/lupyuen/3cd1e1d2b020895389aa08262e77c8c4.js"></script></p>
<p><em>From <a
                        href="https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bitbang.c"
                        class="dn jg"
                        rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bitbang.c</a>
</em></p>

                  <p id="f2da"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">And
                    here‚Äôs the modification we made for <code class="fy kp kq kr ks b">bitbang_exchange()</code> to
                    transmit and receives chunks of bits over SPI‚Ä¶</p>
                    <p><script src="https://gist.github.com/lupyuen/7c86cf1503cd13b08dd3d960bc2fb831.js"></script></p>
<p><em>From <a
                        href="https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bitbang.c"
                        class="dn jg"
                        rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bitbang.c</a>
</em></p>

                  <p id="0fd4"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Which
                    simply forwards the call to our new function <code class="fy kp kq kr ks b">spi_exchange()</code> in
                    <code
                      class="fy kp kq kr ks b"><a href="https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bcm2835spi.c" class="dn jg" rel="noopener nofollow">bcm2835spi.c</a></code>.
                  </p>
                  <p><script src="https://gist.github.com/lupyuen/252ac7dfc2f9426b8d29228ee5732031.js"></script></p>
<p><em>From <a
                        href="https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bcm2835spi.c"
                        class="dn jg"
                        rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bcm2835spi.c</a>
</em></p>

                  <p id="3e6b"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Because
                    <code class="fy kp kq kr ks b">spi_exchange()</code> is called with chunks of bits, we use the <code
                      class="fy kp kq kr ks b">offset</code> and <code class="fy kp kq kr ks b">bit_cnt</code>
                    parameters to figure out whether this chunk came from an SWD Read or Write Operation, and which
                    chunk in that operation‚Ä¶</p>
                    <p><script src="https://gist.github.com/lupyuen/82adeeecf84f6b62d90d9536c3043105.js"></script></p>
<p><em>Deducing the chunk by offset and bit_cnt.
                      From <a
                        href="https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bcm2835spi.c"
                        class="dn jg"
                        rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bcm2835spi.c</a>
</em></p>

                  <p id="98d9"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><em
                      class="ja">(Yeah this chunk handling smells bad‚Ä¶ We should inject the SPI code into </em><code
                      class="fy kp kq kr ks b">bitbang_swd_read_reg()</code><em class="ja"> and </em><code
                      class="fy kp kq kr ks b">bitbang_swd_write_reg()</code><em class="ja"> in </em><code
                      class="fy kp kq kr ks b"><a href="https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bitbang.c#L414-L464" class="dn jg" rel="noopener nofollow">bitbang.c</a></code><em
                      class="ja"> instead)</em></p>
                  <p id="b16e"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">In
                    Raspberry Pi, all bytes must be sent over SPI in Most Significant Bit format‚Ä¶ But OpenOCD uses Least
                    Significant Bit format to manipulate the bytes. So we need to the reverse the bits like this‚Ä¶</p>
                    <p><script src="https://gist.github.com/lupyuen/92c7ed3bf9c3e6969b469aa471e07151.js"></script></p>
<p><em>From <a
                        href="https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bcm2835spi.c"
                        class="dn jg"
                        rel="noopener nofollow">https://github.com/lupyuen/openocd-spi/blob/master/src/jtag/drivers/bcm2835spi.c</a>
</em></p>

                </div>
              </div>
            </section>
            <div class="n p cr jh ji jj" role="separator"><span class="jk hr bq jl jm jn"></span><span
                class="jk hr bq jl jm jn"></span><span class="jk hr bq jl jm"></span></div>
            <section class="dh fk fl dc fm">
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <h1 id="1b10"
                    class="jo jp gk av jq jr js ik jt ju jv in jw jx jy jz ka kb kc kd ke kf kg kh ki kj hg">SPI Sandbox
                  </h1>
                  <p id="20e2"
                    class="ig ih gk ii b ij kk ik il im kl in io ip km iq ir is kn it iu iv ko iw ix iz dh hg">Before
                    implementing SWD over SPI in OpenOCD, I used a simple C program <code
                      class="fy kp kq kr ks b"><a href="https://github.com/lupyuen/pi-swd-spi/blob/master/pi-swd-spi.c" class="dn jg" rel="noopener nofollow">pi-swd-spi.c</a></code>
                    to test the individual SWD functions. I hope you‚Äôll do the same when you‚Äôre modifying OpenOCD.</p>
                  <p id="8f99"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">The
                    program tests all the functions we have covered: misaligned SWD reads, padded SWD writes,
                    JTAG-To-SWD reset, Throwaway Read IDCODE, Write ABORT, Read CTRL/STAT, ‚Ä¶</p>
                  <p id="5bed"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><a
                      href="https://github.com/lupyuen/pi-swd-spi/blob/master/pi-swd-spi.c#L296-L394"
                      class="dn jg" rel="noopener nofollow">Here‚Äôs the output from the test program</a>‚Ä¶</p>
                      <p><script src="https://gist.github.com/lupyuen/41620f4978db2404556f2ffa8dd1ac59.js"></script></p>
<p><em>SWD SPI Test Log. From <a
                        href="https://github.com/lupyuen/pi-swd-spi/blob/master/pi-swd-spi.c#L296-L394"
                        class="dn jg"
                        rel="noopener nofollow">https://github.com/lupyuen/pi-swd-spi/blob/master/pi-swd-spi.c#L296-L394</a>
</em></p>

                </div>
              </div>
            </section>
            <div class="n p cr jh ji jj" role="separator"><span class="jk hr bq jl jm jn"></span><span
                class="jk hr bq jl jm jn"></span><span class="jk hr bq jl jm"></span></div>
            <section class="dh fk fl dc fm">
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <h1 id="bda6"
                    class="jo jp gk av jq jr js ik jt ju jv in jw jx jy jz ka kb kc kd ke kf kg kh ki kj hg">Bit Banging
                    Is Bad</h1>
                  <p id="f168"
                    class="ig ih gk ii b ij kk ik il im kl in io ip km iq ir is kn it iu iv ko iw ix iz dh hg"><a
                      href="https://en.wikipedia.org/wiki/Bit_banging"
                      class="dn jg" rel="noopener nofollow">Bit Banging</a> means sending and receiving data one bit at
                    a time‚Ä¶ By looping around, waiting and sending one bit, waiting and sending another bit, ‚Ä¶</p>
                  <p id="c9a9"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">When I
                    was teaching IoT with Arduino Uno, I saw plenty of Arduino drivers implemented with Bit Banging.
                    This troubled me because‚Ä¶</p>
                  <ol class="">
                    <li id="2b33"
                      class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz nw nx ny hg">
                      <strong class="ii cu">Hard to reuse the Bit Banging code on other platforms</strong> (from Arduino
                      to Raspberry Pi, STM32, nRF52, RISC-V, ‚Ä¶). The timing needs to be adjusted precisely for every
                      platform.</li>
                    <li id="3792"
                      class="ig ih gk ii b ij nz ik il im oa in io ip ob iq ir is oc it iu iv od iw ix iz nw nx ny hg">
                      <strong class="ii cu">Doesn‚Äôt work reliably with Multitasking</strong>, which skews the timing
                      between bits. On a Raspberry Pi graphical desktop, this explains why <strong class="ii cu">OpenOCD
                        can‚Äôt flash nRF52 reliably with GPIO Bit Banging</strong>‚Ä¶ The CPU is just too busy handling
                      interactive tasks.</li>
                    <li id="bfda"
                      class="ig ih gk ii b ij nz ik il im oa in io ip ob iq ir is oc it iu iv od iw ix iz nw nx ny hg">
                      It‚Äôs 2020. <strong class="ii cu">Surely our microcontroller supports interrupt-driven,
                        precisely-clocked SPI and I2C interfaces,</strong> like on Raspberry Pi, STM32, nRF52, RISC-V, ‚Ä¶
                      (If you‚Äôre still using Arduino Uno‚Ä¶ <em class="ja">Why???</em>)</li>
                  </ol>
                  <p id="2456"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Here‚Äôs my
                    plea to all Embedded Developers: <strong class="ii cu">Please stop using Bit Banging!</strong> I
                    hope this article has given you plenty of reasons. <em class="ja">(And this article has wasted your
                      precious time, since you wouldn‚Äôt be reading it if OpenOCD were using SPI already)</em></p>
                  <p id="0ba3"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">If you‚Äôre
                    designing a serial protocol like SWD‚Ä¶ <strong class="ii cu">Please align the bits to whole
                      bytes!</strong> The SWD protocol was designed with plenty of stray bits <em class="ja">(every
                      read/write operation is 46 bits)</em>, thus Bit Banging was the natural solution for implementing
                    the SWD protocol.</p>
                  <p id="af0f"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg"><em
                      class="ja">If Arm had slipped in two measly bits and rounded up to 48 bits, we would have been
                      using SWD over SPI, reliably and efficiently, a long time ago!</em></p>
                  <div class="kt ku kv kw kx ky"><a
                      href="https://github.com/sponsors/lupyuen"
                      target="_blank" rel="noopener nofollow">
                      <div class="kz n ed">
                        <div class="la n ac p lb lc">
                          <h2 class="av cu di ax fu ld le lf lg lh li df hg">Sponsor @lupyuen on GitHub Sponsors</h2>
                        </div>
                        <div class="lm s">
                          <div class="op s lo lp lq lm lr ls ky"></div>
                        </div>
                      </div>
                    </a></div>
                </div>
              </div>
              <div class="fn w">


                  
                <p><img src="https://lupyuen.github.io/images/legacy/d23.jpeg" /></p>
<p><em>Raspberry Pi 4 flashing and debugging PineTime
                    Smart Watch via SPI</em></p>

              </div>
            </section>
            <div class="n p cr jh ji jj" role="separator"><span class="jk hr bq jl jm jn"></span><span
                class="jk hr bq jl jm jn"></span><span class="jk hr bq jl jm"></span></div>
            <section class="dh fk fl dc fm">
              <div class="n p">
                <div class="aj ak al am an gi ap w">
                  <h1 id="eb1a"
                    class="jo jp gk av jq jr js ik jt ju jv in jw jx jy jz ka kb kc kd ke kf kg kh ki kj hg">References
                  </h1>
                  <p id="4e52"
                    class="ig ih gk ii b ij kk ik il im kl in io ip km iq ir is kn it iu iv ko iw ix iz dh hg">The SPI
                    version of OpenOCD is now available as the PineTime Debugger. <em class="ja">Thanks everyone for
                      testing </em><code
                      class="fy kp kq kr ks b"><a href="https://github.com/lupyuen/openocd-spi" class="dn jg" rel="noopener nofollow">openocd-spi</a></code><em
                      class="ja">‚Ä¶ PineTime Debugger wouldn‚Äôt have been possible without you!</em> üòÉ</p>
                  <p id="acdf"
                    class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz dh hg">Read this
                    article to find out how we use Raspberry Pi to Code, Build, Flash and Debug firmware on PineTime‚Ä¶
                  </p>
                  <div class="kt ku kv kw kx ky"><a target="_blank" rel="noopener"
                      href="https://lupyuen.github.io/articles/debug-rust-mynewt-firmware-for-pinetime-on-raspberry-pi">
                      <div class="kz n ed">
                        <div class="la n ac p lb lc">
                          <h2 class="av cu di ax fu ld le lf lg lh li df hg">Debug Rust+Mynewt Firmware for PineTime on
                            Raspberry Pi</h2>
                        </div>
                        <div class="lm s">
                          <div class="or s lo lp lq lm lr ls ky"></div>
                        </div>
                      </div>
                    </a></div>
                  <ul class="">
                    <li id="2003"
                      class="ig ih gk ii b ij jb ik il im jc in io ip jd iq ir is je it iu iv jf iw ix iz os nx ny hg">
                      <a href="https://github.com/MarkDing/swd_programing_sram"
                        class="dn jg" rel="noopener nofollow"><em class="ja">Introduction to SWD</em></a></li>
                    <li id="6b0b"
                      class="ig ih gk ii b ij nz ik il im oa in io ip ob iq ir is oc it iu iv od iw ix iz os nx ny hg">
                      <a href="https://github.com/MarkDing/swd_programing_sram/blob/master/Ref/ARM_debug.pdf"
                        class="dn jg" rel="noopener nofollow"><em class="ja">ARM¬Æ Debug Interface v5 Architecture
                          Specification</em></a></li>
                    <li id="60ea"
                      class="ig ih gk ii b ij nz ik il im oa in io ip ob iq ir is oc it iu iv od iw ix iz os nx ny hg">
                      <a href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/spi/README.md"
                        class="dn jg" rel="noopener nofollow"><em class="ja">Raspberry Pi SPI Hardware</em></a></li>
                    <li id="f7ef"
                      class="ig ih gk ii b ij nz ik il im oa in io ip ob iq ir is oc it iu iv od iw ix iz os nx ny hg">
                      <a href="https://github.com/raspberrypi/linux/blob/rpi-3.12.y/drivers/spi/spi-bcm2708.c"
                        class="dn jg" rel="noopener nofollow"><em class="ja">Raspberry Pi SPI Kernel Driver</em></a>
                    </li>
                    <li id="9a3b"
                      class="ig ih gk ii b ij nz ik il im oa in io ip ob iq ir is oc it iu iv od iw ix iz os nx ny hg">
                      <a href="https://www.raspberrypi.org/documentation/hardware/raspberrypi/bcm2835/BCM2835-ARM-Peripherals.pdf"
                        class="dn jg" rel="noopener nofollow"><em class="ja">BCM2835 Peripherals Datasheet</em></a></li>
                    <li id="dc67"
                      class="ig ih gk ii b ij nz ik il im oa in io ip ob iq ir is oc it iu iv od iw ix iz os nx ny hg">
                      <a href="https://docs.google.com/spreadsheets/d/12oXe1MTTEZVIbdmFXsOgOXVFHCQnYVvIw6fRpIQZybg/edit#gid=0"
                        class="dn jg" rel="noopener nofollow"><em class="ja">SWD mapping to SPI bytes</em></a></li>
                  </ul>
                </div>
              </div>
            </section>
          </div>
        </article>
      </div>
    </div>
  </div>
</body>

</html>
<!--
       FILE ARCHIVED ON 00:48:44 Feb 07, 2021 AND RETRIEVED FROM THE
       INTERNET ARCHIVE ON 06:02:55 Feb 21, 2021.
       JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.
  
       ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
       SECTION 108(a)(3)).
  -->
<!--
  playback timings (ms):
    exclusion.robots: 0.425
    captures_list: 257.773
    LoadShardBlock: 228.347 (3)
    RedisCDXSource: 0.779
    PetaboxLoader3.datanode: 211.621 (4)
    esindex: 0.015
    PetaboxLoader3.resolve: 25.582
    exclusion.robots.policy: 0.386
    CDXLines.iter: 24.184 (3)
    load_resource: 55.553
  -->
