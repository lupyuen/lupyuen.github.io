<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Rust Apps on Apache NuttX RTOS and QEMU RISC-V</title>

    
    <!-- Begin scripts/articles/*-header.html: Article Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<meta property="og:title" 
    content="Rust Apps on Apache NuttX RTOS and QEMU RISC-V" 
    data-rh="true">
<meta property="og:description" 
    content=""
    data-rh="true">
<meta name="description" 
    content="">
<meta property="og:image" 
    content="https://lupyuen.github.io/images/rust3-title.png">
<meta property="og:type" 
    content="article" data-rh="true">
<link rel="canonical"
    href="https://lupyuen.codeberg.page/articles/rust3.html" />
<!-- End scripts/articles/*-header.html -->
<!-- Begin scripts/rustdoc-header.html: Header for Custom Markdown files processed by rustdoc, like chip8.md -->
<link rel="alternate" type="application/rss+xml" title="RSS Feed for lupyuen" href="/rss.xml" />
<link rel="stylesheet" type="text/css" href="../normalize.css">
<link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle">
<link rel="stylesheet" type="text/css" href="../dark.css">
<link rel="stylesheet" type="text/css" href="../light.css" id="themeStyle">
<link rel="stylesheet" type="text/css" href="../prism.css">
<script src="../storage.js"></script><noscript>
<link rel="stylesheet" href="../noscript.css"></noscript>
<link rel="shortcut icon" href="../favicon.ico">
<style type="text/css">
    #crate-search {
        background-image: url("../down-arrow.svg");
    }
</style>
<!-- End scripts/rustdoc-header.html -->


</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
    <!-- Begin scripts/rustdoc-before.html: Pre-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker -->
    <div class="theme-picker" style="left: 0"><button id="theme-picker" aria-label="Pick another theme!"><img src="../brush.svg"
        width="18" alt="Pick another theme!"></button>
        <div id="theme-choices"></div>
    </div>
    <!-- Theme Picker -->

    <!-- End scripts/rustdoc-before.html -->
    

    <h1 class="title">Rust Apps on Apache NuttX RTOS and QEMU RISC-V</h1>
    <nav id="TOC"><ul>
<li><a href="#our-rust-app">1 Our Rust App</a><ul></ul></li>
<li><a href="#build-nuttx-for-32-bit-risc-v-qemu">2 Build NuttX for 32-bit RISC-V QEMU</a><ul></ul></li>
<li><a href="#boot-nuttx-on-32-bit-risc-v-qemu">3 Boot NuttX on 32-bit RISC-V QEMU</a><ul></ul></li>
<li><a href="#console-input-in-rust">4 Console Input in Rust</a><ul></ul></li>
<li><a href="#how-nuttx-builds-rust-apps">5 How NuttX Builds Rust Apps</a><ul></ul></li>
<li><a href="#software-vs-hardware-floating-point">6 Software vs Hardware Floating Point</a><ul></ul></li>
<li><a href="#panic-is-undefined">7 Panic is Undefined</a><ul></ul></li>
<li><a href="#standard-vs-embedded-rust">8 Standard vs Embedded Rust</a><ul></ul></li>
<li><a href="#all-things-considered">9 All Things Considered</a><ul></ul></li>
<li><a href="#whats-next">10 What‚Äôs Next</a><ul></ul></li>
<li><a href="#appendix-panic-is-undefined">11 Appendix: Panic is Undefined</a><ul></ul></li>
<li><a href="#appendix-rust-build-for-qemu-risc-v-64-bit">12 Appendix: Rust Build for QEMU RISC-V 64-bit</a><ul></ul></li></ul></nav><p>üìù <em>10 Apr 2024</em></p>
<p><img src="https://lupyuen.github.io/images/rust3-title.png" alt="TODO" /></p>
<p>TODO</p>
<p>My mentee <a href="https://github.com/apache/nuttx/issues/11907"><strong>Rushabh Gala</strong></a> and I are anxiously awaiting the results of the <a href="TODO"><strong>Google Summer of Code</strong></a> (GSoC) Project Selection. While waiting, we explain the current steps for running barebones Rust Apps on Apache NuttX RTOS (and the challenges we faced)‚Ä¶</p>
<p>Running Rust Apps on NuttX today</p>
<p>Limitations</p>
<p>Workaround</p>
<p>How we plan to fix them in GSoC</p>
<p>PINE64 has kindly sponsored the Ox64 BL808 RISC-V SBCs for testing Rust Apps on NuttX.</p>
<h1 id="our-rust-app"><a class="doc-anchor" href="#our-rust-app">¬ß</a>1 Our Rust App</h1>
<p>TODO</p>
<p><img src="https://lupyuen.github.io/images/riscv-build.png" alt="Build Apache NuttX RTOS for 64-bit RISC-V QEMU" /></p>
<h1 id="build-nuttx-for-32-bit-risc-v-qemu"><a class="doc-anchor" href="#build-nuttx-for-32-bit-risc-v-qemu">¬ß</a>2 Build NuttX for 32-bit RISC-V QEMU</h1>
<p>Follow these steps to build Apache NuttX RTOS for QEMU RISC-V (32-bit), bundled with our ‚ÄúHello Rust‚Äù Demo App‚Ä¶</p>
<ol>
<li>
<p>Install the Build Prerequisites, skip the RISC-V Toolchain‚Ä¶</p>
<p><a href="https://lupyuen.github.io/articles/nuttx#install-prerequisites"><strong>‚ÄúInstall Prerequisites‚Äù</strong></a></p>
</li>
<li>
<p>Download the RISC-V Toolchain for <strong>riscv64-unknown-elf</strong>‚Ä¶</p>
<p><a href="https://lupyuen.github.io/articles/riscv#appendix-download-toolchain-for-64-bit-risc-v"><strong>‚ÄúDownload Toolchain for 64-bit RISC-V‚Äù</strong></a></p>
</li>
<li>
<p>Download and configure NuttX‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>mkdir nuttx
cd nuttx
git clone https://github.com/apache/nuttx nuttx
git clone https://github.com/apache/nuttx-apps apps

cd nuttx
tools/configure.sh rv-virt:nsh
make menuconfig
</code></pre></div></li>
<li>
<p>In <strong>menuconfig</strong>, browse to ‚Äú<strong>Device Drivers</strong> &gt; <strong>System Logging</strong>‚Äù</p>
<p>Disable this option‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>Prepend Timestamp to Syslog Message
</code></pre></div></li>
<li>
<p>Browse to ‚Äú<strong>Build Setup</strong> &gt; <strong>Debug Options</strong>‚Äù</p>
<p>Select the following options‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>Enable Debug Features
Enable Error Output
Enable Warnings Output
Enable Informational Debug Output
Enable Debug Assertions
Enable Debug Assertions Show Expression
Scheduler Debug Features
Scheduler Error Output
Scheduler Warnings Output
Scheduler Informational Output
</code></pre></div></li>
<li>
<p>Browse to ‚Äú<strong>Application Configuration</strong> &gt; <strong>Examples</strong>‚Äù</p>
<p>Select ‚Äú<strong>Hello Rust Example</strong>‚Äù</p>
<p>Select it <strong>Twice</strong> so that ‚Äú<strong><code>&lt;M&gt;</code></strong>‚Äù changes to ‚Äú<strong><code>&lt;*&gt;</code></strong>‚Äù</p>
<p><a href="https://github.com/apache/nuttx-apps/blob/master/examples/hello_rust/hello_rust_main.rs">(Source Code for Hello Rust)</a></p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/commit/c1d9124347da02bbe0842c14ca99100a6b8f42b0">(Reading from Console Input)</a></p>
</li>
<li>
<p>Save and exit <strong>menuconfig</strong>.</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx/commit/9ee00a20a2f8deab8e27a08cfbc1c7a7f948d5ed">(See the NuttX Config)</a></p>
</li>
<li>
<p>Build the NuttX Project and dump the RISC-V Disassembly to <strong>nuttx.S</strong>‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>rustup target add riscv32i-unknown-none-elf

make

riscv64-unknown-elf-objdump \
  -t -S --demangle --line-numbers --wide \
  nuttx \
  &gt;nuttx.S \
  2&gt;&amp;1
</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/31c78de72ade71bbdf63372b44749cd4">(See the Build Log)</a></p>
<p>This produces the NuttX ELF Image <strong>nuttx</strong> that we may boot on QEMU RISC-V Emulator. (Next Section)</p>
</li>
<li>
<p>If the GCC Linker fails with <em>‚ÄúCan‚Äôt link soft-float modules with double-float modules‚Äù</em>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>$ make
LD: nuttx
riscv64-unknown-elf-ld: nuttx/nuttx/staging/libapps.a
  (hello_rust_main.rs...nuttx.apps.examples.hello_rust_1.o):
  can&#39;t link soft-float modules with double-float modules
riscv64-unknown-elf-ld: failed to merge target specific data of file
  nuttx/staging/libapps.a
  (hello_rust_main.rs...nuttx.apps.examples.hello_rust_1.o)
</code></pre></div>
<p>Then we patch the ELF Header like this and it should link correctly‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>xxd -c 1 ../apps/examples/hello_rust/*hello_rust_1.o \
  | sed &#39;s/00000024: 00/00000024: 04/&#39; \
  | xxd -r -c 1 - /tmp/hello_rust_1.o
cp /tmp/hello_rust_1.o ../apps/examples/hello_rust/*hello_rust_1.o
make

## Ignore the warnings:
## riscv64-unknown-elf-ld: warning: nuttx/staging/libapps.a(hello_rust_main.rs...nuttx.apps.examples.hello_rust_1.o): 
## mis-matched ISA version 2.1 for &#39;i&#39; extension, the output version is 2.0
</code></pre></div>
<p>How did it work? We patched the ELF Header, changing it from Software Floating-Point to Double Precision Hardware Floating-Point‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Before Patching: ELF Header says Software Floating-Point
$ riscv64-unknown-elf-readelf -h -A ../apps/examples/hello_rust/*hello_rust_1.o
  Flags: 0x0

## After Patching: ELF Header says Double-Precision Hardware Floating-Point
$ riscv64-unknown-elf-readelf -h -A ../apps/examples/hello_rust/*hello_rust_1.o
  Flags: 0x4, double-float ABI
</code></pre></div>
<p><a href="https://lupyuen.github.io/articles/zig#patch-elf-header">(Similar to this, except we‚Äôre doing Double-Float instead of Single-Float)</a></p>
<p>TODO: Fix the Rust Build for NuttX</p>
</li>
<li>
<p>If the GCC Linker fails with the error <em>‚Äúundefined reference to core::panicking::panic‚Äù</em>, please apply this patch‚Ä¶</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/commit/58c9ebee95626251dd1601476991cdfea7fcd190">Add -O to RUSTFLAGS in Makefile</a></p>
<p>Then rebuild: <code>make clean ; make</code></p>
<p>(If we still hit the same error, see the notes below)</p>
</li>
</ol>
<p><img src="https://lupyuen.github.io/images/riscv-title.png" alt="Apache NuttX RTOS on RISC-V QEMU" /></p>
<h1 id="boot-nuttx-on-32-bit-risc-v-qemu"><a class="doc-anchor" href="#boot-nuttx-on-32-bit-risc-v-qemu">¬ß</a>3 Boot NuttX on 32-bit RISC-V QEMU</h1>
<p>This is how we boot NuttX on QEMU and run our Rust App‚Ä¶</p>
<ol>
<li>
<p>Download and install <a href="https://www.qemu.org/download/"><strong>QEMU Emulator</strong></a>.</p>
<div class="example-wrap"><pre class="language-bash"><code>## For macOS:
brew install qemu

## For Debian and Ubuntu:
sudo apt install qemu-system-riscv32
</code></pre></div></li>
<li>
<p>Start the <strong>QEMU RISC-V Emulator</strong> (32-bit) with the NuttX ELF Image <strong>nuttx</strong> from the previous section‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>qemu-system-riscv32 \
  -semihosting \
  -M virt,aclint=on \
  -cpu rv32 \
  -smp 8 \
  -bios none \
  -kernel nuttx \
  -nographic
</code></pre></div></li>
<li>
<p>NuttX is now running in the QEMU Emulator! (Pic above)</p>
<div class="example-wrap"><pre class="language-text"><code>uart_register: Registering /dev/console
uart_register: Registering /dev/ttyS0
nx_start_application: Starting init thread

NuttShell (NSH) NuttX-12.1.0-RC0
nsh&gt; nx_start: CPU0: Beginning Idle Loop
nsh&gt;
</code></pre></div></li>
<li>
<p>Enter ‚Äú<strong>hello_rust</strong>‚Äù to run the Rust Demo App</p>
<div class="example-wrap"><pre class="language-text"><code>nsh&gt; hello_rust
Hello, Rust!!
</code></pre></div></li>
<li>
<p>Enter ‚Äú<strong>help</strong>‚Äù to see the available commands‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>nsh&gt; help
help usage:  help [-v] [&lt;cmd&gt;]

    .         break     dd        exit      ls        ps        source    umount
    [         cat       df        false     mkdir     pwd       test      unset
    ?         cd        dmesg     free      mkrd      rm        time      uptime
    alias     cp        echo      help      mount     rmdir     true      usleep
    unalias   cmp       env       hexdump   mv        set       truncate  xd
    basename  dirname   exec      kill      printf    sleep     uname

Builtin Apps:
    nsh     ostest  sh
</code></pre></div></li>
<li>
<p>NuttX works like a tiny version of Linux, so the commands will look familiar‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>nsh&gt; uname -a
NuttX 12.1.0-RC0 275db39 Jun 16 2023 20:22:08 risc-v rv-virt

nsh&gt; ls /dev
/dev:
console
null
ttyS0
zero

nsh&gt; ps
  PID GROUP PRI POLICY   TYPE    NPX STATE    EVENT     SIGMASK           STACK   USED  FILLED COMMAND
    0     0   0 FIFO     Kthread N-- Ready              0000000000000000 002000 001224  61.2%  Idle Task
    1     1 100 RR       Task    --- Running            0000000000000000 002992 002024  67.6%  nsh_main
</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/93ad51d49e5f02ad79bb40b0a57e3ac8">(See the Complete Log)</a></p>
</li>
<li>
<p>To Exit QEMU: Press <strong><code>Ctrl-A</code></strong> then <strong><code>x</code></strong></p>
</li>
</ol>
<h1 id="console-input-in-rust"><a class="doc-anchor" href="#console-input-in-rust">¬ß</a>4 Console Input in Rust</h1>
<p>TODO</p>
<h1 id="how-nuttx-builds-rust-apps"><a class="doc-anchor" href="#how-nuttx-builds-rust-apps">¬ß</a>5 How NuttX Builds Rust Apps</h1>
<p>Let‚Äôs watch how NuttX builds Rust Apps by calling <code>rustc</code>. (Instead of <code>cargo build</code>)</p>
<p>Here‚Äôs the NuttX Build Log‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>$ make --trace

## Compile `hello_rust_main.rs` to `hello_rust.o`
rustc \
  --edition 2021 \
  --emit obj \
  -g \
  --target riscv32i-unknown-none-elf \
  -C panic=abort \
  -O \
  hello_rust_main.rs \
  -o hello_rust_main.rs...apps.examples.hello_rust.o

## Copy `hello_rust.o` to `hello_rust_1.o` (Why?)
cp \
  hello_rust_main.rs...apps.examples.hello_rust.o \
  hello_rust_main.rs...apps.examples.hello_rust_1.o

## Omitted: Bundle `hello_rust_1.o`
## into `staging/libapps.a`

## Link `staging/libapps.a` into `nuttx`
riscv64-unknown-elf-ld \
  --entry=__start \
  -melf32lriscv \
  --gc-sections \
  -nostdlib \
  --cref \
  -Map=nuttx/nuttx.map \
  -Tboards/risc-v/qemu-rv/rv-virt/scripts/ld.script.tmp  \
  -L staging \
  -L arch/risc-v/src/board  \
  -o nuttx \
  qemu_rv_head.o  \
  --start-group \
  -lsched \
  -ldrivers \
  -lboards \
  -lc \
  -lmm \
  -larch \
  -lm \
  -lapps \
  -lfs \
  -lbinfmt \
  -lboard riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-apple-darwin/bin/../lib/gcc/riscv64-unknown-elf/10.2.0/rv32imafdc/ilp32d/libgcc.a \
  --end-group
</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/1d79670339480baed19f4fa30266b945">(See the Detailed Build Log)</a></p>
<p><a href="https://github.com/apache/nuttx-apps/blob/master/Application.mk#L164-L170">(Rust Build with <code>rustc</code> is defined here)</a></p>
<p>Here are the Rust Object Files produced by the NuttX Build‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>$ ls -l ../apps/examples/hello_rust     
total 112
-rw-r--r--  1   650 Jul 20  2023 Kconfig
-rw-r--r--  1  1071 Jul 20  2023 Make.defs
-rw-r--r--  1   141 Mar 17 09:44 Make.dep
-rw-r--r--  1  1492 Mar 16 20:41 Makefile
-rw-r--r--  1  3982 Mar 17 00:06 hello_rust_main.rs
-rw-r--r--  1 13168 Mar 17 09:44 hello_rust_main.rs.Users.Luppy.riscv.apps.examples.hello_rust.o
-rw-r--r--  1 18240 Mar 17 09:54 hello_rust_main.rs.Users.Luppy.riscv.apps.examples.hello_rust_1.o
</code></pre></div>
<p><a href="https://gist.github.com/lupyuen/76b8680a58793571db67082bcca2e86c">(See the RISC-V Disassembly)</a></p>
<h1 id="software-vs-hardware-floating-point"><a class="doc-anchor" href="#software-vs-hardware-floating-point">¬ß</a>6 Software vs Hardware Floating Point</h1>
<p>TODO</p>
<p>If the GCC Linker fails with <em>‚ÄúCan‚Äôt link soft-float modules with double-float modules‚Äù</em>‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>$ make
LD: nuttx
riscv64-unknown-elf-ld: nuttx/nuttx/staging/libapps.a
  (hello_rust_main.rs...nuttx.apps.examples.hello_rust_1.o):
  can&#39;t link soft-float modules with double-float modules
riscv64-unknown-elf-ld: failed to merge target specific data of file
  nuttx/staging/libapps.a
  (hello_rust_main.rs...nuttx.apps.examples.hello_rust_1.o)
</code></pre></div>
<p>Then we patch the ELF Header like this and it should link correctly‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>xxd -c 1 ../apps/examples/hello_rust/*hello_rust_1.o \
  | sed &#39;s/00000024: 00/00000024: 04/&#39; \
  | xxd -r -c 1 - /tmp/hello_rust_1.o
cp /tmp/hello_rust_1.o ../apps/examples/hello_rust/*hello_rust_1.o
make

## Ignore the warnings:
## riscv64-unknown-elf-ld: warning: nuttx/staging/libapps.a(hello_rust_main.rs...nuttx.apps.examples.hello_rust_1.o): 
## mis-matched ISA version 2.1 for &#39;i&#39; extension, the output version is 2.0
</code></pre></div>
<p>How did it work? We patched the ELF Header, changing it from Software Floating-Point to Double Precision Hardware Floating-Point‚Ä¶</p>
<div class="example-wrap"><pre class="language-bash"><code>## Before Patching: ELF Header says Software Floating-Point
$ riscv64-unknown-elf-readelf -h -A ../apps/examples/hello_rust/*hello_rust_1.o
  Flags: 0x0

## After Patching: ELF Header says Double-Precision Hardware Floating-Point
$ riscv64-unknown-elf-readelf -h -A ../apps/examples/hello_rust/*hello_rust_1.o
  Flags: 0x4, double-float ABI
</code></pre></div>
<p><a href="https://lupyuen.github.io/articles/zig#patch-elf-header">(Similar to this, except we‚Äôre doing Double-Float instead of Single-Float)</a></p>
<p>TODO: But why Double Float instead of Single Float? (Mmmm ice cream float)</p>
<h1 id="panic-is-undefined"><a class="doc-anchor" href="#panic-is-undefined">¬ß</a>7 Panic is Undefined</h1>
<p><em>What‚Äôs this core::panicking::panic? Why is it undefined?</em></p>
<p>TODO</p>
<p>If the GCC Linker fails with the error <em>‚Äúundefined reference to core::panicking::panic‚Äù</em>, please apply this patch‚Ä¶</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/commit/58c9ebee95626251dd1601476991cdfea7fcd190">Add -O to RUSTFLAGS in Makefile</a></p>
<p>Then rebuild: <code>make clean ; make</code></p>
<p>(If we still hit the same error, see the notes below)</p>
<p>TODO</p>
<p>After adding <code>RUSTFLAGS=-O</code>, we might still hit Undefined <code>core::panicking::panic</code>. Here‚Äôs our Test Code that has 2 Potential Panics: <a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/blob/rust2/examples/hello_rust/hello_rust_main.rs#L90">hello_rust_main.rs</a></p>
<p>TODO: See Appendix</p>
<p>If we omit <code>RUSTFLAGS=-O</code>: We see 2 Undefined <code>core::panicking::panic</code>‚Ä¶</p>
<p>TODO: See Appendix</p>
<p>But when we add <code>RUSTFLAGS=-O</code>: We still see 1 Undefined <code>core::panicking::panic</code> for the divide-by-zero‚Ä¶</p>
<p>TODO: See Appendix</p>
<p>Somehow the divide-by-zero panic refuses to link correctly. <a href="https://github.com/rust-lang/compiler-builtins/issues/79">Based on this discussion</a>, it seems that the Rust Core Library is compiled with LTO (Link-Time Optimisation), so it might still cause problems with our code, which doesn‚Äôt use LTO.</p>
<p>TODO: If we call <code>cargo build</code> (instead of <code>rustc</code>), will it fix this LTO issue? How different is the <code>cargo build</code> Linker from GCC Linker?</p>
<h1 id="standard-vs-embedded-rust"><a class="doc-anchor" href="#standard-vs-embedded-rust">¬ß</a>8 Standard vs Embedded Rust</h1>
<p>TODO: malloc()?</p>
<p>There are 2 ‚Äúflavours‚Äù of Rust, depending on the Rust Libraries that we use:</p>
<ul>
<li>
<p><a href="https://doc.rust-lang.org/std/">Rust Standard Library</a>: This is used by most Rust Apps on desktops and servers. Supports Heap Memory and the Rust Equivalent of POSIX Calls. </p>
</li>
<li>
<p><a href="https://doc.rust-lang.org/core/index.html">Rust Core Library</a> (<code>no_std</code>): Barebones Rust Library that runs on Bare Metal, used by Rust Embedded Apps. Calls minimal libc functions, doesn‚Äôt support Heap Memory and POSIX. </p>
</li>
</ul>
<p>The malloc() that you mentioned: It‚Äôs called by the <strong>Rust Standard Library</strong>. <a href="https://github.com/rust-lang/rust/blob/c8813ddd6d2602ae5473752031fd16ba70a6e4a7/library/std/src/sys/pal/unix/alloc.rs#L14">(Like this)</a></p>
<p>For Kernel Dev <a href="https://rust-for-linux.com/third-party-crates#introduction:~:text=Some%20of%20those%20open%2Dsource%20libraries%20are%20potentially%20usable%20in%20the%20kernel%20because%20they%20only%20depend%20on%20core%20and%20alloc%20(rather%20than%20std)%2C%20or%20because%20they%20only%20provide%20macro%20facilities.">(like Linux)</a>: We‚Äôll use the <strong>Rust Core Library</strong>. Which doesn‚Äôt support Heap Memory and doesn‚Äôt need malloc().</p>
<p>But most Kernel Drivers will need Kernel Heap. That‚Äôs why Linux Kernel also supports the <a href="https://doc.rust-lang.org/alloc/#"><code>alloc</code> Rust Library / Crate</a>. To implement Rust <code>alloc</code>, Linux Kernel calls krealloc() to allocate Kernel Heap. <a href="https://github.com/torvalds/linux/blob/741e9d668aa50c91e4f681511ce0e408d55dd7ce/rust/kernel/allocator.rs#L46">(Like this)</a></p>
<p>For NuttX Kernel: We‚Äôll implement Rust <code>alloc</code> by calling kmm_malloc().</p>
<p>Since we‚Äôre calling Rust Core Library in the Kernel, we won‚Äôt touch any POSIX Application Interfaces. So if we need to support the Kernel Equivalent of Errno (and other Global State), we‚Äôll have to build the Rust Library ourselves. <a href="https://rust-for-linux.github.io/docs/v6.8-rc3/kernel/">(Here‚Äôs the Rust Library for Linux Kernel)</a></p>
<p>TODO: GSoC Project Report, Draft Driver</p>
<h1 id="all-things-considered"><a class="doc-anchor" href="#all-things-considered">¬ß</a>9 All Things Considered</h1>
<ol>
<li>
<p><em>Why are we doing all this?</em></p>
<p>Yeah it‚Äôs tough work but it needs to be done‚Ä¶</p>
<ul>
<li>
<p>Some folks think it‚Äôs the right time to explore <a href="TODO"><strong>Memory-Safe Programming in Rust</strong></a></p>
</li>
<li>
<p>Devs among us might already be coding <strong>Rust Apps and Rust Drivers</strong> for NuttX?</p>
<p>(We know of one Corporate User of NuttX that‚Äôs very keen on Rust)</p>
</li>
<li>
<p>So we‚Äôre helpfully drafting the <strong>Standards and Guidelines</strong> for folks already coding Rust in NuttX</p>
</li>
</ul>
</li>
<li>
<p><em>Learning Rust looks difficult. Any other way to write Memory-Safe Apps?</em></p>
<p>If we‚Äôre familiar with Python, check out the <a href="TODO"><strong>Nim Programming Language</strong></a>.</p>
<p><a href="TODO"><strong>Zig Programming Language</strong></a> is safer than C and easier to learn, but not quite Memory-Safe like Rust.</p>
<p><a href="https://gist.github.com/lupyuen/10ce1aeff7f6a743c374aa7c1931525b"><strong>AI Tools</strong></a> might be helpful for coding the difficult bits of Rust: ChatGPT, GitHub Copilot, Google Gemini, ‚Ä¶</p>
<p>(We‚Äôll validate this during GSoC)</p>
</li>
<li>
<p><em>Giving in to our AI Overlords already?</em></p>
<p>But Rust Devs are familiar with smarty tools. <a href="TODO"><strong>Borrow Checker</strong></a> and <a href="TODO"><strong>Cargo Clippy</strong></a> are already so clever, they might as well be AI!</p>
<p>And Rust Compiler is almost Sentient, always commanding us Humans: <em>‚ÄúPlease do this to fix the build, you poopy nincompoop!‚Äù</em></p>
<p>(My Biggest Wish: Someone please create a Higher-Level variant of Rust that will use bits of AI to compile into the current Low-Level Rust)</p>
</li>
<li>
<p><em>Apparently there‚Äôs some Resistance to Rust Drivers inside NuttX Kernel?</em></p>
<p>Ouch we‚Äôre trapped between a Rock and‚Ä¶ Another Rusty Rock!</p>
<ul>
<li>
<p><strong>NuttX Kernel Devs</strong> are concerned about the <strong>extra complexity</strong> that Rust Drivers add to the Kernel Build</p>
</li>
<li>
<p><strong>Rust Community</strong> is probably thinking we‚Äôre <strong>not doing enough</strong> to promote Memory-Safe Coding in NuttX Kernel</p>
</li>
</ul>
<p>For now we‚Äôll walk the <strong>Middle Way</strong>‚Ä¶</p>
<ul>
<li>
<p><strong>Lay the Groundwork</strong> for Future Integration of Rust Drivers into NuttX Kernel</p>
</li>
<li>
<p>Observe the Rust Development in <a href="https://rust-for-linux.com/"><strong>Linux Kernel</strong></a>. And adapt the Best Practices for NuttX Kernel.</p>
</li>
</ul>
</li>
</ol>
<h1 id="whats-next"><a class="doc-anchor" href="#whats-next">¬ß</a>10 What‚Äôs Next</h1>
<p>TODO</p>
<p>Many Thanks to my <a href="https://github.com/sponsors/lupyuen"><strong>GitHub Sponsors</strong></a> (and the awesome NuttX Community) for supporting my work! This article wouldn‚Äôt have been possible without your support.</p>
<ul>
<li>
<p><a href="https://github.com/sponsors/lupyuen"><strong>Sponsor me a coffee</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-ox64"><strong>My Current Project: ‚ÄúApache NuttX RTOS for Ox64 BL808‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/nuttx-star64"><strong>My Other Project: ‚ÄúNuttX for Star64 JH7110‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://github.com/lupyuen/pinephone-nuttx"><strong>Older Project: ‚ÄúNuttX for PinePhone‚Äù</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io"><strong>Check out my articles</strong></a></p>
</li>
<li>
<p><a href="https://lupyuen.github.io/rss.xml"><strong>RSS Feed</strong></a></p>
</li>
</ul>
<p><em>Got a question, comment or suggestion? Create an Issue or submit a Pull Request here‚Ä¶</em></p>
<p><a href="https://github.com/lupyuen/lupyuen.github.io/blob/master/src/rust3.md"><strong>lupyuen.github.io/src/rust3.md</strong></a></p>
<h1 id="appendix-panic-is-undefined"><a class="doc-anchor" href="#appendix-panic-is-undefined">¬ß</a>11 Appendix: Panic is Undefined</h1>
<p>TODO</p>
<p><em>What‚Äôs this core::panicking::panic? Why is it undefined?</em></p>
<p>TODO</p>
<p>If the GCC Linker fails with the error <em>‚Äúundefined reference to core::panicking::panic‚Äù</em>, please apply this patch‚Ä¶</p>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/commit/58c9ebee95626251dd1601476991cdfea7fcd190">Add -O to RUSTFLAGS in Makefile</a></p>
<p>Then rebuild: <code>make clean ; make</code></p>
<p>(If we still hit the same error, see the notes below)</p>
<p>TODO</p>
<p>After adding <code>RUSTFLAGS=-O</code>, we might still hit Undefined <code>core::panicking::panic</code>. Here‚Äôs our Test Code that has 2 Potential Panics: <a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/blob/rust2/examples/hello_rust/hello_rust_main.rs#L90">hello_rust_main.rs</a></p>
<ul>
<li>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/blob/rust2/examples/hello_rust/hello_rust_main.rs#L84">Converting usize to c_int</a> might panic (due to overflow)</p>
</li>
<li>
<p><a href="https://github.com/lupyuen2/wip-pinephone-nuttx-apps/blob/rust2/examples/hello_rust/hello_rust_main.rs#L90">Divide by 0</a> will panic</p>
</li>
</ul>
<p>If we omit <code>RUSTFLAGS=-O</code>: We see 2 Undefined <code>core::panicking::panic</code>‚Ä¶</p>
<ul>
<li><a href="https://gist.github.com/lupyuen/ac2b43f2e31ecf0d972dcf5fed8d5e4c">RISC-V Disassembly: Without <code>RUSTFLAGS=-O</code></a></li>
</ul>
<p>But when we add <code>RUSTFLAGS=-O</code>: We still see 1 Undefined <code>core::panicking::panic</code> for the divide-by-zero‚Ä¶</p>
<ul>
<li><a href="https://gist.github.com/lupyuen/bec3bdd8379143a6046414d3ad2cc888">RISC-V Disassembly: With <code>RUSTFLAGS=-O</code></a></li>
</ul>
<p>Somehow the divide-by-zero panic refuses to link correctly. <a href="https://github.com/rust-lang/compiler-builtins/issues/79">Based on this discussion</a>, it seems that the Rust Core Library is compiled with LTO (Link-Time Optimisation), so it might still cause problems with our code, which doesn‚Äôt use LTO.</p>
<p>TODO: If we call <code>cargo build</code> (instead of <code>rustc</code>), will it fix this LTO issue? How different is the <code>cargo build</code> Linker from GCC Linker?</p>
<h1 id="appendix-rust-build-for-qemu-risc-v-64-bit"><a class="doc-anchor" href="#appendix-rust-build-for-qemu-risc-v-64-bit">¬ß</a>12 Appendix: Rust Build for QEMU RISC-V 64-bit</h1>
<p>TODO: Rust Build fails for QEMU RISC-V 64-bit‚Ä¶</p>
<div class="example-wrap"><pre class="language-text"><code>$ tools/configure.sh rv-virt:nsh64
$ make menuconfig
## TODO: Enable &quot;Hello Rust Example&quot;
$ make

RUSTC:  hello_rust_main.rs error: Error loading target specification: 
  Could not find specification for target &quot;riscv64i-unknown-none-elf&quot;. 
  Run `rustc --print target-list` for a list of built-in targets

make[2]: *** [nuttx/apps/Application.mk:275: hello_rust_main.rs...nuttx.apps.examples.hello_rust.o] Error 1
make[1]: *** [Makefile:51: nuttx/apps/examples/hello_rust_all] Error 2
make: *** [tools/LibTargets.mk:232: nuttx/apps/libapps.a] Error 2
</code></pre></div>
<p>TODO: Test the Rust Build for QEMU Arm32 and Arm64</p>

    
    <!-- Begin scripts/rustdoc-after.html: Post-HTML for Custom Markdown files processed by rustdoc, like chip8.md -->

    <!-- Begin Theme Picker and Prism Theme -->
    <script src="../theme.js"></script>
    <script src="../prism.js"></script>
    <!-- Theme Picker and Prism Theme -->

    <!-- End scripts/rustdoc-after.html -->
    

</body>
</html>